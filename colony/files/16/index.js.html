<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> bn = require(<span class="string">'bn.js'</span>);
<span class="keyword">var</span> randomBytes = require(<span class="string">'randombytes'</span>);
module.exports = crt;
<span class="function"><span class="keyword">function</span> <span class="title">blind</span><span class="params">(priv)</span> {</span>
  <span class="keyword">var</span> r = getr(priv);
  <span class="keyword">var</span> blinder = r.toRed(bn.mont(priv.modulus))
  .redPow(<span class="keyword">new</span> bn(priv.publicExponent)).fromRed();
  <span class="keyword">return</span> {
    blinder: blinder,
    unblinder:r.invm(priv.modulus)
  };
}
<span class="function"><span class="keyword">function</span> <span class="title">crt</span><span class="params">(msg, priv)</span> {</span>
  <span class="keyword">var</span> blinds = blind(priv);
  <span class="keyword">var</span> len = priv.modulus.byteLength();
  <span class="keyword">var</span> mod = bn.mont(priv.modulus);
  <span class="keyword">var</span> blinded = <span class="keyword">new</span> bn(msg).mul(blinds.blinder).umod(priv.modulus);
  <span class="keyword">var</span> c1 = blinded.toRed(bn.mont(priv.prime1));
  <span class="keyword">var</span> c2 = blinded.toRed(bn.mont(priv.prime2));
  <span class="keyword">var</span> qinv = priv.coefficient;
  <span class="keyword">var</span> p = priv.prime1;
  <span class="keyword">var</span> q = priv.prime2;
  <span class="keyword">var</span> m1 = c1.redPow(priv.exponent1);
  <span class="keyword">var</span> m2 = c2.redPow(priv.exponent2);
  m1 = m1.fromRed();
  m2 = m2.fromRed();
  <span class="keyword">var</span> h = m1.isub(m2).imul(qinv).umod(p);
  h.imul(q);
  m2.iadd(h);
  <span class="keyword">return</span> <span class="keyword">new</span> Buffer(m2.imul(blinds.unblinder).umod(priv.modulus).toArray(<span class="literal">false</span>, len));
}
crt.getr = getr;
<span class="function"><span class="keyword">function</span> <span class="title">getr</span><span class="params">(priv)</span> {</span>
  <span class="keyword">var</span> len = priv.modulus.byteLength();
  <span class="keyword">var</span> r = <span class="keyword">new</span> bn(randomBytes(len));
  <span class="keyword">while</span> (r.cmp(priv.modulus) >=  <span class="number">0</span> || !r.umod(priv.prime1) || !r.umod(priv.prime2)) {
    r = <span class="keyword">new</span> bn(randomBytes(len));
  }
  <span class="keyword">return</span> r;
}
</code></pre>