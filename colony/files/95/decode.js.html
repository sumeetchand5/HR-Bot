<h1>decode.js</h1>
<pre><code class="lang-js"><span class="comment">// Copyright Joyent, Inc. and other Node contributors.</span>
<span class="comment">//</span>
<span class="comment">// Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="comment">// copy of this software and associated documentation files (the</span>
<span class="comment">// "Software"), to deal in the Software without restriction, including</span>
<span class="comment">// without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="comment">// distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<span class="comment">// persons to whom the Software is furnished to do so, subject to the</span>
<span class="comment">// following conditions:</span>
<span class="comment">//</span>
<span class="comment">// The above copyright notice and this permission notice shall be included</span>
<span class="comment">// in all copies or substantial portions of the Software.</span>
<span class="comment">//</span>
<span class="comment">// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="comment">// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="comment">// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN</span>
<span class="comment">// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<span class="comment">// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<span class="comment">// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<span class="comment">// USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="string">'use strict'</span>;

<span class="comment">// If obj.hasOwnProperty has been overridden, then calling</span>
<span class="comment">// obj.hasOwnProperty(prop) will break.</span>
<span class="comment">// See: https://github.com/joyent/node/issues/1707</span>
<span class="function"><span class="keyword">function</span> <span class="title">hasOwnProperty</span><span class="params">(obj, prop)</span> {</span>
  <span class="keyword">return</span> Object.prototype.hasOwnProperty.call(obj, prop);
}

module.exports = <span class="keyword">function</span>(qs, sep, eq, options) {
  sep = sep || <span class="string">'&amp;'</span>;
  eq = eq || <span class="string">'='</span>;
  <span class="keyword">var</span> obj = {};

  <span class="keyword">if</span> (<span class="keyword">typeof</span> qs !== <span class="string">'string'</span> || qs.length === <span class="number">0</span>) {
    <span class="keyword">return</span> obj;
  }

  <span class="keyword">var</span> regexp = <span class="regexp">/\+/g</span>;
  qs = qs.split(sep);

  <span class="keyword">var</span> maxKeys = <span class="number">1000</span>;
  <span class="keyword">if</span> (options &amp;&amp; <span class="keyword">typeof</span> options.maxKeys === <span class="string">'number'</span>) {
    maxKeys = options.maxKeys;
  }

  <span class="keyword">var</span> len = qs.length;
  <span class="comment">// maxKeys &lt;= 0 means that we should not limit keys count</span>
  <span class="keyword">if</span> (maxKeys > <span class="number">0</span> &amp;&amp; len > maxKeys) {
    len = maxKeys;
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) {
    <span class="keyword">var</span> x = qs[i].replace(regexp, <span class="string">'%20'</span>),
        idx = x.indexOf(eq),
        kstr, vstr, k, v;

    <span class="keyword">if</span> (idx >= <span class="number">0</span>) {
      kstr = x.substr(<span class="number">0</span>, idx);
      vstr = x.substr(idx + <span class="number">1</span>);
    } <span class="keyword">else</span> {
      kstr = x;
      vstr = <span class="string">''</span>;
    }

    k = decodeURIComponent(kstr);
    v = decodeURIComponent(vstr);

    <span class="keyword">if</span> (!hasOwnProperty(obj, k)) {
      obj[k] = v;
    } <span class="keyword">else</span> <span class="keyword">if</span> (isArray(obj[k])) {
      obj[k].push(v);
    } <span class="keyword">else</span> {
      obj[k] = [obj[k], v];
    }
  }

  <span class="keyword">return</span> obj;
};

<span class="keyword">var</span> isArray = Array.isArray || <span class="function"><span class="keyword">function</span> <span class="params">(xs)</span> {</span>
  <span class="keyword">return</span> Object.prototype.toString.call(xs) === <span class="string">'[object Array]'</span>;
};
</code></pre>