<h1>browser.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> elliptic = require(<span class="string">'elliptic'</span>)
<span class="keyword">var</span> BN = require(<span class="string">'bn.js'</span>)

module.exports = <span class="function"><span class="keyword">function</span> <span class="title">createECDH</span> <span class="params">(curve)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> ECDH(curve)
}

<span class="keyword">var</span> aliases = {
  secp256k1: {
    name: <span class="string">'secp256k1'</span>,
    byteLength: <span class="number">32</span>
  },
  secp224r1: {
    name: <span class="string">'p224'</span>,
    byteLength: <span class="number">28</span>
  },
  prime256v1: {
    name: <span class="string">'p256'</span>,
    byteLength: <span class="number">32</span>
  },
  prime192v1: {
    name: <span class="string">'p192'</span>,
    byteLength: <span class="number">24</span>
  },
  ed25519: {
    name: <span class="string">'ed25519'</span>,
    byteLength: <span class="number">32</span>
  },
  secp384r1: {
    name: <span class="string">'p384'</span>,
    byteLength: <span class="number">48</span>
  },
  secp521r1: {
    name: <span class="string">'p521'</span>,
    byteLength: <span class="number">66</span>
  }
}

aliases.p224 = aliases.secp224r1
aliases.p256 = aliases.secp256r1 = aliases.prime256v1
aliases.p192 = aliases.secp192r1 = aliases.prime192v1
aliases.p384 = aliases.secp384r1
aliases.p521 = aliases.secp521r1

<span class="function"><span class="keyword">function</span> <span class="title">ECDH</span> <span class="params">(curve)</span> {</span>
  <span class="keyword">this</span>.curveType = aliases[curve]
  <span class="keyword">if</span> (!<span class="keyword">this</span>.curveType) {
    <span class="keyword">this</span>.curveType = {
      name: curve
    }
  }
  <span class="keyword">this</span>.curve = <span class="keyword">new</span> elliptic.ec(<span class="keyword">this</span>.curveType.name) <span class="comment">// eslint-disable-line new-cap</span>
  <span class="keyword">this</span>.keys = <span class="keyword">void</span> <span class="number">0</span>
}

ECDH.prototype.generateKeys = <span class="function"><span class="keyword">function</span> <span class="params">(enc, format)</span> {</span>
  <span class="keyword">this</span>.keys = <span class="keyword">this</span>.curve.genKeyPair()
  <span class="keyword">return</span> <span class="keyword">this</span>.getPublicKey(enc, format)
}

ECDH.prototype.computeSecret = <span class="function"><span class="keyword">function</span> <span class="params">(other, inenc, enc)</span> {</span>
  inenc = inenc || <span class="string">'utf8'</span>
  <span class="keyword">if</span> (!Buffer.isBuffer(other)) {
    other = <span class="keyword">new</span> Buffer(other, inenc)
  }
  <span class="keyword">var</span> otherPub = <span class="keyword">this</span>.curve.keyFromPublic(other).getPublic()
  <span class="keyword">var</span> out = otherPub.mul(<span class="keyword">this</span>.keys.getPrivate()).getX()
  <span class="keyword">return</span> formatReturnValue(out, enc, <span class="keyword">this</span>.curveType.byteLength)
}

ECDH.prototype.getPublicKey = <span class="function"><span class="keyword">function</span> <span class="params">(enc, format)</span> {</span>
  <span class="keyword">var</span> key = <span class="keyword">this</span>.keys.getPublic(format === <span class="string">'compressed'</span>, <span class="literal">true</span>)
  <span class="keyword">if</span> (format === <span class="string">'hybrid'</span>) {
    <span class="keyword">if</span> (key[key.length - <span class="number">1</span>] % <span class="number">2</span>) {
      key[<span class="number">0</span>] = <span class="number">7</span>
    } <span class="keyword">else</span> {
      key[<span class="number">0</span>] = <span class="number">6</span>
    }
  }
  <span class="keyword">return</span> formatReturnValue(key, enc)
}

ECDH.prototype.getPrivateKey = <span class="function"><span class="keyword">function</span> <span class="params">(enc)</span> {</span>
  <span class="keyword">return</span> formatReturnValue(<span class="keyword">this</span>.keys.getPrivate(), enc)
}

ECDH.prototype.setPublicKey = <span class="function"><span class="keyword">function</span> <span class="params">(pub, enc)</span> {</span>
  enc = enc || <span class="string">'utf8'</span>
  <span class="keyword">if</span> (!Buffer.isBuffer(pub)) {
    pub = <span class="keyword">new</span> Buffer(pub, enc)
  }
  <span class="keyword">this</span>.keys._importPublic(pub)
  <span class="keyword">return</span> <span class="keyword">this</span>
}

ECDH.prototype.setPrivateKey = <span class="function"><span class="keyword">function</span> <span class="params">(priv, enc)</span> {</span>
  enc = enc || <span class="string">'utf8'</span>
  <span class="keyword">if</span> (!Buffer.isBuffer(priv)) {
    priv = <span class="keyword">new</span> Buffer(priv, enc)
  }

  <span class="keyword">var</span> _priv = <span class="keyword">new</span> BN(priv)
  _priv = _priv.toString(<span class="number">16</span>)
  <span class="keyword">this</span>.keys = <span class="keyword">this</span>.curve.genKeyPair()
  <span class="keyword">this</span>.keys._importPrivate(_priv)
  <span class="keyword">return</span> <span class="keyword">this</span>
}

<span class="function"><span class="keyword">function</span> <span class="title">formatReturnValue</span> <span class="params">(bn, enc, len)</span> {</span>
  <span class="keyword">if</span> (!Array.isArray(bn)) {
    bn = bn.toArray()
  }
  <span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(bn)
  <span class="keyword">if</span> (len &amp;&amp; buf.length &lt; len) {
    <span class="keyword">var</span> zeros = <span class="keyword">new</span> Buffer(len - buf.length)
    zeros.fill(<span class="number">0</span>)
    buf = Buffer.concat([zeros, buf])
  }
  <span class="keyword">if</span> (!enc) {
    <span class="keyword">return</span> buf
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> buf.toString(enc)
  }
}
</code></pre>