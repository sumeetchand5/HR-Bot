<h1>BufferList.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="function"><span class="keyword">function</span> <span class="title">_classCallCheck</span><span class="params">(instance, Constructor)</span> {</span> <span class="keyword">if</span> (!(instance <span class="keyword">instanceof</span> Constructor)) { <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">"Cannot call a class as a function"</span>); } }

<span class="keyword">var</span> Buffer = require(<span class="string">'safe-buffer'</span>).Buffer;
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">copyBuffer</span><span class="params">(src, target, offset)</span> {</span>
  src.copy(target, offset);
}

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="function"><span class="keyword">function</span> <span class="title">BufferList</span><span class="params">()</span> {</span>
    _classCallCheck(<span class="keyword">this</span>, BufferList);

    <span class="keyword">this</span>.head = <span class="literal">null</span>;
    <span class="keyword">this</span>.tail = <span class="literal">null</span>;
    <span class="keyword">this</span>.length = <span class="number">0</span>;
  }

  BufferList.prototype.push = <span class="function"><span class="keyword">function</span> <span class="title">push</span><span class="params">(v)</span> {</span>
    <span class="keyword">var</span> entry = { data: v, next: <span class="literal">null</span> };
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > <span class="number">0</span>) <span class="keyword">this</span>.tail.next = entry;<span class="keyword">else</span> <span class="keyword">this</span>.head = entry;
    <span class="keyword">this</span>.tail = entry;
    ++<span class="keyword">this</span>.length;
  };

  BufferList.prototype.unshift = <span class="function"><span class="keyword">function</span> <span class="title">unshift</span><span class="params">(v)</span> {</span>
    <span class="keyword">var</span> entry = { data: v, next: <span class="keyword">this</span>.head };
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>) <span class="keyword">this</span>.tail = entry;
    <span class="keyword">this</span>.head = entry;
    ++<span class="keyword">this</span>.length;
  };

  BufferList.prototype.shift = <span class="function"><span class="keyword">function</span> <span class="title">shift</span><span class="params">()</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>) <span class="keyword">return</span>;
    <span class="keyword">var</span> ret = <span class="keyword">this</span>.head.data;
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">1</span>) <span class="keyword">this</span>.head = <span class="keyword">this</span>.tail = <span class="literal">null</span>;<span class="keyword">else</span> <span class="keyword">this</span>.head = <span class="keyword">this</span>.head.next;
    --<span class="keyword">this</span>.length;
    <span class="keyword">return</span> ret;
  };

  BufferList.prototype.clear = <span class="function"><span class="keyword">function</span> <span class="title">clear</span><span class="params">()</span> {</span>
    <span class="keyword">this</span>.head = <span class="keyword">this</span>.tail = <span class="literal">null</span>;
    <span class="keyword">this</span>.length = <span class="number">0</span>;
  };

  BufferList.prototype.join = <span class="function"><span class="keyword">function</span> <span class="title">join</span><span class="params">(s)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>) <span class="keyword">return</span> <span class="string">''</span>;
    <span class="keyword">var</span> p = <span class="keyword">this</span>.head;
    <span class="keyword">var</span> ret = <span class="string">''</span> + p.data;
    <span class="keyword">while</span> (p = p.next) {
      ret += s + p.data;
    }<span class="keyword">return</span> ret;
  };

  BufferList.prototype.concat = <span class="function"><span class="keyword">function</span> <span class="title">concat</span><span class="params">(n)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>) <span class="keyword">return</span> Buffer.alloc(<span class="number">0</span>);
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">this</span>.head.data;
    <span class="keyword">var</span> ret = Buffer.allocUnsafe(n >>> <span class="number">0</span>);
    <span class="keyword">var</span> p = <span class="keyword">this</span>.head;
    <span class="keyword">var</span> i = <span class="number">0</span>;
    <span class="keyword">while</span> (p) {
      copyBuffer(p.data, ret, i);
      i += p.data.length;
      p = p.next;
    }
    <span class="keyword">return</span> ret;
  };

  <span class="keyword">return</span> BufferList;
}();

<span class="keyword">if</span> (util &amp;&amp; util.inspect &amp;&amp; util.inspect.custom) {
  module.exports.prototype[util.inspect.custom] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> obj = util.inspect({ length: <span class="keyword">this</span>.length });
    <span class="keyword">return</span> <span class="keyword">this</span>.constructor.name + <span class="string">' '</span> + obj;
  };
}</code></pre>