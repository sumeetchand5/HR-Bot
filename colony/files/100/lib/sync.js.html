<h1>sync.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> core = require(<span class="string">'./core'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> caller = require(<span class="string">'./caller.js'</span>);
<span class="keyword">var</span> nodeModulesPaths = require(<span class="string">'./node-modules-paths.js'</span>);
<span class="keyword">var</span> normalizeOptions = require(<span class="string">'./normalize-options.js'</span>);

<span class="keyword">var</span> defaultIsFile = <span class="function"><span class="keyword">function</span> <span class="title">isFile</span><span class="params">(file)</span> {</span>
    <span class="keyword">try</span> {
        <span class="keyword">var</span> stat = fs.statSync(file);
    } <span class="keyword">catch</span> (e) {
        <span class="keyword">if</span> (e &amp;&amp; (e.code === <span class="string">'ENOENT'</span> || e.code === <span class="string">'ENOTDIR'</span>)) <span class="keyword">return</span> <span class="literal">false</span>;
        <span class="keyword">throw</span> e;
    }
    <span class="keyword">return</span> stat.isFile() || stat.isFIFO();
};

<span class="keyword">var</span> defaultIsDir = <span class="function"><span class="keyword">function</span> <span class="title">isDirectory</span><span class="params">(dir)</span> {</span>
    <span class="keyword">try</span> {
        <span class="keyword">var</span> stat = fs.statSync(dir);
    } <span class="keyword">catch</span> (e) {
        <span class="keyword">if</span> (e &amp;&amp; (e.code === <span class="string">'ENOENT'</span> || e.code === <span class="string">'ENOTDIR'</span>)) <span class="keyword">return</span> <span class="literal">false</span>;
        <span class="keyword">throw</span> e;
    }
    <span class="keyword">return</span> stat.isDirectory();
};

<span class="keyword">var</span> maybeUnwrapSymlink = <span class="function"><span class="keyword">function</span> <span class="title">maybeUnwrapSymlink</span><span class="params">(x, opts)</span> {</span>
    <span class="keyword">if</span> (opts &amp;&amp; opts.preserveSymlinks === <span class="literal">false</span>) {
        <span class="keyword">try</span> {
            <span class="keyword">return</span> fs.realpathSync(x);
        } <span class="keyword">catch</span> (realPathErr) {
            <span class="keyword">if</span> (realPathErr.code !== <span class="string">'ENOENT'</span>) {
                <span class="keyword">throw</span> realPathErr;
            }
        }
    }
    <span class="keyword">return</span> x;
};

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(x, options)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> x !== <span class="string">'string'</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Path must be a string.'</span>);
    }
    <span class="keyword">var</span> opts = normalizeOptions(x, options);

    <span class="keyword">var</span> isFile = opts.isFile || defaultIsFile;
    <span class="keyword">var</span> readFileSync = opts.readFileSync || fs.readFileSync;
    <span class="keyword">var</span> isDirectory = opts.isDirectory || defaultIsDir;

    <span class="keyword">var</span> extensions = opts.extensions || [<span class="string">'.js'</span>];
    <span class="keyword">var</span> basedir = opts.basedir || path.dirname(caller());
    <span class="keyword">var</span> parent = opts.filename || basedir;

    opts.paths = opts.paths || [];

    <span class="comment">// ensure that `basedir` is an absolute path at this point, resolving against the process' current working directory</span>
    <span class="keyword">var</span> absoluteStart = maybeUnwrapSymlink(path.resolve(basedir), opts);

    <span class="keyword">if</span> ((<span class="regexp">/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[/</span>\\])/).test(x)) {
        <span class="keyword">var</span> res = path.resolve(absoluteStart, x);
        <span class="keyword">if</span> (x === <span class="string">'..'</span> || x.slice(-<span class="number">1</span>) === <span class="string">'/'</span>) res += <span class="string">'/'</span>;
        <span class="keyword">var</span> m = loadAsFileSync(res) || loadAsDirectorySync(res);
        <span class="keyword">if</span> (m) <span class="keyword">return</span> maybeUnwrapSymlink(m, opts);
    } <span class="keyword">else</span> <span class="keyword">if</span> (core[x]) {
        <span class="keyword">return</span> x;
    } <span class="keyword">else</span> {
        <span class="keyword">var</span> n = loadNodeModulesSync(x, absoluteStart);
        <span class="keyword">if</span> (n) <span class="keyword">return</span> maybeUnwrapSymlink(n, opts);
    }

    <span class="keyword">if</span> (core[x]) <span class="keyword">return</span> x;

    <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">"Cannot find module '"</span> + x + <span class="string">"' from '"</span> + parent + <span class="string">"'"</span>);
    err.code = <span class="string">'MODULE_NOT_FOUND'</span>;
    <span class="keyword">throw</span> err;

    <span class="function"><span class="keyword">function</span> <span class="title">loadAsFileSync</span><span class="params">(x)</span> {</span>
        <span class="keyword">var</span> pkg = loadpkg(path.dirname(x));

        <span class="keyword">if</span> (pkg &amp;&amp; pkg.dir &amp;&amp; pkg.pkg &amp;&amp; opts.pathFilter) {
            <span class="keyword">var</span> rfile = path.relative(pkg.dir, x);
            <span class="keyword">var</span> r = opts.pathFilter(pkg.pkg, x, rfile);
            <span class="keyword">if</span> (r) {
                x = path.resolve(pkg.dir, r); <span class="comment">// eslint-disable-line no-param-reassign</span>
            }
        }

        <span class="keyword">if</span> (isFile(x)) {
            <span class="keyword">return</span> x;
        }

        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; extensions.length; i++) {
            <span class="keyword">var</span> file = x + extensions[i];
            <span class="keyword">if</span> (isFile(file)) {
                <span class="keyword">return</span> file;
            }
        }
    }

    <span class="function"><span class="keyword">function</span> <span class="title">loadpkg</span><span class="params">(dir)</span> {</span>
        <span class="keyword">if</span> (dir === <span class="string">''</span> || dir === <span class="string">'/'</span>) <span class="keyword">return</span>;
        <span class="keyword">if</span> (process.platform === <span class="string">'win32'</span> &amp;&amp; (<span class="regexp">/^\w:[/</span>\\]*$/).test(dir)) {
            <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> ((<span class="regexp">/[/</span>\\]node_modules[<span class="regexp">/\\]*$/</span>).test(dir)) <span class="keyword">return</span>;

        <span class="keyword">var</span> pkgfile = path.join(dir, <span class="string">'package.json'</span>);

        <span class="keyword">if</span> (!isFile(pkgfile)) {
            <span class="keyword">return</span> loadpkg(path.dirname(dir));
        }

        <span class="keyword">var</span> body = readFileSync(pkgfile);

        <span class="keyword">try</span> {
            <span class="keyword">var</span> pkg = JSON.parse(body);
        } <span class="keyword">catch</span> (jsonErr) {}

        <span class="keyword">if</span> (pkg &amp;&amp; opts.packageFilter) {
            pkg = opts.packageFilter(pkg, dir);
        }

        <span class="keyword">return</span> { pkg: pkg, dir: dir };
    }

    <span class="function"><span class="keyword">function</span> <span class="title">loadAsDirectorySync</span><span class="params">(x)</span> {</span>
        <span class="keyword">var</span> pkgfile = path.join(x, <span class="string">'/package.json'</span>);
        <span class="keyword">if</span> (isFile(pkgfile)) {
            <span class="keyword">try</span> {
                <span class="keyword">var</span> body = readFileSync(pkgfile, <span class="string">'UTF8'</span>);
                <span class="keyword">var</span> pkg = JSON.parse(body);
            } <span class="keyword">catch</span> (e) {}

            <span class="keyword">if</span> (opts.packageFilter) {
                pkg = opts.packageFilter(pkg, x);
            }

            <span class="keyword">if</span> (pkg.main) {
                <span class="keyword">if</span> (<span class="keyword">typeof</span> pkg.main !== <span class="string">'string'</span>) {
                    <span class="keyword">var</span> mainError = <span class="keyword">new</span> TypeError(<span class="string">'package “'</span> + pkg.name + <span class="string">'” `main` must be a string'</span>);
                    mainError.code = <span class="string">'INVALID_PACKAGE_MAIN'</span>;
                    <span class="keyword">throw</span> mainError;
                }
                <span class="keyword">if</span> (pkg.main === <span class="string">'.'</span> || pkg.main === <span class="string">'./'</span>) {
                    pkg.main = <span class="string">'index'</span>;
                }
                <span class="keyword">try</span> {
                    <span class="keyword">var</span> m = loadAsFileSync(path.resolve(x, pkg.main));
                    <span class="keyword">if</span> (m) <span class="keyword">return</span> m;
                    <span class="keyword">var</span> n = loadAsDirectorySync(path.resolve(x, pkg.main));
                    <span class="keyword">if</span> (n) <span class="keyword">return</span> n;
                } <span class="keyword">catch</span> (e) {}
            }
        }

        <span class="keyword">return</span> loadAsFileSync(path.join(x, <span class="string">'/index'</span>));
    }

    <span class="function"><span class="keyword">function</span> <span class="title">loadNodeModulesSync</span><span class="params">(x, start)</span> {</span>
        <span class="keyword">var</span> dirs = nodeModulesPaths(start, opts, x);
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; dirs.length; i++) {
            <span class="keyword">var</span> dir = dirs[i];
            <span class="keyword">if</span> (isDirectory(dir)) {
                <span class="keyword">var</span> m = loadAsFileSync(path.join(dir, <span class="string">'/'</span>, x));
                <span class="keyword">if</span> (m) <span class="keyword">return</span> m;
                <span class="keyword">var</span> n = loadAsDirectorySync(path.join(dir, <span class="string">'/'</span>, x));
                <span class="keyword">if</span> (n) <span class="keyword">return</span> n;
            }
        }
    }
};
</code></pre>