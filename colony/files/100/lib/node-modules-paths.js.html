<h1>node-modules-paths.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> parse = path.parse || require(<span class="string">'path-parse'</span>);

<span class="keyword">var</span> getNodeModulesDirs = <span class="function"><span class="keyword">function</span> <span class="title">getNodeModulesDirs</span><span class="params">(absoluteStart, modules)</span> {</span>
    <span class="keyword">var</span> prefix = <span class="string">'/'</span>;
    <span class="keyword">if</span> ((<span class="regexp">/^([A-Za-z]:)/</span>).test(absoluteStart)) {
        prefix = <span class="string">''</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="regexp">/^\\\\/).test(absoluteStart)) {
        prefix = '\\\\';
    }

    var paths = [absoluteStart];
    var parsed = parse(absoluteStart);
    while (parsed.dir !== paths[paths.length - 1]) {
        paths.push(parsed.dir);
        parsed = parse(parsed.dir);
    }

    return paths.reduce(function (dirs, aPath) {
        return dirs.concat(modules.map(function (moduleDir) {
            return path.resolve(prefix, aPath, moduleDir);
        }));
    }, []);
};

module.exports = function nodeModulesPaths(start, opts, request) {
    var modules = opts &amp;&amp; opts.moduleDirectory
        ? [].concat(opts.moduleDirectory)
        : ['node_modules'];

    if (opts &amp;&amp; typeof opts.paths === 'function') {
        return opts.paths(
            request,
            start,
            function () { return getNodeModulesDirs(start, modules); },
            opts
        );
    }

    var dirs = getNodeModulesDirs(start, modules);
    return opts &amp;&amp; opts.paths ? dirs.concat(opts.paths) : dirs;
};
</code></pre>