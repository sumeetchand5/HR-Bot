<h1>cbc.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> assert = require(<span class="string">'minimalistic-assert'</span>);
<span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);

<span class="keyword">var</span> proto = {};

<span class="function"><span class="keyword">function</span> <span class="title">CBCState</span><span class="params">(iv)</span> {</span>
  assert.equal(iv.length, <span class="number">8</span>, <span class="string">'Invalid IV length'</span>);

  <span class="keyword">this</span>.iv = <span class="keyword">new</span> Array(<span class="number">8</span>);
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iv.length; i++)
    <span class="keyword">this</span>.iv[i] = iv[i];
}

<span class="function"><span class="keyword">function</span> <span class="title">instantiate</span><span class="params">(Base)</span> {</span>
  <span class="function"><span class="keyword">function</span> <span class="title">CBC</span><span class="params">(options)</span> {</span>
    Base.call(<span class="keyword">this</span>, options);
    <span class="keyword">this</span>._cbcInit();
  }
  inherits(CBC, Base);

  <span class="keyword">var</span> keys = Object.keys(proto);
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) {
    <span class="keyword">var</span> key = keys[i];
    CBC.prototype[key] = proto[key];
  }

  CBC.create = <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(options)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> CBC(options);
  };

  <span class="keyword">return</span> CBC;
}

exports.instantiate = instantiate;

proto._cbcInit = <span class="function"><span class="keyword">function</span> <span class="title">_cbcInit</span><span class="params">()</span> {</span>
  <span class="keyword">var</span> state = <span class="keyword">new</span> CBCState(<span class="keyword">this</span>.options.iv);
  <span class="keyword">this</span>._cbcState = state;
};

proto._update = <span class="function"><span class="keyword">function</span> <span class="title">_update</span><span class="params">(inp, inOff, out, outOff)</span> {</span>
  <span class="keyword">var</span> state = <span class="keyword">this</span>._cbcState;
  <span class="keyword">var</span> superProto = <span class="keyword">this</span>.constructor.super_.prototype;

  <span class="keyword">var</span> iv = state.iv;
  <span class="keyword">if</span> (<span class="keyword">this</span>.type === <span class="string">'encrypt'</span>) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.blockSize; i++)
      iv[i] ^= inp[inOff + i];

    superProto._update.call(<span class="keyword">this</span>, iv, <span class="number">0</span>, out, outOff);

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.blockSize; i++)
      iv[i] = out[outOff + i];
  } <span class="keyword">else</span> {
    superProto._update.call(<span class="keyword">this</span>, inp, inOff, out, outOff);

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.blockSize; i++)
      out[outOff + i] ^= iv[i];

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.blockSize; i++)
      iv[i] = inp[inOff + i];
  }
};
</code></pre>