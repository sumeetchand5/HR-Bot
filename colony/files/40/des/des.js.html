<h1>des.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> assert = require(<span class="string">'minimalistic-assert'</span>);
<span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);

<span class="keyword">var</span> des = require(<span class="string">'../des'</span>);
<span class="keyword">var</span> utils = des.utils;
<span class="keyword">var</span> Cipher = des.Cipher;

<span class="function"><span class="keyword">function</span> <span class="title">DESState</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.tmp = <span class="keyword">new</span> Array(<span class="number">2</span>);
  <span class="keyword">this</span>.keys = <span class="literal">null</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">DES</span><span class="params">(options)</span> {</span>
  Cipher.call(<span class="keyword">this</span>, options);

  <span class="keyword">var</span> state = <span class="keyword">new</span> DESState();
  <span class="keyword">this</span>._desState = state;

  <span class="keyword">this</span>.deriveKeys(state, options.key);
}
inherits(DES, Cipher);
module.exports = DES;

DES.create = <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(options)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> DES(options);
};

<span class="keyword">var</span> shiftTable = [
  <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>,
  <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>
];

DES.prototype.deriveKeys = <span class="function"><span class="keyword">function</span> <span class="title">deriveKeys</span><span class="params">(state, key)</span> {</span>
  state.keys = <span class="keyword">new</span> Array(<span class="number">16</span> * <span class="number">2</span>);

  assert.equal(key.length, <span class="keyword">this</span>.blockSize, <span class="string">'Invalid key length'</span>);

  <span class="keyword">var</span> kL = utils.readUInt32BE(key, <span class="number">0</span>);
  <span class="keyword">var</span> kR = utils.readUInt32BE(key, <span class="number">4</span>);

  utils.pc1(kL, kR, state.tmp, <span class="number">0</span>);
  kL = state.tmp[<span class="number">0</span>];
  kR = state.tmp[<span class="number">1</span>];
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; state.keys.length; i += <span class="number">2</span>) {
    <span class="keyword">var</span> shift = shiftTable[i >>> <span class="number">1</span>];
    kL = utils.r28shl(kL, shift);
    kR = utils.r28shl(kR, shift);
    utils.pc2(kL, kR, state.keys, i);
  }
};

DES.prototype._update = <span class="function"><span class="keyword">function</span> <span class="title">_update</span><span class="params">(inp, inOff, out, outOff)</span> {</span>
  <span class="keyword">var</span> state = <span class="keyword">this</span>._desState;

  <span class="keyword">var</span> l = utils.readUInt32BE(inp, inOff);
  <span class="keyword">var</span> r = utils.readUInt32BE(inp, inOff + <span class="number">4</span>);

  <span class="comment">// Initial Permutation</span>
  utils.ip(l, r, state.tmp, <span class="number">0</span>);
  l = state.tmp[<span class="number">0</span>];
  r = state.tmp[<span class="number">1</span>];

  <span class="keyword">if</span> (<span class="keyword">this</span>.type === <span class="string">'encrypt'</span>)
    <span class="keyword">this</span>._encrypt(state, l, r, state.tmp, <span class="number">0</span>);
  <span class="keyword">else</span>
    <span class="keyword">this</span>._decrypt(state, l, r, state.tmp, <span class="number">0</span>);

  l = state.tmp[<span class="number">0</span>];
  r = state.tmp[<span class="number">1</span>];

  utils.writeUInt32BE(out, l, outOff);
  utils.writeUInt32BE(out, r, outOff + <span class="number">4</span>);
};

DES.prototype._pad = <span class="function"><span class="keyword">function</span> <span class="title">_pad</span><span class="params">(buffer, off)</span> {</span>
  <span class="keyword">var</span> value = buffer.length - off;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = off; i &lt; buffer.length; i++)
    buffer[i] = value;

  <span class="keyword">return</span> <span class="literal">true</span>;
};

DES.prototype._unpad = <span class="function"><span class="keyword">function</span> <span class="title">_unpad</span><span class="params">(buffer)</span> {</span>
  <span class="keyword">var</span> pad = buffer[buffer.length - <span class="number">1</span>];
  <span class="keyword">for</span> (<span class="keyword">var</span> i = buffer.length - pad; i &lt; buffer.length; i++)
    assert.equal(buffer[i], pad);

  <span class="keyword">return</span> buffer.slice(<span class="number">0</span>, buffer.length - pad);
};

DES.prototype._encrypt = <span class="function"><span class="keyword">function</span> <span class="title">_encrypt</span><span class="params">(state, lStart, rStart, out, off)</span> {</span>
  <span class="keyword">var</span> l = lStart;
  <span class="keyword">var</span> r = rStart;

  <span class="comment">// Apply f() x16 times</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; state.keys.length; i += <span class="number">2</span>) {
    <span class="keyword">var</span> keyL = state.keys[i];
    <span class="keyword">var</span> keyR = state.keys[i + <span class="number">1</span>];

    <span class="comment">// f(r, k)</span>
    utils.expand(r, state.tmp, <span class="number">0</span>);

    keyL ^= state.tmp[<span class="number">0</span>];
    keyR ^= state.tmp[<span class="number">1</span>];
    <span class="keyword">var</span> s = utils.substitute(keyL, keyR);
    <span class="keyword">var</span> f = utils.permute(s);

    <span class="keyword">var</span> t = r;
    r = (l ^ f) >>> <span class="number">0</span>;
    l = t;
  }

  <span class="comment">// Reverse Initial Permutation</span>
  utils.rip(r, l, out, off);
};

DES.prototype._decrypt = <span class="function"><span class="keyword">function</span> <span class="title">_decrypt</span><span class="params">(state, lStart, rStart, out, off)</span> {</span>
  <span class="keyword">var</span> l = rStart;
  <span class="keyword">var</span> r = lStart;

  <span class="comment">// Apply f() x16 times</span>
  <span class="keyword">for</span> (<span class="keyword">var</span> i = state.keys.length - <span class="number">2</span>; i >= <span class="number">0</span>; i -= <span class="number">2</span>) {
    <span class="keyword">var</span> keyL = state.keys[i];
    <span class="keyword">var</span> keyR = state.keys[i + <span class="number">1</span>];

    <span class="comment">// f(r, k)</span>
    utils.expand(l, state.tmp, <span class="number">0</span>);

    keyL ^= state.tmp[<span class="number">0</span>];
    keyR ^= state.tmp[<span class="number">1</span>];
    <span class="keyword">var</span> s = utils.substitute(keyL, keyR);
    <span class="keyword">var</span> f = utils.permute(s);

    <span class="keyword">var</span> t = l;
    l = (r ^ f) >>> <span class="number">0</span>;
    r = t;
  }

  <span class="comment">// Reverse Initial Permutation</span>
  utils.rip(l, r, out, off);
};
</code></pre>