<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> r;

module.exports = <span class="function"><span class="keyword">function</span> <span class="title">rand</span><span class="params">(len)</span> {</span>
  <span class="keyword">if</span> (!r)
    r = <span class="keyword">new</span> Rand(<span class="literal">null</span>);

  <span class="keyword">return</span> r.generate(len);
};

<span class="function"><span class="keyword">function</span> <span class="title">Rand</span><span class="params">(rand)</span> {</span>
  <span class="keyword">this</span>.rand = rand;
}
module.exports.Rand = Rand;

Rand.prototype.generate = <span class="function"><span class="keyword">function</span> <span class="title">generate</span><span class="params">(len)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>._rand(len);
};

<span class="comment">// Emulate crypto API using randy</span>
Rand.prototype._rand = <span class="function"><span class="keyword">function</span> <span class="title">_rand</span><span class="params">(n)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.rand.getBytes)
    <span class="keyword">return</span> <span class="keyword">this</span>.rand.getBytes(n);

  <span class="keyword">var</span> res = <span class="keyword">new</span> Uint8Array(n);
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; res.length; i++)
    res[i] = <span class="keyword">this</span>.rand.getByte();
  <span class="keyword">return</span> res;
};

<span class="keyword">if</span> (<span class="keyword">typeof</span> self === <span class="string">'object'</span>) {
  <span class="keyword">if</span> (self.crypto &amp;&amp; self.crypto.getRandomValues) {
    <span class="comment">// Modern browsers</span>
    Rand.prototype._rand = <span class="function"><span class="keyword">function</span> <span class="title">_rand</span><span class="params">(n)</span> {</span>
      <span class="keyword">var</span> arr = <span class="keyword">new</span> Uint8Array(n);
      self.crypto.getRandomValues(arr);
      <span class="keyword">return</span> arr;
    };
  } <span class="keyword">else</span> <span class="keyword">if</span> (self.msCrypto &amp;&amp; self.msCrypto.getRandomValues) {
    <span class="comment">// IE</span>
    Rand.prototype._rand = <span class="function"><span class="keyword">function</span> <span class="title">_rand</span><span class="params">(n)</span> {</span>
      <span class="keyword">var</span> arr = <span class="keyword">new</span> Uint8Array(n);
      self.msCrypto.getRandomValues(arr);
      <span class="keyword">return</span> arr;
    };

  <span class="comment">// Safari's WebWorkers do not have `crypto`</span>
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> window === <span class="string">'object'</span>) {
    <span class="comment">// Old junk</span>
    Rand.prototype._rand = <span class="keyword">function</span>() {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Not implemented yet'</span>);
    };
  }
} <span class="keyword">else</span> {
  <span class="comment">// Node.js or Web worker with no crypto support</span>
  <span class="keyword">try</span> {
    <span class="keyword">var</span> crypto = require(<span class="string">'crypto'</span>);
    <span class="keyword">if</span> (<span class="keyword">typeof</span> crypto.randomBytes !== <span class="string">'function'</span>)
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Not supported'</span>);

    Rand.prototype._rand = <span class="function"><span class="keyword">function</span> <span class="title">_rand</span><span class="params">(n)</span> {</span>
      <span class="keyword">return</span> crypto.randomBytes(n);
    };
  } <span class="keyword">catch</span> (e) {
  }
}
</code></pre>