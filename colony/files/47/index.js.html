<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> Buffer = require(<span class="string">'safe-buffer'</span>).Buffer
<span class="keyword">var</span> MD5 = require(<span class="string">'md5.js'</span>)

<span class="comment">/* eslint-disable camelcase */</span>
<span class="function"><span class="keyword">function</span> <span class="title">EVP_BytesToKey</span> <span class="params">(password, salt, keyBits, ivLen)</span> {</span>
  <span class="keyword">if</span> (!Buffer.isBuffer(password)) password = Buffer.from(password, <span class="string">'binary'</span>)
  <span class="keyword">if</span> (salt) {
    <span class="keyword">if</span> (!Buffer.isBuffer(salt)) salt = Buffer.from(salt, <span class="string">'binary'</span>)
    <span class="keyword">if</span> (salt.length !== <span class="number">8</span>) <span class="keyword">throw</span> <span class="keyword">new</span> RangeError(<span class="string">'salt should be Buffer with 8 byte length'</span>)
  }

  <span class="keyword">var</span> keyLen = keyBits / <span class="number">8</span>
  <span class="keyword">var</span> key = Buffer.alloc(keyLen)
  <span class="keyword">var</span> iv = Buffer.alloc(ivLen || <span class="number">0</span>)
  <span class="keyword">var</span> tmp = Buffer.alloc(<span class="number">0</span>)

  <span class="keyword">while</span> (keyLen > <span class="number">0</span> || ivLen > <span class="number">0</span>) {
    <span class="keyword">var</span> hash = <span class="keyword">new</span> MD5()
    hash.update(tmp)
    hash.update(password)
    <span class="keyword">if</span> (salt) hash.update(salt)
    tmp = hash.digest()

    <span class="keyword">var</span> used = <span class="number">0</span>

    <span class="keyword">if</span> (keyLen > <span class="number">0</span>) {
      <span class="keyword">var</span> keyStart = key.length - keyLen
      used = Math.min(keyLen, tmp.length)
      tmp.copy(key, keyStart, <span class="number">0</span>, used)
      keyLen -= used
    }

    <span class="keyword">if</span> (used &lt; tmp.length &amp;&amp; ivLen > <span class="number">0</span>) {
      <span class="keyword">var</span> ivStart = iv.length - ivLen
      <span class="keyword">var</span> length = Math.min(ivLen, tmp.length - used)
      tmp.copy(iv, ivStart, used, used + length)
      ivLen -= length
    }
  }

  tmp.fill(<span class="number">0</span>)
  <span class="keyword">return</span> { key: key, iv: iv }
}

module.exports = EVP_BytesToKey
</code></pre>