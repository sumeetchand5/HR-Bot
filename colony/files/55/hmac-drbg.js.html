<h1>hmac-drbg.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> hash = require(<span class="string">'hash.js'</span>);
<span class="keyword">var</span> utils = require(<span class="string">'minimalistic-crypto-utils'</span>);
<span class="keyword">var</span> assert = require(<span class="string">'minimalistic-assert'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">HmacDRBG</span><span class="params">(options)</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> HmacDRBG))
    <span class="keyword">return</span> <span class="keyword">new</span> HmacDRBG(options);
  <span class="keyword">this</span>.hash = options.hash;
  <span class="keyword">this</span>.predResist = !!options.predResist;

  <span class="keyword">this</span>.outLen = <span class="keyword">this</span>.hash.outSize;
  <span class="keyword">this</span>.minEntropy = options.minEntropy || <span class="keyword">this</span>.hash.hmacStrength;

  <span class="keyword">this</span>._reseed = <span class="literal">null</span>;
  <span class="keyword">this</span>.reseedInterval = <span class="literal">null</span>;
  <span class="keyword">this</span>.K = <span class="literal">null</span>;
  <span class="keyword">this</span>.V = <span class="literal">null</span>;

  <span class="keyword">var</span> entropy = utils.toArray(options.entropy, options.entropyEnc || <span class="string">'hex'</span>);
  <span class="keyword">var</span> nonce = utils.toArray(options.nonce, options.nonceEnc || <span class="string">'hex'</span>);
  <span class="keyword">var</span> pers = utils.toArray(options.pers, options.persEnc || <span class="string">'hex'</span>);
  assert(entropy.length >= (<span class="keyword">this</span>.minEntropy / <span class="number">8</span>),
         <span class="string">'Not enough entropy. Minimum is: '</span> + <span class="keyword">this</span>.minEntropy + <span class="string">' bits'</span>);
  <span class="keyword">this</span>._init(entropy, nonce, pers);
}
module.exports = HmacDRBG;

HmacDRBG.prototype._init = <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(entropy, nonce, pers)</span> {</span>
  <span class="keyword">var</span> seed = entropy.concat(nonce).concat(pers);

  <span class="keyword">this</span>.K = <span class="keyword">new</span> Array(<span class="keyword">this</span>.outLen / <span class="number">8</span>);
  <span class="keyword">this</span>.V = <span class="keyword">new</span> Array(<span class="keyword">this</span>.outLen / <span class="number">8</span>);
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.V.length; i++) {
    <span class="keyword">this</span>.K[i] = <span class="number">0x00</span>;
    <span class="keyword">this</span>.V[i] = <span class="number">0x01</span>;
  }

  <span class="keyword">this</span>._update(seed);
  <span class="keyword">this</span>._reseed = <span class="number">1</span>;
  <span class="keyword">this</span>.reseedInterval = <span class="number">0x1000000000000</span>;  <span class="comment">// 2^48</span>
};

HmacDRBG.prototype._hmac = <span class="function"><span class="keyword">function</span> <span class="title">hmac</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> hash.hmac(<span class="keyword">this</span>.hash, <span class="keyword">this</span>.K);
};

HmacDRBG.prototype._update = <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(seed)</span> {</span>
  <span class="keyword">var</span> kmac = <span class="keyword">this</span>._hmac()
                 .update(<span class="keyword">this</span>.V)
                 .update([ <span class="number">0x00</span> ]);
  <span class="keyword">if</span> (seed)
    kmac = kmac.update(seed);
  <span class="keyword">this</span>.K = kmac.digest();
  <span class="keyword">this</span>.V = <span class="keyword">this</span>._hmac().update(<span class="keyword">this</span>.V).digest();
  <span class="keyword">if</span> (!seed)
    <span class="keyword">return</span>;

  <span class="keyword">this</span>.K = <span class="keyword">this</span>._hmac()
               .update(<span class="keyword">this</span>.V)
               .update([ <span class="number">0x01</span> ])
               .update(seed)
               .digest();
  <span class="keyword">this</span>.V = <span class="keyword">this</span>._hmac().update(<span class="keyword">this</span>.V).digest();
};

HmacDRBG.prototype.reseed = <span class="function"><span class="keyword">function</span> <span class="title">reseed</span><span class="params">(entropy, entropyEnc, add, addEnc)</span> {</span>
  <span class="comment">// Optional entropy enc</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> entropyEnc !== <span class="string">'string'</span>) {
    addEnc = add;
    add = entropyEnc;
    entropyEnc = <span class="literal">null</span>;
  }

  entropy = utils.toArray(entropy, entropyEnc);
  add = utils.toArray(add, addEnc);

  assert(entropy.length >= (<span class="keyword">this</span>.minEntropy / <span class="number">8</span>),
         <span class="string">'Not enough entropy. Minimum is: '</span> + <span class="keyword">this</span>.minEntropy + <span class="string">' bits'</span>);

  <span class="keyword">this</span>._update(entropy.concat(add || []));
  <span class="keyword">this</span>._reseed = <span class="number">1</span>;
};

HmacDRBG.prototype.generate = <span class="function"><span class="keyword">function</span> <span class="title">generate</span><span class="params">(len, enc, add, addEnc)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._reseed > <span class="keyword">this</span>.reseedInterval)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Reseed is required'</span>);

  <span class="comment">// Optional encoding</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> enc !== <span class="string">'string'</span>) {
    addEnc = add;
    add = enc;
    enc = <span class="literal">null</span>;
  }

  <span class="comment">// Optional additional data</span>
  <span class="keyword">if</span> (add) {
    add = utils.toArray(add, addEnc || <span class="string">'hex'</span>);
    <span class="keyword">this</span>._update(add);
  }

  <span class="keyword">var</span> temp = [];
  <span class="keyword">while</span> (temp.length &lt; len) {
    <span class="keyword">this</span>.V = <span class="keyword">this</span>._hmac().update(<span class="keyword">this</span>.V).digest();
    temp = temp.concat(<span class="keyword">this</span>.V);
  }

  <span class="keyword">var</span> res = temp.slice(<span class="number">0</span>, len);
  <span class="keyword">this</span>._update(add);
  <span class="keyword">this</span>._reseed++;
  <span class="keyword">return</span> utils.encode(res, enc);
};
</code></pre>