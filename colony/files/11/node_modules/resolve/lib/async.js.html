<h1>async.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> core = require(<span class="string">'./core'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> caller = require(<span class="string">'./caller.js'</span>);
<span class="keyword">var</span> nodeModulesPaths = require(<span class="string">'./node-modules-paths.js'</span>);
<span class="keyword">var</span> splitRe = process.platform === <span class="string">'win32'</span> ? <span class="regexp">/[\/\\]/</span> : <span class="regexp">/\//</span>;

module.exports = <span class="function"><span class="keyword">function</span> <span class="title">resolve</span> <span class="params">(x, opts, cb)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts === <span class="string">'function'</span>) {
        cb = opts;
        opts = {};
    }
    <span class="keyword">if</span> (!opts) opts = {};
    <span class="keyword">if</span> (<span class="keyword">typeof</span> x !== <span class="string">'string'</span>) {
        <span class="keyword">return</span> process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            cb(<span class="keyword">new</span> Error(<span class="string">'path must be a string'</span>));
        });
    }
    
    <span class="keyword">var</span> isFile = opts.isFile || <span class="function"><span class="keyword">function</span> <span class="params">(file, cb)</span> {</span>
        fs.stat(file, <span class="function"><span class="keyword">function</span> <span class="params">(err, stat)</span> {</span>
            <span class="keyword">if</span> (err &amp;&amp; err.code === <span class="string">'ENOENT'</span>) cb(<span class="literal">null</span>, <span class="literal">false</span>)
            <span class="keyword">else</span> <span class="keyword">if</span> (err) cb(err)
            <span class="keyword">else</span> cb(<span class="literal">null</span>, stat.isFile() || stat.isFIFO())
        });
    };
    <span class="keyword">var</span> readFile = opts.readFile || fs.readFile;
    
    <span class="keyword">var</span> extensions = opts.extensions || [ <span class="string">'.js'</span> ];
    <span class="keyword">var</span> y = opts.basedir || path.dirname(caller());
    
    opts.paths = opts.paths || [];
    
    <span class="keyword">if</span> (<span class="regexp">/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[\\\/])/</span>.test(x)) {
        <span class="keyword">var</span> res = path.resolve(y, x);
        <span class="keyword">if</span> (x === <span class="string">'..'</span>) res += <span class="string">'/'</span>;
        <span class="keyword">if</span> (<span class="regexp">/\/$/</span>.test(x) &amp;&amp; res === y) {
            loadAsDirectory(res, opts.package, onfile);
        }
        <span class="keyword">else</span> loadAsFile(res, opts.package, onfile);
    }
    <span class="keyword">else</span> loadNodeModules(x, y, <span class="function"><span class="keyword">function</span> <span class="params">(err, n, pkg)</span> {</span>
        <span class="keyword">if</span> (err) cb(err)
        <span class="keyword">else</span> <span class="keyword">if</span> (n) cb(<span class="literal">null</span>, n, pkg)
        <span class="keyword">else</span> <span class="keyword">if</span> (core[x]) <span class="keyword">return</span> cb(<span class="literal">null</span>, x);
        <span class="keyword">else</span> cb(<span class="keyword">new</span> Error(<span class="string">"Cannot find module '"</span> + x + <span class="string">"' from '"</span> + y + <span class="string">"'"</span>))
    });
    
    <span class="function"><span class="keyword">function</span> <span class="title">onfile</span> <span class="params">(err, m, pkg)</span> {</span>
        <span class="keyword">if</span> (err) cb(err)
        <span class="keyword">else</span> <span class="keyword">if</span> (m) cb(<span class="literal">null</span>, m, pkg)
        <span class="keyword">else</span> loadAsDirectory(res, <span class="function"><span class="keyword">function</span> <span class="params">(err, d, pkg)</span> {</span>
            <span class="keyword">if</span> (err) cb(err)
            <span class="keyword">else</span> <span class="keyword">if</span> (d) cb(<span class="literal">null</span>, d, pkg)
            <span class="keyword">else</span> cb(<span class="keyword">new</span> Error(<span class="string">"Cannot find module '"</span> + x + <span class="string">"' from '"</span> + y + <span class="string">"'"</span>))
        })
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadAsFile</span> <span class="params">(x, pkg, cb)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> pkg === <span class="string">'function'</span>) {
            cb = pkg;
            pkg = <span class="literal">undefined</span>;
        }
        
        <span class="keyword">var</span> exts = [<span class="string">''</span>].concat(extensions);
        load(exts, x, pkg)
		
		<span class="function"><span class="keyword">function</span> <span class="title">load</span> <span class="params">(exts, x, pkg)</span> {</span>
            <span class="keyword">if</span> (exts.length === <span class="number">0</span>) <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">undefined</span>, pkg);
            <span class="keyword">var</span> file = x + exts[<span class="number">0</span>];
            
            <span class="keyword">if</span> (pkg) onpkg(<span class="literal">null</span>, pkg)
            <span class="keyword">else</span> loadpkg(path.dirname(file), onpkg);
            
            <span class="function"><span class="keyword">function</span> <span class="title">onpkg</span> <span class="params">(err, pkg_, dir)</span> {</span>
                pkg = pkg_;
                <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err)
                <span class="keyword">if</span> (dir &amp;&amp; pkg &amp;&amp; opts.pathFilter) {
                    <span class="keyword">var</span> rfile = path.relative(dir, file);
                    <span class="keyword">var</span> rel = rfile.slice(<span class="number">0</span>, rfile.length - exts[<span class="number">0</span>].length);
                    <span class="keyword">var</span> r = opts.pathFilter(pkg, x, rel);
                    <span class="keyword">if</span> (r) <span class="keyword">return</span> load(
                        [<span class="string">''</span>].concat(extensions.slice()),
                        path.resolve(dir, r),
                        pkg
                    );
                }
                isFile(file, onex);
            }
            <span class="function"><span class="keyword">function</span> <span class="title">onex</span> <span class="params">(err, ex)</span> {</span>
                <span class="keyword">if</span> (err) cb(err)
                <span class="keyword">else</span> <span class="keyword">if</span> (!ex) load(exts.slice(<span class="number">1</span>), x, pkg)
                <span class="keyword">else</span> cb(<span class="literal">null</span>, file, pkg)
            }
        }
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadpkg</span> <span class="params">(dir, cb)</span> {</span>
        <span class="keyword">if</span> (dir === <span class="string">''</span> || dir === <span class="string">'/'</span>) <span class="keyword">return</span> cb(<span class="literal">null</span>);
        <span class="keyword">if</span> (process.platform === <span class="string">'win32'</span> &amp;&amp; <span class="regexp">/^\w:[\\\/]*$/</span>.test(dir)) {
            <span class="keyword">return</span> cb(<span class="literal">null</span>);
        }
        <span class="keyword">if</span> (<span class="regexp">/[\\\/]node_modules[\\\/]*$/</span>.test(dir)) <span class="keyword">return</span> cb(<span class="literal">null</span>);
        
        <span class="keyword">var</span> pkgfile = path.join(dir, <span class="string">'package.json'</span>);
        isFile(pkgfile, <span class="function"><span class="keyword">function</span> <span class="params">(err, ex)</span> {</span>
            <span class="comment">// on err, ex is false</span>
            <span class="keyword">if</span> (!ex) <span class="keyword">return</span> loadpkg(
                path.dirname(dir), cb
            );
            
            readFile(pkgfile, <span class="function"><span class="keyword">function</span> <span class="params">(err, body)</span> {</span>
                <span class="keyword">if</span> (err) cb(err);
                <span class="keyword">try</span> { <span class="keyword">var</span> pkg = JSON.parse(body) }
                <span class="keyword">catch</span> (err) {}
                
                <span class="keyword">if</span> (pkg &amp;&amp; opts.packageFilter) {
                    pkg = opts.packageFilter(pkg, pkgfile);
                }
                cb(<span class="literal">null</span>, pkg, dir);
            });
        });
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadAsDirectory</span> <span class="params">(x, fpkg, cb)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> fpkg === <span class="string">'function'</span>) {
            cb = fpkg;
            fpkg = opts.package;
        }
        
        <span class="keyword">var</span> pkgfile = path.join(x, <span class="string">'/package.json'</span>);
        isFile(pkgfile, <span class="function"><span class="keyword">function</span> <span class="params">(err, ex)</span> {</span>
            <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err);
            <span class="keyword">if</span> (!ex) <span class="keyword">return</span> loadAsFile(path.join(x, <span class="string">'/index'</span>), fpkg, cb);
            
            readFile(pkgfile, <span class="function"><span class="keyword">function</span> <span class="params">(err, body)</span> {</span>
                <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err);
                <span class="keyword">try</span> {
                    <span class="keyword">var</span> pkg = JSON.parse(body);
                }
                <span class="keyword">catch</span> (err) {}
                
                <span class="keyword">if</span> (opts.packageFilter) {
                    pkg = opts.packageFilter(pkg, pkgfile);
                }
                
                <span class="keyword">if</span> (pkg.main) {
                    <span class="keyword">if</span> (pkg.main === <span class="string">'.'</span> || pkg.main === <span class="string">'./'</span>){
                        pkg.main = <span class="string">'index'</span>
                    }
                    loadAsFile(path.resolve(x, pkg.main), pkg, <span class="function"><span class="keyword">function</span> <span class="params">(err, m, pkg)</span> {</span>
                        <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err);
                        <span class="keyword">if</span> (m) <span class="keyword">return</span> cb(<span class="literal">null</span>, m, pkg);
                        <span class="keyword">if</span> (!pkg) <span class="keyword">return</span> loadAsFile(path.join(x, <span class="string">'/index'</span>), pkg, cb);

                        <span class="keyword">var</span> dir = path.resolve(x, pkg.main);
                        loadAsDirectory(dir, pkg, <span class="function"><span class="keyword">function</span> <span class="params">(err, n, pkg)</span> {</span>
                            <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err);
                            <span class="keyword">if</span> (n) <span class="keyword">return</span> cb(<span class="literal">null</span>, n, pkg);
                            loadAsFile(path.join(x, <span class="string">'/index'</span>), pkg, cb);
                        });
                    });
                    <span class="keyword">return</span>;
                }
                
                loadAsFile(path.join(x, <span class="string">'/index'</span>), pkg, cb);
            });
        });
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadNodeModules</span> <span class="params">(x, start, cb)</span> {</span>
        (<span class="function"><span class="keyword">function</span> <span class="title">process</span> <span class="params">(dirs)</span> {</span>
            <span class="keyword">if</span> (dirs.length === <span class="number">0</span>) <span class="keyword">return</span> cb(<span class="literal">null</span>, <span class="literal">undefined</span>);
            <span class="keyword">var</span> dir = dirs[<span class="number">0</span>];
            
            <span class="keyword">var</span> file = path.join(dir, <span class="string">'/'</span>, x);
            loadAsFile(file, <span class="literal">undefined</span>, onfile);
            
            <span class="function"><span class="keyword">function</span> <span class="title">onfile</span> <span class="params">(err, m, pkg)</span> {</span>
                <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err);
                <span class="keyword">if</span> (m) <span class="keyword">return</span> cb(<span class="literal">null</span>, m, pkg);
                loadAsDirectory(path.join(dir, <span class="string">'/'</span>, x), <span class="literal">undefined</span>, ondir);
            }
            
            <span class="function"><span class="keyword">function</span> <span class="title">ondir</span> <span class="params">(err, n, pkg)</span> {</span>
                <span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err);
                <span class="keyword">if</span> (n) <span class="keyword">return</span> cb(<span class="literal">null</span>, n, pkg);
                process(dirs.slice(<span class="number">1</span>));
            }
        })(nodeModulesPaths(start, opts));
    }
};
</code></pre>