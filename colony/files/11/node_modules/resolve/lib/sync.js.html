<h1>sync.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> core = require(<span class="string">'./core'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> caller = require(<span class="string">'./caller.js'</span>);
<span class="keyword">var</span> nodeModulesPaths = require(<span class="string">'./node-modules-paths.js'</span>);

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(x, opts)</span> {</span>
    <span class="keyword">if</span> (!opts) opts = {};
    <span class="keyword">var</span> isFile = opts.isFile || <span class="function"><span class="keyword">function</span> <span class="params">(file)</span> {</span>
        <span class="keyword">try</span> { <span class="keyword">var</span> stat = fs.statSync(file) }
        <span class="keyword">catch</span> (err) { <span class="keyword">if</span> (err &amp;&amp; err.code === <span class="string">'ENOENT'</span>) <span class="keyword">return</span> <span class="literal">false</span> }
        <span class="keyword">return</span> stat.isFile() || stat.isFIFO();
    };
    <span class="keyword">var</span> readFileSync = opts.readFileSync || fs.readFileSync;
    
    <span class="keyword">var</span> extensions = opts.extensions || [ <span class="string">'.js'</span> ];
    <span class="keyword">var</span> y = opts.basedir || path.dirname(caller());

    opts.paths = opts.paths || [];

    <span class="keyword">if</span> (<span class="regexp">/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[\\\/])/</span>.test(x)) {
        <span class="keyword">var</span> res = path.resolve(y, x);
        <span class="keyword">if</span> (x === <span class="string">'..'</span>) res += <span class="string">'/'</span>;
        <span class="keyword">var</span> m = loadAsFileSync(res) || loadAsDirectorySync(res);
        <span class="keyword">if</span> (m) <span class="keyword">return</span> m;
    } <span class="keyword">else</span> {
        <span class="keyword">var</span> n = loadNodeModulesSync(x, y);
        <span class="keyword">if</span> (n) <span class="keyword">return</span> n;
    }
    
    <span class="keyword">if</span> (core[x]) <span class="keyword">return</span> x;
    
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Cannot find module '"</span> + x + <span class="string">"' from '"</span> + y + <span class="string">"'"</span>);
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadAsFileSync</span> <span class="params">(x)</span> {</span>
        <span class="keyword">if</span> (isFile(x)) {
            <span class="keyword">return</span> x;
        }
        
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; extensions.length; i++) {
            <span class="keyword">var</span> file = x + extensions[i];
            <span class="keyword">if</span> (isFile(file)) {
                <span class="keyword">return</span> file;
            }
        }
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadAsDirectorySync</span> <span class="params">(x)</span> {</span>
        <span class="keyword">var</span> pkgfile = path.join(x, <span class="string">'/package.json'</span>);
        <span class="keyword">if</span> (isFile(pkgfile)) {
            <span class="keyword">var</span> body = readFileSync(pkgfile, <span class="string">'utf8'</span>);
            <span class="keyword">try</span> {
                <span class="keyword">var</span> pkg = JSON.parse(body);
                <span class="keyword">if</span> (opts.packageFilter) {
                    pkg = opts.packageFilter(pkg, x);
                }
                
                <span class="keyword">if</span> (pkg.main) {
                    <span class="keyword">var</span> m = loadAsFileSync(path.resolve(x, pkg.main));
                    <span class="keyword">if</span> (m) <span class="keyword">return</span> m;
                    <span class="keyword">var</span> n = loadAsDirectorySync(path.resolve(x, pkg.main));
                    <span class="keyword">if</span> (n) <span class="keyword">return</span> n;
                }
            }
            <span class="keyword">catch</span> (err) {}
        }
        
        <span class="keyword">return</span> loadAsFileSync(path.join( x, <span class="string">'/index'</span>));
    }
    
    <span class="function"><span class="keyword">function</span> <span class="title">loadNodeModulesSync</span> <span class="params">(x, start)</span> {</span>
        <span class="keyword">var</span> dirs = nodeModulesPaths(start, opts);
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; dirs.length; i++) {
            <span class="keyword">var</span> dir = dirs[i];
            <span class="keyword">var</span> m = loadAsFileSync(path.join( dir, <span class="string">'/'</span>, x));
            <span class="keyword">if</span> (m) <span class="keyword">return</span> m;
            <span class="keyword">var</span> n = loadAsDirectorySync(path.join( dir, <span class="string">'/'</span>, x ));
            <span class="keyword">if</span> (n) <span class="keyword">return</span> n;
        }
    }
};
</code></pre>