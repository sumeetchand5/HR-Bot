<h1>node-modules-paths.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> path = require(<span class="string">'path'</span>);

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(start, opts)</span> {</span>
    <span class="keyword">var</span> modules = opts.moduleDirectory
        ? [].concat(opts.moduleDirectory)
        : [<span class="string">'node_modules'</span>]
    ;

    <span class="comment">// ensure that `start` is an absolute path at this point,</span>
    <span class="comment">// resolving against the process' current working directory</span>
    start = path.resolve(start);

    <span class="keyword">var</span> prefix = <span class="string">'/'</span>;
    <span class="keyword">if</span> (<span class="regexp">/^([A-Za-z]:)/</span>.test(start)) {
        prefix = <span class="string">''</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^\\\\/.test(start)) {
        prefix = '\\\\';
    }

    var splitRe = process.platform === 'win32' ? /</span>[\/\\]/ : <span class="regexp">/\/+/</span>;

    <span class="keyword">var</span> parts = start.split(splitRe);

    <span class="keyword">var</span> dirs = [];
    <span class="keyword">for</span> (<span class="keyword">var</span> i = parts.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
        <span class="keyword">if</span> (modules.indexOf(parts[i]) !== -<span class="number">1</span>) <span class="keyword">continue</span>;
        dirs = dirs.concat(modules.map(<span class="keyword">function</span>(module_dir) {
            <span class="keyword">return</span> prefix + path.join(
                path.join.apply(path, parts.slice(<span class="number">0</span>, i + <span class="number">1</span>)),
                module_dir
            );
        }));
    }
    <span class="keyword">if</span> (process.platform === <span class="string">'win32'</span>){
        dirs[dirs.length-<span class="number">1</span>] = dirs[dirs.length-<span class="number">1</span>].replace(<span class="string">":"</span>, <span class="string">":\\"</span>);
    }
    <span class="keyword">return</span> dirs.concat(opts.paths);
}
</code></pre>