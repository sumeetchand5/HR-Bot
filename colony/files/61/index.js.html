<h1>index.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;
<span class="keyword">var</span> SourceMapGenerator = require(<span class="string">'source-map'</span>).SourceMapGenerator;

<span class="function"><span class="keyword">function</span> <span class="title">offsetMapping</span><span class="params">(mapping, offset)</span> {</span>
  <span class="keyword">return</span> { line: offset.line + mapping.line, column: offset.column + mapping.column };
}

<span class="function"><span class="keyword">function</span> <span class="title">newlinesIn</span><span class="params">(src)</span> {</span>
  <span class="keyword">if</span> (!src) <span class="keyword">return</span> <span class="number">0</span>;
  <span class="keyword">var</span> newlines = src.match(<span class="regexp">/\n/g</span>);

  <span class="keyword">return</span> newlines ? newlines.length : <span class="number">0</span>;
}
 
<span class="function"><span class="keyword">function</span> <span class="title">Generator</span><span class="params">(opts)</span> {</span>
  opts = opts || {};
  <span class="keyword">this</span>.generator = <span class="keyword">new</span> SourceMapGenerator({ file: opts.file || <span class="string">''</span>, sourceRoot: opts.sourceRoot || <span class="string">''</span> });
  <span class="keyword">this</span>.sourcesContent = <span class="literal">undefined</span>;
  <span class="keyword">this</span>.opts = opts;
}

<span class="comment">/**
 * Adds the given mappings to the generator and offsets them if offset is given 
 *
 * @name addMappings
 * @function
 * @param sourceFile {String} name of the source file
 * @param mappings {Array{{Object}} each object has the form { original: { line: _, column: _ }, generated: { line: _, column: _ } }
 * @param offset {Object} offset to apply to each mapping. Has the form { line: _, column: _ }
 * @return {Object} the generator to allow chaining
 */</span>
Generator.prototype.addMappings = <span class="function"><span class="keyword">function</span> <span class="params">(sourceFile, mappings, offset)</span> {</span> 
  <span class="keyword">var</span> generator = <span class="keyword">this</span>.generator; 

  offset = offset || {};
  offset.line = offset.hasOwnProperty(<span class="string">'line'</span>) ? offset.line : <span class="number">0</span>;
  offset.column = offset.hasOwnProperty(<span class="string">'column'</span>) ? offset.column : <span class="number">0</span>;

  mappings.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
    <span class="comment">// only set source if we have original position to handle edgecase (see inline-source-map tests)</span>
    generator.addMapping({
        source    :  m.original ? sourceFile : <span class="literal">undefined</span>
      , original  :  m.original
      , generated :  offsetMapping(m.generated, offset)
    });
  });
  <span class="keyword">return</span> <span class="keyword">this</span>;
};

<span class="comment">/**
 * Generates mappings for the given source, assuming that no translation from original to generated is necessary.
 *
 * @name addGeneratedMappings
 * @function
 * @param sourceFile {String} name of the source file
 * @param source {String} source of the file
 * @param offset {Object} offset to apply to each mapping. Has the form { line: _, column: _ }
 * @return {Object} the generator to allow chaining
 */</span>
Generator.prototype.addGeneratedMappings = <span class="function"><span class="keyword">function</span> <span class="params">(sourceFile, source, offset)</span> {</span>
  <span class="keyword">var</span> mappings = []
    , linesToGenerate = newlinesIn(source) + <span class="number">1</span>;

  <span class="keyword">for</span> (<span class="keyword">var</span> line = <span class="number">1</span>; line &lt;= linesToGenerate; line++) {
    <span class="keyword">var</span> location = { line: line, column: <span class="number">0</span> };
    mappings.push({ original: location, generated: location });
  }

  <span class="keyword">return</span> <span class="keyword">this</span>.addMappings(sourceFile, mappings, offset);
};

<span class="comment">/**
 * Adds source content for the given source file.
 * 
 * @name addSourceContent
 * @function
 * @param sourceFile {String} The source file for which a mapping is included
 * @param sourcesContent {String} The content of the source file
 * @return {Object} The generator to allow chaining
 */</span>
Generator.prototype.addSourceContent = <span class="function"><span class="keyword">function</span> <span class="params">(sourceFile, sourcesContent)</span> {</span>
  <span class="keyword">this</span>.sourcesContent = <span class="keyword">this</span>.sourcesContent || {};
  <span class="keyword">this</span>.sourcesContent[sourceFile] = sourcesContent;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};

<span class="comment">/**
 * @name base64Encode
 * @function
 * @return {String} bas64 encoded representation of the added mappings
 */</span>
Generator.prototype.base64Encode = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> map = <span class="keyword">this</span>.toString();
  <span class="keyword">return</span> <span class="keyword">new</span> Buffer(map).toString(<span class="string">'base64'</span>);
};

<span class="comment">/**
 * @name inlineMappingUrl
 * @function
 * @return {String} comment with base64 encoded representation of the added mappings. Can be inlined at the end of the generated file. 
 */</span>
Generator.prototype.inlineMappingUrl = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> charset = <span class="keyword">this</span>.opts.charset || <span class="string">'utf-8'</span>;
  <span class="keyword">return</span> <span class="string">'//# sourceMappingURL=data:application/json;charset='</span> + charset + <span class="string">';base64,'</span> + <span class="keyword">this</span>.base64Encode();
};

Generator.prototype.toJSON = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> map = <span class="keyword">this</span>.generator.toJSON();
  <span class="keyword">if</span> (!<span class="keyword">this</span>.sourcesContent) <span class="keyword">return</span> map;

  <span class="keyword">var</span> toSourcesContent = (<span class="function"><span class="keyword">function</span> <span class="params">(s)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.sourcesContent[s] === <span class="string">'string'</span>) {
      <span class="keyword">return</span> <span class="keyword">this</span>.sourcesContent[s];
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }
  }).bind(<span class="keyword">this</span>);
  map.sourcesContent = map.sources.map(toSourcesContent);
  <span class="keyword">return</span> map;
};

Generator.prototype.toString = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> JSON.stringify(<span class="keyword">this</span>);
};

Generator.prototype._mappings = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.generator._mappings._array;
};

Generator.prototype.gen = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.generator;
};

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(opts)</span> {</span> <span class="keyword">return</span> <span class="keyword">new</span> Generator(opts); };
module.exports.Generator = Generator;
</code></pre>