<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> json = <span class="keyword">typeof</span> JSON !== <span class="string">'undefined'</span> ? JSON : require(<span class="string">'jsonify'</span>);

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(obj, opts)</span> {</span>
    <span class="keyword">if</span> (!opts) opts = {};
    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts === <span class="string">'function'</span>) opts = { cmp: opts };
    <span class="keyword">var</span> cmp = opts.cmp &amp;&amp; (<span class="function"><span class="keyword">function</span> <span class="params">(f)</span> {</span>
        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(node)</span> {</span>
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(a, b)</span> {</span>
                <span class="keyword">var</span> aobj = { key: a, value: node[a] };
                <span class="keyword">var</span> bobj = { key: b, value: node[b] };
                <span class="keyword">return</span> f(aobj, bobj);
            };
        };
    })(opts.cmp);
    
    <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span> <span class="title">stringify</span> <span class="params">(node)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> node !== <span class="string">'object'</span> || node === <span class="literal">null</span>) {
            <span class="keyword">return</span> json.stringify(node);
        }
        <span class="keyword">if</span> (isArray(node)) {
            <span class="keyword">var</span> out = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; node.length; i++) {
                out.push(stringify(node[i]));
            }
            <span class="keyword">return</span> <span class="string">'['</span> + out.join(<span class="string">','</span>) + <span class="string">']'</span>;
        }
        <span class="keyword">else</span> {
            <span class="keyword">var</span> keys = objectKeys(node).sort(cmp &amp;&amp; cmp(node));
            <span class="keyword">var</span> out = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) {
                <span class="keyword">var</span> key = keys[i];
                out.push(stringify(key) + <span class="string">':'</span> + stringify(node[key]));
            }
            <span class="keyword">return</span> <span class="string">'{'</span> + out.join(<span class="string">','</span>) + <span class="string">'}'</span>;
        }
    })(obj);
};

<span class="keyword">var</span> isArray = Array.isArray || <span class="function"><span class="keyword">function</span> <span class="params">(x)</span> {</span>
    <span class="keyword">return</span> {}.toString.call(x) === <span class="string">'[object Array]'</span>;
};

<span class="keyword">var</span> objectKeys = Object.keys || <span class="function"><span class="keyword">function</span> <span class="params">(obj)</span> {</span>
    <span class="keyword">var</span> has = Object.prototype.hasOwnProperty || <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> <span class="keyword">return</span> <span class="literal">true</span> };
    <span class="keyword">var</span> keys = [];
    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) {
        <span class="keyword">if</span> (has.call(obj, key)) keys.push(key);
    }
    <span class="keyword">return</span> keys;
};
</code></pre>