<h1>mapping-list.js</h1>
<pre><code class="lang-js"><span class="comment">/* -*- Mode: js; js-indent-level: 2; -*- */</span>
<span class="comment">/*
 * Copyright 2014 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */</span>

<span class="keyword">var</span> util = require(<span class="string">'./util'</span>);

<span class="comment">/**
 * Determine whether mappingB is after mappingA with respect to generated
 * position.
 */</span>
<span class="function"><span class="keyword">function</span> <span class="title">generatedPositionAfter</span><span class="params">(mappingA, mappingB)</span> {</span>
  <span class="comment">// Optimized for most common case</span>
  <span class="keyword">var</span> lineA = mappingA.generatedLine;
  <span class="keyword">var</span> lineB = mappingB.generatedLine;
  <span class="keyword">var</span> columnA = mappingA.generatedColumn;
  <span class="keyword">var</span> columnB = mappingB.generatedColumn;
  <span class="keyword">return</span> lineB > lineA || lineB == lineA &amp;&amp; columnB >= columnA ||
         util.compareByGeneratedPositionsInflated(mappingA, mappingB) &lt;= <span class="number">0</span>;
}

<span class="comment">/**
 * A data structure to provide a sorted view of accumulated mappings in a
 * performance conscious manner. It trades a neglibable overhead in general
 * case for a large speedup in case of mappings being added in order.
 */</span>
<span class="function"><span class="keyword">function</span> <span class="title">MappingList</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>._array = [];
  <span class="keyword">this</span>._sorted = <span class="literal">true</span>;
  <span class="comment">// Serves as infimum</span>
  <span class="keyword">this</span>._last = {generatedLine: -<span class="number">1</span>, generatedColumn: <span class="number">0</span>};
}

<span class="comment">/**
 * Iterate through internal items. This method takes the same arguments that
 * `Array.prototype.forEach` takes.
 *
 * NOTE: The order of the mappings is NOT guaranteed.
 */</span>
MappingList.prototype.unsortedForEach =
  <span class="function"><span class="keyword">function</span> <span class="title">MappingList_forEach</span><span class="params">(aCallback, aThisArg)</span> {</span>
    <span class="keyword">this</span>._array.forEach(aCallback, aThisArg);
  };

<span class="comment">/**
 * Add the given source mapping.
 *
 * @param Object aMapping
 */</span>
MappingList.prototype.add = <span class="function"><span class="keyword">function</span> <span class="title">MappingList_add</span><span class="params">(aMapping)</span> {</span>
  <span class="keyword">if</span> (generatedPositionAfter(<span class="keyword">this</span>._last, aMapping)) {
    <span class="keyword">this</span>._last = aMapping;
    <span class="keyword">this</span>._array.push(aMapping);
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>._sorted = <span class="literal">false</span>;
    <span class="keyword">this</span>._array.push(aMapping);
  }
};

<span class="comment">/**
 * Returns the flat, sorted array of mappings. The mappings are sorted by
 * generated position.
 *
 * WARNING: This method returns internal data without copying, for
 * performance. The return value must NOT be mutated, and should be treated as
 * an immutable borrow. If you want to take ownership, you must make your own
 * copy.
 */</span>
MappingList.prototype.toArray = <span class="function"><span class="keyword">function</span> <span class="title">MappingList_toArray</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>._sorted) {
    <span class="keyword">this</span>._array.sort(util.compareByGeneratedPositionsInflated);
    <span class="keyword">this</span>._sorted = <span class="literal">true</span>;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>._array;
};

exports.MappingList = MappingList;
</code></pre>