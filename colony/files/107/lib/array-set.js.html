<h1>array-set.js</h1>
<pre><code class="lang-js"><span class="comment">/* -*- Mode: js; js-indent-level: 2; -*- */</span>
<span class="comment">/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */</span>

<span class="keyword">var</span> util = require(<span class="string">'./util'</span>);
<span class="keyword">var</span> has = Object.prototype.hasOwnProperty;
<span class="keyword">var</span> hasNativeMap = <span class="keyword">typeof</span> Map !== <span class="string">"undefined"</span>;

<span class="comment">/**
 * A data structure which is a combination of an array and a set. Adding a new
 * member is O(1), testing for membership is O(1), and finding the index of an
 * element is O(1). Removing elements from the set is not supported. Only
 * strings are supported for membership.
 */</span>
<span class="function"><span class="keyword">function</span> <span class="title">ArraySet</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>._array = [];
  <span class="keyword">this</span>._set = hasNativeMap ? <span class="keyword">new</span> Map() : Object.create(<span class="literal">null</span>);
}

<span class="comment">/**
 * Static method for creating ArraySet instances from an existing array.
 */</span>
ArraySet.fromArray = <span class="function"><span class="keyword">function</span> <span class="title">ArraySet_fromArray</span><span class="params">(aArray, aAllowDuplicates)</span> {</span>
  <span class="keyword">var</span> set = <span class="keyword">new</span> ArraySet();
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = aArray.length; i &lt; len; i++) {
    set.add(aArray[i], aAllowDuplicates);
  }
  <span class="keyword">return</span> set;
};

<span class="comment">/**
 * Return how many unique items are in this ArraySet. If duplicates have been
 * added, than those do not count towards the size.
 *
 * @returns Number
 */</span>
ArraySet.prototype.size = <span class="function"><span class="keyword">function</span> <span class="title">ArraySet_size</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> hasNativeMap ? <span class="keyword">this</span>._set.size : Object.getOwnPropertyNames(<span class="keyword">this</span>._set).length;
};

<span class="comment">/**
 * Add the given string to this set.
 *
 * @param String aStr
 */</span>
ArraySet.prototype.add = <span class="function"><span class="keyword">function</span> <span class="title">ArraySet_add</span><span class="params">(aStr, aAllowDuplicates)</span> {</span>
  <span class="keyword">var</span> sStr = hasNativeMap ? aStr : util.toSetString(aStr);
  <span class="keyword">var</span> isDuplicate = hasNativeMap ? <span class="keyword">this</span>.has(aStr) : has.call(<span class="keyword">this</span>._set, sStr);
  <span class="keyword">var</span> idx = <span class="keyword">this</span>._array.length;
  <span class="keyword">if</span> (!isDuplicate || aAllowDuplicates) {
    <span class="keyword">this</span>._array.push(aStr);
  }
  <span class="keyword">if</span> (!isDuplicate) {
    <span class="keyword">if</span> (hasNativeMap) {
      <span class="keyword">this</span>._set.set(aStr, idx);
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>._set[sStr] = idx;
    }
  }
};

<span class="comment">/**
 * Is the given string a member of this set?
 *
 * @param String aStr
 */</span>
ArraySet.prototype.has = <span class="function"><span class="keyword">function</span> <span class="title">ArraySet_has</span><span class="params">(aStr)</span> {</span>
  <span class="keyword">if</span> (hasNativeMap) {
    <span class="keyword">return</span> <span class="keyword">this</span>._set.has(aStr);
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> sStr = util.toSetString(aStr);
    <span class="keyword">return</span> has.call(<span class="keyword">this</span>._set, sStr);
  }
};

<span class="comment">/**
 * What is the index of the given string in the array?
 *
 * @param String aStr
 */</span>
ArraySet.prototype.indexOf = <span class="function"><span class="keyword">function</span> <span class="title">ArraySet_indexOf</span><span class="params">(aStr)</span> {</span>
  <span class="keyword">if</span> (hasNativeMap) {
    <span class="keyword">var</span> idx = <span class="keyword">this</span>._set.get(aStr);
    <span class="keyword">if</span> (idx >= <span class="number">0</span>) {
        <span class="keyword">return</span> idx;
    }
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> sStr = util.toSetString(aStr);
    <span class="keyword">if</span> (has.call(<span class="keyword">this</span>._set, sStr)) {
      <span class="keyword">return</span> <span class="keyword">this</span>._set[sStr];
    }
  }

  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'"'</span> + aStr + <span class="string">'" is not in the set.'</span>);
};

<span class="comment">/**
 * What is the element at the given index?
 *
 * @param Number aIdx
 */</span>
ArraySet.prototype.at = <span class="function"><span class="keyword">function</span> <span class="title">ArraySet_at</span><span class="params">(aIdx)</span> {</span>
  <span class="keyword">if</span> (aIdx >= <span class="number">0</span> &amp;&amp; aIdx &lt; <span class="keyword">this</span>._array.length) {
    <span class="keyword">return</span> <span class="keyword">this</span>._array[aIdx];
  }
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'No element indexed by '</span> + aIdx);
};

<span class="comment">/**
 * Returns the array representation of this set (which has the proper indices
 * indicated by indexOf). Note that this is a copy of the internal array used
 * for storing the members so that no one can mess with internal state.
 */</span>
ArraySet.prototype.toArray = <span class="function"><span class="keyword">function</span> <span class="title">ArraySet_toArray</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>._array.slice();
};

exports.ArraySet = ArraySet;
</code></pre>