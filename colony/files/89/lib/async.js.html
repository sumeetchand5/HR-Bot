<h1>async.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> checkParameters = require(<span class="string">'./precondition'</span>)
<span class="keyword">var</span> defaultEncoding = require(<span class="string">'./default-encoding'</span>)
<span class="keyword">var</span> sync = require(<span class="string">'./sync'</span>)
<span class="keyword">var</span> Buffer = require(<span class="string">'safe-buffer'</span>).Buffer

<span class="keyword">var</span> ZERO_BUF
<span class="keyword">var</span> subtle = global.crypto &amp;&amp; global.crypto.subtle
<span class="keyword">var</span> toBrowser = {
  <span class="string">'sha'</span>: <span class="string">'SHA-1'</span>,
  <span class="string">'sha-1'</span>: <span class="string">'SHA-1'</span>,
  <span class="string">'sha1'</span>: <span class="string">'SHA-1'</span>,
  <span class="string">'sha256'</span>: <span class="string">'SHA-256'</span>,
  <span class="string">'sha-256'</span>: <span class="string">'SHA-256'</span>,
  <span class="string">'sha384'</span>: <span class="string">'SHA-384'</span>,
  <span class="string">'sha-384'</span>: <span class="string">'SHA-384'</span>,
  <span class="string">'sha-512'</span>: <span class="string">'SHA-512'</span>,
  <span class="string">'sha512'</span>: <span class="string">'SHA-512'</span>
}
<span class="keyword">var</span> checks = []
<span class="function"><span class="keyword">function</span> <span class="title">checkNative</span> <span class="params">(algo)</span> {</span>
  <span class="keyword">if</span> (global.process &amp;&amp; !global.process.browser) {
    <span class="keyword">return</span> Promise.resolve(<span class="literal">false</span>)
  }
  <span class="keyword">if</span> (!subtle || !subtle.importKey || !subtle.deriveBits) {
    <span class="keyword">return</span> Promise.resolve(<span class="literal">false</span>)
  }
  <span class="keyword">if</span> (checks[algo] !== <span class="literal">undefined</span>) {
    <span class="keyword">return</span> checks[algo]
  }
  ZERO_BUF = ZERO_BUF || Buffer.alloc(<span class="number">8</span>)
  <span class="keyword">var</span> prom = browserPbkdf2(ZERO_BUF, ZERO_BUF, <span class="number">10</span>, <span class="number">128</span>, algo)
    .then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="literal">true</span>
    }).<span class="keyword">catch</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="literal">false</span>
    })
  checks[algo] = prom
  <span class="keyword">return</span> prom
}

<span class="function"><span class="keyword">function</span> <span class="title">browserPbkdf2</span> <span class="params">(password, salt, iterations, length, algo)</span> {</span>
  <span class="keyword">return</span> subtle.importKey(
    <span class="string">'raw'</span>, password, {name: <span class="string">'PBKDF2'</span>}, <span class="literal">false</span>, [<span class="string">'deriveBits'</span>]
  ).then(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
    <span class="keyword">return</span> subtle.deriveBits({
      name: <span class="string">'PBKDF2'</span>,
      salt: salt,
      iterations: iterations,
      hash: {
        name: algo
      }
    }, key, length &lt;&lt; <span class="number">3</span>)
  }).then(<span class="function"><span class="keyword">function</span> <span class="params">(res)</span> {</span>
    <span class="keyword">return</span> Buffer.from(res)
  })
}

<span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span> <span class="params">(promise, callback)</span> {</span>
  promise.then(<span class="function"><span class="keyword">function</span> <span class="params">(out)</span> {</span>
    process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      callback(<span class="literal">null</span>, out)
    })
  }, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> {</span>
    process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      callback(e)
    })
  })
}
module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(password, salt, iterations, keylen, digest, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> digest === <span class="string">'function'</span>) {
    callback = digest
    digest = <span class="literal">undefined</span>
  }

  digest = digest || <span class="string">'sha1'</span>
  <span class="keyword">var</span> algo = toBrowser[digest.toLowerCase()]

  <span class="keyword">if</span> (!algo || <span class="keyword">typeof</span> global.Promise !== <span class="string">'function'</span>) {
    <span class="keyword">return</span> process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> out
      <span class="keyword">try</span> {
        out = sync(password, salt, iterations, keylen, digest)
      } <span class="keyword">catch</span> (e) {
        <span class="keyword">return</span> callback(e)
      }
      callback(<span class="literal">null</span>, out)
    })
  }

  checkParameters(password, salt, iterations, keylen)
  <span class="keyword">if</span> (<span class="keyword">typeof</span> callback !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'No callback provided to pbkdf2'</span>)
  <span class="keyword">if</span> (!Buffer.isBuffer(password)) password = Buffer.from(password, defaultEncoding)
  <span class="keyword">if</span> (!Buffer.isBuffer(salt)) salt = Buffer.from(salt, defaultEncoding)

  resolvePromise(checkNative(algo).then(<span class="function"><span class="keyword">function</span> <span class="params">(resp)</span> {</span>
    <span class="keyword">if</span> (resp) <span class="keyword">return</span> browserPbkdf2(password, salt, iterations, keylen, algo)

    <span class="keyword">return</span> sync(password, salt, iterations, keylen, digest)
  }), callback)
}
</code></pre>