<h1>buffer.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);
<span class="keyword">var</span> Reporter = require(<span class="string">'../base'</span>).Reporter;
<span class="keyword">var</span> Buffer = require(<span class="string">'buffer'</span>).Buffer;

<span class="function"><span class="keyword">function</span> <span class="title">DecoderBuffer</span><span class="params">(base, options)</span> {</span>
  Reporter.call(<span class="keyword">this</span>, options);
  <span class="keyword">if</span> (!Buffer.isBuffer(base)) {
    <span class="keyword">this</span>.error(<span class="string">'Input not Buffer'</span>);
    <span class="keyword">return</span>;
  }

  <span class="keyword">this</span>.base = base;
  <span class="keyword">this</span>.offset = <span class="number">0</span>;
  <span class="keyword">this</span>.length = base.length;
}
inherits(DecoderBuffer, Reporter);
exports.DecoderBuffer = DecoderBuffer;

DecoderBuffer.prototype.save = <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> { offset: <span class="keyword">this</span>.offset, reporter: Reporter.prototype.save.call(<span class="keyword">this</span>) };
};

DecoderBuffer.prototype.restore = <span class="function"><span class="keyword">function</span> <span class="title">restore</span><span class="params">(save)</span> {</span>
  <span class="comment">// Return skipped data</span>
  <span class="keyword">var</span> res = <span class="keyword">new</span> DecoderBuffer(<span class="keyword">this</span>.base);
  res.offset = save.offset;
  res.length = <span class="keyword">this</span>.offset;

  <span class="keyword">this</span>.offset = save.offset;
  Reporter.prototype.restore.call(<span class="keyword">this</span>, save.reporter);

  <span class="keyword">return</span> res;
};

DecoderBuffer.prototype.isEmpty = <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.offset === <span class="keyword">this</span>.length;
};

DecoderBuffer.prototype.readUInt8 = <span class="function"><span class="keyword">function</span> <span class="title">readUInt8</span><span class="params">(fail)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.offset + <span class="number">1</span> &lt;= <span class="keyword">this</span>.length)
    <span class="keyword">return</span> <span class="keyword">this</span>.base.readUInt8(<span class="keyword">this</span>.offset++, <span class="literal">true</span>);
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.error(fail || <span class="string">'DecoderBuffer overrun'</span>);
}

DecoderBuffer.prototype.skip = <span class="function"><span class="keyword">function</span> <span class="title">skip</span><span class="params">(bytes, fail)</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span>.offset + bytes &lt;= <span class="keyword">this</span>.length))
    <span class="keyword">return</span> <span class="keyword">this</span>.error(fail || <span class="string">'DecoderBuffer overrun'</span>);

  <span class="keyword">var</span> res = <span class="keyword">new</span> DecoderBuffer(<span class="keyword">this</span>.base);

  <span class="comment">// Share reporter state</span>
  res._reporterState = <span class="keyword">this</span>._reporterState;

  res.offset = <span class="keyword">this</span>.offset;
  res.length = <span class="keyword">this</span>.offset + bytes;
  <span class="keyword">this</span>.offset += bytes;
  <span class="keyword">return</span> res;
}

DecoderBuffer.prototype.raw = <span class="function"><span class="keyword">function</span> <span class="title">raw</span><span class="params">(save)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.base.slice(save ? save.offset : <span class="keyword">this</span>.offset, <span class="keyword">this</span>.length);
}

<span class="function"><span class="keyword">function</span> <span class="title">EncoderBuffer</span><span class="params">(value, reporter)</span> {</span>
  <span class="keyword">if</span> (Array.isArray(value)) {
    <span class="keyword">this</span>.length = <span class="number">0</span>;
    <span class="keyword">this</span>.value = value.map(<span class="keyword">function</span>(item) {
      <span class="keyword">if</span> (!(item <span class="keyword">instanceof</span> EncoderBuffer))
        item = <span class="keyword">new</span> EncoderBuffer(item, reporter);
      <span class="keyword">this</span>.length += item.length;
      <span class="keyword">return</span> item;
    }, <span class="keyword">this</span>);
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'number'</span>) {
    <span class="keyword">if</span> (!(<span class="number">0</span> &lt;= value &amp;&amp; value &lt;= <span class="number">0xff</span>))
      <span class="keyword">return</span> reporter.error(<span class="string">'non-byte EncoderBuffer value'</span>);
    <span class="keyword">this</span>.value = value;
    <span class="keyword">this</span>.length = <span class="number">1</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'string'</span>) {
    <span class="keyword">this</span>.value = value;
    <span class="keyword">this</span>.length = Buffer.byteLength(value);
  } <span class="keyword">else</span> <span class="keyword">if</span> (Buffer.isBuffer(value)) {
    <span class="keyword">this</span>.value = value;
    <span class="keyword">this</span>.length = value.length;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> reporter.error(<span class="string">'Unsupported type: '</span> + <span class="keyword">typeof</span> value);
  }
}
exports.EncoderBuffer = EncoderBuffer;

EncoderBuffer.prototype.join = <span class="function"><span class="keyword">function</span> <span class="title">join</span><span class="params">(out, offset)</span> {</span>
  <span class="keyword">if</span> (!out)
    out = <span class="keyword">new</span> Buffer(<span class="keyword">this</span>.length);
  <span class="keyword">if</span> (!offset)
    offset = <span class="number">0</span>;

  <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>)
    <span class="keyword">return</span> out;

  <span class="keyword">if</span> (Array.isArray(<span class="keyword">this</span>.value)) {
    <span class="keyword">this</span>.value.forEach(<span class="keyword">function</span>(item) {
      item.join(out, offset);
      offset += item.length;
    });
  } <span class="keyword">else</span> {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.value === <span class="string">'number'</span>)
      out[offset] = <span class="keyword">this</span>.value;
    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.value === <span class="string">'string'</span>)
      out.write(<span class="keyword">this</span>.value, offset);
    <span class="keyword">else</span> <span class="keyword">if</span> (Buffer.isBuffer(<span class="keyword">this</span>.value))
      <span class="keyword">this</span>.value.copy(out, offset);
    offset += <span class="keyword">this</span>.length;
  }

  <span class="keyword">return</span> out;
};
</code></pre>