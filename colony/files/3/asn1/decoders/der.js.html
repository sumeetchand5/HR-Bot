<h1>der.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);

<span class="keyword">var</span> asn1 = require(<span class="string">'../../asn1'</span>);
<span class="keyword">var</span> base = asn1.base;
<span class="keyword">var</span> bignum = asn1.bignum;

<span class="comment">// Import DER constants</span>
<span class="keyword">var</span> der = asn1.constants.der;

<span class="function"><span class="keyword">function</span> <span class="title">DERDecoder</span><span class="params">(entity)</span> {</span>
  <span class="keyword">this</span>.enc = <span class="string">'der'</span>;
  <span class="keyword">this</span>.name = entity.name;
  <span class="keyword">this</span>.entity = entity;

  <span class="comment">// Construct base tree</span>
  <span class="keyword">this</span>.tree = <span class="keyword">new</span> DERNode();
  <span class="keyword">this</span>.tree._init(entity.body);
};
module.exports = DERDecoder;

DERDecoder.prototype.decode = <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">(data, options)</span> {</span>
  <span class="keyword">if</span> (!(data <span class="keyword">instanceof</span> base.DecoderBuffer))
    data = <span class="keyword">new</span> base.DecoderBuffer(data, options);

  <span class="keyword">return</span> <span class="keyword">this</span>.tree._decode(data, options);
};

<span class="comment">// Tree methods</span>

<span class="function"><span class="keyword">function</span> <span class="title">DERNode</span><span class="params">(parent)</span> {</span>
  base.Node.call(<span class="keyword">this</span>, <span class="string">'der'</span>, parent);
}
inherits(DERNode, base.Node);

DERNode.prototype._peekTag = <span class="function"><span class="keyword">function</span> <span class="title">peekTag</span><span class="params">(buffer, tag, any)</span> {</span>
  <span class="keyword">if</span> (buffer.isEmpty())
    <span class="keyword">return</span> <span class="literal">false</span>;

  <span class="keyword">var</span> state = buffer.save();
  <span class="keyword">var</span> decodedTag = derDecodeTag(buffer, <span class="string">'Failed to peek tag: "'</span> + tag + <span class="string">'"'</span>);
  <span class="keyword">if</span> (buffer.isError(decodedTag))
    <span class="keyword">return</span> decodedTag;

  buffer.restore(state);

  <span class="keyword">return</span> decodedTag.tag === tag || decodedTag.tagStr === tag ||
    (decodedTag.tagStr + <span class="string">'of'</span>) === tag || any;
};

DERNode.prototype._decodeTag = <span class="function"><span class="keyword">function</span> <span class="title">decodeTag</span><span class="params">(buffer, tag, any)</span> {</span>
  <span class="keyword">var</span> decodedTag = derDecodeTag(buffer,
                                <span class="string">'Failed to decode tag of "'</span> + tag + <span class="string">'"'</span>);
  <span class="keyword">if</span> (buffer.isError(decodedTag))
    <span class="keyword">return</span> decodedTag;

  <span class="keyword">var</span> len = derDecodeLen(buffer,
                         decodedTag.primitive,
                         <span class="string">'Failed to get length of "'</span> + tag + <span class="string">'"'</span>);

  <span class="comment">// Failure</span>
  <span class="keyword">if</span> (buffer.isError(len))
    <span class="keyword">return</span> len;

  <span class="keyword">if</span> (!any &amp;&amp;
      decodedTag.tag !== tag &amp;&amp;
      decodedTag.tagStr !== tag &amp;&amp;
      decodedTag.tagStr + <span class="string">'of'</span> !== tag) {
    <span class="keyword">return</span> buffer.error(<span class="string">'Failed to match tag: "'</span> + tag + <span class="string">'"'</span>);
  }

  <span class="keyword">if</span> (decodedTag.primitive || len !== <span class="literal">null</span>)
    <span class="keyword">return</span> buffer.skip(len, <span class="string">'Failed to match body of: "'</span> + tag + <span class="string">'"'</span>);

  <span class="comment">// Indefinite length... find END tag</span>
  <span class="keyword">var</span> state = buffer.save();
  <span class="keyword">var</span> res = <span class="keyword">this</span>._skipUntilEnd(
      buffer,
      <span class="string">'Failed to skip indefinite length body: "'</span> + <span class="keyword">this</span>.tag + <span class="string">'"'</span>);
  <span class="keyword">if</span> (buffer.isError(res))
    <span class="keyword">return</span> res;

  len = buffer.offset - state.offset;
  buffer.restore(state);
  <span class="keyword">return</span> buffer.skip(len, <span class="string">'Failed to match body of: "'</span> + tag + <span class="string">'"'</span>);
};

DERNode.prototype._skipUntilEnd = <span class="function"><span class="keyword">function</span> <span class="title">skipUntilEnd</span><span class="params">(buffer, fail)</span> {</span>
  <span class="keyword">while</span> (<span class="literal">true</span>) {
    <span class="keyword">var</span> tag = derDecodeTag(buffer, fail);
    <span class="keyword">if</span> (buffer.isError(tag))
      <span class="keyword">return</span> tag;
    <span class="keyword">var</span> len = derDecodeLen(buffer, tag.primitive, fail);
    <span class="keyword">if</span> (buffer.isError(len))
      <span class="keyword">return</span> len;

    <span class="keyword">var</span> res;
    <span class="keyword">if</span> (tag.primitive || len !== <span class="literal">null</span>)
      res = buffer.skip(len)
    <span class="keyword">else</span>
      res = <span class="keyword">this</span>._skipUntilEnd(buffer, fail);

    <span class="comment">// Failure</span>
    <span class="keyword">if</span> (buffer.isError(res))
      <span class="keyword">return</span> res;

    <span class="keyword">if</span> (tag.tagStr === <span class="string">'end'</span>)
      <span class="keyword">break</span>;
  }
};

DERNode.prototype._decodeList = <span class="function"><span class="keyword">function</span> <span class="title">decodeList</span><span class="params">(buffer, tag, decoder,
                                                    options)</span> {</span>
  <span class="keyword">var</span> result = [];
  <span class="keyword">while</span> (!buffer.isEmpty()) {
    <span class="keyword">var</span> possibleEnd = <span class="keyword">this</span>._peekTag(buffer, <span class="string">'end'</span>);
    <span class="keyword">if</span> (buffer.isError(possibleEnd))
      <span class="keyword">return</span> possibleEnd;

    <span class="keyword">var</span> res = decoder.decode(buffer, <span class="string">'der'</span>, options);
    <span class="keyword">if</span> (buffer.isError(res) &amp;&amp; possibleEnd)
      <span class="keyword">break</span>;
    result.push(res);
  }
  <span class="keyword">return</span> result;
};

DERNode.prototype._decodeStr = <span class="function"><span class="keyword">function</span> <span class="title">decodeStr</span><span class="params">(buffer, tag)</span> {</span>
  <span class="keyword">if</span> (tag === <span class="string">'bitstr'</span>) {
    <span class="keyword">var</span> unused = buffer.readUInt8();
    <span class="keyword">if</span> (buffer.isError(unused))
      <span class="keyword">return</span> unused;
    <span class="keyword">return</span> { unused: unused, data: buffer.raw() };
  } <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'bmpstr'</span>) {
    <span class="keyword">var</span> raw = buffer.raw();
    <span class="keyword">if</span> (raw.length % <span class="number">2</span> === <span class="number">1</span>)
      <span class="keyword">return</span> buffer.error(<span class="string">'Decoding of string type: bmpstr length mismatch'</span>);

    <span class="keyword">var</span> str = <span class="string">''</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; raw.length / <span class="number">2</span>; i++) {
      str += String.fromCharCode(raw.readUInt16BE(i * <span class="number">2</span>));
    }
    <span class="keyword">return</span> str;
  } <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'numstr'</span>) {
    <span class="keyword">var</span> numstr = buffer.raw().toString(<span class="string">'ascii'</span>);
    <span class="keyword">if</span> (!<span class="keyword">this</span>._isNumstr(numstr)) {
      <span class="keyword">return</span> buffer.error(<span class="string">'Decoding of string type: '</span> +
                          <span class="string">'numstr unsupported characters'</span>);
    }
    <span class="keyword">return</span> numstr;
  } <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'octstr'</span>) {
    <span class="keyword">return</span> buffer.raw();
  } <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'objDesc'</span>) {
    <span class="keyword">return</span> buffer.raw();
  } <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'printstr'</span>) {
    <span class="keyword">var</span> printstr = buffer.raw().toString(<span class="string">'ascii'</span>);
    <span class="keyword">if</span> (!<span class="keyword">this</span>._isPrintstr(printstr)) {
      <span class="keyword">return</span> buffer.error(<span class="string">'Decoding of string type: '</span> +
                          <span class="string">'printstr unsupported characters'</span>);
    }
    <span class="keyword">return</span> printstr;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/str$/</span>.test(tag)) {
    <span class="keyword">return</span> buffer.raw().toString();
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> buffer.error(<span class="string">'Decoding of string type: '</span> + tag + <span class="string">' unsupported'</span>);
  }
};

DERNode.prototype._decodeObjid = <span class="function"><span class="keyword">function</span> <span class="title">decodeObjid</span><span class="params">(buffer, values, relative)</span> {</span>
  <span class="keyword">var</span> result;
  <span class="keyword">var</span> identifiers = [];
  <span class="keyword">var</span> ident = <span class="number">0</span>;
  <span class="keyword">while</span> (!buffer.isEmpty()) {
    <span class="keyword">var</span> subident = buffer.readUInt8();
    ident &lt;&lt;= <span class="number">7</span>;
    ident |= subident &amp; <span class="number">0x7f</span>;
    <span class="keyword">if</span> ((subident &amp; <span class="number">0x80</span>) === <span class="number">0</span>) {
      identifiers.push(ident);
      ident = <span class="number">0</span>;
    }
  }
  <span class="keyword">if</span> (subident &amp; <span class="number">0x80</span>)
    identifiers.push(ident);

  <span class="keyword">var</span> first = (identifiers[<span class="number">0</span>] / <span class="number">40</span>) | <span class="number">0</span>;
  <span class="keyword">var</span> second = identifiers[<span class="number">0</span>] % <span class="number">40</span>;

  <span class="keyword">if</span> (relative)
    result = identifiers;
  <span class="keyword">else</span>
    result = [first, second].concat(identifiers.slice(<span class="number">1</span>));

  <span class="keyword">if</span> (values) {
    <span class="keyword">var</span> tmp = values[result.join(<span class="string">' '</span>)];
    <span class="keyword">if</span> (tmp === <span class="literal">undefined</span>)
      tmp = values[result.join(<span class="string">'.'</span>)];
    <span class="keyword">if</span> (tmp !== <span class="literal">undefined</span>)
      result = tmp;
  }

  <span class="keyword">return</span> result;
};

DERNode.prototype._decodeTime = <span class="function"><span class="keyword">function</span> <span class="title">decodeTime</span><span class="params">(buffer, tag)</span> {</span>
  <span class="keyword">var</span> str = buffer.raw().toString();
  <span class="keyword">if</span> (tag === <span class="string">'gentime'</span>) {
    <span class="keyword">var</span> year = str.slice(<span class="number">0</span>, <span class="number">4</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> mon = str.slice(<span class="number">4</span>, <span class="number">6</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> day = str.slice(<span class="number">6</span>, <span class="number">8</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> hour = str.slice(<span class="number">8</span>, <span class="number">10</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> min = str.slice(<span class="number">10</span>, <span class="number">12</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> sec = str.slice(<span class="number">12</span>, <span class="number">14</span>) | <span class="number">0</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="string">'utctime'</span>) {
    <span class="keyword">var</span> year = str.slice(<span class="number">0</span>, <span class="number">2</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> mon = str.slice(<span class="number">2</span>, <span class="number">4</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> day = str.slice(<span class="number">4</span>, <span class="number">6</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> hour = str.slice(<span class="number">6</span>, <span class="number">8</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> min = str.slice(<span class="number">8</span>, <span class="number">10</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> sec = str.slice(<span class="number">10</span>, <span class="number">12</span>) | <span class="number">0</span>;
    <span class="keyword">if</span> (year &lt; <span class="number">70</span>)
      year = <span class="number">2000</span> + year;
    <span class="keyword">else</span>
      year = <span class="number">1900</span> + year;
  } <span class="keyword">else</span> {
    <span class="keyword">return</span> buffer.error(<span class="string">'Decoding '</span> + tag + <span class="string">' time is not supported yet'</span>);
  }

  <span class="keyword">return</span> Date.UTC(year, mon - <span class="number">1</span>, day, hour, min, sec, <span class="number">0</span>);
};

DERNode.prototype._decodeNull = <span class="function"><span class="keyword">function</span> <span class="title">decodeNull</span><span class="params">(buffer)</span> {</span>
  <span class="keyword">return</span> <span class="literal">null</span>;
};

DERNode.prototype._decodeBool = <span class="function"><span class="keyword">function</span> <span class="title">decodeBool</span><span class="params">(buffer)</span> {</span>
  <span class="keyword">var</span> res = buffer.readUInt8();
  <span class="keyword">if</span> (buffer.isError(res))
    <span class="keyword">return</span> res;
  <span class="keyword">else</span>
    <span class="keyword">return</span> res !== <span class="number">0</span>;
};

DERNode.prototype._decodeInt = <span class="function"><span class="keyword">function</span> <span class="title">decodeInt</span><span class="params">(buffer, values)</span> {</span>
  <span class="comment">// Bigint, return as it is (assume big endian)</span>
  <span class="keyword">var</span> raw = buffer.raw();
  <span class="keyword">var</span> res = <span class="keyword">new</span> bignum(raw);

  <span class="keyword">if</span> (values)
    res = values[res.toString(<span class="number">10</span>)] || res;

  <span class="keyword">return</span> res;
};

DERNode.prototype._use = <span class="function"><span class="keyword">function</span> <span class="title">use</span><span class="params">(entity, obj)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> entity === <span class="string">'function'</span>)
    entity = entity(obj);
  <span class="keyword">return</span> entity._getDecoder(<span class="string">'der'</span>).tree;
};

<span class="comment">// Utility methods</span>

<span class="function"><span class="keyword">function</span> <span class="title">derDecodeTag</span><span class="params">(buf, fail)</span> {</span>
  <span class="keyword">var</span> tag = buf.readUInt8(fail);
  <span class="keyword">if</span> (buf.isError(tag))
    <span class="keyword">return</span> tag;

  <span class="keyword">var</span> cls = der.tagClass[tag >> <span class="number">6</span>];
  <span class="keyword">var</span> primitive = (tag &amp; <span class="number">0x20</span>) === <span class="number">0</span>;

  <span class="comment">// Multi-octet tag - load</span>
  <span class="keyword">if</span> ((tag &amp; <span class="number">0x1f</span>) === <span class="number">0x1f</span>) {
    <span class="keyword">var</span> oct = tag;
    tag = <span class="number">0</span>;
    <span class="keyword">while</span> ((oct &amp; <span class="number">0x80</span>) === <span class="number">0x80</span>) {
      oct = buf.readUInt8(fail);
      <span class="keyword">if</span> (buf.isError(oct))
        <span class="keyword">return</span> oct;

      tag &lt;&lt;= <span class="number">7</span>;
      tag |= oct &amp; <span class="number">0x7f</span>;
    }
  } <span class="keyword">else</span> {
    tag &amp;= <span class="number">0x1f</span>;
  }
  <span class="keyword">var</span> tagStr = der.tag[tag];

  <span class="keyword">return</span> {
    cls: cls,
    primitive: primitive,
    tag: tag,
    tagStr: tagStr
  };
}

<span class="function"><span class="keyword">function</span> <span class="title">derDecodeLen</span><span class="params">(buf, primitive, fail)</span> {</span>
  <span class="keyword">var</span> len = buf.readUInt8(fail);
  <span class="keyword">if</span> (buf.isError(len))
    <span class="keyword">return</span> len;

  <span class="comment">// Indefinite form</span>
  <span class="keyword">if</span> (!primitive &amp;&amp; len === <span class="number">0x80</span>)
    <span class="keyword">return</span> <span class="literal">null</span>;

  <span class="comment">// Definite form</span>
  <span class="keyword">if</span> ((len &amp; <span class="number">0x80</span>) === <span class="number">0</span>) {
    <span class="comment">// Short form</span>
    <span class="keyword">return</span> len;
  }

  <span class="comment">// Long form</span>
  <span class="keyword">var</span> num = len &amp; <span class="number">0x7f</span>;
  <span class="keyword">if</span> (num > <span class="number">4</span>)
    <span class="keyword">return</span> buf.error(<span class="string">'length octect is too long'</span>);

  len = <span class="number">0</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; num; i++) {
    len &lt;&lt;= <span class="number">8</span>;
    <span class="keyword">var</span> j = buf.readUInt8(fail);
    <span class="keyword">if</span> (buf.isError(j))
      <span class="keyword">return</span> j;
    len |= j;
  }

  <span class="keyword">return</span> len;
}
</code></pre>