<h1>pem.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);
<span class="keyword">var</span> Buffer = require(<span class="string">'buffer'</span>).Buffer;

<span class="keyword">var</span> DERDecoder = require(<span class="string">'./der'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">PEMDecoder</span><span class="params">(entity)</span> {</span>
  DERDecoder.call(<span class="keyword">this</span>, entity);
  <span class="keyword">this</span>.enc = <span class="string">'pem'</span>;
};
inherits(PEMDecoder, DERDecoder);
module.exports = PEMDecoder;

PEMDecoder.prototype.decode = <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">(data, options)</span> {</span>
  <span class="keyword">var</span> lines = data.toString().split(<span class="regexp">/[\r\n]+/g</span>);

  <span class="keyword">var</span> label = options.label.toUpperCase();

  <span class="keyword">var</span> re = <span class="regexp">/^-----(BEGIN|END) ([^-]+)-----$/</span>;
  <span class="keyword">var</span> start = -<span class="number">1</span>;
  <span class="keyword">var</span> end = -<span class="number">1</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; lines.length; i++) {
    <span class="keyword">var</span> match = lines[i].match(re);
    <span class="keyword">if</span> (match === <span class="literal">null</span>)
      <span class="keyword">continue</span>;

    <span class="keyword">if</span> (match[<span class="number">2</span>] !== label)
      <span class="keyword">continue</span>;

    <span class="keyword">if</span> (start === -<span class="number">1</span>) {
      <span class="keyword">if</span> (match[<span class="number">1</span>] !== <span class="string">'BEGIN'</span>)
        <span class="keyword">break</span>;
      start = i;
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (match[<span class="number">1</span>] !== <span class="string">'END'</span>)
        <span class="keyword">break</span>;
      end = i;
      <span class="keyword">break</span>;
    }
  }
  <span class="keyword">if</span> (start === -<span class="number">1</span> || end === -<span class="number">1</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'PEM section not found for: '</span> + label);

  <span class="keyword">var</span> base64 = lines.slice(start + <span class="number">1</span>, end).join(<span class="string">''</span>);
  <span class="comment">// Remove excessive symbols</span>
  base64.replace(<span class="regexp">/[^a-z0-9\+\/=]+/gi</span>, <span class="string">''</span>);

  <span class="keyword">var</span> input = <span class="keyword">new</span> Buffer(base64, <span class="string">'base64'</span>);
  <span class="keyword">return</span> DERDecoder.prototype.decode.call(<span class="keyword">this</span>, input, options);
};
</code></pre>