<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> through = require(<span class="string">'through2'</span>);
<span class="keyword">var</span> shasum = require(<span class="string">'shasum'</span>);

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(opts)</span> {</span>
    <span class="keyword">if</span> (!opts) opts = {};
    <span class="keyword">var</span> rows = [];
    <span class="keyword">return</span> through.obj(write, end);
    
    <span class="function"><span class="keyword">function</span> <span class="title">write</span> <span class="params">(row, enc, next)</span> {</span> rows.push(row); next() }
    
    <span class="function"><span class="keyword">function</span> <span class="title">end</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> tr = <span class="keyword">this</span>;
        rows.sort(cmp);
        sorter(rows, tr, opts);
    }
};

<span class="function"><span class="keyword">function</span> <span class="title">sorter</span> <span class="params">(rows, tr, opts)</span> {</span>
    <span class="keyword">var</span> expose = opts.expose || {};
    <span class="keyword">if</span> (Array.isArray(expose)) {
        expose = expose.reduce(<span class="function"><span class="keyword">function</span> <span class="params">(acc, key)</span> {</span>
            acc[key] = <span class="literal">true</span>;
            <span class="keyword">return</span> acc;
        }, {});
    }
    
    <span class="keyword">var</span> hashes = {}, deduped = {};
    <span class="keyword">var</span> sameDeps = depCmp();
    
    <span class="keyword">if</span> (opts.dedupe) {
        rows.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(row)</span> {</span>
            <span class="keyword">var</span> h = shasum(row.source);
            sameDeps.add(row, h);
            <span class="keyword">if</span> (hashes[h]) {
                hashes[h].push(row);
            } <span class="keyword">else</span> {
                hashes[h] = [row];
            }
        });
        Object.keys(hashes).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(h)</span> {</span>
            <span class="keyword">var</span> rows = hashes[h];
            <span class="keyword">while</span> (rows.length > <span class="number">1</span>) {
                <span class="keyword">var</span> row = rows.pop();
                row.dedupe = rows[<span class="number">0</span>].id;
                row.sameDeps = sameDeps.cmp(rows[<span class="number">0</span>].deps, row.deps);
                deduped[row.id] = rows[<span class="number">0</span>].id;
            }
        });
    }
    
    <span class="keyword">if</span> (opts.index) {
        <span class="keyword">var</span> index = {};
        <span class="keyword">var</span> offset = <span class="number">0</span>;
        rows.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(row, ix)</span> {</span>
            <span class="keyword">if</span> (has(expose, row.id)) {
                row.index = row.id;
                offset ++;
                <span class="keyword">if</span> (expose[row.id] !== <span class="literal">true</span>) {
                    index[expose[row.id]] = row.index;
                }
            }
            <span class="keyword">else</span> {
                row.index = ix + <span class="number">1</span> - offset;
            }
            index[row.id] = row.index;
        });
        rows.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(row)</span> {</span>
            row.indexDeps = {};
            Object.keys(row.deps).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
                <span class="keyword">var</span> id = row.deps[key];
                row.indexDeps[key] = index[id];
            });
            <span class="keyword">if</span> (row.dedupe) {
                row.dedupeIndex = index[row.dedupe];
            }
            tr.push(row);
        });
    }
    <span class="keyword">else</span> {
        rows.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(row)</span> {</span> tr.push(row) });
    }
    tr.push(<span class="literal">null</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">cmp</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">return</span> a.id + a.hash &lt; b.id + b.hash ? -<span class="number">1</span> : <span class="number">1</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">has</span> <span class="params">(obj, key)</span> {</span>
    <span class="keyword">return</span> Object.prototype.hasOwnProperty.call(obj, key);
}

<span class="function"><span class="keyword">function</span> <span class="title">depCmp</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> deps = {}, hashes = {};
    <span class="keyword">return</span> { add: add, cmp: cmp }
    
    <span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">(row, hash)</span> {</span>
        deps[row.id] = row.deps;
        hashes[row.id] = hash;
    }
    <span class="function"><span class="keyword">function</span> <span class="title">cmp</span> <span class="params">(a, b, limit)</span> {</span>
        <span class="keyword">if</span> (!a &amp;&amp; !b) <span class="keyword">return</span> <span class="literal">true</span>;
        <span class="keyword">if</span> (!a || !b) <span class="keyword">return</span> <span class="literal">false</span>;
        
        <span class="keyword">var</span> keys = Object.keys(a);
        <span class="keyword">if</span> (keys.length !== Object.keys(b).length) <span class="keyword">return</span> <span class="literal">false</span>;

        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) {
            <span class="keyword">var</span> k = keys[i], ka = a[k], kb = b[k];
            <span class="keyword">var</span> ha = hashes[ka];
            <span class="keyword">var</span> hb = hashes[kb];
            <span class="keyword">var</span> da = deps[ka];
            <span class="keyword">var</span> db = deps[kb];

            <span class="keyword">if</span> (ka === kb) <span class="keyword">continue</span>;
            <span class="keyword">if</span> (ha !== hb || (!limit &amp;&amp; !cmp(da, db, <span class="number">1</span>))) {
                <span class="keyword">return</span> <span class="literal">false</span>;
            }
        }
        <span class="keyword">return</span> <span class="literal">true</span>;
    }
}
</code></pre>