<h1>index.js</h1>
<pre><code class="lang-js"><span class="comment">// This file should be ES5 compatible</span>
<span class="comment">/* eslint prefer-spread:0, no-var:0, prefer-reflect:0, no-magic-numbers:0 */</span>
<span class="string">'use strict'</span>

module.exports = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
	<span class="comment">// Import Events</span>
	<span class="keyword">var</span> events = require(<span class="string">'events'</span>)

	<span class="comment">// Export Domain</span>
	<span class="keyword">var</span> domain = {}
	domain.createDomain = domain.create = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
		<span class="keyword">var</span> d = <span class="keyword">new</span> events.EventEmitter()

		<span class="function"><span class="keyword">function</span> <span class="title">emitError</span> <span class="params">(e)</span> {</span>
			d.emit(<span class="string">'error'</span>, e)
		}

		d.add = <span class="function"><span class="keyword">function</span> <span class="params">(emitter)</span> {</span>
			emitter.on(<span class="string">'error'</span>, emitError)
		}
		d.remove = <span class="function"><span class="keyword">function</span> <span class="params">(emitter)</span> {</span>
			emitter.removeListener(<span class="string">'error'</span>, emitError)
		}
		d.bind = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
			<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
				<span class="keyword">var</span> args = Array.prototype.slice.call(arguments)
				<span class="keyword">try</span> {
					fn.apply(<span class="literal">null</span>, args)
				}
				<span class="keyword">catch</span> (err) {
					emitError(err)
				}
			}
		}
		d.intercept = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
			<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
				<span class="keyword">if</span> ( err ) {
					emitError(err)
				}
				<span class="keyword">else</span> {
					<span class="keyword">var</span> args = Array.prototype.slice.call(arguments, <span class="number">1</span>)
					<span class="keyword">try</span> {
						fn.apply(<span class="literal">null</span>, args)
					}
					<span class="keyword">catch</span> (err) {
						emitError(err)
					}
				}
			}
		}
		d.run = <span class="function"><span class="keyword">function</span> <span class="params">(fn)</span> {</span>
			<span class="keyword">try</span> {
				fn()
			}
			<span class="keyword">catch</span> (err) {
				emitError(err)
			}
			<span class="keyword">return</span> <span class="keyword">this</span>
		}
		d.dispose = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
			<span class="keyword">this</span>.removeAllListeners()
			<span class="keyword">return</span> <span class="keyword">this</span>
		}
		d.enter = d.exit = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
			<span class="keyword">return</span> <span class="keyword">this</span>
		}
		<span class="keyword">return</span> d
	}
	<span class="keyword">return</span> domain
}).call(<span class="keyword">this</span>)
</code></pre>