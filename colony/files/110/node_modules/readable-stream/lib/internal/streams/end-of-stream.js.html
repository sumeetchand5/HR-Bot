<h1>end-of-stream.js</h1>
<pre><code class="lang-js"><span class="comment">// Ported from https://github.com/mafintosh/end-of-stream with</span>
<span class="comment">// permission from the author, Mathias Buus (@mafintosh).</span>
<span class="string">'use strict'</span>;

<span class="keyword">var</span> ERR_STREAM_PREMATURE_CLOSE = require(<span class="string">'../../../errors'</span>).codes.ERR_STREAM_PREMATURE_CLOSE;

<span class="function"><span class="keyword">function</span> <span class="title">once</span><span class="params">(callback)</span> {</span>
  <span class="keyword">var</span> called = <span class="literal">false</span>;
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (called) <span class="keyword">return</span>;
    called = <span class="literal">true</span>;

    <span class="keyword">for</span> (<span class="keyword">var</span> _len = arguments.length, args = <span class="keyword">new</span> Array(_len), _key = <span class="number">0</span>; _key &lt; _len; _key++) {
      args[_key] = arguments[_key];
    }

    callback.apply(<span class="keyword">this</span>, args);
  };
}

<span class="function"><span class="keyword">function</span> <span class="title">noop</span><span class="params">()</span> {</span>}

<span class="function"><span class="keyword">function</span> <span class="title">isRequest</span><span class="params">(stream)</span> {</span>
  <span class="keyword">return</span> stream.setHeader &amp;&amp; <span class="keyword">typeof</span> stream.abort === <span class="string">'function'</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">eos</span><span class="params">(stream, opts, callback)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> opts === <span class="string">'function'</span>) <span class="keyword">return</span> eos(stream, <span class="literal">null</span>, opts);
  <span class="keyword">if</span> (!opts) opts = {};
  callback = once(callback || noop);
  <span class="keyword">var</span> readable = opts.readable || opts.readable !== <span class="literal">false</span> &amp;&amp; stream.readable;
  <span class="keyword">var</span> writable = opts.writable || opts.writable !== <span class="literal">false</span> &amp;&amp; stream.writable;

  <span class="keyword">var</span> onlegacyfinish = <span class="function"><span class="keyword">function</span> <span class="title">onlegacyfinish</span><span class="params">()</span> {</span>
    <span class="keyword">if</span> (!stream.writable) onfinish();
  };

  <span class="keyword">var</span> writableEnded = stream._writableState &amp;&amp; stream._writableState.finished;

  <span class="keyword">var</span> onfinish = <span class="function"><span class="keyword">function</span> <span class="title">onfinish</span><span class="params">()</span> {</span>
    writable = <span class="literal">false</span>;
    writableEnded = <span class="literal">true</span>;
    <span class="keyword">if</span> (!readable) callback.call(stream);
  };

  <span class="keyword">var</span> readableEnded = stream._readableState &amp;&amp; stream._readableState.endEmitted;

  <span class="keyword">var</span> onend = <span class="function"><span class="keyword">function</span> <span class="title">onend</span><span class="params">()</span> {</span>
    readable = <span class="literal">false</span>;
    readableEnded = <span class="literal">true</span>;
    <span class="keyword">if</span> (!writable) callback.call(stream);
  };

  <span class="keyword">var</span> onerror = <span class="function"><span class="keyword">function</span> <span class="title">onerror</span><span class="params">(err)</span> {</span>
    callback.call(stream, err);
  };

  <span class="keyword">var</span> onclose = <span class="function"><span class="keyword">function</span> <span class="title">onclose</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> err;

    <span class="keyword">if</span> (readable &amp;&amp; !readableEnded) {
      <span class="keyword">if</span> (!stream._readableState || !stream._readableState.ended) err = <span class="keyword">new</span> ERR_STREAM_PREMATURE_CLOSE();
      <span class="keyword">return</span> callback.call(stream, err);
    }

    <span class="keyword">if</span> (writable &amp;&amp; !writableEnded) {
      <span class="keyword">if</span> (!stream._writableState || !stream._writableState.ended) err = <span class="keyword">new</span> ERR_STREAM_PREMATURE_CLOSE();
      <span class="keyword">return</span> callback.call(stream, err);
    }
  };

  <span class="keyword">var</span> onrequest = <span class="function"><span class="keyword">function</span> <span class="title">onrequest</span><span class="params">()</span> {</span>
    stream.req.on(<span class="string">'finish'</span>, onfinish);
  };

  <span class="keyword">if</span> (isRequest(stream)) {
    stream.on(<span class="string">'complete'</span>, onfinish);
    stream.on(<span class="string">'abort'</span>, onclose);
    <span class="keyword">if</span> (stream.req) onrequest();<span class="keyword">else</span> stream.on(<span class="string">'request'</span>, onrequest);
  } <span class="keyword">else</span> <span class="keyword">if</span> (writable &amp;&amp; !stream._writableState) {
    <span class="comment">// legacy streams</span>
    stream.on(<span class="string">'end'</span>, onlegacyfinish);
    stream.on(<span class="string">'close'</span>, onlegacyfinish);
  }

  stream.on(<span class="string">'end'</span>, onend);
  stream.on(<span class="string">'finish'</span>, onfinish);
  <span class="keyword">if</span> (opts.error !== <span class="literal">false</span>) stream.on(<span class="string">'error'</span>, onerror);
  stream.on(<span class="string">'close'</span>, onclose);
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    stream.removeListener(<span class="string">'complete'</span>, onfinish);
    stream.removeListener(<span class="string">'abort'</span>, onclose);
    stream.removeListener(<span class="string">'request'</span>, onrequest);
    <span class="keyword">if</span> (stream.req) stream.req.removeListener(<span class="string">'finish'</span>, onfinish);
    stream.removeListener(<span class="string">'end'</span>, onlegacyfinish);
    stream.removeListener(<span class="string">'close'</span>, onlegacyfinish);
    stream.removeListener(<span class="string">'finish'</span>, onfinish);
    stream.removeListener(<span class="string">'end'</span>, onend);
    stream.removeListener(<span class="string">'error'</span>, onerror);
    stream.removeListener(<span class="string">'close'</span>, onclose);
  };
}

module.exports = eos;</code></pre>