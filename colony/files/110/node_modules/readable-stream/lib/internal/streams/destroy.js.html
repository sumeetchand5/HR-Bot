<h1>destroy.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>; <span class="comment">// undocumented cb() API, needed for core, not for public API</span>

<span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">(err, cb)</span> {</span>
  <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;

  <span class="keyword">var</span> readableDestroyed = <span class="keyword">this</span>._readableState &amp;&amp; <span class="keyword">this</span>._readableState.destroyed;
  <span class="keyword">var</span> writableDestroyed = <span class="keyword">this</span>._writableState &amp;&amp; <span class="keyword">this</span>._writableState.destroyed;

  <span class="keyword">if</span> (readableDestroyed || writableDestroyed) {
    <span class="keyword">if</span> (cb) {
      cb(err);
    } <span class="keyword">else</span> <span class="keyword">if</span> (err &amp;&amp; (!<span class="keyword">this</span>._writableState || !<span class="keyword">this</span>._writableState.errorEmitted)) {
      process.nextTick(emitErrorNT, <span class="keyword">this</span>, err);
    }

    <span class="keyword">return</span> <span class="keyword">this</span>;
  } <span class="comment">// we set destroyed to true before firing error callbacks in order</span>
  <span class="comment">// to make it re-entrance safe in case destroy() is called within callbacks</span>


  <span class="keyword">if</span> (<span class="keyword">this</span>._readableState) {
    <span class="keyword">this</span>._readableState.destroyed = <span class="literal">true</span>;
  } <span class="comment">// if this is a duplex stream mark the writable part as destroyed as well</span>


  <span class="keyword">if</span> (<span class="keyword">this</span>._writableState) {
    <span class="keyword">this</span>._writableState.destroyed = <span class="literal">true</span>;
  }

  <span class="keyword">this</span>._destroy(err || <span class="literal">null</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span>
    <span class="keyword">if</span> (!cb &amp;&amp; err) {
      process.nextTick(emitErrorAndCloseNT, _<span class="keyword">this</span>, err);

      <span class="keyword">if</span> (_<span class="keyword">this</span>._writableState) {
        _<span class="keyword">this</span>._writableState.errorEmitted = <span class="literal">true</span>;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (cb) {
      process.nextTick(emitCloseNT, _<span class="keyword">this</span>);
      cb(err);
    } <span class="keyword">else</span> {
      process.nextTick(emitCloseNT, _<span class="keyword">this</span>);
    }
  });

  <span class="keyword">return</span> <span class="keyword">this</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">emitErrorAndCloseNT</span><span class="params">(self, err)</span> {</span>
  emitErrorNT(self, err);
  emitCloseNT(self);
}

<span class="function"><span class="keyword">function</span> <span class="title">emitCloseNT</span><span class="params">(self)</span> {</span>
  <span class="keyword">if</span> (self._writableState &amp;&amp; !self._writableState.emitClose) <span class="keyword">return</span>;
  <span class="keyword">if</span> (self._readableState &amp;&amp; !self._readableState.emitClose) <span class="keyword">return</span>;
  self.emit(<span class="string">'close'</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">undestroy</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._readableState) {
    <span class="keyword">this</span>._readableState.destroyed = <span class="literal">false</span>;
    <span class="keyword">this</span>._readableState.reading = <span class="literal">false</span>;
    <span class="keyword">this</span>._readableState.ended = <span class="literal">false</span>;
    <span class="keyword">this</span>._readableState.endEmitted = <span class="literal">false</span>;
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>._writableState) {
    <span class="keyword">this</span>._writableState.destroyed = <span class="literal">false</span>;
    <span class="keyword">this</span>._writableState.ended = <span class="literal">false</span>;
    <span class="keyword">this</span>._writableState.ending = <span class="literal">false</span>;
    <span class="keyword">this</span>._writableState.finalCalled = <span class="literal">false</span>;
    <span class="keyword">this</span>._writableState.prefinished = <span class="literal">false</span>;
    <span class="keyword">this</span>._writableState.finished = <span class="literal">false</span>;
    <span class="keyword">this</span>._writableState.errorEmitted = <span class="literal">false</span>;
  }
}

<span class="function"><span class="keyword">function</span> <span class="title">emitErrorNT</span><span class="params">(self, err)</span> {</span>
  self.emit(<span class="string">'error'</span>, err);
}

module.exports = {
  destroy: destroy,
  undestroy: undestroy
};</code></pre>