<h1>fixProc.js</h1>
<pre><code class="lang-js"><span class="comment">// adapted from https://github.com/apatil/pemstrip</span>
<span class="keyword">var</span> findProc = <span class="regexp">/Proc-Type: 4,ENCRYPTED[\n\r]+DEK-Info: AES-((?:128)|(?:192)|(?:256))-CBC,([0-9A-H]+)[\n\r]+([0-9A-z\n\r\+\/\=]+)[\n\r]+/m</span>
<span class="keyword">var</span> startRegex = <span class="regexp">/^-----BEGIN ((?:.*? KEY)|CERTIFICATE)-----/m</span>
<span class="keyword">var</span> fullRegex = <span class="regexp">/^-----BEGIN ((?:.*? KEY)|CERTIFICATE)-----([0-9A-z\n\r\+\/\=]+)-----END \1-----$/m</span>
<span class="keyword">var</span> evp = require(<span class="string">'evp_bytestokey'</span>)
<span class="keyword">var</span> ciphers = require(<span class="string">'browserify-aes'</span>)
<span class="keyword">var</span> Buffer = require(<span class="string">'safe-buffer'</span>).Buffer
module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(okey, password)</span> {</span>
  <span class="keyword">var</span> key = okey.toString()
  <span class="keyword">var</span> match = key.match(findProc)
  <span class="keyword">var</span> decrypted
  <span class="keyword">if</span> (!match) {
    <span class="keyword">var</span> match2 = key.match(fullRegex)
    decrypted = <span class="keyword">new</span> Buffer(match2[<span class="number">2</span>].replace(<span class="regexp">/[\r\n]/g</span>, <span class="string">''</span>), <span class="string">'base64'</span>)
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> suite = <span class="string">'aes'</span> + match[<span class="number">1</span>]
    <span class="keyword">var</span> iv = Buffer.from(match[<span class="number">2</span>], <span class="string">'hex'</span>)
    <span class="keyword">var</span> cipherText = Buffer.from(match[<span class="number">3</span>].replace(<span class="regexp">/[\r\n]/g</span>, <span class="string">''</span>), <span class="string">'base64'</span>)
    <span class="keyword">var</span> cipherKey = evp(password, iv.slice(<span class="number">0</span>, <span class="number">8</span>), parseInt(match[<span class="number">1</span>], <span class="number">10</span>)).key
    <span class="keyword">var</span> out = []
    <span class="keyword">var</span> cipher = ciphers.createDecipheriv(suite, cipherKey, iv)
    out.push(cipher.update(cipherText))
    out.push(cipher.final())
    decrypted = Buffer.concat(out)
  }
  <span class="keyword">var</span> tag = key.match(startRegex)[<span class="number">1</span>]
  <span class="keyword">return</span> {
    tag: tag,
    data: decrypted
  }
}
</code></pre>