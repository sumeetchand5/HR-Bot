<h1>index.js</h1>
<pre><code class="lang-js"><span class="comment">// Copyright Joyent, Inc. and other Node contributors.</span>
<span class="comment">//</span>
<span class="comment">// Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="comment">// copy of this software and associated documentation files (the</span>
<span class="comment">// "Software"), to deal in the Software without restriction, including</span>
<span class="comment">// without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="comment">// distribute, sublicense, and/or sell copies of the Software, and to permit</span>
<span class="comment">// persons to whom the Software is furnished to do so, subject to the</span>
<span class="comment">// following conditions:</span>
<span class="comment">//</span>
<span class="comment">// The above copyright notice and this permission notice shall be included</span>
<span class="comment">// in all copies or substantial portions of the Software.</span>
<span class="comment">//</span>
<span class="comment">// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="comment">// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="comment">// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN</span>
<span class="comment">// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,</span>
<span class="comment">// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<span class="comment">// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<span class="comment">// USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

module.exports = Stream;

<span class="keyword">var</span> EE = require(<span class="string">'events'</span>).EventEmitter;
<span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);

inherits(Stream, EE);
Stream.Readable = require(<span class="string">'readable-stream/readable.js'</span>);
Stream.Writable = require(<span class="string">'readable-stream/writable.js'</span>);
Stream.Duplex = require(<span class="string">'readable-stream/duplex.js'</span>);
Stream.Transform = require(<span class="string">'readable-stream/transform.js'</span>);
Stream.PassThrough = require(<span class="string">'readable-stream/passthrough.js'</span>);

<span class="comment">// Backwards-compat with node 0.4.x</span>
Stream.Stream = Stream;



<span class="comment">// old-style streams.  Note that the pipe method (the only relevant</span>
<span class="comment">// part of this class) is overridden in the Readable class.</span>

<span class="function"><span class="keyword">function</span> <span class="title">Stream</span><span class="params">()</span> {</span>
  EE.call(<span class="keyword">this</span>);
}

Stream.prototype.pipe = <span class="keyword">function</span>(dest, options) {
  <span class="keyword">var</span> source = <span class="keyword">this</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">ondata</span><span class="params">(chunk)</span> {</span>
    <span class="keyword">if</span> (dest.writable) {
      <span class="keyword">if</span> (<span class="literal">false</span> === dest.write(chunk) &amp;&amp; source.pause) {
        source.pause();
      }
    }
  }

  source.on(<span class="string">'data'</span>, ondata);

  <span class="function"><span class="keyword">function</span> <span class="title">ondrain</span><span class="params">()</span> {</span>
    <span class="keyword">if</span> (source.readable &amp;&amp; source.resume) {
      source.resume();
    }
  }

  dest.on(<span class="string">'drain'</span>, ondrain);

  <span class="comment">// If the 'end' option is not supplied, dest.end() will be called when</span>
  <span class="comment">// source gets the 'end' or 'close' events.  Only dest.end() once.</span>
  <span class="keyword">if</span> (!dest._isStdio &amp;&amp; (!options || options.end !== <span class="literal">false</span>)) {
    source.on(<span class="string">'end'</span>, onend);
    source.on(<span class="string">'close'</span>, onclose);
  }

  <span class="keyword">var</span> didOnEnd = <span class="literal">false</span>;
  <span class="function"><span class="keyword">function</span> <span class="title">onend</span><span class="params">()</span> {</span>
    <span class="keyword">if</span> (didOnEnd) <span class="keyword">return</span>;
    didOnEnd = <span class="literal">true</span>;

    dest.end();
  }


  <span class="function"><span class="keyword">function</span> <span class="title">onclose</span><span class="params">()</span> {</span>
    <span class="keyword">if</span> (didOnEnd) <span class="keyword">return</span>;
    didOnEnd = <span class="literal">true</span>;

    <span class="keyword">if</span> (<span class="keyword">typeof</span> dest.destroy === <span class="string">'function'</span>) dest.destroy();
  }

  <span class="comment">// don't leave dangling pipes when there are errors.</span>
  <span class="function"><span class="keyword">function</span> <span class="title">onerror</span><span class="params">(er)</span> {</span>
    cleanup();
    <span class="keyword">if</span> (EE.listenerCount(<span class="keyword">this</span>, <span class="string">'error'</span>) === <span class="number">0</span>) {
      <span class="keyword">throw</span> er; <span class="comment">// Unhandled stream error in pipe.</span>
    }
  }

  source.on(<span class="string">'error'</span>, onerror);
  dest.on(<span class="string">'error'</span>, onerror);

  <span class="comment">// remove all the event listeners that were added.</span>
  <span class="function"><span class="keyword">function</span> <span class="title">cleanup</span><span class="params">()</span> {</span>
    source.removeListener(<span class="string">'data'</span>, ondata);
    dest.removeListener(<span class="string">'drain'</span>, ondrain);

    source.removeListener(<span class="string">'end'</span>, onend);
    source.removeListener(<span class="string">'close'</span>, onclose);

    source.removeListener(<span class="string">'error'</span>, onerror);
    dest.removeListener(<span class="string">'error'</span>, onerror);

    source.removeListener(<span class="string">'end'</span>, cleanup);
    source.removeListener(<span class="string">'close'</span>, cleanup);

    dest.removeListener(<span class="string">'close'</span>, cleanup);
  }

  source.on(<span class="string">'end'</span>, cleanup);
  source.on(<span class="string">'close'</span>, cleanup);

  dest.on(<span class="string">'close'</span>, cleanup);

  dest.emit(<span class="string">'pipe'</span>, source);

  <span class="comment">// Allow for unix-like usage: A.pipe(B).pipe(C)</span>
  <span class="keyword">return</span> dest;
};
</code></pre>