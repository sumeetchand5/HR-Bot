<h1>256.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> utils = require(<span class="string">'../utils'</span>);
<span class="keyword">var</span> common = require(<span class="string">'../common'</span>);
<span class="keyword">var</span> shaCommon = require(<span class="string">'./common'</span>);
<span class="keyword">var</span> assert = require(<span class="string">'minimalistic-assert'</span>);

<span class="keyword">var</span> sum32 = utils.sum32;
<span class="keyword">var</span> sum32_4 = utils.sum32_4;
<span class="keyword">var</span> sum32_5 = utils.sum32_5;
<span class="keyword">var</span> ch32 = shaCommon.ch32;
<span class="keyword">var</span> maj32 = shaCommon.maj32;
<span class="keyword">var</span> s0_256 = shaCommon.s0_256;
<span class="keyword">var</span> s1_256 = shaCommon.s1_256;
<span class="keyword">var</span> g0_256 = shaCommon.g0_256;
<span class="keyword">var</span> g1_256 = shaCommon.g1_256;

<span class="keyword">var</span> BlockHash = common.BlockHash;

<span class="keyword">var</span> sha256_K = [
  <span class="number">0x428a2f98</span>, <span class="number">0x71374491</span>, <span class="number">0xb5c0fbcf</span>, <span class="number">0xe9b5dba5</span>,
  <span class="number">0x3956c25b</span>, <span class="number">0x59f111f1</span>, <span class="number">0x923f82a4</span>, <span class="number">0xab1c5ed5</span>,
  <span class="number">0xd807aa98</span>, <span class="number">0x12835b01</span>, <span class="number">0x243185be</span>, <span class="number">0x550c7dc3</span>,
  <span class="number">0x72be5d74</span>, <span class="number">0x80deb1fe</span>, <span class="number">0x9bdc06a7</span>, <span class="number">0xc19bf174</span>,
  <span class="number">0xe49b69c1</span>, <span class="number">0xefbe4786</span>, <span class="number">0x0fc19dc6</span>, <span class="number">0x240ca1cc</span>,
  <span class="number">0x2de92c6f</span>, <span class="number">0x4a7484aa</span>, <span class="number">0x5cb0a9dc</span>, <span class="number">0x76f988da</span>,
  <span class="number">0x983e5152</span>, <span class="number">0xa831c66d</span>, <span class="number">0xb00327c8</span>, <span class="number">0xbf597fc7</span>,
  <span class="number">0xc6e00bf3</span>, <span class="number">0xd5a79147</span>, <span class="number">0x06ca6351</span>, <span class="number">0x14292967</span>,
  <span class="number">0x27b70a85</span>, <span class="number">0x2e1b2138</span>, <span class="number">0x4d2c6dfc</span>, <span class="number">0x53380d13</span>,
  <span class="number">0x650a7354</span>, <span class="number">0x766a0abb</span>, <span class="number">0x81c2c92e</span>, <span class="number">0x92722c85</span>,
  <span class="number">0xa2bfe8a1</span>, <span class="number">0xa81a664b</span>, <span class="number">0xc24b8b70</span>, <span class="number">0xc76c51a3</span>,
  <span class="number">0xd192e819</span>, <span class="number">0xd6990624</span>, <span class="number">0xf40e3585</span>, <span class="number">0x106aa070</span>,
  <span class="number">0x19a4c116</span>, <span class="number">0x1e376c08</span>, <span class="number">0x2748774c</span>, <span class="number">0x34b0bcb5</span>,
  <span class="number">0x391c0cb3</span>, <span class="number">0x4ed8aa4a</span>, <span class="number">0x5b9cca4f</span>, <span class="number">0x682e6ff3</span>,
  <span class="number">0x748f82ee</span>, <span class="number">0x78a5636f</span>, <span class="number">0x84c87814</span>, <span class="number">0x8cc70208</span>,
  <span class="number">0x90befffa</span>, <span class="number">0xa4506ceb</span>, <span class="number">0xbef9a3f7</span>, <span class="number">0xc67178f2</span>
];

<span class="function"><span class="keyword">function</span> <span class="title">SHA256</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> SHA256))
    <span class="keyword">return</span> <span class="keyword">new</span> SHA256();

  BlockHash.call(<span class="keyword">this</span>);
  <span class="keyword">this</span>.h = [
    <span class="number">0x6a09e667</span>, <span class="number">0xbb67ae85</span>, <span class="number">0x3c6ef372</span>, <span class="number">0xa54ff53a</span>,
    <span class="number">0x510e527f</span>, <span class="number">0x9b05688c</span>, <span class="number">0x1f83d9ab</span>, <span class="number">0x5be0cd19</span>
  ];
  <span class="keyword">this</span>.k = sha256_K;
  <span class="keyword">this</span>.W = <span class="keyword">new</span> Array(<span class="number">64</span>);
}
utils.inherits(SHA256, BlockHash);
module.exports = SHA256;

SHA256.blockSize = <span class="number">512</span>;
SHA256.outSize = <span class="number">256</span>;
SHA256.hmacStrength = <span class="number">192</span>;
SHA256.padLength = <span class="number">64</span>;

SHA256.prototype._update = <span class="function"><span class="keyword">function</span> <span class="title">_update</span><span class="params">(msg, start)</span> {</span>
  <span class="keyword">var</span> W = <span class="keyword">this</span>.W;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)
    W[i] = msg[start + i];
  <span class="keyword">for</span> (; i &lt; W.length; i++)
    W[i] = sum32_4(g1_256(W[i - <span class="number">2</span>]), W[i - <span class="number">7</span>], g0_256(W[i - <span class="number">15</span>]), W[i - <span class="number">16</span>]);

  <span class="keyword">var</span> a = <span class="keyword">this</span>.h[<span class="number">0</span>];
  <span class="keyword">var</span> b = <span class="keyword">this</span>.h[<span class="number">1</span>];
  <span class="keyword">var</span> c = <span class="keyword">this</span>.h[<span class="number">2</span>];
  <span class="keyword">var</span> d = <span class="keyword">this</span>.h[<span class="number">3</span>];
  <span class="keyword">var</span> e = <span class="keyword">this</span>.h[<span class="number">4</span>];
  <span class="keyword">var</span> f = <span class="keyword">this</span>.h[<span class="number">5</span>];
  <span class="keyword">var</span> g = <span class="keyword">this</span>.h[<span class="number">6</span>];
  <span class="keyword">var</span> h = <span class="keyword">this</span>.h[<span class="number">7</span>];

  assert(<span class="keyword">this</span>.k.length === W.length);
  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; W.length; i++) {
    <span class="keyword">var</span> T1 = sum32_5(h, s1_256(e), ch32(e, f, g), <span class="keyword">this</span>.k[i], W[i]);
    <span class="keyword">var</span> T2 = sum32(s0_256(a), maj32(a, b, c));
    h = g;
    g = f;
    f = e;
    e = sum32(d, T1);
    d = c;
    c = b;
    b = a;
    a = sum32(T1, T2);
  }

  <span class="keyword">this</span>.h[<span class="number">0</span>] = sum32(<span class="keyword">this</span>.h[<span class="number">0</span>], a);
  <span class="keyword">this</span>.h[<span class="number">1</span>] = sum32(<span class="keyword">this</span>.h[<span class="number">1</span>], b);
  <span class="keyword">this</span>.h[<span class="number">2</span>] = sum32(<span class="keyword">this</span>.h[<span class="number">2</span>], c);
  <span class="keyword">this</span>.h[<span class="number">3</span>] = sum32(<span class="keyword">this</span>.h[<span class="number">3</span>], d);
  <span class="keyword">this</span>.h[<span class="number">4</span>] = sum32(<span class="keyword">this</span>.h[<span class="number">4</span>], e);
  <span class="keyword">this</span>.h[<span class="number">5</span>] = sum32(<span class="keyword">this</span>.h[<span class="number">5</span>], f);
  <span class="keyword">this</span>.h[<span class="number">6</span>] = sum32(<span class="keyword">this</span>.h[<span class="number">6</span>], g);
  <span class="keyword">this</span>.h[<span class="number">7</span>] = sum32(<span class="keyword">this</span>.h[<span class="number">7</span>], h);
};

SHA256.prototype._digest = <span class="function"><span class="keyword">function</span> <span class="title">digest</span><span class="params">(enc)</span> {</span>
  <span class="keyword">if</span> (enc === <span class="string">'hex'</span>)
    <span class="keyword">return</span> utils.toHex32(<span class="keyword">this</span>.h, <span class="string">'big'</span>);
  <span class="keyword">else</span>
    <span class="keyword">return</span> utils.split32(<span class="keyword">this</span>.h, <span class="string">'big'</span>);
};
</code></pre>