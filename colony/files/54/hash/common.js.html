<h1>common.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> utils = require(<span class="string">'./utils'</span>);
<span class="keyword">var</span> assert = require(<span class="string">'minimalistic-assert'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">BlockHash</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.pending = <span class="literal">null</span>;
  <span class="keyword">this</span>.pendingTotal = <span class="number">0</span>;
  <span class="keyword">this</span>.blockSize = <span class="keyword">this</span>.constructor.blockSize;
  <span class="keyword">this</span>.outSize = <span class="keyword">this</span>.constructor.outSize;
  <span class="keyword">this</span>.hmacStrength = <span class="keyword">this</span>.constructor.hmacStrength;
  <span class="keyword">this</span>.padLength = <span class="keyword">this</span>.constructor.padLength / <span class="number">8</span>;
  <span class="keyword">this</span>.endian = <span class="string">'big'</span>;

  <span class="keyword">this</span>._delta8 = <span class="keyword">this</span>.blockSize / <span class="number">8</span>;
  <span class="keyword">this</span>._delta32 = <span class="keyword">this</span>.blockSize / <span class="number">32</span>;
}
exports.BlockHash = BlockHash;

BlockHash.prototype.update = <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(msg, enc)</span> {</span>
  <span class="comment">// Convert message to array, pad it, and join into 32bit blocks</span>
  msg = utils.toArray(msg, enc);
  <span class="keyword">if</span> (!<span class="keyword">this</span>.pending)
    <span class="keyword">this</span>.pending = msg;
  <span class="keyword">else</span>
    <span class="keyword">this</span>.pending = <span class="keyword">this</span>.pending.concat(msg);
  <span class="keyword">this</span>.pendingTotal += msg.length;

  <span class="comment">// Enough data, try updating</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.pending.length >= <span class="keyword">this</span>._delta8) {
    msg = <span class="keyword">this</span>.pending;

    <span class="comment">// Process pending data in blocks</span>
    <span class="keyword">var</span> r = msg.length % <span class="keyword">this</span>._delta8;
    <span class="keyword">this</span>.pending = msg.slice(msg.length - r, msg.length);
    <span class="keyword">if</span> (<span class="keyword">this</span>.pending.length === <span class="number">0</span>)
      <span class="keyword">this</span>.pending = <span class="literal">null</span>;

    msg = utils.join32(msg, <span class="number">0</span>, msg.length - r, <span class="keyword">this</span>.endian);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msg.length; i += <span class="keyword">this</span>._delta32)
      <span class="keyword">this</span>._update(msg, i, i + <span class="keyword">this</span>._delta32);
  }

  <span class="keyword">return</span> <span class="keyword">this</span>;
};

BlockHash.prototype.digest = <span class="function"><span class="keyword">function</span> <span class="title">digest</span><span class="params">(enc)</span> {</span>
  <span class="keyword">this</span>.update(<span class="keyword">this</span>._pad());
  assert(<span class="keyword">this</span>.pending === <span class="literal">null</span>);

  <span class="keyword">return</span> <span class="keyword">this</span>._digest(enc);
};

BlockHash.prototype._pad = <span class="function"><span class="keyword">function</span> <span class="title">pad</span><span class="params">()</span> {</span>
  <span class="keyword">var</span> len = <span class="keyword">this</span>.pendingTotal;
  <span class="keyword">var</span> bytes = <span class="keyword">this</span>._delta8;
  <span class="keyword">var</span> k = bytes - ((len + <span class="keyword">this</span>.padLength) % bytes);
  <span class="keyword">var</span> res = <span class="keyword">new</span> Array(k + <span class="keyword">this</span>.padLength);
  res[<span class="number">0</span>] = <span class="number">0x80</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; k; i++)
    res[i] = <span class="number">0</span>;

  <span class="comment">// Append length</span>
  len &lt;&lt;= <span class="number">3</span>;
  <span class="keyword">if</span> (<span class="keyword">this</span>.endian === <span class="string">'big'</span>) {
    <span class="keyword">for</span> (<span class="keyword">var</span> t = <span class="number">8</span>; t &lt; <span class="keyword">this</span>.padLength; t++)
      res[i++] = <span class="number">0</span>;

    res[i++] = <span class="number">0</span>;
    res[i++] = <span class="number">0</span>;
    res[i++] = <span class="number">0</span>;
    res[i++] = <span class="number">0</span>;
    res[i++] = (len >>> <span class="number">24</span>) &amp; <span class="number">0xff</span>;
    res[i++] = (len >>> <span class="number">16</span>) &amp; <span class="number">0xff</span>;
    res[i++] = (len >>> <span class="number">8</span>) &amp; <span class="number">0xff</span>;
    res[i++] = len &amp; <span class="number">0xff</span>;
  } <span class="keyword">else</span> {
    res[i++] = len &amp; <span class="number">0xff</span>;
    res[i++] = (len >>> <span class="number">8</span>) &amp; <span class="number">0xff</span>;
    res[i++] = (len >>> <span class="number">16</span>) &amp; <span class="number">0xff</span>;
    res[i++] = (len >>> <span class="number">24</span>) &amp; <span class="number">0xff</span>;
    res[i++] = <span class="number">0</span>;
    res[i++] = <span class="number">0</span>;
    res[i++] = <span class="number">0</span>;
    res[i++] = <span class="number">0</span>;

    <span class="keyword">for</span> (t = <span class="number">8</span>; t &lt; <span class="keyword">this</span>.padLength; t++)
      res[i++] = <span class="number">0</span>;
  }

  <span class="keyword">return</span> res;
};
</code></pre>