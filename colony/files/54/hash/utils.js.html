<h1>utils.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> assert = require(<span class="string">'minimalistic-assert'</span>);
<span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);

exports.inherits = inherits;

<span class="function"><span class="keyword">function</span> <span class="title">isSurrogatePair</span><span class="params">(msg, i)</span> {</span>
  <span class="keyword">if</span> ((msg.charCodeAt(i) &amp; <span class="number">0xFC00</span>) !== <span class="number">0xD800</span>) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i + <span class="number">1</span> >= msg.length) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">return</span> (msg.charCodeAt(i + <span class="number">1</span>) &amp; <span class="number">0xFC00</span>) === <span class="number">0xDC00</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">(msg, enc)</span> {</span>
  <span class="keyword">if</span> (Array.isArray(msg))
    <span class="keyword">return</span> msg.slice();
  <span class="keyword">if</span> (!msg)
    <span class="keyword">return</span> [];
  <span class="keyword">var</span> res = [];
  <span class="keyword">if</span> (<span class="keyword">typeof</span> msg === <span class="string">'string'</span>) {
    <span class="keyword">if</span> (!enc) {
      <span class="comment">// Inspired by stringToUtf8ByteArray() in closure-library by Google</span>
      <span class="comment">// https://github.com/google/closure-library/blob/8598d87242af59aac233270742c8984e2b2bdbe0/closure/goog/crypt/crypt.js#L117-L143</span>
      <span class="comment">// Apache License 2.0</span>
      <span class="comment">// https://github.com/google/closure-library/blob/master/LICENSE</span>
      <span class="keyword">var</span> p = <span class="number">0</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msg.length; i++) {
        <span class="keyword">var</span> c = msg.charCodeAt(i);
        <span class="keyword">if</span> (c &lt; <span class="number">128</span>) {
          res[p++] = c;
        } <span class="keyword">else</span> <span class="keyword">if</span> (c &lt; <span class="number">2048</span>) {
          res[p++] = (c >> <span class="number">6</span>) | <span class="number">192</span>;
          res[p++] = (c &amp; <span class="number">63</span>) | <span class="number">128</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (isSurrogatePair(msg, i)) {
          c = <span class="number">0x10000</span> + ((c &amp; <span class="number">0x03FF</span>) &lt;&lt; <span class="number">10</span>) + (msg.charCodeAt(++i) &amp; <span class="number">0x03FF</span>);
          res[p++] = (c >> <span class="number">18</span>) | <span class="number">240</span>;
          res[p++] = ((c >> <span class="number">12</span>) &amp; <span class="number">63</span>) | <span class="number">128</span>;
          res[p++] = ((c >> <span class="number">6</span>) &amp; <span class="number">63</span>) | <span class="number">128</span>;
          res[p++] = (c &amp; <span class="number">63</span>) | <span class="number">128</span>;
        } <span class="keyword">else</span> {
          res[p++] = (c >> <span class="number">12</span>) | <span class="number">224</span>;
          res[p++] = ((c >> <span class="number">6</span>) &amp; <span class="number">63</span>) | <span class="number">128</span>;
          res[p++] = (c &amp; <span class="number">63</span>) | <span class="number">128</span>;
        }
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (enc === <span class="string">'hex'</span>) {
      msg = msg.replace(<span class="regexp">/[^a-z0-9]+/ig</span>, <span class="string">''</span>);
      <span class="keyword">if</span> (msg.length % <span class="number">2</span> !== <span class="number">0</span>)
        msg = <span class="string">'0'</span> + msg;
      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; msg.length; i += <span class="number">2</span>)
        res.push(parseInt(msg[i] + msg[i + <span class="number">1</span>], <span class="number">16</span>));
    }
  } <span class="keyword">else</span> {
    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; msg.length; i++)
      res[i] = msg[i] | <span class="number">0</span>;
  }
  <span class="keyword">return</span> res;
}
exports.toArray = toArray;

<span class="function"><span class="keyword">function</span> <span class="title">toHex</span><span class="params">(msg)</span> {</span>
  <span class="keyword">var</span> res = <span class="string">''</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msg.length; i++)
    res += zero2(msg[i].toString(<span class="number">16</span>));
  <span class="keyword">return</span> res;
}
exports.toHex = toHex;

<span class="function"><span class="keyword">function</span> <span class="title">htonl</span><span class="params">(w)</span> {</span>
  <span class="keyword">var</span> res = (w >>> <span class="number">24</span>) |
            ((w >>> <span class="number">8</span>) &amp; <span class="number">0xff00</span>) |
            ((w &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xff0000</span>) |
            ((w &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">24</span>);
  <span class="keyword">return</span> res >>> <span class="number">0</span>;
}
exports.htonl = htonl;

<span class="function"><span class="keyword">function</span> <span class="title">toHex32</span><span class="params">(msg, endian)</span> {</span>
  <span class="keyword">var</span> res = <span class="string">''</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msg.length; i++) {
    <span class="keyword">var</span> w = msg[i];
    <span class="keyword">if</span> (endian === <span class="string">'little'</span>)
      w = htonl(w);
    res += zero8(w.toString(<span class="number">16</span>));
  }
  <span class="keyword">return</span> res;
}
exports.toHex32 = toHex32;

<span class="function"><span class="keyword">function</span> <span class="title">zero2</span><span class="params">(word)</span> {</span>
  <span class="keyword">if</span> (word.length === <span class="number">1</span>)
    <span class="keyword">return</span> <span class="string">'0'</span> + word;
  <span class="keyword">else</span>
    <span class="keyword">return</span> word;
}
exports.zero2 = zero2;

<span class="function"><span class="keyword">function</span> <span class="title">zero8</span><span class="params">(word)</span> {</span>
  <span class="keyword">if</span> (word.length === <span class="number">7</span>)
    <span class="keyword">return</span> <span class="string">'0'</span> + word;
  <span class="keyword">else</span> <span class="keyword">if</span> (word.length === <span class="number">6</span>)
    <span class="keyword">return</span> <span class="string">'00'</span> + word;
  <span class="keyword">else</span> <span class="keyword">if</span> (word.length === <span class="number">5</span>)
    <span class="keyword">return</span> <span class="string">'000'</span> + word;
  <span class="keyword">else</span> <span class="keyword">if</span> (word.length === <span class="number">4</span>)
    <span class="keyword">return</span> <span class="string">'0000'</span> + word;
  <span class="keyword">else</span> <span class="keyword">if</span> (word.length === <span class="number">3</span>)
    <span class="keyword">return</span> <span class="string">'00000'</span> + word;
  <span class="keyword">else</span> <span class="keyword">if</span> (word.length === <span class="number">2</span>)
    <span class="keyword">return</span> <span class="string">'000000'</span> + word;
  <span class="keyword">else</span> <span class="keyword">if</span> (word.length === <span class="number">1</span>)
    <span class="keyword">return</span> <span class="string">'0000000'</span> + word;
  <span class="keyword">else</span>
    <span class="keyword">return</span> word;
}
exports.zero8 = zero8;

<span class="function"><span class="keyword">function</span> <span class="title">join32</span><span class="params">(msg, start, end, endian)</span> {</span>
  <span class="keyword">var</span> len = end - start;
  assert(len % <span class="number">4</span> === <span class="number">0</span>);
  <span class="keyword">var</span> res = <span class="keyword">new</span> Array(len / <span class="number">4</span>);
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, k = start; i &lt; res.length; i++, k += <span class="number">4</span>) {
    <span class="keyword">var</span> w;
    <span class="keyword">if</span> (endian === <span class="string">'big'</span>)
      w = (msg[k] &lt;&lt; <span class="number">24</span>) | (msg[k + <span class="number">1</span>] &lt;&lt; <span class="number">16</span>) | (msg[k + <span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | msg[k + <span class="number">3</span>];
    <span class="keyword">else</span>
      w = (msg[k + <span class="number">3</span>] &lt;&lt; <span class="number">24</span>) | (msg[k + <span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (msg[k + <span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | msg[k];
    res[i] = w >>> <span class="number">0</span>;
  }
  <span class="keyword">return</span> res;
}
exports.join32 = join32;

<span class="function"><span class="keyword">function</span> <span class="title">split32</span><span class="params">(msg, endian)</span> {</span>
  <span class="keyword">var</span> res = <span class="keyword">new</span> Array(msg.length * <span class="number">4</span>);
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, k = <span class="number">0</span>; i &lt; msg.length; i++, k += <span class="number">4</span>) {
    <span class="keyword">var</span> m = msg[i];
    <span class="keyword">if</span> (endian === <span class="string">'big'</span>) {
      res[k] = m >>> <span class="number">24</span>;
      res[k + <span class="number">1</span>] = (m >>> <span class="number">16</span>) &amp; <span class="number">0xff</span>;
      res[k + <span class="number">2</span>] = (m >>> <span class="number">8</span>) &amp; <span class="number">0xff</span>;
      res[k + <span class="number">3</span>] = m &amp; <span class="number">0xff</span>;
    } <span class="keyword">else</span> {
      res[k + <span class="number">3</span>] = m >>> <span class="number">24</span>;
      res[k + <span class="number">2</span>] = (m >>> <span class="number">16</span>) &amp; <span class="number">0xff</span>;
      res[k + <span class="number">1</span>] = (m >>> <span class="number">8</span>) &amp; <span class="number">0xff</span>;
      res[k] = m &amp; <span class="number">0xff</span>;
    }
  }
  <span class="keyword">return</span> res;
}
exports.split32 = split32;

<span class="function"><span class="keyword">function</span> <span class="title">rotr32</span><span class="params">(w, b)</span> {</span>
  <span class="keyword">return</span> (w >>> b) | (w &lt;&lt; (<span class="number">32</span> - b));
}
exports.rotr32 = rotr32;

<span class="function"><span class="keyword">function</span> <span class="title">rotl32</span><span class="params">(w, b)</span> {</span>
  <span class="keyword">return</span> (w &lt;&lt; b) | (w >>> (<span class="number">32</span> - b));
}
exports.rotl32 = rotl32;

<span class="function"><span class="keyword">function</span> <span class="title">sum32</span><span class="params">(a, b)</span> {</span>
  <span class="keyword">return</span> (a + b) >>> <span class="number">0</span>;
}
exports.sum32 = sum32;

<span class="function"><span class="keyword">function</span> <span class="title">sum32_3</span><span class="params">(a, b, c)</span> {</span>
  <span class="keyword">return</span> (a + b + c) >>> <span class="number">0</span>;
}
exports.sum32_3 = sum32_3;

<span class="function"><span class="keyword">function</span> <span class="title">sum32_4</span><span class="params">(a, b, c, d)</span> {</span>
  <span class="keyword">return</span> (a + b + c + d) >>> <span class="number">0</span>;
}
exports.sum32_4 = sum32_4;

<span class="function"><span class="keyword">function</span> <span class="title">sum32_5</span><span class="params">(a, b, c, d, e)</span> {</span>
  <span class="keyword">return</span> (a + b + c + d + e) >>> <span class="number">0</span>;
}
exports.sum32_5 = sum32_5;

<span class="function"><span class="keyword">function</span> <span class="title">sum64</span><span class="params">(buf, pos, ah, al)</span> {</span>
  <span class="keyword">var</span> bh = buf[pos];
  <span class="keyword">var</span> bl = buf[pos + <span class="number">1</span>];

  <span class="keyword">var</span> lo = (al + bl) >>> <span class="number">0</span>;
  <span class="keyword">var</span> hi = (lo &lt; al ? <span class="number">1</span> : <span class="number">0</span>) + ah + bh;
  buf[pos] = hi >>> <span class="number">0</span>;
  buf[pos + <span class="number">1</span>] = lo;
}
exports.sum64 = sum64;

<span class="function"><span class="keyword">function</span> <span class="title">sum64_hi</span><span class="params">(ah, al, bh, bl)</span> {</span>
  <span class="keyword">var</span> lo = (al + bl) >>> <span class="number">0</span>;
  <span class="keyword">var</span> hi = (lo &lt; al ? <span class="number">1</span> : <span class="number">0</span>) + ah + bh;
  <span class="keyword">return</span> hi >>> <span class="number">0</span>;
}
exports.sum64_hi = sum64_hi;

<span class="function"><span class="keyword">function</span> <span class="title">sum64_lo</span><span class="params">(ah, al, bh, bl)</span> {</span>
  <span class="keyword">var</span> lo = al + bl;
  <span class="keyword">return</span> lo >>> <span class="number">0</span>;
}
exports.sum64_lo = sum64_lo;

<span class="function"><span class="keyword">function</span> <span class="title">sum64_4_hi</span><span class="params">(ah, al, bh, bl, ch, cl, dh, dl)</span> {</span>
  <span class="keyword">var</span> carry = <span class="number">0</span>;
  <span class="keyword">var</span> lo = al;
  lo = (lo + bl) >>> <span class="number">0</span>;
  carry += lo &lt; al ? <span class="number">1</span> : <span class="number">0</span>;
  lo = (lo + cl) >>> <span class="number">0</span>;
  carry += lo &lt; cl ? <span class="number">1</span> : <span class="number">0</span>;
  lo = (lo + dl) >>> <span class="number">0</span>;
  carry += lo &lt; dl ? <span class="number">1</span> : <span class="number">0</span>;

  <span class="keyword">var</span> hi = ah + bh + ch + dh + carry;
  <span class="keyword">return</span> hi >>> <span class="number">0</span>;
}
exports.sum64_4_hi = sum64_4_hi;

<span class="function"><span class="keyword">function</span> <span class="title">sum64_4_lo</span><span class="params">(ah, al, bh, bl, ch, cl, dh, dl)</span> {</span>
  <span class="keyword">var</span> lo = al + bl + cl + dl;
  <span class="keyword">return</span> lo >>> <span class="number">0</span>;
}
exports.sum64_4_lo = sum64_4_lo;

<span class="function"><span class="keyword">function</span> <span class="title">sum64_5_hi</span><span class="params">(ah, al, bh, bl, ch, cl, dh, dl, eh, el)</span> {</span>
  <span class="keyword">var</span> carry = <span class="number">0</span>;
  <span class="keyword">var</span> lo = al;
  lo = (lo + bl) >>> <span class="number">0</span>;
  carry += lo &lt; al ? <span class="number">1</span> : <span class="number">0</span>;
  lo = (lo + cl) >>> <span class="number">0</span>;
  carry += lo &lt; cl ? <span class="number">1</span> : <span class="number">0</span>;
  lo = (lo + dl) >>> <span class="number">0</span>;
  carry += lo &lt; dl ? <span class="number">1</span> : <span class="number">0</span>;
  lo = (lo + el) >>> <span class="number">0</span>;
  carry += lo &lt; el ? <span class="number">1</span> : <span class="number">0</span>;

  <span class="keyword">var</span> hi = ah + bh + ch + dh + eh + carry;
  <span class="keyword">return</span> hi >>> <span class="number">0</span>;
}
exports.sum64_5_hi = sum64_5_hi;

<span class="function"><span class="keyword">function</span> <span class="title">sum64_5_lo</span><span class="params">(ah, al, bh, bl, ch, cl, dh, dl, eh, el)</span> {</span>
  <span class="keyword">var</span> lo = al + bl + cl + dl + el;

  <span class="keyword">return</span> lo >>> <span class="number">0</span>;
}
exports.sum64_5_lo = sum64_5_lo;

<span class="function"><span class="keyword">function</span> <span class="title">rotr64_hi</span><span class="params">(ah, al, num)</span> {</span>
  <span class="keyword">var</span> r = (al &lt;&lt; (<span class="number">32</span> - num)) | (ah >>> num);
  <span class="keyword">return</span> r >>> <span class="number">0</span>;
}
exports.rotr64_hi = rotr64_hi;

<span class="function"><span class="keyword">function</span> <span class="title">rotr64_lo</span><span class="params">(ah, al, num)</span> {</span>
  <span class="keyword">var</span> r = (ah &lt;&lt; (<span class="number">32</span> - num)) | (al >>> num);
  <span class="keyword">return</span> r >>> <span class="number">0</span>;
}
exports.rotr64_lo = rotr64_lo;

<span class="function"><span class="keyword">function</span> <span class="title">shr64_hi</span><span class="params">(ah, al, num)</span> {</span>
  <span class="keyword">return</span> ah >>> num;
}
exports.shr64_hi = shr64_hi;

<span class="function"><span class="keyword">function</span> <span class="title">shr64_lo</span><span class="params">(ah, al, num)</span> {</span>
  <span class="keyword">var</span> r = (ah &lt;&lt; (<span class="number">32</span> - num)) | (al >>> num);
  <span class="keyword">return</span> r >>> <span class="number">0</span>;
}
exports.shr64_lo = shr64_lo;
</code></pre>