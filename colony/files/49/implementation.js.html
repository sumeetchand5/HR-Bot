<h1>implementation.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="comment">/* eslint no-invalid-this: 1 */</span>

<span class="keyword">var</span> ERROR_MESSAGE = <span class="string">'Function.prototype.bind called on incompatible '</span>;
<span class="keyword">var</span> slice = Array.prototype.slice;
<span class="keyword">var</span> toStr = Object.prototype.toString;
<span class="keyword">var</span> funcType = <span class="string">'[object Function]'</span>;

module.exports = <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">(that)</span> {</span>
    <span class="keyword">var</span> target = <span class="keyword">this</span>;
    <span class="keyword">if</span> (<span class="keyword">typeof</span> target !== <span class="string">'function'</span> || toStr.call(target) !== funcType) {
        <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(ERROR_MESSAGE + target);
    }
    <span class="keyword">var</span> args = slice.call(arguments, <span class="number">1</span>);

    <span class="keyword">var</span> bound;
    <span class="keyword">var</span> binder = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">instanceof</span> bound) {
            <span class="keyword">var</span> result = target.apply(
                <span class="keyword">this</span>,
                args.concat(slice.call(arguments))
            );
            <span class="keyword">if</span> (Object(result) === result) {
                <span class="keyword">return</span> result;
            }
            <span class="keyword">return</span> <span class="keyword">this</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> target.apply(
                that,
                args.concat(slice.call(arguments))
            );
        }
    };

    <span class="keyword">var</span> boundLength = Math.max(<span class="number">0</span>, target.length - args.length);
    <span class="keyword">var</span> boundArgs = [];
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; boundLength; i++) {
        boundArgs.push(<span class="string">'$'</span> + i);
    }

    bound = Function(<span class="string">'binder'</span>, <span class="string">'return function ('</span> + boundArgs.join(<span class="string">','</span>) + <span class="string">'){ return binder.apply(this,arguments); }'</span>)(binder);

    <span class="keyword">if</span> (target.prototype) {
        <span class="keyword">var</span> Empty = <span class="function"><span class="keyword">function</span> <span class="title">Empty</span><span class="params">()</span> {</span>};
        Empty.prototype = target.prototype;
        bound.prototype = <span class="keyword">new</span> Empty();
        Empty.prototype = <span class="literal">null</span>;
    }

    <span class="keyword">return</span> bound;
};
</code></pre>