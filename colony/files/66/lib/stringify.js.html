<h1>stringify.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> cx = <span class="regexp">/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g</span>,
    escapable = <span class="regexp">/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g</span>,
    gap,
    indent,
    meta = {    <span class="comment">// table of character substitutions</span>
        <span class="string">'\b'</span>: <span class="string">'\\b'</span>,
        <span class="string">'\t'</span>: <span class="string">'\\t'</span>,
        <span class="string">'\n'</span>: <span class="string">'\\n'</span>,
        <span class="string">'\f'</span>: <span class="string">'\\f'</span>,
        <span class="string">'\r'</span>: <span class="string">'\\r'</span>,
        <span class="string">'"'</span> : <span class="string">'\\"'</span>,
        <span class="string">'\\'</span>: <span class="string">'\\\\'</span>
    },
    rep;

<span class="function"><span class="keyword">function</span> <span class="title">quote</span><span class="params">(string)</span> {</span>
    <span class="comment">// If the string contains no control characters, no quote characters, and no</span>
    <span class="comment">// backslash characters, then we can safely slap some quotes around it.</span>
    <span class="comment">// Otherwise we must also replace the offending characters with safe escape</span>
    <span class="comment">// sequences.</span>
    
    escapable.lastIndex = <span class="number">0</span>;
    <span class="keyword">return</span> escapable.test(string) ? <span class="string">'"'</span> + string.replace(escapable, <span class="function"><span class="keyword">function</span> <span class="params">(a)</span> {</span>
        <span class="keyword">var</span> c = meta[a];
        <span class="keyword">return</span> <span class="keyword">typeof</span> c === <span class="string">'string'</span> ? c :
            <span class="string">'\\u'</span> + (<span class="string">'0000'</span> + a.charCodeAt(<span class="number">0</span>).toString(<span class="number">16</span>)).slice(-<span class="number">4</span>);
    }) + <span class="string">'"'</span> : <span class="string">'"'</span> + string + <span class="string">'"'</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">str</span><span class="params">(key, holder)</span> {</span>
    <span class="comment">// Produce a string from holder[key].</span>
    <span class="keyword">var</span> i,          <span class="comment">// The loop counter.</span>
        k,          <span class="comment">// The member key.</span>
        v,          <span class="comment">// The member value.</span>
        length,
        mind = gap,
        partial,
        value = holder[key];
    
    <span class="comment">// If the value has a toJSON method, call it to obtain a replacement value.</span>
    <span class="keyword">if</span> (value &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp;
            <span class="keyword">typeof</span> value.toJSON === <span class="string">'function'</span>) {
        value = value.toJSON(key);
    }
    
    <span class="comment">// If we were called with a replacer function, then call the replacer to</span>
    <span class="comment">// obtain a replacement value.</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> rep === <span class="string">'function'</span>) {
        value = rep.call(holder, key, value);
    }
    
    <span class="comment">// What happens next depends on the value's type.</span>
    <span class="keyword">switch</span> (<span class="keyword">typeof</span> value) {
        <span class="keyword">case</span> <span class="string">'string'</span>:
            <span class="keyword">return</span> quote(value);
        
        <span class="keyword">case</span> <span class="string">'number'</span>:
            <span class="comment">// JSON numbers must be finite. Encode non-finite numbers as null.</span>
            <span class="keyword">return</span> isFinite(value) ? String(value) : <span class="string">'null'</span>;
        
        <span class="keyword">case</span> <span class="string">'boolean'</span>:
        <span class="keyword">case</span> <span class="string">'null'</span>:
            <span class="comment">// If the value is a boolean or null, convert it to a string. Note:</span>
            <span class="comment">// typeof null does not produce 'null'. The case is included here in</span>
            <span class="comment">// the remote chance that this gets fixed someday.</span>
            <span class="keyword">return</span> String(value);
            
        <span class="keyword">case</span> <span class="string">'object'</span>:
            <span class="keyword">if</span> (!value) <span class="keyword">return</span> <span class="string">'null'</span>;
            gap += indent;
            partial = [];
            
            <span class="comment">// Array.isArray</span>
            <span class="keyword">if</span> (Object.prototype.toString.apply(value) === <span class="string">'[object Array]'</span>) {
                length = value.length;
                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i += <span class="number">1</span>) {
                    partial[i] = str(i, value) || <span class="string">'null'</span>;
                }
                
                <span class="comment">// Join all of the elements together, separated with commas, and</span>
                <span class="comment">// wrap them in brackets.</span>
                v = partial.length === <span class="number">0</span> ? <span class="string">'[]'</span> : gap ?
                    <span class="string">'[\n'</span> + gap + partial.join(<span class="string">',\n'</span> + gap) + <span class="string">'\n'</span> + mind + <span class="string">']'</span> :
                    <span class="string">'['</span> + partial.join(<span class="string">','</span>) + <span class="string">']'</span>;
                gap = mind;
                <span class="keyword">return</span> v;
            }
            
            <span class="comment">// If the replacer is an array, use it to select the members to be</span>
            <span class="comment">// stringified.</span>
            <span class="keyword">if</span> (rep &amp;&amp; <span class="keyword">typeof</span> rep === <span class="string">'object'</span>) {
                length = rep.length;
                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i += <span class="number">1</span>) {
                    k = rep[i];
                    <span class="keyword">if</span> (<span class="keyword">typeof</span> k === <span class="string">'string'</span>) {
                        v = str(k, value);
                        <span class="keyword">if</span> (v) {
                            partial.push(quote(k) + (gap ? <span class="string">': '</span> : <span class="string">':'</span>) + v);
                        }
                    }
                }
            }
            <span class="keyword">else</span> {
                <span class="comment">// Otherwise, iterate through all of the keys in the object.</span>
                <span class="keyword">for</span> (k <span class="keyword">in</span> value) {
                    <span class="keyword">if</span> (Object.prototype.hasOwnProperty.call(value, k)) {
                        v = str(k, value);
                        <span class="keyword">if</span> (v) {
                            partial.push(quote(k) + (gap ? <span class="string">': '</span> : <span class="string">':'</span>) + v);
                        }
                    }
                }
            }
            
        <span class="comment">// Join all of the member texts together, separated with commas,</span>
        <span class="comment">// and wrap them in braces.</span>

        v = partial.length === <span class="number">0</span> ? <span class="string">'{}'</span> : gap ?
            <span class="string">'{\n'</span> + gap + partial.join(<span class="string">',\n'</span> + gap) + <span class="string">'\n'</span> + mind + <span class="string">'}'</span> :
            <span class="string">'{'</span> + partial.join(<span class="string">','</span>) + <span class="string">'}'</span>;
        gap = mind;
        <span class="keyword">return</span> v;
    }
}

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(value, replacer, space)</span> {</span>
    <span class="keyword">var</span> i;
    gap = <span class="string">''</span>;
    indent = <span class="string">''</span>;
    
    <span class="comment">// If the space parameter is a number, make an indent string containing that</span>
    <span class="comment">// many spaces.</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> space === <span class="string">'number'</span>) {
        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; space; i += <span class="number">1</span>) {
            indent += <span class="string">' '</span>;
        }
    }
    <span class="comment">// If the space parameter is a string, it will be used as the indent string.</span>
    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> space === <span class="string">'string'</span>) {
        indent = space;
    }

    <span class="comment">// If there is a replacer, it must be a function or an array.</span>
    <span class="comment">// Otherwise, throw an error.</span>
    rep = replacer;
    <span class="keyword">if</span> (replacer &amp;&amp; <span class="keyword">typeof</span> replacer !== <span class="string">'function'</span>
    &amp;&amp; (<span class="keyword">typeof</span> replacer !== <span class="string">'object'</span> || <span class="keyword">typeof</span> replacer.length !== <span class="string">'number'</span>)) {
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'JSON.stringify'</span>);
    }
    
    <span class="comment">// Make a fake root object containing our value under the key of ''.</span>
    <span class="comment">// Return the result of stringifying the value.</span>
    <span class="keyword">return</span> str(<span class="string">''</span>, {<span class="string">''</span>: value});
};
</code></pre>