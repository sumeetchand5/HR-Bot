<h1>parse.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> at, <span class="comment">// The index of the current character</span>
    ch, <span class="comment">// The current character</span>
    escapee = {
        <span class="string">'"'</span>:  <span class="string">'"'</span>,
        <span class="string">'\\'</span>: <span class="string">'\\'</span>,
        <span class="string">'/'</span>:  <span class="string">'/'</span>,
        b:    <span class="string">'\b'</span>,
        f:    <span class="string">'\f'</span>,
        n:    <span class="string">'\n'</span>,
        r:    <span class="string">'\r'</span>,
        t:    <span class="string">'\t'</span>
    },
    text,

    error = <span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
        <span class="comment">// Call error when something is wrong.</span>
        <span class="keyword">throw</span> {
            name:    <span class="string">'SyntaxError'</span>,
            message: m,
            at:      at,
            text:    text
        };
    },
    
    next = <span class="function"><span class="keyword">function</span> <span class="params">(c)</span> {</span>
        <span class="comment">// If a c parameter is provided, verify that it matches the current character.</span>
        <span class="keyword">if</span> (c &amp;&amp; c !== ch) {
            error(<span class="string">"Expected '"</span> + c + <span class="string">"' instead of '"</span> + ch + <span class="string">"'"</span>);
        }
        
        <span class="comment">// Get the next character. When there are no more characters,</span>
        <span class="comment">// return the empty string.</span>
        
        ch = text.charAt(at);
        at += <span class="number">1</span>;
        <span class="keyword">return</span> ch;
    },
    
    number = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="comment">// Parse a number value.</span>
        <span class="keyword">var</span> number,
            string = <span class="string">''</span>;
        
        <span class="keyword">if</span> (ch === <span class="string">'-'</span>) {
            string = <span class="string">'-'</span>;
            next(<span class="string">'-'</span>);
        }
        <span class="keyword">while</span> (ch >= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) {
            string += ch;
            next();
        }
        <span class="keyword">if</span> (ch === <span class="string">'.'</span>) {
            string += <span class="string">'.'</span>;
            <span class="keyword">while</span> (next() &amp;&amp; ch >= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) {
                string += ch;
            }
        }
        <span class="keyword">if</span> (ch === <span class="string">'e'</span> || ch === <span class="string">'E'</span>) {
            string += ch;
            next();
            <span class="keyword">if</span> (ch === <span class="string">'-'</span> || ch === <span class="string">'+'</span>) {
                string += ch;
                next();
            }
            <span class="keyword">while</span> (ch >= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) {
                string += ch;
                next();
            }
        }
        number = +string;
        <span class="keyword">if</span> (!isFinite(number)) {
            error(<span class="string">"Bad number"</span>);
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> number;
        }
    },
    
    string = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="comment">// Parse a string value.</span>
        <span class="keyword">var</span> hex,
            i,
            string = <span class="string">''</span>,
            uffff;
        
        <span class="comment">// When parsing for string values, we must look for " and \ characters.</span>
        <span class="keyword">if</span> (ch === <span class="string">'"'</span>) {
            <span class="keyword">while</span> (next()) {
                <span class="keyword">if</span> (ch === <span class="string">'"'</span>) {
                    next();
                    <span class="keyword">return</span> string;
                } <span class="keyword">else</span> <span class="keyword">if</span> (ch === <span class="string">'\\'</span>) {
                    next();
                    <span class="keyword">if</span> (ch === <span class="string">'u'</span>) {
                        uffff = <span class="number">0</span>;
                        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i += <span class="number">1</span>) {
                            hex = parseInt(next(), <span class="number">16</span>);
                            <span class="keyword">if</span> (!isFinite(hex)) {
                                <span class="keyword">break</span>;
                            }
                            uffff = uffff * <span class="number">16</span> + hex;
                        }
                        string += String.fromCharCode(uffff);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> escapee[ch] === <span class="string">'string'</span>) {
                        string += escapee[ch];
                    } <span class="keyword">else</span> {
                        <span class="keyword">break</span>;
                    }
                } <span class="keyword">else</span> {
                    string += ch;
                }
            }
        }
        error(<span class="string">"Bad string"</span>);
    },

    white = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

<span class="comment">// Skip whitespace.</span>

        <span class="keyword">while</span> (ch &amp;&amp; ch &lt;= <span class="string">' '</span>) {
            next();
        }
    },

    word = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

<span class="comment">// true, false, or null.</span>

        <span class="keyword">switch</span> (ch) {
        <span class="keyword">case</span> <span class="string">'t'</span>:
            next(<span class="string">'t'</span>);
            next(<span class="string">'r'</span>);
            next(<span class="string">'u'</span>);
            next(<span class="string">'e'</span>);
            <span class="keyword">return</span> <span class="literal">true</span>;
        <span class="keyword">case</span> <span class="string">'f'</span>:
            next(<span class="string">'f'</span>);
            next(<span class="string">'a'</span>);
            next(<span class="string">'l'</span>);
            next(<span class="string">'s'</span>);
            next(<span class="string">'e'</span>);
            <span class="keyword">return</span> <span class="literal">false</span>;
        <span class="keyword">case</span> <span class="string">'n'</span>:
            next(<span class="string">'n'</span>);
            next(<span class="string">'u'</span>);
            next(<span class="string">'l'</span>);
            next(<span class="string">'l'</span>);
            <span class="keyword">return</span> <span class="literal">null</span>;
        }
        error(<span class="string">"Unexpected '"</span> + ch + <span class="string">"'"</span>);
    },

    value,  <span class="comment">// Place holder for the value function.</span>

    array = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

<span class="comment">// Parse an array value.</span>

        <span class="keyword">var</span> array = [];

        <span class="keyword">if</span> (ch === <span class="string">'['</span>) {
            next(<span class="string">'['</span>);
            white();
            <span class="keyword">if</span> (ch === <span class="string">']'</span>) {
                next(<span class="string">']'</span>);
                <span class="keyword">return</span> array;   <span class="comment">// empty array</span>
            }
            <span class="keyword">while</span> (ch) {
                array.push(value());
                white();
                <span class="keyword">if</span> (ch === <span class="string">']'</span>) {
                    next(<span class="string">']'</span>);
                    <span class="keyword">return</span> array;
                }
                next(<span class="string">','</span>);
                white();
            }
        }
        error(<span class="string">"Bad array"</span>);
    },

    object = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

<span class="comment">// Parse an object value.</span>

        <span class="keyword">var</span> key,
            object = {};

        <span class="keyword">if</span> (ch === <span class="string">'{'</span>) {
            next(<span class="string">'{'</span>);
            white();
            <span class="keyword">if</span> (ch === <span class="string">'}'</span>) {
                next(<span class="string">'}'</span>);
                <span class="keyword">return</span> object;   <span class="comment">// empty object</span>
            }
            <span class="keyword">while</span> (ch) {
                key = string();
                white();
                next(<span class="string">':'</span>);
                <span class="keyword">if</span> (Object.hasOwnProperty.call(object, key)) {
                    error(<span class="string">'Duplicate key "'</span> + key + <span class="string">'"'</span>);
                }
                object[key] = value();
                white();
                <span class="keyword">if</span> (ch === <span class="string">'}'</span>) {
                    next(<span class="string">'}'</span>);
                    <span class="keyword">return</span> object;
                }
                next(<span class="string">','</span>);
                white();
            }
        }
        error(<span class="string">"Bad object"</span>);
    };

value = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

<span class="comment">// Parse a JSON value. It could be an object, an array, a string, a number,</span>
<span class="comment">// or a word.</span>

    white();
    <span class="keyword">switch</span> (ch) {
    <span class="keyword">case</span> <span class="string">'{'</span>:
        <span class="keyword">return</span> object();
    <span class="keyword">case</span> <span class="string">'['</span>:
        <span class="keyword">return</span> array();
    <span class="keyword">case</span> <span class="string">'"'</span>:
        <span class="keyword">return</span> string();
    <span class="keyword">case</span> <span class="string">'-'</span>:
        <span class="keyword">return</span> number();
    <span class="keyword">default</span>:
        <span class="keyword">return</span> ch >= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span> ? number() : word();
    }
};

<span class="comment">// Return the json_parse function. It will have access to all of the above</span>
<span class="comment">// functions and variables.</span>

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(source, reviver)</span> {</span>
    <span class="keyword">var</span> result;
    
    text = source;
    at = <span class="number">0</span>;
    ch = <span class="string">' '</span>;
    result = value();
    white();
    <span class="keyword">if</span> (ch) {
        error(<span class="string">"Syntax error"</span>);
    }

    <span class="comment">// If there is a reviver function, we recursively walk the new structure,</span>
    <span class="comment">// passing each name/value pair to the reviver function for possible</span>
    <span class="comment">// transformation, starting with a temporary root object that holds the result</span>
    <span class="comment">// in an empty key. If there is not a reviver function, we simply return the</span>
    <span class="comment">// result.</span>

    <span class="keyword">return</span> <span class="keyword">typeof</span> reviver === <span class="string">'function'</span> ? (<span class="function"><span class="keyword">function</span> <span class="title">walk</span><span class="params">(holder, key)</span> {</span>
        <span class="keyword">var</span> k, v, value = holder[key];
        <span class="keyword">if</span> (value &amp;&amp; <span class="keyword">typeof</span> value === <span class="string">'object'</span>) {
            <span class="keyword">for</span> (k <span class="keyword">in</span> value) {
                <span class="keyword">if</span> (Object.prototype.hasOwnProperty.call(value, k)) {
                    v = walk(value, k);
                    <span class="keyword">if</span> (v !== <span class="literal">undefined</span>) {
                        value[k] = v;
                    } <span class="keyword">else</span> {
                        <span class="keyword">delete</span> value[k];
                    }
                }
            }
        }
        <span class="keyword">return</span> reviver.call(holder, key, value);
    }({<span class="string">''</span>: result}, <span class="string">''</span>)) : result;
};
</code></pre>