<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> Readable = require(<span class="string">'readable-stream'</span>).Readable;

module.exports = <span class="function"><span class="keyword">function</span> <span class="params">(stream)</span> {</span>
    <span class="keyword">var</span> opts = stream._readableState;
    <span class="keyword">if</span> (<span class="keyword">typeof</span> stream.read !== <span class="string">'function'</span>) {
        stream = <span class="keyword">new</span> Readable(opts).wrap(stream);
    }
    
    <span class="keyword">var</span> ro = <span class="keyword">new</span> Readable({ objectMode: opts &amp;&amp; opts.objectMode });
    <span class="keyword">var</span> waiting = <span class="literal">false</span>;
    
    stream.on(<span class="string">'readable'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (waiting) {
            waiting = <span class="literal">false</span>;
            ro._read();
        }
    });
    
    ro._read = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> buf, reads = <span class="number">0</span>;
        <span class="keyword">while</span> ((buf = stream.read()) !== <span class="literal">null</span>) {
            ro.push(buf);
            reads ++;
        }
        <span class="keyword">if</span> (reads === <span class="number">0</span>) waiting = <span class="literal">true</span>;
    };
    stream.once(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span> ro.push(<span class="literal">null</span>) });
    stream.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> {</span> ro.emit(<span class="string">'error'</span>, err) });
    <span class="keyword">return</span> ro;
};
</code></pre>