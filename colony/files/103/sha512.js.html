<h1>sha512.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>)
<span class="keyword">var</span> Hash = require(<span class="string">'./hash'</span>)
<span class="keyword">var</span> Buffer = require(<span class="string">'safe-buffer'</span>).Buffer

<span class="keyword">var</span> K = [
  <span class="number">0x428a2f98</span>, <span class="number">0xd728ae22</span>, <span class="number">0x71374491</span>, <span class="number">0x23ef65cd</span>,
  <span class="number">0xb5c0fbcf</span>, <span class="number">0xec4d3b2f</span>, <span class="number">0xe9b5dba5</span>, <span class="number">0x8189dbbc</span>,
  <span class="number">0x3956c25b</span>, <span class="number">0xf348b538</span>, <span class="number">0x59f111f1</span>, <span class="number">0xb605d019</span>,
  <span class="number">0x923f82a4</span>, <span class="number">0xaf194f9b</span>, <span class="number">0xab1c5ed5</span>, <span class="number">0xda6d8118</span>,
  <span class="number">0xd807aa98</span>, <span class="number">0xa3030242</span>, <span class="number">0x12835b01</span>, <span class="number">0x45706fbe</span>,
  <span class="number">0x243185be</span>, <span class="number">0x4ee4b28c</span>, <span class="number">0x550c7dc3</span>, <span class="number">0xd5ffb4e2</span>,
  <span class="number">0x72be5d74</span>, <span class="number">0xf27b896f</span>, <span class="number">0x80deb1fe</span>, <span class="number">0x3b1696b1</span>,
  <span class="number">0x9bdc06a7</span>, <span class="number">0x25c71235</span>, <span class="number">0xc19bf174</span>, <span class="number">0xcf692694</span>,
  <span class="number">0xe49b69c1</span>, <span class="number">0x9ef14ad2</span>, <span class="number">0xefbe4786</span>, <span class="number">0x384f25e3</span>,
  <span class="number">0x0fc19dc6</span>, <span class="number">0x8b8cd5b5</span>, <span class="number">0x240ca1cc</span>, <span class="number">0x77ac9c65</span>,
  <span class="number">0x2de92c6f</span>, <span class="number">0x592b0275</span>, <span class="number">0x4a7484aa</span>, <span class="number">0x6ea6e483</span>,
  <span class="number">0x5cb0a9dc</span>, <span class="number">0xbd41fbd4</span>, <span class="number">0x76f988da</span>, <span class="number">0x831153b5</span>,
  <span class="number">0x983e5152</span>, <span class="number">0xee66dfab</span>, <span class="number">0xa831c66d</span>, <span class="number">0x2db43210</span>,
  <span class="number">0xb00327c8</span>, <span class="number">0x98fb213f</span>, <span class="number">0xbf597fc7</span>, <span class="number">0xbeef0ee4</span>,
  <span class="number">0xc6e00bf3</span>, <span class="number">0x3da88fc2</span>, <span class="number">0xd5a79147</span>, <span class="number">0x930aa725</span>,
  <span class="number">0x06ca6351</span>, <span class="number">0xe003826f</span>, <span class="number">0x14292967</span>, <span class="number">0x0a0e6e70</span>,
  <span class="number">0x27b70a85</span>, <span class="number">0x46d22ffc</span>, <span class="number">0x2e1b2138</span>, <span class="number">0x5c26c926</span>,
  <span class="number">0x4d2c6dfc</span>, <span class="number">0x5ac42aed</span>, <span class="number">0x53380d13</span>, <span class="number">0x9d95b3df</span>,
  <span class="number">0x650a7354</span>, <span class="number">0x8baf63de</span>, <span class="number">0x766a0abb</span>, <span class="number">0x3c77b2a8</span>,
  <span class="number">0x81c2c92e</span>, <span class="number">0x47edaee6</span>, <span class="number">0x92722c85</span>, <span class="number">0x1482353b</span>,
  <span class="number">0xa2bfe8a1</span>, <span class="number">0x4cf10364</span>, <span class="number">0xa81a664b</span>, <span class="number">0xbc423001</span>,
  <span class="number">0xc24b8b70</span>, <span class="number">0xd0f89791</span>, <span class="number">0xc76c51a3</span>, <span class="number">0x0654be30</span>,
  <span class="number">0xd192e819</span>, <span class="number">0xd6ef5218</span>, <span class="number">0xd6990624</span>, <span class="number">0x5565a910</span>,
  <span class="number">0xf40e3585</span>, <span class="number">0x5771202a</span>, <span class="number">0x106aa070</span>, <span class="number">0x32bbd1b8</span>,
  <span class="number">0x19a4c116</span>, <span class="number">0xb8d2d0c8</span>, <span class="number">0x1e376c08</span>, <span class="number">0x5141ab53</span>,
  <span class="number">0x2748774c</span>, <span class="number">0xdf8eeb99</span>, <span class="number">0x34b0bcb5</span>, <span class="number">0xe19b48a8</span>,
  <span class="number">0x391c0cb3</span>, <span class="number">0xc5c95a63</span>, <span class="number">0x4ed8aa4a</span>, <span class="number">0xe3418acb</span>,
  <span class="number">0x5b9cca4f</span>, <span class="number">0x7763e373</span>, <span class="number">0x682e6ff3</span>, <span class="number">0xd6b2b8a3</span>,
  <span class="number">0x748f82ee</span>, <span class="number">0x5defb2fc</span>, <span class="number">0x78a5636f</span>, <span class="number">0x43172f60</span>,
  <span class="number">0x84c87814</span>, <span class="number">0xa1f0ab72</span>, <span class="number">0x8cc70208</span>, <span class="number">0x1a6439ec</span>,
  <span class="number">0x90befffa</span>, <span class="number">0x23631e28</span>, <span class="number">0xa4506ceb</span>, <span class="number">0xde82bde9</span>,
  <span class="number">0xbef9a3f7</span>, <span class="number">0xb2c67915</span>, <span class="number">0xc67178f2</span>, <span class="number">0xe372532b</span>,
  <span class="number">0xca273ece</span>, <span class="number">0xea26619c</span>, <span class="number">0xd186b8c7</span>, <span class="number">0x21c0c207</span>,
  <span class="number">0xeada7dd6</span>, <span class="number">0xcde0eb1e</span>, <span class="number">0xf57d4f7f</span>, <span class="number">0xee6ed178</span>,
  <span class="number">0x06f067aa</span>, <span class="number">0x72176fba</span>, <span class="number">0x0a637dc5</span>, <span class="number">0xa2c898a6</span>,
  <span class="number">0x113f9804</span>, <span class="number">0xbef90dae</span>, <span class="number">0x1b710b35</span>, <span class="number">0x131c471b</span>,
  <span class="number">0x28db77f5</span>, <span class="number">0x23047d84</span>, <span class="number">0x32caab7b</span>, <span class="number">0x40c72493</span>,
  <span class="number">0x3c9ebe0a</span>, <span class="number">0x15c9bebc</span>, <span class="number">0x431d67c4</span>, <span class="number">0x9c100d4c</span>,
  <span class="number">0x4cc5d4be</span>, <span class="number">0xcb3e42b6</span>, <span class="number">0x597f299c</span>, <span class="number">0xfc657e2a</span>,
  <span class="number">0x5fcb6fab</span>, <span class="number">0x3ad6faec</span>, <span class="number">0x6c44198c</span>, <span class="number">0x4a475817</span>
]

<span class="keyword">var</span> W = <span class="keyword">new</span> Array(<span class="number">160</span>)

<span class="function"><span class="keyword">function</span> <span class="title">Sha512</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.init()
  <span class="keyword">this</span>._w = W

  Hash.call(<span class="keyword">this</span>, <span class="number">128</span>, <span class="number">112</span>)
}

inherits(Sha512, Hash)

Sha512.prototype.init = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>._ah = <span class="number">0x6a09e667</span>
  <span class="keyword">this</span>._bh = <span class="number">0xbb67ae85</span>
  <span class="keyword">this</span>._ch = <span class="number">0x3c6ef372</span>
  <span class="keyword">this</span>._dh = <span class="number">0xa54ff53a</span>
  <span class="keyword">this</span>._eh = <span class="number">0x510e527f</span>
  <span class="keyword">this</span>._fh = <span class="number">0x9b05688c</span>
  <span class="keyword">this</span>._gh = <span class="number">0x1f83d9ab</span>
  <span class="keyword">this</span>._hh = <span class="number">0x5be0cd19</span>

  <span class="keyword">this</span>._al = <span class="number">0xf3bcc908</span>
  <span class="keyword">this</span>._bl = <span class="number">0x84caa73b</span>
  <span class="keyword">this</span>._cl = <span class="number">0xfe94f82b</span>
  <span class="keyword">this</span>._dl = <span class="number">0x5f1d36f1</span>
  <span class="keyword">this</span>._el = <span class="number">0xade682d1</span>
  <span class="keyword">this</span>._fl = <span class="number">0x2b3e6c1f</span>
  <span class="keyword">this</span>._gl = <span class="number">0xfb41bd6b</span>
  <span class="keyword">this</span>._hl = <span class="number">0x137e2179</span>

  <span class="keyword">return</span> <span class="keyword">this</span>
}

<span class="function"><span class="keyword">function</span> <span class="title">Ch</span> <span class="params">(x, y, z)</span> {</span>
  <span class="keyword">return</span> z ^ (x &amp; (y ^ z))
}

<span class="function"><span class="keyword">function</span> <span class="title">maj</span> <span class="params">(x, y, z)</span> {</span>
  <span class="keyword">return</span> (x &amp; y) | (z &amp; (x | y))
}

<span class="function"><span class="keyword">function</span> <span class="title">sigma0</span> <span class="params">(x, xl)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">28</span> | xl &lt;&lt; <span class="number">4</span>) ^ (xl >>> <span class="number">2</span> | x &lt;&lt; <span class="number">30</span>) ^ (xl >>> <span class="number">7</span> | x &lt;&lt; <span class="number">25</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">sigma1</span> <span class="params">(x, xl)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">14</span> | xl &lt;&lt; <span class="number">18</span>) ^ (x >>> <span class="number">18</span> | xl &lt;&lt; <span class="number">14</span>) ^ (xl >>> <span class="number">9</span> | x &lt;&lt; <span class="number">23</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">Gamma0</span> <span class="params">(x, xl)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">1</span> | xl &lt;&lt; <span class="number">31</span>) ^ (x >>> <span class="number">8</span> | xl &lt;&lt; <span class="number">24</span>) ^ (x >>> <span class="number">7</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">Gamma0l</span> <span class="params">(x, xl)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">1</span> | xl &lt;&lt; <span class="number">31</span>) ^ (x >>> <span class="number">8</span> | xl &lt;&lt; <span class="number">24</span>) ^ (x >>> <span class="number">7</span> | xl &lt;&lt; <span class="number">25</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">Gamma1</span> <span class="params">(x, xl)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">19</span> | xl &lt;&lt; <span class="number">13</span>) ^ (xl >>> <span class="number">29</span> | x &lt;&lt; <span class="number">3</span>) ^ (x >>> <span class="number">6</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">Gamma1l</span> <span class="params">(x, xl)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">19</span> | xl &lt;&lt; <span class="number">13</span>) ^ (xl >>> <span class="number">29</span> | x &lt;&lt; <span class="number">3</span>) ^ (x >>> <span class="number">6</span> | xl &lt;&lt; <span class="number">26</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">getCarry</span> <span class="params">(a, b)</span> {</span>
  <span class="keyword">return</span> (a >>> <span class="number">0</span>) &lt; (b >>> <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">0</span>
}

Sha512.prototype._update = <span class="function"><span class="keyword">function</span> <span class="params">(M)</span> {</span>
  <span class="keyword">var</span> W = <span class="keyword">this</span>._w

  <span class="keyword">var</span> ah = <span class="keyword">this</span>._ah | <span class="number">0</span>
  <span class="keyword">var</span> bh = <span class="keyword">this</span>._bh | <span class="number">0</span>
  <span class="keyword">var</span> ch = <span class="keyword">this</span>._ch | <span class="number">0</span>
  <span class="keyword">var</span> dh = <span class="keyword">this</span>._dh | <span class="number">0</span>
  <span class="keyword">var</span> eh = <span class="keyword">this</span>._eh | <span class="number">0</span>
  <span class="keyword">var</span> fh = <span class="keyword">this</span>._fh | <span class="number">0</span>
  <span class="keyword">var</span> gh = <span class="keyword">this</span>._gh | <span class="number">0</span>
  <span class="keyword">var</span> hh = <span class="keyword">this</span>._hh | <span class="number">0</span>

  <span class="keyword">var</span> al = <span class="keyword">this</span>._al | <span class="number">0</span>
  <span class="keyword">var</span> bl = <span class="keyword">this</span>._bl | <span class="number">0</span>
  <span class="keyword">var</span> cl = <span class="keyword">this</span>._cl | <span class="number">0</span>
  <span class="keyword">var</span> dl = <span class="keyword">this</span>._dl | <span class="number">0</span>
  <span class="keyword">var</span> el = <span class="keyword">this</span>._el | <span class="number">0</span>
  <span class="keyword">var</span> fl = <span class="keyword">this</span>._fl | <span class="number">0</span>
  <span class="keyword">var</span> gl = <span class="keyword">this</span>._gl | <span class="number">0</span>
  <span class="keyword">var</span> hl = <span class="keyword">this</span>._hl | <span class="number">0</span>

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i += <span class="number">2</span>) {
    W[i] = M.readInt32BE(i * <span class="number">4</span>)
    W[i + <span class="number">1</span>] = M.readInt32BE(i * <span class="number">4</span> + <span class="number">4</span>)
  }
  <span class="keyword">for</span> (; i &lt; <span class="number">160</span>; i += <span class="number">2</span>) {
    <span class="keyword">var</span> xh = W[i - <span class="number">15</span> * <span class="number">2</span>]
    <span class="keyword">var</span> xl = W[i - <span class="number">15</span> * <span class="number">2</span> + <span class="number">1</span>]
    <span class="keyword">var</span> gamma0 = Gamma0(xh, xl)
    <span class="keyword">var</span> gamma0l = Gamma0l(xl, xh)

    xh = W[i - <span class="number">2</span> * <span class="number">2</span>]
    xl = W[i - <span class="number">2</span> * <span class="number">2</span> + <span class="number">1</span>]
    <span class="keyword">var</span> gamma1 = Gamma1(xh, xl)
    <span class="keyword">var</span> gamma1l = Gamma1l(xl, xh)

    <span class="comment">// W[i] = gamma0 + W[i - 7] + gamma1 + W[i - 16]</span>
    <span class="keyword">var</span> Wi7h = W[i - <span class="number">7</span> * <span class="number">2</span>]
    <span class="keyword">var</span> Wi7l = W[i - <span class="number">7</span> * <span class="number">2</span> + <span class="number">1</span>]

    <span class="keyword">var</span> Wi16h = W[i - <span class="number">16</span> * <span class="number">2</span>]
    <span class="keyword">var</span> Wi16l = W[i - <span class="number">16</span> * <span class="number">2</span> + <span class="number">1</span>]

    <span class="keyword">var</span> Wil = (gamma0l + Wi7l) | <span class="number">0</span>
    <span class="keyword">var</span> Wih = (gamma0 + Wi7h + getCarry(Wil, gamma0l)) | <span class="number">0</span>
    Wil = (Wil + gamma1l) | <span class="number">0</span>
    Wih = (Wih + gamma1 + getCarry(Wil, gamma1l)) | <span class="number">0</span>
    Wil = (Wil + Wi16l) | <span class="number">0</span>
    Wih = (Wih + Wi16h + getCarry(Wil, Wi16l)) | <span class="number">0</span>

    W[i] = Wih
    W[i + <span class="number">1</span>] = Wil
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">160</span>; j += <span class="number">2</span>) {
    Wih = W[j]
    Wil = W[j + <span class="number">1</span>]

    <span class="keyword">var</span> majh = maj(ah, bh, ch)
    <span class="keyword">var</span> majl = maj(al, bl, cl)

    <span class="keyword">var</span> sigma0h = sigma0(ah, al)
    <span class="keyword">var</span> sigma0l = sigma0(al, ah)
    <span class="keyword">var</span> sigma1h = sigma1(eh, el)
    <span class="keyword">var</span> sigma1l = sigma1(el, eh)

    <span class="comment">// t1 = h + sigma1 + ch + K[j] + W[j]</span>
    <span class="keyword">var</span> Kih = K[j]
    <span class="keyword">var</span> Kil = K[j + <span class="number">1</span>]

    <span class="keyword">var</span> chh = Ch(eh, fh, gh)
    <span class="keyword">var</span> chl = Ch(el, fl, gl)

    <span class="keyword">var</span> t1l = (hl + sigma1l) | <span class="number">0</span>
    <span class="keyword">var</span> t1h = (hh + sigma1h + getCarry(t1l, hl)) | <span class="number">0</span>
    t1l = (t1l + chl) | <span class="number">0</span>
    t1h = (t1h + chh + getCarry(t1l, chl)) | <span class="number">0</span>
    t1l = (t1l + Kil) | <span class="number">0</span>
    t1h = (t1h + Kih + getCarry(t1l, Kil)) | <span class="number">0</span>
    t1l = (t1l + Wil) | <span class="number">0</span>
    t1h = (t1h + Wih + getCarry(t1l, Wil)) | <span class="number">0</span>

    <span class="comment">// t2 = sigma0 + maj</span>
    <span class="keyword">var</span> t2l = (sigma0l + majl) | <span class="number">0</span>
    <span class="keyword">var</span> t2h = (sigma0h + majh + getCarry(t2l, sigma0l)) | <span class="number">0</span>

    hh = gh
    hl = gl
    gh = fh
    gl = fl
    fh = eh
    fl = el
    el = (dl + t1l) | <span class="number">0</span>
    eh = (dh + t1h + getCarry(el, dl)) | <span class="number">0</span>
    dh = ch
    dl = cl
    ch = bh
    cl = bl
    bh = ah
    bl = al
    al = (t1l + t2l) | <span class="number">0</span>
    ah = (t1h + t2h + getCarry(al, t1l)) | <span class="number">0</span>
  }

  <span class="keyword">this</span>._al = (<span class="keyword">this</span>._al + al) | <span class="number">0</span>
  <span class="keyword">this</span>._bl = (<span class="keyword">this</span>._bl + bl) | <span class="number">0</span>
  <span class="keyword">this</span>._cl = (<span class="keyword">this</span>._cl + cl) | <span class="number">0</span>
  <span class="keyword">this</span>._dl = (<span class="keyword">this</span>._dl + dl) | <span class="number">0</span>
  <span class="keyword">this</span>._el = (<span class="keyword">this</span>._el + el) | <span class="number">0</span>
  <span class="keyword">this</span>._fl = (<span class="keyword">this</span>._fl + fl) | <span class="number">0</span>
  <span class="keyword">this</span>._gl = (<span class="keyword">this</span>._gl + gl) | <span class="number">0</span>
  <span class="keyword">this</span>._hl = (<span class="keyword">this</span>._hl + hl) | <span class="number">0</span>

  <span class="keyword">this</span>._ah = (<span class="keyword">this</span>._ah + ah + getCarry(<span class="keyword">this</span>._al, al)) | <span class="number">0</span>
  <span class="keyword">this</span>._bh = (<span class="keyword">this</span>._bh + bh + getCarry(<span class="keyword">this</span>._bl, bl)) | <span class="number">0</span>
  <span class="keyword">this</span>._ch = (<span class="keyword">this</span>._ch + ch + getCarry(<span class="keyword">this</span>._cl, cl)) | <span class="number">0</span>
  <span class="keyword">this</span>._dh = (<span class="keyword">this</span>._dh + dh + getCarry(<span class="keyword">this</span>._dl, dl)) | <span class="number">0</span>
  <span class="keyword">this</span>._eh = (<span class="keyword">this</span>._eh + eh + getCarry(<span class="keyword">this</span>._el, el)) | <span class="number">0</span>
  <span class="keyword">this</span>._fh = (<span class="keyword">this</span>._fh + fh + getCarry(<span class="keyword">this</span>._fl, fl)) | <span class="number">0</span>
  <span class="keyword">this</span>._gh = (<span class="keyword">this</span>._gh + gh + getCarry(<span class="keyword">this</span>._gl, gl)) | <span class="number">0</span>
  <span class="keyword">this</span>._hh = (<span class="keyword">this</span>._hh + hh + getCarry(<span class="keyword">this</span>._hl, hl)) | <span class="number">0</span>
}

Sha512.prototype._hash = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> H = Buffer.allocUnsafe(<span class="number">64</span>)

  <span class="function"><span class="keyword">function</span> <span class="title">writeInt64BE</span> <span class="params">(h, l, offset)</span> {</span>
    H.writeInt32BE(h, offset)
    H.writeInt32BE(l, offset + <span class="number">4</span>)
  }

  writeInt64BE(<span class="keyword">this</span>._ah, <span class="keyword">this</span>._al, <span class="number">0</span>)
  writeInt64BE(<span class="keyword">this</span>._bh, <span class="keyword">this</span>._bl, <span class="number">8</span>)
  writeInt64BE(<span class="keyword">this</span>._ch, <span class="keyword">this</span>._cl, <span class="number">16</span>)
  writeInt64BE(<span class="keyword">this</span>._dh, <span class="keyword">this</span>._dl, <span class="number">24</span>)
  writeInt64BE(<span class="keyword">this</span>._eh, <span class="keyword">this</span>._el, <span class="number">32</span>)
  writeInt64BE(<span class="keyword">this</span>._fh, <span class="keyword">this</span>._fl, <span class="number">40</span>)
  writeInt64BE(<span class="keyword">this</span>._gh, <span class="keyword">this</span>._gl, <span class="number">48</span>)
  writeInt64BE(<span class="keyword">this</span>._hh, <span class="keyword">this</span>._hl, <span class="number">56</span>)

  <span class="keyword">return</span> H
}

module.exports = Sha512
</code></pre>