<h1>sha256.js</h1>
<pre><code class="lang-js"><span class="comment">/**
 * A JavaScript implementation of the Secure Hash Algorithm, SHA-256, as defined
 * in FIPS 180-2
 * Version 2.2-beta Copyright Angel Marin, Paul Johnston 2000 - 2009.
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 *
 */</span>

<span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>)
<span class="keyword">var</span> Hash = require(<span class="string">'./hash'</span>)
<span class="keyword">var</span> Buffer = require(<span class="string">'safe-buffer'</span>).Buffer

<span class="keyword">var</span> K = [
  <span class="number">0x428A2F98</span>, <span class="number">0x71374491</span>, <span class="number">0xB5C0FBCF</span>, <span class="number">0xE9B5DBA5</span>,
  <span class="number">0x3956C25B</span>, <span class="number">0x59F111F1</span>, <span class="number">0x923F82A4</span>, <span class="number">0xAB1C5ED5</span>,
  <span class="number">0xD807AA98</span>, <span class="number">0x12835B01</span>, <span class="number">0x243185BE</span>, <span class="number">0x550C7DC3</span>,
  <span class="number">0x72BE5D74</span>, <span class="number">0x80DEB1FE</span>, <span class="number">0x9BDC06A7</span>, <span class="number">0xC19BF174</span>,
  <span class="number">0xE49B69C1</span>, <span class="number">0xEFBE4786</span>, <span class="number">0x0FC19DC6</span>, <span class="number">0x240CA1CC</span>,
  <span class="number">0x2DE92C6F</span>, <span class="number">0x4A7484AA</span>, <span class="number">0x5CB0A9DC</span>, <span class="number">0x76F988DA</span>,
  <span class="number">0x983E5152</span>, <span class="number">0xA831C66D</span>, <span class="number">0xB00327C8</span>, <span class="number">0xBF597FC7</span>,
  <span class="number">0xC6E00BF3</span>, <span class="number">0xD5A79147</span>, <span class="number">0x06CA6351</span>, <span class="number">0x14292967</span>,
  <span class="number">0x27B70A85</span>, <span class="number">0x2E1B2138</span>, <span class="number">0x4D2C6DFC</span>, <span class="number">0x53380D13</span>,
  <span class="number">0x650A7354</span>, <span class="number">0x766A0ABB</span>, <span class="number">0x81C2C92E</span>, <span class="number">0x92722C85</span>,
  <span class="number">0xA2BFE8A1</span>, <span class="number">0xA81A664B</span>, <span class="number">0xC24B8B70</span>, <span class="number">0xC76C51A3</span>,
  <span class="number">0xD192E819</span>, <span class="number">0xD6990624</span>, <span class="number">0xF40E3585</span>, <span class="number">0x106AA070</span>,
  <span class="number">0x19A4C116</span>, <span class="number">0x1E376C08</span>, <span class="number">0x2748774C</span>, <span class="number">0x34B0BCB5</span>,
  <span class="number">0x391C0CB3</span>, <span class="number">0x4ED8AA4A</span>, <span class="number">0x5B9CCA4F</span>, <span class="number">0x682E6FF3</span>,
  <span class="number">0x748F82EE</span>, <span class="number">0x78A5636F</span>, <span class="number">0x84C87814</span>, <span class="number">0x8CC70208</span>,
  <span class="number">0x90BEFFFA</span>, <span class="number">0xA4506CEB</span>, <span class="number">0xBEF9A3F7</span>, <span class="number">0xC67178F2</span>
]

<span class="keyword">var</span> W = <span class="keyword">new</span> Array(<span class="number">64</span>)

<span class="function"><span class="keyword">function</span> <span class="title">Sha256</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>.init()

  <span class="keyword">this</span>._w = W <span class="comment">// new Array(64)</span>

  Hash.call(<span class="keyword">this</span>, <span class="number">64</span>, <span class="number">56</span>)
}

inherits(Sha256, Hash)

Sha256.prototype.init = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">this</span>._a = <span class="number">0x6a09e667</span>
  <span class="keyword">this</span>._b = <span class="number">0xbb67ae85</span>
  <span class="keyword">this</span>._c = <span class="number">0x3c6ef372</span>
  <span class="keyword">this</span>._d = <span class="number">0xa54ff53a</span>
  <span class="keyword">this</span>._e = <span class="number">0x510e527f</span>
  <span class="keyword">this</span>._f = <span class="number">0x9b05688c</span>
  <span class="keyword">this</span>._g = <span class="number">0x1f83d9ab</span>
  <span class="keyword">this</span>._h = <span class="number">0x5be0cd19</span>

  <span class="keyword">return</span> <span class="keyword">this</span>
}

<span class="function"><span class="keyword">function</span> <span class="title">ch</span> <span class="params">(x, y, z)</span> {</span>
  <span class="keyword">return</span> z ^ (x &amp; (y ^ z))
}

<span class="function"><span class="keyword">function</span> <span class="title">maj</span> <span class="params">(x, y, z)</span> {</span>
  <span class="keyword">return</span> (x &amp; y) | (z &amp; (x | y))
}

<span class="function"><span class="keyword">function</span> <span class="title">sigma0</span> <span class="params">(x)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">2</span> | x &lt;&lt; <span class="number">30</span>) ^ (x >>> <span class="number">13</span> | x &lt;&lt; <span class="number">19</span>) ^ (x >>> <span class="number">22</span> | x &lt;&lt; <span class="number">10</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">sigma1</span> <span class="params">(x)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">6</span> | x &lt;&lt; <span class="number">26</span>) ^ (x >>> <span class="number">11</span> | x &lt;&lt; <span class="number">21</span>) ^ (x >>> <span class="number">25</span> | x &lt;&lt; <span class="number">7</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">gamma0</span> <span class="params">(x)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">7</span> | x &lt;&lt; <span class="number">25</span>) ^ (x >>> <span class="number">18</span> | x &lt;&lt; <span class="number">14</span>) ^ (x >>> <span class="number">3</span>)
}

<span class="function"><span class="keyword">function</span> <span class="title">gamma1</span> <span class="params">(x)</span> {</span>
  <span class="keyword">return</span> (x >>> <span class="number">17</span> | x &lt;&lt; <span class="number">15</span>) ^ (x >>> <span class="number">19</span> | x &lt;&lt; <span class="number">13</span>) ^ (x >>> <span class="number">10</span>)
}

Sha256.prototype._update = <span class="function"><span class="keyword">function</span> <span class="params">(M)</span> {</span>
  <span class="keyword">var</span> W = <span class="keyword">this</span>._w

  <span class="keyword">var</span> a = <span class="keyword">this</span>._a | <span class="number">0</span>
  <span class="keyword">var</span> b = <span class="keyword">this</span>._b | <span class="number">0</span>
  <span class="keyword">var</span> c = <span class="keyword">this</span>._c | <span class="number">0</span>
  <span class="keyword">var</span> d = <span class="keyword">this</span>._d | <span class="number">0</span>
  <span class="keyword">var</span> e = <span class="keyword">this</span>._e | <span class="number">0</span>
  <span class="keyword">var</span> f = <span class="keyword">this</span>._f | <span class="number">0</span>
  <span class="keyword">var</span> g = <span class="keyword">this</span>._g | <span class="number">0</span>
  <span class="keyword">var</span> h = <span class="keyword">this</span>._h | <span class="number">0</span>

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) W[i] = M.readInt32BE(i * <span class="number">4</span>)
  <span class="keyword">for</span> (; i &lt; <span class="number">64</span>; ++i) W[i] = (gamma1(W[i - <span class="number">2</span>]) + W[i - <span class="number">7</span>] + gamma0(W[i - <span class="number">15</span>]) + W[i - <span class="number">16</span>]) | <span class="number">0</span>

  <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; ++j) {
    <span class="keyword">var</span> T1 = (h + sigma1(e) + ch(e, f, g) + K[j] + W[j]) | <span class="number">0</span>
    <span class="keyword">var</span> T2 = (sigma0(a) + maj(a, b, c)) | <span class="number">0</span>

    h = g
    g = f
    f = e
    e = (d + T1) | <span class="number">0</span>
    d = c
    c = b
    b = a
    a = (T1 + T2) | <span class="number">0</span>
  }

  <span class="keyword">this</span>._a = (a + <span class="keyword">this</span>._a) | <span class="number">0</span>
  <span class="keyword">this</span>._b = (b + <span class="keyword">this</span>._b) | <span class="number">0</span>
  <span class="keyword">this</span>._c = (c + <span class="keyword">this</span>._c) | <span class="number">0</span>
  <span class="keyword">this</span>._d = (d + <span class="keyword">this</span>._d) | <span class="number">0</span>
  <span class="keyword">this</span>._e = (e + <span class="keyword">this</span>._e) | <span class="number">0</span>
  <span class="keyword">this</span>._f = (f + <span class="keyword">this</span>._f) | <span class="number">0</span>
  <span class="keyword">this</span>._g = (g + <span class="keyword">this</span>._g) | <span class="number">0</span>
  <span class="keyword">this</span>._h = (h + <span class="keyword">this</span>._h) | <span class="number">0</span>
}

Sha256.prototype._hash = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">var</span> H = Buffer.allocUnsafe(<span class="number">32</span>)

  H.writeInt32BE(<span class="keyword">this</span>._a, <span class="number">0</span>)
  H.writeInt32BE(<span class="keyword">this</span>._b, <span class="number">4</span>)
  H.writeInt32BE(<span class="keyword">this</span>._c, <span class="number">8</span>)
  H.writeInt32BE(<span class="keyword">this</span>._d, <span class="number">12</span>)
  H.writeInt32BE(<span class="keyword">this</span>._e, <span class="number">16</span>)
  H.writeInt32BE(<span class="keyword">this</span>._f, <span class="number">20</span>)
  H.writeInt32BE(<span class="keyword">this</span>._g, <span class="number">24</span>)
  H.writeInt32BE(<span class="keyword">this</span>._h, <span class="number">28</span>)

  <span class="keyword">return</span> H
}

module.exports = Sha256
</code></pre>