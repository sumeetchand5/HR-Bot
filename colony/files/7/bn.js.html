<h1>bn.js</h1>
<pre><code class="lang-js">(<span class="function"><span class="keyword">function</span> <span class="params">(module, exports)</span> {</span>
  <span class="string">'use strict'</span>;

  <span class="comment">// Utils</span>
  <span class="function"><span class="keyword">function</span> <span class="title">assert</span> <span class="params">(val, msg)</span> {</span>
    <span class="keyword">if</span> (!val) <span class="keyword">throw</span> <span class="keyword">new</span> Error(msg || <span class="string">'Assertion failed'</span>);
  }

  <span class="comment">// Could use `inherits` module, but don't want to move from single file</span>
  <span class="comment">// architecture yet.</span>
  <span class="function"><span class="keyword">function</span> <span class="title">inherits</span> <span class="params">(ctor, superCtor)</span> {</span>
    ctor.super_ = superCtor;
    <span class="keyword">var</span> TempCtor = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>};
    TempCtor.prototype = superCtor.prototype;
    ctor.prototype = <span class="keyword">new</span> TempCtor();
    ctor.prototype.constructor = ctor;
  }

  <span class="comment">// BN</span>

  <span class="function"><span class="keyword">function</span> <span class="title">BN</span> <span class="params">(number, base, endian)</span> {</span>
    <span class="keyword">if</span> (BN.isBN(number)) {
      <span class="keyword">return</span> number;
    }

    <span class="keyword">this</span>.negative = <span class="number">0</span>;
    <span class="keyword">this</span>.words = <span class="literal">null</span>;
    <span class="keyword">this</span>.length = <span class="number">0</span>;

    <span class="comment">// Reduction context</span>
    <span class="keyword">this</span>.red = <span class="literal">null</span>;

    <span class="keyword">if</span> (number !== <span class="literal">null</span>) {
      <span class="keyword">if</span> (base === <span class="string">'le'</span> || base === <span class="string">'be'</span>) {
        endian = base;
        base = <span class="number">10</span>;
      }

      <span class="keyword">this</span>._init(number || <span class="number">0</span>, base || <span class="number">10</span>, endian || <span class="string">'be'</span>);
    }
  }
  <span class="keyword">if</span> (<span class="keyword">typeof</span> module === <span class="string">'object'</span>) {
    module.exports = BN;
  } <span class="keyword">else</span> {
    exports.BN = BN;
  }

  BN.BN = BN;
  BN.wordSize = <span class="number">26</span>;

  <span class="keyword">var</span> Buffer;
  <span class="keyword">try</span> {
    Buffer = require(<span class="string">'buffer'</span>).Buffer;
  } <span class="keyword">catch</span> (e) {
  }

  BN.isBN = <span class="function"><span class="keyword">function</span> <span class="title">isBN</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (num <span class="keyword">instanceof</span> BN) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }

    <span class="keyword">return</span> num !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> num === <span class="string">'object'</span> &amp;&amp;
      num.constructor.wordSize === BN.wordSize &amp;&amp; Array.isArray(num.words);
  };

  BN.max = <span class="function"><span class="keyword">function</span> <span class="title">max</span> <span class="params">(left, right)</span> {</span>
    <span class="keyword">if</span> (left.cmp(right) > <span class="number">0</span>) <span class="keyword">return</span> left;
    <span class="keyword">return</span> right;
  };

  BN.min = <span class="function"><span class="keyword">function</span> <span class="title">min</span> <span class="params">(left, right)</span> {</span>
    <span class="keyword">if</span> (left.cmp(right) &lt; <span class="number">0</span>) <span class="keyword">return</span> left;
    <span class="keyword">return</span> right;
  };

  BN.prototype._init = <span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(number, base, endian)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> number === <span class="string">'number'</span>) {
      <span class="keyword">return</span> <span class="keyword">this</span>._initNumber(number, base, endian);
    }

    <span class="keyword">if</span> (<span class="keyword">typeof</span> number === <span class="string">'object'</span>) {
      <span class="keyword">return</span> <span class="keyword">this</span>._initArray(number, base, endian);
    }

    <span class="keyword">if</span> (base === <span class="string">'hex'</span>) {
      base = <span class="number">16</span>;
    }
    assert(base === (base | <span class="number">0</span>) &amp;&amp; base >= <span class="number">2</span> &amp;&amp; base &lt;= <span class="number">36</span>);

    number = number.toString().replace(<span class="regexp">/\s+/g</span>, <span class="string">''</span>);
    <span class="keyword">var</span> start = <span class="number">0</span>;
    <span class="keyword">if</span> (number[<span class="number">0</span>] === <span class="string">'-'</span>) {
      start++;
    }

    <span class="keyword">if</span> (base === <span class="number">16</span>) {
      <span class="keyword">this</span>._parseHex(number, start);
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>._parseBase(number, base, start);
    }

    <span class="keyword">if</span> (number[<span class="number">0</span>] === <span class="string">'-'</span>) {
      <span class="keyword">this</span>.negative = <span class="number">1</span>;
    }

    <span class="keyword">this</span>.strip();

    <span class="keyword">if</span> (endian !== <span class="string">'le'</span>) <span class="keyword">return</span>;

    <span class="keyword">this</span>._initArray(<span class="keyword">this</span>.toArray(), base, endian);
  };

  BN.prototype._initNumber = <span class="function"><span class="keyword">function</span> <span class="title">_initNumber</span> <span class="params">(number, base, endian)</span> {</span>
    <span class="keyword">if</span> (number &lt; <span class="number">0</span>) {
      <span class="keyword">this</span>.negative = <span class="number">1</span>;
      number = -number;
    }
    <span class="keyword">if</span> (number &lt; <span class="number">0x4000000</span>) {
      <span class="keyword">this</span>.words = [ number &amp; <span class="number">0x3ffffff</span> ];
      <span class="keyword">this</span>.length = <span class="number">1</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (number &lt; <span class="number">0x10000000000000</span>) {
      <span class="keyword">this</span>.words = [
        number &amp; <span class="number">0x3ffffff</span>,
        (number / <span class="number">0x4000000</span>) &amp; <span class="number">0x3ffffff</span>
      ];
      <span class="keyword">this</span>.length = <span class="number">2</span>;
    } <span class="keyword">else</span> {
      assert(number &lt; <span class="number">0x20000000000000</span>); <span class="comment">// 2 ^ 53 (unsafe)</span>
      <span class="keyword">this</span>.words = [
        number &amp; <span class="number">0x3ffffff</span>,
        (number / <span class="number">0x4000000</span>) &amp; <span class="number">0x3ffffff</span>,
        <span class="number">1</span>
      ];
      <span class="keyword">this</span>.length = <span class="number">3</span>;
    }

    <span class="keyword">if</span> (endian !== <span class="string">'le'</span>) <span class="keyword">return</span>;

    <span class="comment">// Reverse the bytes</span>
    <span class="keyword">this</span>._initArray(<span class="keyword">this</span>.toArray(), base, endian);
  };

  BN.prototype._initArray = <span class="function"><span class="keyword">function</span> <span class="title">_initArray</span> <span class="params">(number, base, endian)</span> {</span>
    <span class="comment">// Perhaps a Uint8Array</span>
    assert(<span class="keyword">typeof</span> number.length === <span class="string">'number'</span>);
    <span class="keyword">if</span> (number.length &lt;= <span class="number">0</span>) {
      <span class="keyword">this</span>.words = [ <span class="number">0</span> ];
      <span class="keyword">this</span>.length = <span class="number">1</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }

    <span class="keyword">this</span>.length = Math.ceil(number.length / <span class="number">3</span>);
    <span class="keyword">this</span>.words = <span class="keyword">new</span> Array(<span class="keyword">this</span>.length);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
      <span class="keyword">this</span>.words[i] = <span class="number">0</span>;
    }

    <span class="keyword">var</span> j, w;
    <span class="keyword">var</span> off = <span class="number">0</span>;
    <span class="keyword">if</span> (endian === <span class="string">'be'</span>) {
      <span class="keyword">for</span> (i = number.length - <span class="number">1</span>, j = <span class="number">0</span>; i >= <span class="number">0</span>; i -= <span class="number">3</span>) {
        w = number[i] | (number[i - <span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (number[i - <span class="number">2</span>] &lt;&lt; <span class="number">16</span>);
        <span class="keyword">this</span>.words[j] |= (w &lt;&lt; off) &amp; <span class="number">0x3ffffff</span>;
        <span class="keyword">this</span>.words[j + <span class="number">1</span>] = (w >>> (<span class="number">26</span> - off)) &amp; <span class="number">0x3ffffff</span>;
        off += <span class="number">24</span>;
        <span class="keyword">if</span> (off >= <span class="number">26</span>) {
          off -= <span class="number">26</span>;
          j++;
        }
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (endian === <span class="string">'le'</span>) {
      <span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; number.length; i += <span class="number">3</span>) {
        w = number[i] | (number[i + <span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | (number[i + <span class="number">2</span>] &lt;&lt; <span class="number">16</span>);
        <span class="keyword">this</span>.words[j] |= (w &lt;&lt; off) &amp; <span class="number">0x3ffffff</span>;
        <span class="keyword">this</span>.words[j + <span class="number">1</span>] = (w >>> (<span class="number">26</span> - off)) &amp; <span class="number">0x3ffffff</span>;
        off += <span class="number">24</span>;
        <span class="keyword">if</span> (off >= <span class="number">26</span>) {
          off -= <span class="number">26</span>;
          j++;
        }
      }
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  <span class="function"><span class="keyword">function</span> <span class="title">parseHex</span> <span class="params">(str, start, end)</span> {</span>
    <span class="keyword">var</span> r = <span class="number">0</span>;
    <span class="keyword">var</span> len = Math.min(str.length, end);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = start; i &lt; len; i++) {
      <span class="keyword">var</span> c = str.charCodeAt(i) - <span class="number">48</span>;

      r &lt;&lt;= <span class="number">4</span>;

      <span class="comment">// 'a' - 'f'</span>
      <span class="keyword">if</span> (c >= <span class="number">49</span> &amp;&amp; c &lt;= <span class="number">54</span>) {
        r |= c - <span class="number">49</span> + <span class="number">0xa</span>;

      <span class="comment">// 'A' - 'F'</span>
      } <span class="keyword">else</span> <span class="keyword">if</span> (c >= <span class="number">17</span> &amp;&amp; c &lt;= <span class="number">22</span>) {
        r |= c - <span class="number">17</span> + <span class="number">0xa</span>;

      <span class="comment">// '0' - '9'</span>
      } <span class="keyword">else</span> {
        r |= c &amp; <span class="number">0xf</span>;
      }
    }
    <span class="keyword">return</span> r;
  }

  BN.prototype._parseHex = <span class="function"><span class="keyword">function</span> <span class="title">_parseHex</span> <span class="params">(number, start)</span> {</span>
    <span class="comment">// Create possibly bigger array to ensure that it fits the number</span>
    <span class="keyword">this</span>.length = Math.ceil((number.length - start) / <span class="number">6</span>);
    <span class="keyword">this</span>.words = <span class="keyword">new</span> Array(<span class="keyword">this</span>.length);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
      <span class="keyword">this</span>.words[i] = <span class="number">0</span>;
    }

    <span class="keyword">var</span> j, w;
    <span class="comment">// Scan 24-bit chunks and add them to the number</span>
    <span class="keyword">var</span> off = <span class="number">0</span>;
    <span class="keyword">for</span> (i = number.length - <span class="number">6</span>, j = <span class="number">0</span>; i >= start; i -= <span class="number">6</span>) {
      w = parseHex(number, i, i + <span class="number">6</span>);
      <span class="keyword">this</span>.words[j] |= (w &lt;&lt; off) &amp; <span class="number">0x3ffffff</span>;
      <span class="comment">// NOTE: `0x3fffff` is intentional here, 26bits max shift + 24bit hex limb</span>
      <span class="keyword">this</span>.words[j + <span class="number">1</span>] |= w >>> (<span class="number">26</span> - off) &amp; <span class="number">0x3fffff</span>;
      off += <span class="number">24</span>;
      <span class="keyword">if</span> (off >= <span class="number">26</span>) {
        off -= <span class="number">26</span>;
        j++;
      }
    }
    <span class="keyword">if</span> (i + <span class="number">6</span> !== start) {
      w = parseHex(number, start, i + <span class="number">6</span>);
      <span class="keyword">this</span>.words[j] |= (w &lt;&lt; off) &amp; <span class="number">0x3ffffff</span>;
      <span class="keyword">this</span>.words[j + <span class="number">1</span>] |= w >>> (<span class="number">26</span> - off) &amp; <span class="number">0x3fffff</span>;
    }
    <span class="keyword">this</span>.strip();
  };

  <span class="function"><span class="keyword">function</span> <span class="title">parseBase</span> <span class="params">(str, start, end, mul)</span> {</span>
    <span class="keyword">var</span> r = <span class="number">0</span>;
    <span class="keyword">var</span> len = Math.min(str.length, end);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = start; i &lt; len; i++) {
      <span class="keyword">var</span> c = str.charCodeAt(i) - <span class="number">48</span>;

      r *= mul;

      <span class="comment">// 'a'</span>
      <span class="keyword">if</span> (c >= <span class="number">49</span>) {
        r += c - <span class="number">49</span> + <span class="number">0xa</span>;

      <span class="comment">// 'A'</span>
      } <span class="keyword">else</span> <span class="keyword">if</span> (c >= <span class="number">17</span>) {
        r += c - <span class="number">17</span> + <span class="number">0xa</span>;

      <span class="comment">// '0' - '9'</span>
      } <span class="keyword">else</span> {
        r += c;
      }
    }
    <span class="keyword">return</span> r;
  }

  BN.prototype._parseBase = <span class="function"><span class="keyword">function</span> <span class="title">_parseBase</span> <span class="params">(number, base, start)</span> {</span>
    <span class="comment">// Initialize as zero</span>
    <span class="keyword">this</span>.words = [ <span class="number">0</span> ];
    <span class="keyword">this</span>.length = <span class="number">1</span>;

    <span class="comment">// Find length of limb in base</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> limbLen = <span class="number">0</span>, limbPow = <span class="number">1</span>; limbPow &lt;= <span class="number">0x3ffffff</span>; limbPow *= base) {
      limbLen++;
    }
    limbLen--;
    limbPow = (limbPow / base) | <span class="number">0</span>;

    <span class="keyword">var</span> total = number.length - start;
    <span class="keyword">var</span> mod = total % limbLen;
    <span class="keyword">var</span> end = Math.min(total, total - mod) + start;

    <span class="keyword">var</span> word = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = start; i &lt; end; i += limbLen) {
      word = parseBase(number, i, i + limbLen, base);

      <span class="keyword">this</span>.imuln(limbPow);
      <span class="keyword">if</span> (<span class="keyword">this</span>.words[<span class="number">0</span>] + word &lt; <span class="number">0x4000000</span>) {
        <span class="keyword">this</span>.words[<span class="number">0</span>] += word;
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>._iaddn(word);
      }
    }

    <span class="keyword">if</span> (mod !== <span class="number">0</span>) {
      <span class="keyword">var</span> pow = <span class="number">1</span>;
      word = parseBase(number, i, number.length, base);

      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; mod; i++) {
        pow *= base;
      }

      <span class="keyword">this</span>.imuln(pow);
      <span class="keyword">if</span> (<span class="keyword">this</span>.words[<span class="number">0</span>] + word &lt; <span class="number">0x4000000</span>) {
        <span class="keyword">this</span>.words[<span class="number">0</span>] += word;
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>._iaddn(word);
      }
    }
  };

  BN.prototype.copy = <span class="function"><span class="keyword">function</span> <span class="title">copy</span> <span class="params">(dest)</span> {</span>
    dest.words = <span class="keyword">new</span> Array(<span class="keyword">this</span>.length);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
      dest.words[i] = <span class="keyword">this</span>.words[i];
    }
    dest.length = <span class="keyword">this</span>.length;
    dest.negative = <span class="keyword">this</span>.negative;
    dest.red = <span class="keyword">this</span>.red;
  };

  BN.prototype.clone = <span class="function"><span class="keyword">function</span> <span class="title">clone</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> r = <span class="keyword">new</span> BN(<span class="literal">null</span>);
    <span class="keyword">this</span>.copy(r);
    <span class="keyword">return</span> r;
  };

  BN.prototype._expand = <span class="function"><span class="keyword">function</span> <span class="title">_expand</span> <span class="params">(size)</span> {</span>
    <span class="keyword">while</span> (<span class="keyword">this</span>.length &lt; size) {
      <span class="keyword">this</span>.words[<span class="keyword">this</span>.length++] = <span class="number">0</span>;
    }
    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  <span class="comment">// Remove leading `0` from `this`</span>
  BN.prototype.strip = <span class="function"><span class="keyword">function</span> <span class="title">strip</span> <span class="params">()</span> {</span>
    <span class="keyword">while</span> (<span class="keyword">this</span>.length > <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>.words[<span class="keyword">this</span>.length - <span class="number">1</span>] === <span class="number">0</span>) {
      <span class="keyword">this</span>.length--;
    }
    <span class="keyword">return</span> <span class="keyword">this</span>._normSign();
  };

  BN.prototype._normSign = <span class="function"><span class="keyword">function</span> <span class="title">_normSign</span> <span class="params">()</span> {</span>
    <span class="comment">// -0 = 0</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>.words[<span class="number">0</span>] === <span class="number">0</span>) {
      <span class="keyword">this</span>.negative = <span class="number">0</span>;
    }
    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  BN.prototype.inspect = <span class="function"><span class="keyword">function</span> <span class="title">inspect</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> (<span class="keyword">this</span>.red ? <span class="string">'&lt;BN-R: '</span> : <span class="string">'&lt;BN: '</span>) + <span class="keyword">this</span>.toString(<span class="number">16</span>) + <span class="string">'>'</span>;
  };

  <span class="comment">/*

  var zeros = [];
  var groupSizes = [];
  var groupBases = [];

  var s = '';
  var i = -1;
  while (++i &lt; BN.wordSize) {
    zeros[i] = s;
    s += '0';
  }
  groupSizes[0] = 0;
  groupSizes[1] = 0;
  groupBases[0] = 0;
  groupBases[1] = 0;
  var base = 2 - 1;
  while (++base &lt; 36 + 1) {
    var groupSize = 0;
    var groupBase = 1;
    while (groupBase &lt; (1 &lt;&lt; BN.wordSize) / base) {
      groupBase *= base;
      groupSize += 1;
    }
    groupSizes[base] = groupSize;
    groupBases[base] = groupBase;
  }

  */</span>

  <span class="keyword">var</span> zeros = [
    <span class="string">''</span>,
    <span class="string">'0'</span>,
    <span class="string">'00'</span>,
    <span class="string">'000'</span>,
    <span class="string">'0000'</span>,
    <span class="string">'00000'</span>,
    <span class="string">'000000'</span>,
    <span class="string">'0000000'</span>,
    <span class="string">'00000000'</span>,
    <span class="string">'000000000'</span>,
    <span class="string">'0000000000'</span>,
    <span class="string">'00000000000'</span>,
    <span class="string">'000000000000'</span>,
    <span class="string">'0000000000000'</span>,
    <span class="string">'00000000000000'</span>,
    <span class="string">'000000000000000'</span>,
    <span class="string">'0000000000000000'</span>,
    <span class="string">'00000000000000000'</span>,
    <span class="string">'000000000000000000'</span>,
    <span class="string">'0000000000000000000'</span>,
    <span class="string">'00000000000000000000'</span>,
    <span class="string">'000000000000000000000'</span>,
    <span class="string">'0000000000000000000000'</span>,
    <span class="string">'00000000000000000000000'</span>,
    <span class="string">'000000000000000000000000'</span>,
    <span class="string">'0000000000000000000000000'</span>
  ];

  <span class="keyword">var</span> groupSizes = [
    <span class="number">0</span>, <span class="number">0</span>,
    <span class="number">25</span>, <span class="number">16</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">8</span>,
    <span class="number">8</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">6</span>,
    <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">5</span>,
    <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>,
    <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>
  ];

  <span class="keyword">var</span> groupBases = [
    <span class="number">0</span>, <span class="number">0</span>,
    <span class="number">33554432</span>, <span class="number">43046721</span>, <span class="number">16777216</span>, <span class="number">48828125</span>, <span class="number">60466176</span>, <span class="number">40353607</span>, <span class="number">16777216</span>,
    <span class="number">43046721</span>, <span class="number">10000000</span>, <span class="number">19487171</span>, <span class="number">35831808</span>, <span class="number">62748517</span>, <span class="number">7529536</span>, <span class="number">11390625</span>,
    <span class="number">16777216</span>, <span class="number">24137569</span>, <span class="number">34012224</span>, <span class="number">47045881</span>, <span class="number">64000000</span>, <span class="number">4084101</span>, <span class="number">5153632</span>,
    <span class="number">6436343</span>, <span class="number">7962624</span>, <span class="number">9765625</span>, <span class="number">11881376</span>, <span class="number">14348907</span>, <span class="number">17210368</span>, <span class="number">20511149</span>,
    <span class="number">24300000</span>, <span class="number">28629151</span>, <span class="number">33554432</span>, <span class="number">39135393</span>, <span class="number">45435424</span>, <span class="number">52521875</span>, <span class="number">60466176</span>
  ];

  BN.prototype.toString = <span class="function"><span class="keyword">function</span> <span class="title">toString</span> <span class="params">(base, padding)</span> {</span>
    base = base || <span class="number">10</span>;
    padding = padding | <span class="number">0</span> || <span class="number">1</span>;

    <span class="keyword">var</span> out;
    <span class="keyword">if</span> (base === <span class="number">16</span> || base === <span class="string">'hex'</span>) {
      out = <span class="string">''</span>;
      <span class="keyword">var</span> off = <span class="number">0</span>;
      <span class="keyword">var</span> carry = <span class="number">0</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
        <span class="keyword">var</span> w = <span class="keyword">this</span>.words[i];
        <span class="keyword">var</span> word = (((w &lt;&lt; off) | carry) &amp; <span class="number">0xffffff</span>).toString(<span class="number">16</span>);
        carry = (w >>> (<span class="number">24</span> - off)) &amp; <span class="number">0xffffff</span>;
        <span class="keyword">if</span> (carry !== <span class="number">0</span> || i !== <span class="keyword">this</span>.length - <span class="number">1</span>) {
          out = zeros[<span class="number">6</span> - word.length] + word + out;
        } <span class="keyword">else</span> {
          out = word + out;
        }
        off += <span class="number">2</span>;
        <span class="keyword">if</span> (off >= <span class="number">26</span>) {
          off -= <span class="number">26</span>;
          i--;
        }
      }
      <span class="keyword">if</span> (carry !== <span class="number">0</span>) {
        out = carry.toString(<span class="number">16</span>) + out;
      }
      <span class="keyword">while</span> (out.length % padding !== <span class="number">0</span>) {
        out = <span class="string">'0'</span> + out;
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) {
        out = <span class="string">'-'</span> + out;
      }
      <span class="keyword">return</span> out;
    }

    <span class="keyword">if</span> (base === (base | <span class="number">0</span>) &amp;&amp; base >= <span class="number">2</span> &amp;&amp; base &lt;= <span class="number">36</span>) {
      <span class="comment">// var groupSize = Math.floor(BN.wordSize * Math.LN2 / Math.log(base));</span>
      <span class="keyword">var</span> groupSize = groupSizes[base];
      <span class="comment">// var groupBase = Math.pow(base, groupSize);</span>
      <span class="keyword">var</span> groupBase = groupBases[base];
      out = <span class="string">''</span>;
      <span class="keyword">var</span> c = <span class="keyword">this</span>.clone();
      c.negative = <span class="number">0</span>;
      <span class="keyword">while</span> (!c.isZero()) {
        <span class="keyword">var</span> r = c.modn(groupBase).toString(base);
        c = c.idivn(groupBase);

        <span class="keyword">if</span> (!c.isZero()) {
          out = zeros[groupSize - r.length] + r + out;
        } <span class="keyword">else</span> {
          out = r + out;
        }
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.isZero()) {
        out = <span class="string">'0'</span> + out;
      }
      <span class="keyword">while</span> (out.length % padding !== <span class="number">0</span>) {
        out = <span class="string">'0'</span> + out;
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) {
        out = <span class="string">'-'</span> + out;
      }
      <span class="keyword">return</span> out;
    }

    assert(<span class="literal">false</span>, <span class="string">'Base should be between 2 and 36'</span>);
  };

  BN.prototype.toNumber = <span class="function"><span class="keyword">function</span> <span class="title">toNumber</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> ret = <span class="keyword">this</span>.words[<span class="number">0</span>];
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">2</span>) {
      ret += <span class="keyword">this</span>.words[<span class="number">1</span>] * <span class="number">0x4000000</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">3</span> &amp;&amp; <span class="keyword">this</span>.words[<span class="number">2</span>] === <span class="number">0x01</span>) {
      <span class="comment">// NOTE: at this stage it is known that the top bit is set</span>
      ret += <span class="number">0x10000000000000</span> + (<span class="keyword">this</span>.words[<span class="number">1</span>] * <span class="number">0x4000000</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.length > <span class="number">2</span>) {
      assert(<span class="literal">false</span>, <span class="string">'Number can only safely store up to 53 bits'</span>);
    }
    <span class="keyword">return</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) ? -ret : ret;
  };

  BN.prototype.toJSON = <span class="function"><span class="keyword">function</span> <span class="title">toJSON</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.toString(<span class="number">16</span>);
  };

  BN.prototype.toBuffer = <span class="function"><span class="keyword">function</span> <span class="title">toBuffer</span> <span class="params">(endian, length)</span> {</span>
    assert(<span class="keyword">typeof</span> Buffer !== <span class="string">'undefined'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.toArrayLike(Buffer, endian, length);
  };

  BN.prototype.toArray = <span class="function"><span class="keyword">function</span> <span class="title">toArray</span> <span class="params">(endian, length)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.toArrayLike(Array, endian, length);
  };

  BN.prototype.toArrayLike = <span class="function"><span class="keyword">function</span> <span class="title">toArrayLike</span> <span class="params">(ArrayType, endian, length)</span> {</span>
    <span class="keyword">var</span> byteLength = <span class="keyword">this</span>.byteLength();
    <span class="keyword">var</span> reqLength = length || Math.max(<span class="number">1</span>, byteLength);
    assert(byteLength &lt;= reqLength, <span class="string">'byte array longer than desired length'</span>);
    assert(reqLength > <span class="number">0</span>, <span class="string">'Requested array length &lt;= 0'</span>);

    <span class="keyword">this</span>.strip();
    <span class="keyword">var</span> littleEndian = endian === <span class="string">'le'</span>;
    <span class="keyword">var</span> res = <span class="keyword">new</span> ArrayType(reqLength);

    <span class="keyword">var</span> b, i;
    <span class="keyword">var</span> q = <span class="keyword">this</span>.clone();
    <span class="keyword">if</span> (!littleEndian) {
      <span class="comment">// Assume big-endian</span>
      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; reqLength - byteLength; i++) {
        res[i] = <span class="number">0</span>;
      }

      <span class="keyword">for</span> (i = <span class="number">0</span>; !q.isZero(); i++) {
        b = q.andln(<span class="number">0xff</span>);
        q.iushrn(<span class="number">8</span>);

        res[reqLength - i - <span class="number">1</span>] = b;
      }
    } <span class="keyword">else</span> {
      <span class="keyword">for</span> (i = <span class="number">0</span>; !q.isZero(); i++) {
        b = q.andln(<span class="number">0xff</span>);
        q.iushrn(<span class="number">8</span>);

        res[i] = b;
      }

      <span class="keyword">for</span> (; i &lt; reqLength; i++) {
        res[i] = <span class="number">0</span>;
      }
    }

    <span class="keyword">return</span> res;
  };

  <span class="keyword">if</span> (Math.clz32) {
    BN.prototype._countBits = <span class="function"><span class="keyword">function</span> <span class="title">_countBits</span> <span class="params">(w)</span> {</span>
      <span class="keyword">return</span> <span class="number">32</span> - Math.clz32(w);
    };
  } <span class="keyword">else</span> {
    BN.prototype._countBits = <span class="function"><span class="keyword">function</span> <span class="title">_countBits</span> <span class="params">(w)</span> {</span>
      <span class="keyword">var</span> t = w;
      <span class="keyword">var</span> r = <span class="number">0</span>;
      <span class="keyword">if</span> (t >= <span class="number">0x1000</span>) {
        r += <span class="number">13</span>;
        t >>>= <span class="number">13</span>;
      }
      <span class="keyword">if</span> (t >= <span class="number">0x40</span>) {
        r += <span class="number">7</span>;
        t >>>= <span class="number">7</span>;
      }
      <span class="keyword">if</span> (t >= <span class="number">0x8</span>) {
        r += <span class="number">4</span>;
        t >>>= <span class="number">4</span>;
      }
      <span class="keyword">if</span> (t >= <span class="number">0x02</span>) {
        r += <span class="number">2</span>;
        t >>>= <span class="number">2</span>;
      }
      <span class="keyword">return</span> r + t;
    };
  }

  BN.prototype._zeroBits = <span class="function"><span class="keyword">function</span> <span class="title">_zeroBits</span> <span class="params">(w)</span> {</span>
    <span class="comment">// Short-cut</span>
    <span class="keyword">if</span> (w === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">26</span>;

    <span class="keyword">var</span> t = w;
    <span class="keyword">var</span> r = <span class="number">0</span>;
    <span class="keyword">if</span> ((t &amp; <span class="number">0x1fff</span>) === <span class="number">0</span>) {
      r += <span class="number">13</span>;
      t >>>= <span class="number">13</span>;
    }
    <span class="keyword">if</span> ((t &amp; <span class="number">0x7f</span>) === <span class="number">0</span>) {
      r += <span class="number">7</span>;
      t >>>= <span class="number">7</span>;
    }
    <span class="keyword">if</span> ((t &amp; <span class="number">0xf</span>) === <span class="number">0</span>) {
      r += <span class="number">4</span>;
      t >>>= <span class="number">4</span>;
    }
    <span class="keyword">if</span> ((t &amp; <span class="number">0x3</span>) === <span class="number">0</span>) {
      r += <span class="number">2</span>;
      t >>>= <span class="number">2</span>;
    }
    <span class="keyword">if</span> ((t &amp; <span class="number">0x1</span>) === <span class="number">0</span>) {
      r++;
    }
    <span class="keyword">return</span> r;
  };

  <span class="comment">// Return number of used bits in a BN</span>
  BN.prototype.bitLength = <span class="function"><span class="keyword">function</span> <span class="title">bitLength</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> w = <span class="keyword">this</span>.words[<span class="keyword">this</span>.length - <span class="number">1</span>];
    <span class="keyword">var</span> hi = <span class="keyword">this</span>._countBits(w);
    <span class="keyword">return</span> (<span class="keyword">this</span>.length - <span class="number">1</span>) * <span class="number">26</span> + hi;
  };

  <span class="function"><span class="keyword">function</span> <span class="title">toBitArray</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> w = <span class="keyword">new</span> Array(num.bitLength());

    <span class="keyword">for</span> (<span class="keyword">var</span> bit = <span class="number">0</span>; bit &lt; w.length; bit++) {
      <span class="keyword">var</span> off = (bit / <span class="number">26</span>) | <span class="number">0</span>;
      <span class="keyword">var</span> wbit = bit % <span class="number">26</span>;

      w[bit] = (num.words[off] &amp; (<span class="number">1</span> &lt;&lt; wbit)) >>> wbit;
    }

    <span class="keyword">return</span> w;
  }

  <span class="comment">// Number of trailing zero bits</span>
  BN.prototype.zeroBits = <span class="function"><span class="keyword">function</span> <span class="title">zeroBits</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.isZero()) <span class="keyword">return</span> <span class="number">0</span>;

    <span class="keyword">var</span> r = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
      <span class="keyword">var</span> b = <span class="keyword">this</span>._zeroBits(<span class="keyword">this</span>.words[i]);
      r += b;
      <span class="keyword">if</span> (b !== <span class="number">26</span>) <span class="keyword">break</span>;
    }
    <span class="keyword">return</span> r;
  };

  BN.prototype.byteLength = <span class="function"><span class="keyword">function</span> <span class="title">byteLength</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> Math.ceil(<span class="keyword">this</span>.bitLength() / <span class="number">8</span>);
  };

  BN.prototype.toTwos = <span class="function"><span class="keyword">function</span> <span class="title">toTwos</span> <span class="params">(width)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) {
      <span class="keyword">return</span> <span class="keyword">this</span>.abs().inotn(width).iaddn(<span class="number">1</span>);
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.clone();
  };

  BN.prototype.fromTwos = <span class="function"><span class="keyword">function</span> <span class="title">fromTwos</span> <span class="params">(width)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.testn(width - <span class="number">1</span>)) {
      <span class="keyword">return</span> <span class="keyword">this</span>.notn(width).iaddn(<span class="number">1</span>).ineg();
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.clone();
  };

  BN.prototype.isNeg = <span class="function"><span class="keyword">function</span> <span class="title">isNeg</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.negative !== <span class="number">0</span>;
  };

  <span class="comment">// Return negative clone of `this`</span>
  BN.prototype.neg = <span class="function"><span class="keyword">function</span> <span class="title">neg</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().ineg();
  };

  BN.prototype.ineg = <span class="function"><span class="keyword">function</span> <span class="title">ineg</span> <span class="params">()</span> {</span>
    <span class="keyword">if</span> (!<span class="keyword">this</span>.isZero()) {
      <span class="keyword">this</span>.negative ^= <span class="number">1</span>;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  <span class="comment">// Or `num` with `this` in-place</span>
  BN.prototype.iuor = <span class="function"><span class="keyword">function</span> <span class="title">iuor</span> <span class="params">(num)</span> {</span>
    <span class="keyword">while</span> (<span class="keyword">this</span>.length &lt; num.length) {
      <span class="keyword">this</span>.words[<span class="keyword">this</span>.length++] = <span class="number">0</span>;
    }

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; num.length; i++) {
      <span class="keyword">this</span>.words[i] = <span class="keyword">this</span>.words[i] | num.words[i];
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype.ior = <span class="function"><span class="keyword">function</span> <span class="title">ior</span> <span class="params">(num)</span> {</span>
    assert((<span class="keyword">this</span>.negative | num.negative) === <span class="number">0</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.iuor(num);
  };

  <span class="comment">// Or `num` with `this`</span>
  BN.prototype.or = <span class="function"><span class="keyword">function</span> <span class="title">or</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) <span class="keyword">return</span> <span class="keyword">this</span>.clone().ior(num);
    <span class="keyword">return</span> num.clone().ior(<span class="keyword">this</span>);
  };

  BN.prototype.uor = <span class="function"><span class="keyword">function</span> <span class="title">uor</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) <span class="keyword">return</span> <span class="keyword">this</span>.clone().iuor(num);
    <span class="keyword">return</span> num.clone().iuor(<span class="keyword">this</span>);
  };

  <span class="comment">// And `num` with `this` in-place</span>
  BN.prototype.iuand = <span class="function"><span class="keyword">function</span> <span class="title">iuand</span> <span class="params">(num)</span> {</span>
    <span class="comment">// b = min-length(num, this)</span>
    <span class="keyword">var</span> b;
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) {
      b = num;
    } <span class="keyword">else</span> {
      b = <span class="keyword">this</span>;
    }

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; b.length; i++) {
      <span class="keyword">this</span>.words[i] = <span class="keyword">this</span>.words[i] &amp; num.words[i];
    }

    <span class="keyword">this</span>.length = b.length;

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype.iand = <span class="function"><span class="keyword">function</span> <span class="title">iand</span> <span class="params">(num)</span> {</span>
    assert((<span class="keyword">this</span>.negative | num.negative) === <span class="number">0</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.iuand(num);
  };

  <span class="comment">// And `num` with `this`</span>
  BN.prototype.and = <span class="function"><span class="keyword">function</span> <span class="title">and</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) <span class="keyword">return</span> <span class="keyword">this</span>.clone().iand(num);
    <span class="keyword">return</span> num.clone().iand(<span class="keyword">this</span>);
  };

  BN.prototype.uand = <span class="function"><span class="keyword">function</span> <span class="title">uand</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) <span class="keyword">return</span> <span class="keyword">this</span>.clone().iuand(num);
    <span class="keyword">return</span> num.clone().iuand(<span class="keyword">this</span>);
  };

  <span class="comment">// Xor `num` with `this` in-place</span>
  BN.prototype.iuxor = <span class="function"><span class="keyword">function</span> <span class="title">iuxor</span> <span class="params">(num)</span> {</span>
    <span class="comment">// a.length > b.length</span>
    <span class="keyword">var</span> a;
    <span class="keyword">var</span> b;
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) {
      a = <span class="keyword">this</span>;
      b = num;
    } <span class="keyword">else</span> {
      a = num;
      b = <span class="keyword">this</span>;
    }

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; b.length; i++) {
      <span class="keyword">this</span>.words[i] = a.words[i] ^ b.words[i];
    }

    <span class="keyword">if</span> (<span class="keyword">this</span> !== a) {
      <span class="keyword">for</span> (; i &lt; a.length; i++) {
        <span class="keyword">this</span>.words[i] = a.words[i];
      }
    }

    <span class="keyword">this</span>.length = a.length;

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype.ixor = <span class="function"><span class="keyword">function</span> <span class="title">ixor</span> <span class="params">(num)</span> {</span>
    assert((<span class="keyword">this</span>.negative | num.negative) === <span class="number">0</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.iuxor(num);
  };

  <span class="comment">// Xor `num` with `this`</span>
  BN.prototype.xor = <span class="function"><span class="keyword">function</span> <span class="title">xor</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) <span class="keyword">return</span> <span class="keyword">this</span>.clone().ixor(num);
    <span class="keyword">return</span> num.clone().ixor(<span class="keyword">this</span>);
  };

  BN.prototype.uxor = <span class="function"><span class="keyword">function</span> <span class="title">uxor</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) <span class="keyword">return</span> <span class="keyword">this</span>.clone().iuxor(num);
    <span class="keyword">return</span> num.clone().iuxor(<span class="keyword">this</span>);
  };

  <span class="comment">// Not ``this`` with ``width`` bitwidth</span>
  BN.prototype.inotn = <span class="function"><span class="keyword">function</span> <span class="title">inotn</span> <span class="params">(width)</span> {</span>
    assert(<span class="keyword">typeof</span> width === <span class="string">'number'</span> &amp;&amp; width >= <span class="number">0</span>);

    <span class="keyword">var</span> bytesNeeded = Math.ceil(width / <span class="number">26</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> bitsLeft = width % <span class="number">26</span>;

    <span class="comment">// Extend the buffer with leading zeroes</span>
    <span class="keyword">this</span>._expand(bytesNeeded);

    <span class="keyword">if</span> (bitsLeft > <span class="number">0</span>) {
      bytesNeeded--;
    }

    <span class="comment">// Handle complete words</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytesNeeded; i++) {
      <span class="keyword">this</span>.words[i] = ~<span class="keyword">this</span>.words[i] &amp; <span class="number">0x3ffffff</span>;
    }

    <span class="comment">// Handle the residue</span>
    <span class="keyword">if</span> (bitsLeft > <span class="number">0</span>) {
      <span class="keyword">this</span>.words[i] = ~<span class="keyword">this</span>.words[i] &amp; (<span class="number">0x3ffffff</span> >> (<span class="number">26</span> - bitsLeft));
    }

    <span class="comment">// And remove leading zeroes</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype.notn = <span class="function"><span class="keyword">function</span> <span class="title">notn</span> <span class="params">(width)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().inotn(width);
  };

  <span class="comment">// Set `bit` of `this`</span>
  BN.prototype.setn = <span class="function"><span class="keyword">function</span> <span class="title">setn</span> <span class="params">(bit, val)</span> {</span>
    assert(<span class="keyword">typeof</span> bit === <span class="string">'number'</span> &amp;&amp; bit >= <span class="number">0</span>);

    <span class="keyword">var</span> off = (bit / <span class="number">26</span>) | <span class="number">0</span>;
    <span class="keyword">var</span> wbit = bit % <span class="number">26</span>;

    <span class="keyword">this</span>._expand(off + <span class="number">1</span>);

    <span class="keyword">if</span> (val) {
      <span class="keyword">this</span>.words[off] = <span class="keyword">this</span>.words[off] | (<span class="number">1</span> &lt;&lt; wbit);
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.words[off] = <span class="keyword">this</span>.words[off] &amp; ~(<span class="number">1</span> &lt;&lt; wbit);
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  <span class="comment">// Add `num` to `this` in-place</span>
  BN.prototype.iadd = <span class="function"><span class="keyword">function</span> <span class="title">iadd</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> r;

    <span class="comment">// negative + positive</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span> &amp;&amp; num.negative === <span class="number">0</span>) {
      <span class="keyword">this</span>.negative = <span class="number">0</span>;
      r = <span class="keyword">this</span>.isub(num);
      <span class="keyword">this</span>.negative ^= <span class="number">1</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>._normSign();

    <span class="comment">// positive + negative</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.negative === <span class="number">0</span> &amp;&amp; num.negative !== <span class="number">0</span>) {
      num.negative = <span class="number">0</span>;
      r = <span class="keyword">this</span>.isub(num);
      num.negative = <span class="number">1</span>;
      <span class="keyword">return</span> r._normSign();
    }

    <span class="comment">// a.length > b.length</span>
    <span class="keyword">var</span> a, b;
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) {
      a = <span class="keyword">this</span>;
      b = num;
    } <span class="keyword">else</span> {
      a = num;
      b = <span class="keyword">this</span>;
    }

    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; b.length; i++) {
      r = (a.words[i] | <span class="number">0</span>) + (b.words[i] | <span class="number">0</span>) + carry;
      <span class="keyword">this</span>.words[i] = r &amp; <span class="number">0x3ffffff</span>;
      carry = r >>> <span class="number">26</span>;
    }
    <span class="keyword">for</span> (; carry !== <span class="number">0</span> &amp;&amp; i &lt; a.length; i++) {
      r = (a.words[i] | <span class="number">0</span>) + carry;
      <span class="keyword">this</span>.words[i] = r &amp; <span class="number">0x3ffffff</span>;
      carry = r >>> <span class="number">26</span>;
    }

    <span class="keyword">this</span>.length = a.length;
    <span class="keyword">if</span> (carry !== <span class="number">0</span>) {
      <span class="keyword">this</span>.words[<span class="keyword">this</span>.length] = carry;
      <span class="keyword">this</span>.length++;
    <span class="comment">// Copy the rest of the words</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (a !== <span class="keyword">this</span>) {
      <span class="keyword">for</span> (; i &lt; a.length; i++) {
        <span class="keyword">this</span>.words[i] = a.words[i];
      }
    }

    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  <span class="comment">// Add `num` to `this`</span>
  BN.prototype.add = <span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> res;
    <span class="keyword">if</span> (num.negative !== <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.negative === <span class="number">0</span>) {
      num.negative = <span class="number">0</span>;
      res = <span class="keyword">this</span>.sub(num);
      num.negative ^= <span class="number">1</span>;
      <span class="keyword">return</span> res;
    } <span class="keyword">else</span> <span class="keyword">if</span> (num.negative === <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.negative !== <span class="number">0</span>) {
      <span class="keyword">this</span>.negative = <span class="number">0</span>;
      res = num.sub(<span class="keyword">this</span>);
      <span class="keyword">this</span>.negative = <span class="number">1</span>;
      <span class="keyword">return</span> res;
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) <span class="keyword">return</span> <span class="keyword">this</span>.clone().iadd(num);

    <span class="keyword">return</span> num.clone().iadd(<span class="keyword">this</span>);
  };

  <span class="comment">// Subtract `num` from `this` in-place</span>
  BN.prototype.isub = <span class="function"><span class="keyword">function</span> <span class="title">isub</span> <span class="params">(num)</span> {</span>
    <span class="comment">// this - (-num) = this + num</span>
    <span class="keyword">if</span> (num.negative !== <span class="number">0</span>) {
      num.negative = <span class="number">0</span>;
      <span class="keyword">var</span> r = <span class="keyword">this</span>.iadd(num);
      num.negative = <span class="number">1</span>;
      <span class="keyword">return</span> r._normSign();

    <span class="comment">// -this - num = -(this + num)</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) {
      <span class="keyword">this</span>.negative = <span class="number">0</span>;
      <span class="keyword">this</span>.iadd(num);
      <span class="keyword">this</span>.negative = <span class="number">1</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>._normSign();
    }

    <span class="comment">// At this point both numbers are positive</span>
    <span class="keyword">var</span> cmp = <span class="keyword">this</span>.cmp(num);

    <span class="comment">// Optimization - zeroify</span>
    <span class="keyword">if</span> (cmp === <span class="number">0</span>) {
      <span class="keyword">this</span>.negative = <span class="number">0</span>;
      <span class="keyword">this</span>.length = <span class="number">1</span>;
      <span class="keyword">this</span>.words[<span class="number">0</span>] = <span class="number">0</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }

    <span class="comment">// a > b</span>
    <span class="keyword">var</span> a, b;
    <span class="keyword">if</span> (cmp > <span class="number">0</span>) {
      a = <span class="keyword">this</span>;
      b = num;
    } <span class="keyword">else</span> {
      a = num;
      b = <span class="keyword">this</span>;
    }

    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; b.length; i++) {
      r = (a.words[i] | <span class="number">0</span>) - (b.words[i] | <span class="number">0</span>) + carry;
      carry = r >> <span class="number">26</span>;
      <span class="keyword">this</span>.words[i] = r &amp; <span class="number">0x3ffffff</span>;
    }
    <span class="keyword">for</span> (; carry !== <span class="number">0</span> &amp;&amp; i &lt; a.length; i++) {
      r = (a.words[i] | <span class="number">0</span>) + carry;
      carry = r >> <span class="number">26</span>;
      <span class="keyword">this</span>.words[i] = r &amp; <span class="number">0x3ffffff</span>;
    }

    <span class="comment">// Copy rest of the words</span>
    <span class="keyword">if</span> (carry === <span class="number">0</span> &amp;&amp; i &lt; a.length &amp;&amp; a !== <span class="keyword">this</span>) {
      <span class="keyword">for</span> (; i &lt; a.length; i++) {
        <span class="keyword">this</span>.words[i] = a.words[i];
      }
    }

    <span class="keyword">this</span>.length = Math.max(<span class="keyword">this</span>.length, i);

    <span class="keyword">if</span> (a !== <span class="keyword">this</span>) {
      <span class="keyword">this</span>.negative = <span class="number">1</span>;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  <span class="comment">// Subtract `num` from `this`</span>
  BN.prototype.sub = <span class="function"><span class="keyword">function</span> <span class="title">sub</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().isub(num);
  };

  <span class="function"><span class="keyword">function</span> <span class="title">smallMulTo</span> <span class="params">(self, num, out)</span> {</span>
    out.negative = num.negative ^ self.negative;
    <span class="keyword">var</span> len = (self.length + num.length) | <span class="number">0</span>;
    out.length = len;
    len = (len - <span class="number">1</span>) | <span class="number">0</span>;

    <span class="comment">// Peel one iteration (compiler can't do it, because of code complexity)</span>
    <span class="keyword">var</span> a = self.words[<span class="number">0</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> b = num.words[<span class="number">0</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> r = a * b;

    <span class="keyword">var</span> lo = r &amp; <span class="number">0x3ffffff</span>;
    <span class="keyword">var</span> carry = (r / <span class="number">0x4000000</span>) | <span class="number">0</span>;
    out.words[<span class="number">0</span>] = lo;

    <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">1</span>; k &lt; len; k++) {
      <span class="comment">// Sum all words with the same `i + j = k` and accumulate `ncarry`,</span>
      <span class="comment">// note that ncarry could be >= 0x3ffffff</span>
      <span class="keyword">var</span> ncarry = carry >>> <span class="number">26</span>;
      <span class="keyword">var</span> rword = carry &amp; <span class="number">0x3ffffff</span>;
      <span class="keyword">var</span> maxJ = Math.min(k, num.length - <span class="number">1</span>);
      <span class="keyword">for</span> (<span class="keyword">var</span> j = Math.max(<span class="number">0</span>, k - self.length + <span class="number">1</span>); j &lt;= maxJ; j++) {
        <span class="keyword">var</span> i = (k - j) | <span class="number">0</span>;
        a = self.words[i] | <span class="number">0</span>;
        b = num.words[j] | <span class="number">0</span>;
        r = a * b + rword;
        ncarry += (r / <span class="number">0x4000000</span>) | <span class="number">0</span>;
        rword = r &amp; <span class="number">0x3ffffff</span>;
      }
      out.words[k] = rword | <span class="number">0</span>;
      carry = ncarry | <span class="number">0</span>;
    }
    <span class="keyword">if</span> (carry !== <span class="number">0</span>) {
      out.words[k] = carry | <span class="number">0</span>;
    } <span class="keyword">else</span> {
      out.length--;
    }

    <span class="keyword">return</span> out.strip();
  }

  <span class="comment">// TODO(indutny): it may be reasonable to omit it for users who don't need</span>
  <span class="comment">// to work with 256-bit numbers, otherwise it gives 20% improvement for 256-bit</span>
  <span class="comment">// multiplication (like elliptic secp256k1).</span>
  <span class="keyword">var</span> comb10MulTo = <span class="function"><span class="keyword">function</span> <span class="title">comb10MulTo</span> <span class="params">(self, num, out)</span> {</span>
    <span class="keyword">var</span> a = self.words;
    <span class="keyword">var</span> b = num.words;
    <span class="keyword">var</span> o = out.words;
    <span class="keyword">var</span> c = <span class="number">0</span>;
    <span class="keyword">var</span> lo;
    <span class="keyword">var</span> mid;
    <span class="keyword">var</span> hi;
    <span class="keyword">var</span> a0 = a[<span class="number">0</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al0 = a0 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah0 = a0 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a1 = a[<span class="number">1</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al1 = a1 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah1 = a1 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a2 = a[<span class="number">2</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al2 = a2 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah2 = a2 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a3 = a[<span class="number">3</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al3 = a3 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah3 = a3 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a4 = a[<span class="number">4</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al4 = a4 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah4 = a4 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a5 = a[<span class="number">5</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al5 = a5 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah5 = a5 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a6 = a[<span class="number">6</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al6 = a6 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah6 = a6 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a7 = a[<span class="number">7</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al7 = a7 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah7 = a7 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a8 = a[<span class="number">8</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al8 = a8 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah8 = a8 >>> <span class="number">13</span>;
    <span class="keyword">var</span> a9 = a[<span class="number">9</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> al9 = a9 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> ah9 = a9 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b0 = b[<span class="number">0</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl0 = b0 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh0 = b0 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b1 = b[<span class="number">1</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl1 = b1 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh1 = b1 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b2 = b[<span class="number">2</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl2 = b2 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh2 = b2 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b3 = b[<span class="number">3</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl3 = b3 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh3 = b3 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b4 = b[<span class="number">4</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl4 = b4 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh4 = b4 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b5 = b[<span class="number">5</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl5 = b5 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh5 = b5 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b6 = b[<span class="number">6</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl6 = b6 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh6 = b6 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b7 = b[<span class="number">7</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl7 = b7 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh7 = b7 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b8 = b[<span class="number">8</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl8 = b8 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh8 = b8 >>> <span class="number">13</span>;
    <span class="keyword">var</span> b9 = b[<span class="number">9</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bl9 = b9 &amp; <span class="number">0x1fff</span>;
    <span class="keyword">var</span> bh9 = b9 >>> <span class="number">13</span>;

    out.negative = self.negative ^ num.negative;
    out.length = <span class="number">19</span>;
    <span class="comment">/* k = 0 */</span>
    lo = Math.imul(al0, bl0);
    mid = Math.imul(al0, bh0);
    mid = (mid + Math.imul(ah0, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah0, bh0);
    <span class="keyword">var</span> w0 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w0 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w0 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 1 */</span>
    lo = Math.imul(al1, bl0);
    mid = Math.imul(al1, bh0);
    mid = (mid + Math.imul(ah1, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah1, bh0);
    lo = (lo + Math.imul(al0, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh1)) | <span class="number">0</span>;
    <span class="keyword">var</span> w1 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w1 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w1 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 2 */</span>
    lo = Math.imul(al2, bl0);
    mid = Math.imul(al2, bh0);
    mid = (mid + Math.imul(ah2, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah2, bh0);
    lo = (lo + Math.imul(al1, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh1)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al0, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh2)) | <span class="number">0</span>;
    <span class="keyword">var</span> w2 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w2 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w2 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 3 */</span>
    lo = Math.imul(al3, bl0);
    mid = Math.imul(al3, bh0);
    mid = (mid + Math.imul(ah3, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah3, bh0);
    lo = (lo + Math.imul(al2, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh1)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al1, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh2)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al0, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh3)) | <span class="number">0</span>;
    <span class="keyword">var</span> w3 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w3 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w3 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 4 */</span>
    lo = Math.imul(al4, bl0);
    mid = Math.imul(al4, bh0);
    mid = (mid + Math.imul(ah4, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah4, bh0);
    lo = (lo + Math.imul(al3, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh1)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al2, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh2)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al1, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh3)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al0, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh4)) | <span class="number">0</span>;
    <span class="keyword">var</span> w4 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w4 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w4 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 5 */</span>
    lo = Math.imul(al5, bl0);
    mid = Math.imul(al5, bh0);
    mid = (mid + Math.imul(ah5, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah5, bh0);
    lo = (lo + Math.imul(al4, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh1)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al3, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh2)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al2, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh3)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al1, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh4)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al0, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh5)) | <span class="number">0</span>;
    <span class="keyword">var</span> w5 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w5 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w5 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 6 */</span>
    lo = Math.imul(al6, bl0);
    mid = Math.imul(al6, bh0);
    mid = (mid + Math.imul(ah6, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah6, bh0);
    lo = (lo + Math.imul(al5, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh1)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al4, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh2)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al3, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh3)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al2, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh4)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al1, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh5)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al0, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh6)) | <span class="number">0</span>;
    <span class="keyword">var</span> w6 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w6 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w6 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 7 */</span>
    lo = Math.imul(al7, bl0);
    mid = Math.imul(al7, bh0);
    mid = (mid + Math.imul(ah7, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah7, bh0);
    lo = (lo + Math.imul(al6, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh1)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al5, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh2)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al4, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh3)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al3, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh4)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al2, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh5)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al1, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh6)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al0, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh7)) | <span class="number">0</span>;
    <span class="keyword">var</span> w7 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w7 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w7 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 8 */</span>
    lo = Math.imul(al8, bl0);
    mid = Math.imul(al8, bh0);
    mid = (mid + Math.imul(ah8, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah8, bh0);
    lo = (lo + Math.imul(al7, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh1)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al6, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh2)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al5, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh3)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al4, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh4)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al3, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh5)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al2, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh6)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al1, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh7)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al0, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh8)) | <span class="number">0</span>;
    <span class="keyword">var</span> w8 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w8 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w8 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 9 */</span>
    lo = Math.imul(al9, bl0);
    mid = Math.imul(al9, bh0);
    mid = (mid + Math.imul(ah9, bl0)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh0);
    lo = (lo + Math.imul(al8, bl1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh1)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl1)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh1)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al7, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh2)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al6, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh3)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al5, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh4)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al4, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh5)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al3, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh6)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al2, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh7)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al1, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh8)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al0, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al0, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah0, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah0, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w9 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w9 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w9 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 10 */</span>
    lo = Math.imul(al9, bl1);
    mid = Math.imul(al9, bh1);
    mid = (mid + Math.imul(ah9, bl1)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh1);
    lo = (lo + Math.imul(al8, bl2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh2)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl2)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh2)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al7, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh3)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al6, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh4)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al5, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh5)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al4, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh6)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al3, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh7)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al2, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh8)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al1, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al1, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah1, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah1, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w10 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w10 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w10 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 11 */</span>
    lo = Math.imul(al9, bl2);
    mid = Math.imul(al9, bh2);
    mid = (mid + Math.imul(ah9, bl2)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh2);
    lo = (lo + Math.imul(al8, bl3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh3)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl3)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh3)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al7, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh4)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al6, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh5)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al5, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh6)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al4, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh7)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al3, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh8)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al2, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al2, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah2, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah2, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w11 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w11 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w11 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 12 */</span>
    lo = Math.imul(al9, bl3);
    mid = Math.imul(al9, bh3);
    mid = (mid + Math.imul(ah9, bl3)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh3);
    lo = (lo + Math.imul(al8, bl4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh4)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl4)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh4)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al7, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh5)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al6, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh6)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al5, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh7)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al4, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh8)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al3, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al3, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah3, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah3, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w12 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w12 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w12 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 13 */</span>
    lo = Math.imul(al9, bl4);
    mid = Math.imul(al9, bh4);
    mid = (mid + Math.imul(ah9, bl4)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh4);
    lo = (lo + Math.imul(al8, bl5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh5)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl5)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh5)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al7, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh6)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al6, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh7)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al5, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh8)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al4, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al4, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah4, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah4, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w13 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w13 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w13 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 14 */</span>
    lo = Math.imul(al9, bl5);
    mid = Math.imul(al9, bh5);
    mid = (mid + Math.imul(ah9, bl5)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh5);
    lo = (lo + Math.imul(al8, bl6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh6)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl6)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh6)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al7, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh7)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al6, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh8)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al5, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al5, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah5, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah5, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w14 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w14 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w14 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 15 */</span>
    lo = Math.imul(al9, bl6);
    mid = Math.imul(al9, bh6);
    mid = (mid + Math.imul(ah9, bl6)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh6);
    lo = (lo + Math.imul(al8, bl7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh7)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl7)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh7)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al7, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh8)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al6, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al6, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah6, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah6, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w15 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w15 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w15 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 16 */</span>
    lo = Math.imul(al9, bl7);
    mid = Math.imul(al9, bh7);
    mid = (mid + Math.imul(ah9, bl7)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh7);
    lo = (lo + Math.imul(al8, bl8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh8)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl8)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh8)) | <span class="number">0</span>;
    lo = (lo + Math.imul(al7, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al7, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah7, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah7, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w16 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w16 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w16 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 17 */</span>
    lo = Math.imul(al9, bl8);
    mid = Math.imul(al9, bh8);
    mid = (mid + Math.imul(ah9, bl8)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh8);
    lo = (lo + Math.imul(al8, bl9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(al8, bh9)) | <span class="number">0</span>;
    mid = (mid + Math.imul(ah8, bl9)) | <span class="number">0</span>;
    hi = (hi + Math.imul(ah8, bh9)) | <span class="number">0</span>;
    <span class="keyword">var</span> w17 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w17 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w17 &amp;= <span class="number">0x3ffffff</span>;
    <span class="comment">/* k = 18 */</span>
    lo = Math.imul(al9, bl9);
    mid = Math.imul(al9, bh9);
    mid = (mid + Math.imul(ah9, bl9)) | <span class="number">0</span>;
    hi = Math.imul(ah9, bh9);
    <span class="keyword">var</span> w18 = (((c + lo) | <span class="number">0</span>) + ((mid &amp; <span class="number">0x1fff</span>) &lt;&lt; <span class="number">13</span>)) | <span class="number">0</span>;
    c = (((hi + (mid >>> <span class="number">13</span>)) | <span class="number">0</span>) + (w18 >>> <span class="number">26</span>)) | <span class="number">0</span>;
    w18 &amp;= <span class="number">0x3ffffff</span>;
    o[<span class="number">0</span>] = w0;
    o[<span class="number">1</span>] = w1;
    o[<span class="number">2</span>] = w2;
    o[<span class="number">3</span>] = w3;
    o[<span class="number">4</span>] = w4;
    o[<span class="number">5</span>] = w5;
    o[<span class="number">6</span>] = w6;
    o[<span class="number">7</span>] = w7;
    o[<span class="number">8</span>] = w8;
    o[<span class="number">9</span>] = w9;
    o[<span class="number">10</span>] = w10;
    o[<span class="number">11</span>] = w11;
    o[<span class="number">12</span>] = w12;
    o[<span class="number">13</span>] = w13;
    o[<span class="number">14</span>] = w14;
    o[<span class="number">15</span>] = w15;
    o[<span class="number">16</span>] = w16;
    o[<span class="number">17</span>] = w17;
    o[<span class="number">18</span>] = w18;
    <span class="keyword">if</span> (c !== <span class="number">0</span>) {
      o[<span class="number">19</span>] = c;
      out.length++;
    }
    <span class="keyword">return</span> out;
  };

  <span class="comment">// Polyfill comb</span>
  <span class="keyword">if</span> (!Math.imul) {
    comb10MulTo = smallMulTo;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">bigMulTo</span> <span class="params">(self, num, out)</span> {</span>
    out.negative = num.negative ^ self.negative;
    out.length = self.length + num.length;

    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">var</span> hncarry = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; out.length - <span class="number">1</span>; k++) {
      <span class="comment">// Sum all words with the same `i + j = k` and accumulate `ncarry`,</span>
      <span class="comment">// note that ncarry could be >= 0x3ffffff</span>
      <span class="keyword">var</span> ncarry = hncarry;
      hncarry = <span class="number">0</span>;
      <span class="keyword">var</span> rword = carry &amp; <span class="number">0x3ffffff</span>;
      <span class="keyword">var</span> maxJ = Math.min(k, num.length - <span class="number">1</span>);
      <span class="keyword">for</span> (<span class="keyword">var</span> j = Math.max(<span class="number">0</span>, k - self.length + <span class="number">1</span>); j &lt;= maxJ; j++) {
        <span class="keyword">var</span> i = k - j;
        <span class="keyword">var</span> a = self.words[i] | <span class="number">0</span>;
        <span class="keyword">var</span> b = num.words[j] | <span class="number">0</span>;
        <span class="keyword">var</span> r = a * b;

        <span class="keyword">var</span> lo = r &amp; <span class="number">0x3ffffff</span>;
        ncarry = (ncarry + ((r / <span class="number">0x4000000</span>) | <span class="number">0</span>)) | <span class="number">0</span>;
        lo = (lo + rword) | <span class="number">0</span>;
        rword = lo &amp; <span class="number">0x3ffffff</span>;
        ncarry = (ncarry + (lo >>> <span class="number">26</span>)) | <span class="number">0</span>;

        hncarry += ncarry >>> <span class="number">26</span>;
        ncarry &amp;= <span class="number">0x3ffffff</span>;
      }
      out.words[k] = rword;
      carry = ncarry;
      ncarry = hncarry;
    }
    <span class="keyword">if</span> (carry !== <span class="number">0</span>) {
      out.words[k] = carry;
    } <span class="keyword">else</span> {
      out.length--;
    }

    <span class="keyword">return</span> out.strip();
  }

  <span class="function"><span class="keyword">function</span> <span class="title">jumboMulTo</span> <span class="params">(self, num, out)</span> {</span>
    <span class="keyword">var</span> fftm = <span class="keyword">new</span> FFTM();
    <span class="keyword">return</span> fftm.mulp(self, num, out);
  }

  BN.prototype.mulTo = <span class="function"><span class="keyword">function</span> <span class="title">mulTo</span> <span class="params">(num, out)</span> {</span>
    <span class="keyword">var</span> res;
    <span class="keyword">var</span> len = <span class="keyword">this</span>.length + num.length;
    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">10</span> &amp;&amp; num.length === <span class="number">10</span>) {
      res = comb10MulTo(<span class="keyword">this</span>, num, out);
    } <span class="keyword">else</span> <span class="keyword">if</span> (len &lt; <span class="number">63</span>) {
      res = smallMulTo(<span class="keyword">this</span>, num, out);
    } <span class="keyword">else</span> <span class="keyword">if</span> (len &lt; <span class="number">1024</span>) {
      res = bigMulTo(<span class="keyword">this</span>, num, out);
    } <span class="keyword">else</span> {
      res = jumboMulTo(<span class="keyword">this</span>, num, out);
    }

    <span class="keyword">return</span> res;
  };

  <span class="comment">// Cooley-Tukey algorithm for FFT</span>
  <span class="comment">// slightly revisited to rely on looping instead of recursion</span>

  <span class="function"><span class="keyword">function</span> <span class="title">FFTM</span> <span class="params">(x, y)</span> {</span>
    <span class="keyword">this</span>.x = x;
    <span class="keyword">this</span>.y = y;
  }

  FFTM.prototype.makeRBT = <span class="function"><span class="keyword">function</span> <span class="title">makeRBT</span> <span class="params">(N)</span> {</span>
    <span class="keyword">var</span> t = <span class="keyword">new</span> Array(N);
    <span class="keyword">var</span> l = BN.prototype._countBits(N) - <span class="number">1</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; N; i++) {
      t[i] = <span class="keyword">this</span>.revBin(i, l, N);
    }

    <span class="keyword">return</span> t;
  };

  <span class="comment">// Returns binary-reversed representation of `x`</span>
  FFTM.prototype.revBin = <span class="function"><span class="keyword">function</span> <span class="title">revBin</span> <span class="params">(x, l, N)</span> {</span>
    <span class="keyword">if</span> (x === <span class="number">0</span> || x === N - <span class="number">1</span>) <span class="keyword">return</span> x;

    <span class="keyword">var</span> rb = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; l; i++) {
      rb |= (x &amp; <span class="number">1</span>) &lt;&lt; (l - i - <span class="number">1</span>);
      x >>= <span class="number">1</span>;
    }

    <span class="keyword">return</span> rb;
  };

  <span class="comment">// Performs "tweedling" phase, therefore 'emulating'</span>
  <span class="comment">// behaviour of the recursive algorithm</span>
  FFTM.prototype.permute = <span class="function"><span class="keyword">function</span> <span class="title">permute</span> <span class="params">(rbt, rws, iws, rtws, itws, N)</span> {</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; N; i++) {
      rtws[i] = rws[rbt[i]];
      itws[i] = iws[rbt[i]];
    }
  };

  FFTM.prototype.transform = <span class="function"><span class="keyword">function</span> <span class="title">transform</span> <span class="params">(rws, iws, rtws, itws, N, rbt)</span> {</span>
    <span class="keyword">this</span>.permute(rbt, rws, iws, rtws, itws, N);

    <span class="keyword">for</span> (<span class="keyword">var</span> s = <span class="number">1</span>; s &lt; N; s &lt;&lt;= <span class="number">1</span>) {
      <span class="keyword">var</span> l = s &lt;&lt; <span class="number">1</span>;

      <span class="keyword">var</span> rtwdf = Math.cos(<span class="number">2</span> * Math.PI / l);
      <span class="keyword">var</span> itwdf = Math.sin(<span class="number">2</span> * Math.PI / l);

      <span class="keyword">for</span> (<span class="keyword">var</span> p = <span class="number">0</span>; p &lt; N; p += l) {
        <span class="keyword">var</span> rtwdf_ = rtwdf;
        <span class="keyword">var</span> itwdf_ = itwdf;

        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; s; j++) {
          <span class="keyword">var</span> re = rtws[p + j];
          <span class="keyword">var</span> ie = itws[p + j];

          <span class="keyword">var</span> ro = rtws[p + j + s];
          <span class="keyword">var</span> io = itws[p + j + s];

          <span class="keyword">var</span> rx = rtwdf_ * ro - itwdf_ * io;

          io = rtwdf_ * io + itwdf_ * ro;
          ro = rx;

          rtws[p + j] = re + ro;
          itws[p + j] = ie + io;

          rtws[p + j + s] = re - ro;
          itws[p + j + s] = ie - io;

          <span class="comment">/* jshint maxdepth : false */</span>
          <span class="keyword">if</span> (j !== l) {
            rx = rtwdf * rtwdf_ - itwdf * itwdf_;

            itwdf_ = rtwdf * itwdf_ + itwdf * rtwdf_;
            rtwdf_ = rx;
          }
        }
      }
    }
  };

  FFTM.prototype.guessLen13b = <span class="function"><span class="keyword">function</span> <span class="title">guessLen13b</span> <span class="params">(n, m)</span> {</span>
    <span class="keyword">var</span> N = Math.max(m, n) | <span class="number">1</span>;
    <span class="keyword">var</span> odd = N &amp; <span class="number">1</span>;
    <span class="keyword">var</span> i = <span class="number">0</span>;
    <span class="keyword">for</span> (N = N / <span class="number">2</span> | <span class="number">0</span>; N; N = N >>> <span class="number">1</span>) {
      i++;
    }

    <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; i + <span class="number">1</span> + odd;
  };

  FFTM.prototype.conjugate = <span class="function"><span class="keyword">function</span> <span class="title">conjugate</span> <span class="params">(rws, iws, N)</span> {</span>
    <span class="keyword">if</span> (N &lt;= <span class="number">1</span>) <span class="keyword">return</span>;

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; N / <span class="number">2</span>; i++) {
      <span class="keyword">var</span> t = rws[i];

      rws[i] = rws[N - i - <span class="number">1</span>];
      rws[N - i - <span class="number">1</span>] = t;

      t = iws[i];

      iws[i] = -iws[N - i - <span class="number">1</span>];
      iws[N - i - <span class="number">1</span>] = -t;
    }
  };

  FFTM.prototype.normalize13b = <span class="function"><span class="keyword">function</span> <span class="title">normalize13b</span> <span class="params">(ws, N)</span> {</span>
    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; N / <span class="number">2</span>; i++) {
      <span class="keyword">var</span> w = Math.round(ws[<span class="number">2</span> * i + <span class="number">1</span>] / N) * <span class="number">0x2000</span> +
        Math.round(ws[<span class="number">2</span> * i] / N) +
        carry;

      ws[i] = w &amp; <span class="number">0x3ffffff</span>;

      <span class="keyword">if</span> (w &lt; <span class="number">0x4000000</span>) {
        carry = <span class="number">0</span>;
      } <span class="keyword">else</span> {
        carry = w / <span class="number">0x4000000</span> | <span class="number">0</span>;
      }
    }

    <span class="keyword">return</span> ws;
  };

  FFTM.prototype.convert13b = <span class="function"><span class="keyword">function</span> <span class="title">convert13b</span> <span class="params">(ws, len, rws, N)</span> {</span>
    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) {
      carry = carry + (ws[i] | <span class="number">0</span>);

      rws[<span class="number">2</span> * i] = carry &amp; <span class="number">0x1fff</span>; carry = carry >>> <span class="number">13</span>;
      rws[<span class="number">2</span> * i + <span class="number">1</span>] = carry &amp; <span class="number">0x1fff</span>; carry = carry >>> <span class="number">13</span>;
    }

    <span class="comment">// Pad with zeroes</span>
    <span class="keyword">for</span> (i = <span class="number">2</span> * len; i &lt; N; ++i) {
      rws[i] = <span class="number">0</span>;
    }

    assert(carry === <span class="number">0</span>);
    assert((carry &amp; ~<span class="number">0x1fff</span>) === <span class="number">0</span>);
  };

  FFTM.prototype.stub = <span class="function"><span class="keyword">function</span> <span class="title">stub</span> <span class="params">(N)</span> {</span>
    <span class="keyword">var</span> ph = <span class="keyword">new</span> Array(N);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; N; i++) {
      ph[i] = <span class="number">0</span>;
    }

    <span class="keyword">return</span> ph;
  };

  FFTM.prototype.mulp = <span class="function"><span class="keyword">function</span> <span class="title">mulp</span> <span class="params">(x, y, out)</span> {</span>
    <span class="keyword">var</span> N = <span class="number">2</span> * <span class="keyword">this</span>.guessLen13b(x.length, y.length);

    <span class="keyword">var</span> rbt = <span class="keyword">this</span>.makeRBT(N);

    <span class="keyword">var</span> _ = <span class="keyword">this</span>.stub(N);

    <span class="keyword">var</span> rws = <span class="keyword">new</span> Array(N);
    <span class="keyword">var</span> rwst = <span class="keyword">new</span> Array(N);
    <span class="keyword">var</span> iwst = <span class="keyword">new</span> Array(N);

    <span class="keyword">var</span> nrws = <span class="keyword">new</span> Array(N);
    <span class="keyword">var</span> nrwst = <span class="keyword">new</span> Array(N);
    <span class="keyword">var</span> niwst = <span class="keyword">new</span> Array(N);

    <span class="keyword">var</span> rmws = out.words;
    rmws.length = N;

    <span class="keyword">this</span>.convert13b(x.words, x.length, rws, N);
    <span class="keyword">this</span>.convert13b(y.words, y.length, nrws, N);

    <span class="keyword">this</span>.transform(rws, _, rwst, iwst, N, rbt);
    <span class="keyword">this</span>.transform(nrws, _, nrwst, niwst, N, rbt);

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; N; i++) {
      <span class="keyword">var</span> rx = rwst[i] * nrwst[i] - iwst[i] * niwst[i];
      iwst[i] = rwst[i] * niwst[i] + iwst[i] * nrwst[i];
      rwst[i] = rx;
    }

    <span class="keyword">this</span>.conjugate(rwst, iwst, N);
    <span class="keyword">this</span>.transform(rwst, iwst, rmws, _, N, rbt);
    <span class="keyword">this</span>.conjugate(rmws, _, N);
    <span class="keyword">this</span>.normalize13b(rmws, N);

    out.negative = x.negative ^ y.negative;
    out.length = x.length + y.length;
    <span class="keyword">return</span> out.strip();
  };

  <span class="comment">// Multiply `this` by `num`</span>
  BN.prototype.mul = <span class="function"><span class="keyword">function</span> <span class="title">mul</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> out = <span class="keyword">new</span> BN(<span class="literal">null</span>);
    out.words = <span class="keyword">new</span> Array(<span class="keyword">this</span>.length + num.length);
    <span class="keyword">return</span> <span class="keyword">this</span>.mulTo(num, out);
  };

  <span class="comment">// Multiply employing FFT</span>
  BN.prototype.mulf = <span class="function"><span class="keyword">function</span> <span class="title">mulf</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> out = <span class="keyword">new</span> BN(<span class="literal">null</span>);
    out.words = <span class="keyword">new</span> Array(<span class="keyword">this</span>.length + num.length);
    <span class="keyword">return</span> jumboMulTo(<span class="keyword">this</span>, num, out);
  };

  <span class="comment">// In-place Multiplication</span>
  BN.prototype.imul = <span class="function"><span class="keyword">function</span> <span class="title">imul</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().mulTo(num, <span class="keyword">this</span>);
  };

  BN.prototype.imuln = <span class="function"><span class="keyword">function</span> <span class="title">imuln</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">typeof</span> num === <span class="string">'number'</span>);
    assert(num &lt; <span class="number">0x4000000</span>);

    <span class="comment">// Carry</span>
    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
      <span class="keyword">var</span> w = (<span class="keyword">this</span>.words[i] | <span class="number">0</span>) * num;
      <span class="keyword">var</span> lo = (w &amp; <span class="number">0x3ffffff</span>) + (carry &amp; <span class="number">0x3ffffff</span>);
      carry >>= <span class="number">26</span>;
      carry += (w / <span class="number">0x4000000</span>) | <span class="number">0</span>;
      <span class="comment">// NOTE: lo is 27bit maximum</span>
      carry += lo >>> <span class="number">26</span>;
      <span class="keyword">this</span>.words[i] = lo &amp; <span class="number">0x3ffffff</span>;
    }

    <span class="keyword">if</span> (carry !== <span class="number">0</span>) {
      <span class="keyword">this</span>.words[i] = carry;
      <span class="keyword">this</span>.length++;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  BN.prototype.muln = <span class="function"><span class="keyword">function</span> <span class="title">muln</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().imuln(num);
  };

  <span class="comment">// `this` * `this`</span>
  BN.prototype.sqr = <span class="function"><span class="keyword">function</span> <span class="title">sqr</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.mul(<span class="keyword">this</span>);
  };

  <span class="comment">// `this` * `this` in-place</span>
  BN.prototype.isqr = <span class="function"><span class="keyword">function</span> <span class="title">isqr</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.imul(<span class="keyword">this</span>.clone());
  };

  <span class="comment">// Math.pow(`this`, `num`)</span>
  BN.prototype.pow = <span class="function"><span class="keyword">function</span> <span class="title">pow</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> w = toBitArray(num);
    <span class="keyword">if</span> (w.length === <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">new</span> BN(<span class="number">1</span>);

    <span class="comment">// Skip leading zeroes</span>
    <span class="keyword">var</span> res = <span class="keyword">this</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; w.length; i++, res = res.sqr()) {
      <span class="keyword">if</span> (w[i] !== <span class="number">0</span>) <span class="keyword">break</span>;
    }

    <span class="keyword">if</span> (++i &lt; w.length) {
      <span class="keyword">for</span> (<span class="keyword">var</span> q = res.sqr(); i &lt; w.length; i++, q = q.sqr()) {
        <span class="keyword">if</span> (w[i] === <span class="number">0</span>) <span class="keyword">continue</span>;

        res = res.mul(q);
      }
    }

    <span class="keyword">return</span> res;
  };

  <span class="comment">// Shift-left in-place</span>
  BN.prototype.iushln = <span class="function"><span class="keyword">function</span> <span class="title">iushln</span> <span class="params">(bits)</span> {</span>
    assert(<span class="keyword">typeof</span> bits === <span class="string">'number'</span> &amp;&amp; bits >= <span class="number">0</span>);
    <span class="keyword">var</span> r = bits % <span class="number">26</span>;
    <span class="keyword">var</span> s = (bits - r) / <span class="number">26</span>;
    <span class="keyword">var</span> carryMask = (<span class="number">0x3ffffff</span> >>> (<span class="number">26</span> - r)) &lt;&lt; (<span class="number">26</span> - r);
    <span class="keyword">var</span> i;

    <span class="keyword">if</span> (r !== <span class="number">0</span>) {
      <span class="keyword">var</span> carry = <span class="number">0</span>;

      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
        <span class="keyword">var</span> newCarry = <span class="keyword">this</span>.words[i] &amp; carryMask;
        <span class="keyword">var</span> c = ((<span class="keyword">this</span>.words[i] | <span class="number">0</span>) - newCarry) &lt;&lt; r;
        <span class="keyword">this</span>.words[i] = c | carry;
        carry = newCarry >>> (<span class="number">26</span> - r);
      }

      <span class="keyword">if</span> (carry) {
        <span class="keyword">this</span>.words[i] = carry;
        <span class="keyword">this</span>.length++;
      }
    }

    <span class="keyword">if</span> (s !== <span class="number">0</span>) {
      <span class="keyword">for</span> (i = <span class="keyword">this</span>.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
        <span class="keyword">this</span>.words[i + s] = <span class="keyword">this</span>.words[i];
      }

      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; s; i++) {
        <span class="keyword">this</span>.words[i] = <span class="number">0</span>;
      }

      <span class="keyword">this</span>.length += s;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype.ishln = <span class="function"><span class="keyword">function</span> <span class="title">ishln</span> <span class="params">(bits)</span> {</span>
    <span class="comment">// TODO(indutny): implement me</span>
    assert(<span class="keyword">this</span>.negative === <span class="number">0</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.iushln(bits);
  };

  <span class="comment">// Shift-right in-place</span>
  <span class="comment">// NOTE: `hint` is a lowest bit before trailing zeroes</span>
  <span class="comment">// NOTE: if `extended` is present - it will be filled with destroyed bits</span>
  BN.prototype.iushrn = <span class="function"><span class="keyword">function</span> <span class="title">iushrn</span> <span class="params">(bits, hint, extended)</span> {</span>
    assert(<span class="keyword">typeof</span> bits === <span class="string">'number'</span> &amp;&amp; bits >= <span class="number">0</span>);
    <span class="keyword">var</span> h;
    <span class="keyword">if</span> (hint) {
      h = (hint - (hint % <span class="number">26</span>)) / <span class="number">26</span>;
    } <span class="keyword">else</span> {
      h = <span class="number">0</span>;
    }

    <span class="keyword">var</span> r = bits % <span class="number">26</span>;
    <span class="keyword">var</span> s = Math.min((bits - r) / <span class="number">26</span>, <span class="keyword">this</span>.length);
    <span class="keyword">var</span> mask = <span class="number">0x3ffffff</span> ^ ((<span class="number">0x3ffffff</span> >>> r) &lt;&lt; r);
    <span class="keyword">var</span> maskedWords = extended;

    h -= s;
    h = Math.max(<span class="number">0</span>, h);

    <span class="comment">// Extended mode, copy masked part</span>
    <span class="keyword">if</span> (maskedWords) {
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; s; i++) {
        maskedWords.words[i] = <span class="keyword">this</span>.words[i];
      }
      maskedWords.length = s;
    }

    <span class="keyword">if</span> (s === <span class="number">0</span>) {
      <span class="comment">// No-op, we should not move anything at all</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.length > s) {
      <span class="keyword">this</span>.length -= s;
      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
        <span class="keyword">this</span>.words[i] = <span class="keyword">this</span>.words[i + s];
      }
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.words[<span class="number">0</span>] = <span class="number">0</span>;
      <span class="keyword">this</span>.length = <span class="number">1</span>;
    }

    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (i = <span class="keyword">this</span>.length - <span class="number">1</span>; i >= <span class="number">0</span> &amp;&amp; (carry !== <span class="number">0</span> || i >= h); i--) {
      <span class="keyword">var</span> word = <span class="keyword">this</span>.words[i] | <span class="number">0</span>;
      <span class="keyword">this</span>.words[i] = (carry &lt;&lt; (<span class="number">26</span> - r)) | (word >>> r);
      carry = word &amp; mask;
    }

    <span class="comment">// Push carried bits as a mask</span>
    <span class="keyword">if</span> (maskedWords &amp;&amp; carry !== <span class="number">0</span>) {
      maskedWords.words[maskedWords.length++] = carry;
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>) {
      <span class="keyword">this</span>.words[<span class="number">0</span>] = <span class="number">0</span>;
      <span class="keyword">this</span>.length = <span class="number">1</span>;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype.ishrn = <span class="function"><span class="keyword">function</span> <span class="title">ishrn</span> <span class="params">(bits, hint, extended)</span> {</span>
    <span class="comment">// TODO(indutny): implement me</span>
    assert(<span class="keyword">this</span>.negative === <span class="number">0</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.iushrn(bits, hint, extended);
  };

  <span class="comment">// Shift-left</span>
  BN.prototype.shln = <span class="function"><span class="keyword">function</span> <span class="title">shln</span> <span class="params">(bits)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().ishln(bits);
  };

  BN.prototype.ushln = <span class="function"><span class="keyword">function</span> <span class="title">ushln</span> <span class="params">(bits)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().iushln(bits);
  };

  <span class="comment">// Shift-right</span>
  BN.prototype.shrn = <span class="function"><span class="keyword">function</span> <span class="title">shrn</span> <span class="params">(bits)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().ishrn(bits);
  };

  BN.prototype.ushrn = <span class="function"><span class="keyword">function</span> <span class="title">ushrn</span> <span class="params">(bits)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().iushrn(bits);
  };

  <span class="comment">// Test if n bit is set</span>
  BN.prototype.testn = <span class="function"><span class="keyword">function</span> <span class="title">testn</span> <span class="params">(bit)</span> {</span>
    assert(<span class="keyword">typeof</span> bit === <span class="string">'number'</span> &amp;&amp; bit >= <span class="number">0</span>);
    <span class="keyword">var</span> r = bit % <span class="number">26</span>;
    <span class="keyword">var</span> s = (bit - r) / <span class="number">26</span>;
    <span class="keyword">var</span> q = <span class="number">1</span> &lt;&lt; r;

    <span class="comment">// Fast case: bit is much higher than all existing words</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length &lt;= s) <span class="keyword">return</span> <span class="literal">false</span>;

    <span class="comment">// Check bit and return</span>
    <span class="keyword">var</span> w = <span class="keyword">this</span>.words[s];

    <span class="keyword">return</span> !!(w &amp; q);
  };

  <span class="comment">// Return only lowers bits of number (in-place)</span>
  BN.prototype.imaskn = <span class="function"><span class="keyword">function</span> <span class="title">imaskn</span> <span class="params">(bits)</span> {</span>
    assert(<span class="keyword">typeof</span> bits === <span class="string">'number'</span> &amp;&amp; bits >= <span class="number">0</span>);
    <span class="keyword">var</span> r = bits % <span class="number">26</span>;
    <span class="keyword">var</span> s = (bits - r) / <span class="number">26</span>;

    assert(<span class="keyword">this</span>.negative === <span class="number">0</span>, <span class="string">'imaskn works only with positive numbers'</span>);

    <span class="keyword">if</span> (<span class="keyword">this</span>.length &lt;= s) {
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }

    <span class="keyword">if</span> (r !== <span class="number">0</span>) {
      s++;
    }
    <span class="keyword">this</span>.length = Math.min(s, <span class="keyword">this</span>.length);

    <span class="keyword">if</span> (r !== <span class="number">0</span>) {
      <span class="keyword">var</span> mask = <span class="number">0x3ffffff</span> ^ ((<span class="number">0x3ffffff</span> >>> r) &lt;&lt; r);
      <span class="keyword">this</span>.words[<span class="keyword">this</span>.length - <span class="number">1</span>] &amp;= mask;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  <span class="comment">// Return only lowers bits of number</span>
  BN.prototype.maskn = <span class="function"><span class="keyword">function</span> <span class="title">maskn</span> <span class="params">(bits)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().imaskn(bits);
  };

  <span class="comment">// Add plain number `num` to `this`</span>
  BN.prototype.iaddn = <span class="function"><span class="keyword">function</span> <span class="title">iaddn</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">typeof</span> num === <span class="string">'number'</span>);
    assert(num &lt; <span class="number">0x4000000</span>);
    <span class="keyword">if</span> (num &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">this</span>.isubn(-num);

    <span class="comment">// Possible sign change</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) {
      <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">1</span> &amp;&amp; (<span class="keyword">this</span>.words[<span class="number">0</span>] | <span class="number">0</span>) &lt; num) {
        <span class="keyword">this</span>.words[<span class="number">0</span>] = num - (<span class="keyword">this</span>.words[<span class="number">0</span>] | <span class="number">0</span>);
        <span class="keyword">this</span>.negative = <span class="number">0</span>;
        <span class="keyword">return</span> <span class="keyword">this</span>;
      }

      <span class="keyword">this</span>.negative = <span class="number">0</span>;
      <span class="keyword">this</span>.isubn(num);
      <span class="keyword">this</span>.negative = <span class="number">1</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }

    <span class="comment">// Add without checks</span>
    <span class="keyword">return</span> <span class="keyword">this</span>._iaddn(num);
  };

  BN.prototype._iaddn = <span class="function"><span class="keyword">function</span> <span class="title">_iaddn</span> <span class="params">(num)</span> {</span>
    <span class="keyword">this</span>.words[<span class="number">0</span>] += num;

    <span class="comment">// Carry</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length &amp;&amp; <span class="keyword">this</span>.words[i] >= <span class="number">0x4000000</span>; i++) {
      <span class="keyword">this</span>.words[i] -= <span class="number">0x4000000</span>;
      <span class="keyword">if</span> (i === <span class="keyword">this</span>.length - <span class="number">1</span>) {
        <span class="keyword">this</span>.words[i + <span class="number">1</span>] = <span class="number">1</span>;
      } <span class="keyword">else</span> {
        <span class="keyword">this</span>.words[i + <span class="number">1</span>]++;
      }
    }
    <span class="keyword">this</span>.length = Math.max(<span class="keyword">this</span>.length, i + <span class="number">1</span>);

    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  <span class="comment">// Subtract plain number `num` from `this`</span>
  BN.prototype.isubn = <span class="function"><span class="keyword">function</span> <span class="title">isubn</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">typeof</span> num === <span class="string">'number'</span>);
    assert(num &lt; <span class="number">0x4000000</span>);
    <span class="keyword">if</span> (num &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">this</span>.iaddn(-num);

    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) {
      <span class="keyword">this</span>.negative = <span class="number">0</span>;
      <span class="keyword">this</span>.iaddn(num);
      <span class="keyword">this</span>.negative = <span class="number">1</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }

    <span class="keyword">this</span>.words[<span class="number">0</span>] -= num;

    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>.words[<span class="number">0</span>] &lt; <span class="number">0</span>) {
      <span class="keyword">this</span>.words[<span class="number">0</span>] = -<span class="keyword">this</span>.words[<span class="number">0</span>];
      <span class="keyword">this</span>.negative = <span class="number">1</span>;
    } <span class="keyword">else</span> {
      <span class="comment">// Carry</span>
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length &amp;&amp; <span class="keyword">this</span>.words[i] &lt; <span class="number">0</span>; i++) {
        <span class="keyword">this</span>.words[i] += <span class="number">0x4000000</span>;
        <span class="keyword">this</span>.words[i + <span class="number">1</span>] -= <span class="number">1</span>;
      }
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype.addn = <span class="function"><span class="keyword">function</span> <span class="title">addn</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().iaddn(num);
  };

  BN.prototype.subn = <span class="function"><span class="keyword">function</span> <span class="title">subn</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().isubn(num);
  };

  BN.prototype.iabs = <span class="function"><span class="keyword">function</span> <span class="title">iabs</span> <span class="params">()</span> {</span>
    <span class="keyword">this</span>.negative = <span class="number">0</span>;

    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  BN.prototype.abs = <span class="function"><span class="keyword">function</span> <span class="title">abs</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().iabs();
  };

  BN.prototype._ishlnsubmul = <span class="function"><span class="keyword">function</span> <span class="title">_ishlnsubmul</span> <span class="params">(num, mul, shift)</span> {</span>
    <span class="keyword">var</span> len = num.length + shift;
    <span class="keyword">var</span> i;

    <span class="keyword">this</span>._expand(len);

    <span class="keyword">var</span> w;
    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num.length; i++) {
      w = (<span class="keyword">this</span>.words[i + shift] | <span class="number">0</span>) + carry;
      <span class="keyword">var</span> right = (num.words[i] | <span class="number">0</span>) * mul;
      w -= right &amp; <span class="number">0x3ffffff</span>;
      carry = (w >> <span class="number">26</span>) - ((right / <span class="number">0x4000000</span>) | <span class="number">0</span>);
      <span class="keyword">this</span>.words[i + shift] = w &amp; <span class="number">0x3ffffff</span>;
    }
    <span class="keyword">for</span> (; i &lt; <span class="keyword">this</span>.length - shift; i++) {
      w = (<span class="keyword">this</span>.words[i + shift] | <span class="number">0</span>) + carry;
      carry = w >> <span class="number">26</span>;
      <span class="keyword">this</span>.words[i + shift] = w &amp; <span class="number">0x3ffffff</span>;
    }

    <span class="keyword">if</span> (carry === <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">this</span>.strip();

    <span class="comment">// Subtraction overflow</span>
    assert(carry === -<span class="number">1</span>);
    carry = <span class="number">0</span>;
    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.length; i++) {
      w = -(<span class="keyword">this</span>.words[i] | <span class="number">0</span>) + carry;
      carry = w >> <span class="number">26</span>;
      <span class="keyword">this</span>.words[i] = w &amp; <span class="number">0x3ffffff</span>;
    }
    <span class="keyword">this</span>.negative = <span class="number">1</span>;

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype._wordDiv = <span class="function"><span class="keyword">function</span> <span class="title">_wordDiv</span> <span class="params">(num, mode)</span> {</span>
    <span class="keyword">var</span> shift = <span class="keyword">this</span>.length - num.length;

    <span class="keyword">var</span> a = <span class="keyword">this</span>.clone();
    <span class="keyword">var</span> b = num;

    <span class="comment">// Normalize</span>
    <span class="keyword">var</span> bhi = b.words[b.length - <span class="number">1</span>] | <span class="number">0</span>;
    <span class="keyword">var</span> bhiBits = <span class="keyword">this</span>._countBits(bhi);
    shift = <span class="number">26</span> - bhiBits;
    <span class="keyword">if</span> (shift !== <span class="number">0</span>) {
      b = b.ushln(shift);
      a.iushln(shift);
      bhi = b.words[b.length - <span class="number">1</span>] | <span class="number">0</span>;
    }

    <span class="comment">// Initialize quotient</span>
    <span class="keyword">var</span> m = a.length - b.length;
    <span class="keyword">var</span> q;

    <span class="keyword">if</span> (mode !== <span class="string">'mod'</span>) {
      q = <span class="keyword">new</span> BN(<span class="literal">null</span>);
      q.length = m + <span class="number">1</span>;
      q.words = <span class="keyword">new</span> Array(q.length);
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; q.length; i++) {
        q.words[i] = <span class="number">0</span>;
      }
    }

    <span class="keyword">var</span> diff = a.clone()._ishlnsubmul(b, <span class="number">1</span>, m);
    <span class="keyword">if</span> (diff.negative === <span class="number">0</span>) {
      a = diff;
      <span class="keyword">if</span> (q) {
        q.words[m] = <span class="number">1</span>;
      }
    }

    <span class="keyword">for</span> (<span class="keyword">var</span> j = m - <span class="number">1</span>; j >= <span class="number">0</span>; j--) {
      <span class="keyword">var</span> qj = (a.words[b.length + j] | <span class="number">0</span>) * <span class="number">0x4000000</span> +
        (a.words[b.length + j - <span class="number">1</span>] | <span class="number">0</span>);

      <span class="comment">// NOTE: (qj / bhi) is (0x3ffffff * 0x4000000 + 0x3ffffff) / 0x2000000 max</span>
      <span class="comment">// (0x7ffffff)</span>
      qj = Math.min((qj / bhi) | <span class="number">0</span>, <span class="number">0x3ffffff</span>);

      a._ishlnsubmul(b, qj, j);
      <span class="keyword">while</span> (a.negative !== <span class="number">0</span>) {
        qj--;
        a.negative = <span class="number">0</span>;
        a._ishlnsubmul(b, <span class="number">1</span>, j);
        <span class="keyword">if</span> (!a.isZero()) {
          a.negative ^= <span class="number">1</span>;
        }
      }
      <span class="keyword">if</span> (q) {
        q.words[j] = qj;
      }
    }
    <span class="keyword">if</span> (q) {
      q.strip();
    }
    a.strip();

    <span class="comment">// Denormalize</span>
    <span class="keyword">if</span> (mode !== <span class="string">'div'</span> &amp;&amp; shift !== <span class="number">0</span>) {
      a.iushrn(shift);
    }

    <span class="keyword">return</span> {
      div: q || <span class="literal">null</span>,
      mod: a
    };
  };

  <span class="comment">// NOTE: 1) `mode` can be set to `mod` to request mod only,</span>
  <span class="comment">//       to `div` to request div only, or be absent to</span>
  <span class="comment">//       request both div &amp; mod</span>
  <span class="comment">//       2) `positive` is true if unsigned mod is requested</span>
  BN.prototype.divmod = <span class="function"><span class="keyword">function</span> <span class="title">divmod</span> <span class="params">(num, mode, positive)</span> {</span>
    assert(!num.isZero());

    <span class="keyword">if</span> (<span class="keyword">this</span>.isZero()) {
      <span class="keyword">return</span> {
        div: <span class="keyword">new</span> BN(<span class="number">0</span>),
        mod: <span class="keyword">new</span> BN(<span class="number">0</span>)
      };
    }

    <span class="keyword">var</span> div, mod, res;
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span> &amp;&amp; num.negative === <span class="number">0</span>) {
      res = <span class="keyword">this</span>.neg().divmod(num, mode);

      <span class="keyword">if</span> (mode !== <span class="string">'mod'</span>) {
        div = res.div.neg();
      }

      <span class="keyword">if</span> (mode !== <span class="string">'div'</span>) {
        mod = res.mod.neg();
        <span class="keyword">if</span> (positive &amp;&amp; mod.negative !== <span class="number">0</span>) {
          mod.iadd(num);
        }
      }

      <span class="keyword">return</span> {
        div: div,
        mod: mod
      };
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.negative === <span class="number">0</span> &amp;&amp; num.negative !== <span class="number">0</span>) {
      res = <span class="keyword">this</span>.divmod(num.neg(), mode);

      <span class="keyword">if</span> (mode !== <span class="string">'mod'</span>) {
        div = res.div.neg();
      }

      <span class="keyword">return</span> {
        div: div,
        mod: res.mod
      };
    }

    <span class="keyword">if</span> ((<span class="keyword">this</span>.negative &amp; num.negative) !== <span class="number">0</span>) {
      res = <span class="keyword">this</span>.neg().divmod(num.neg(), mode);

      <span class="keyword">if</span> (mode !== <span class="string">'div'</span>) {
        mod = res.mod.neg();
        <span class="keyword">if</span> (positive &amp;&amp; mod.negative !== <span class="number">0</span>) {
          mod.isub(num);
        }
      }

      <span class="keyword">return</span> {
        div: res.div,
        mod: mod
      };
    }

    <span class="comment">// Both numbers are positive at this point</span>

    <span class="comment">// Strip both numbers to approximate shift value</span>
    <span class="keyword">if</span> (num.length > <span class="keyword">this</span>.length || <span class="keyword">this</span>.cmp(num) &lt; <span class="number">0</span>) {
      <span class="keyword">return</span> {
        div: <span class="keyword">new</span> BN(<span class="number">0</span>),
        mod: <span class="keyword">this</span>
      };
    }

    <span class="comment">// Very short reduction</span>
    <span class="keyword">if</span> (num.length === <span class="number">1</span>) {
      <span class="keyword">if</span> (mode === <span class="string">'div'</span>) {
        <span class="keyword">return</span> {
          div: <span class="keyword">this</span>.divn(num.words[<span class="number">0</span>]),
          mod: <span class="literal">null</span>
        };
      }

      <span class="keyword">if</span> (mode === <span class="string">'mod'</span>) {
        <span class="keyword">return</span> {
          div: <span class="literal">null</span>,
          mod: <span class="keyword">new</span> BN(<span class="keyword">this</span>.modn(num.words[<span class="number">0</span>]))
        };
      }

      <span class="keyword">return</span> {
        div: <span class="keyword">this</span>.divn(num.words[<span class="number">0</span>]),
        mod: <span class="keyword">new</span> BN(<span class="keyword">this</span>.modn(num.words[<span class="number">0</span>]))
      };
    }

    <span class="keyword">return</span> <span class="keyword">this</span>._wordDiv(num, mode);
  };

  <span class="comment">// Find `this` / `num`</span>
  BN.prototype.div = <span class="function"><span class="keyword">function</span> <span class="title">div</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.divmod(num, <span class="string">'div'</span>, <span class="literal">false</span>).div;
  };

  <span class="comment">// Find `this` % `num`</span>
  BN.prototype.mod = <span class="function"><span class="keyword">function</span> <span class="title">mod</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.divmod(num, <span class="string">'mod'</span>, <span class="literal">false</span>).mod;
  };

  BN.prototype.umod = <span class="function"><span class="keyword">function</span> <span class="title">umod</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.divmod(num, <span class="string">'mod'</span>, <span class="literal">true</span>).mod;
  };

  <span class="comment">// Find Round(`this` / `num`)</span>
  BN.prototype.divRound = <span class="function"><span class="keyword">function</span> <span class="title">divRound</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> dm = <span class="keyword">this</span>.divmod(num);

    <span class="comment">// Fast case - exact division</span>
    <span class="keyword">if</span> (dm.mod.isZero()) <span class="keyword">return</span> dm.div;

    <span class="keyword">var</span> mod = dm.div.negative !== <span class="number">0</span> ? dm.mod.isub(num) : dm.mod;

    <span class="keyword">var</span> half = num.ushrn(<span class="number">1</span>);
    <span class="keyword">var</span> r2 = num.andln(<span class="number">1</span>);
    <span class="keyword">var</span> cmp = mod.cmp(half);

    <span class="comment">// Round down</span>
    <span class="keyword">if</span> (cmp &lt; <span class="number">0</span> || r2 === <span class="number">1</span> &amp;&amp; cmp === <span class="number">0</span>) <span class="keyword">return</span> dm.div;

    <span class="comment">// Round up</span>
    <span class="keyword">return</span> dm.div.negative !== <span class="number">0</span> ? dm.div.isubn(<span class="number">1</span>) : dm.div.iaddn(<span class="number">1</span>);
  };

  BN.prototype.modn = <span class="function"><span class="keyword">function</span> <span class="title">modn</span> <span class="params">(num)</span> {</span>
    assert(num &lt;= <span class="number">0x3ffffff</span>);
    <span class="keyword">var</span> p = (<span class="number">1</span> &lt;&lt; <span class="number">26</span>) % num;

    <span class="keyword">var</span> acc = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="keyword">this</span>.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
      acc = (p * acc + (<span class="keyword">this</span>.words[i] | <span class="number">0</span>)) % num;
    }

    <span class="keyword">return</span> acc;
  };

  <span class="comment">// In-place division by number</span>
  BN.prototype.idivn = <span class="function"><span class="keyword">function</span> <span class="title">idivn</span> <span class="params">(num)</span> {</span>
    assert(num &lt;= <span class="number">0x3ffffff</span>);

    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="keyword">this</span>.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
      <span class="keyword">var</span> w = (<span class="keyword">this</span>.words[i] | <span class="number">0</span>) + carry * <span class="number">0x4000000</span>;
      <span class="keyword">this</span>.words[i] = (w / num) | <span class="number">0</span>;
      carry = w % num;
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.strip();
  };

  BN.prototype.divn = <span class="function"><span class="keyword">function</span> <span class="title">divn</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.clone().idivn(num);
  };

  BN.prototype.egcd = <span class="function"><span class="keyword">function</span> <span class="title">egcd</span> <span class="params">(p)</span> {</span>
    assert(p.negative === <span class="number">0</span>);
    assert(!p.isZero());

    <span class="keyword">var</span> x = <span class="keyword">this</span>;
    <span class="keyword">var</span> y = p.clone();

    <span class="keyword">if</span> (x.negative !== <span class="number">0</span>) {
      x = x.umod(p);
    } <span class="keyword">else</span> {
      x = x.clone();
    }

    <span class="comment">// A * x + B * y = x</span>
    <span class="keyword">var</span> A = <span class="keyword">new</span> BN(<span class="number">1</span>);
    <span class="keyword">var</span> B = <span class="keyword">new</span> BN(<span class="number">0</span>);

    <span class="comment">// C * x + D * y = y</span>
    <span class="keyword">var</span> C = <span class="keyword">new</span> BN(<span class="number">0</span>);
    <span class="keyword">var</span> D = <span class="keyword">new</span> BN(<span class="number">1</span>);

    <span class="keyword">var</span> g = <span class="number">0</span>;

    <span class="keyword">while</span> (x.isEven() &amp;&amp; y.isEven()) {
      x.iushrn(<span class="number">1</span>);
      y.iushrn(<span class="number">1</span>);
      ++g;
    }

    <span class="keyword">var</span> yp = y.clone();
    <span class="keyword">var</span> xp = x.clone();

    <span class="keyword">while</span> (!x.isZero()) {
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, im = <span class="number">1</span>; (x.words[<span class="number">0</span>] &amp; im) === <span class="number">0</span> &amp;&amp; i &lt; <span class="number">26</span>; ++i, im &lt;&lt;= <span class="number">1</span>);
      <span class="keyword">if</span> (i > <span class="number">0</span>) {
        x.iushrn(i);
        <span class="keyword">while</span> (i-- > <span class="number">0</span>) {
          <span class="keyword">if</span> (A.isOdd() || B.isOdd()) {
            A.iadd(yp);
            B.isub(xp);
          }

          A.iushrn(<span class="number">1</span>);
          B.iushrn(<span class="number">1</span>);
        }
      }

      <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>, jm = <span class="number">1</span>; (y.words[<span class="number">0</span>] &amp; jm) === <span class="number">0</span> &amp;&amp; j &lt; <span class="number">26</span>; ++j, jm &lt;&lt;= <span class="number">1</span>);
      <span class="keyword">if</span> (j > <span class="number">0</span>) {
        y.iushrn(j);
        <span class="keyword">while</span> (j-- > <span class="number">0</span>) {
          <span class="keyword">if</span> (C.isOdd() || D.isOdd()) {
            C.iadd(yp);
            D.isub(xp);
          }

          C.iushrn(<span class="number">1</span>);
          D.iushrn(<span class="number">1</span>);
        }
      }

      <span class="keyword">if</span> (x.cmp(y) >= <span class="number">0</span>) {
        x.isub(y);
        A.isub(C);
        B.isub(D);
      } <span class="keyword">else</span> {
        y.isub(x);
        C.isub(A);
        D.isub(B);
      }
    }

    <span class="keyword">return</span> {
      a: C,
      b: D,
      gcd: y.iushln(g)
    };
  };

  <span class="comment">// This is reduced incarnation of the binary EEA</span>
  <span class="comment">// above, designated to invert members of the</span>
  <span class="comment">// _prime_ fields F(p) at a maximal speed</span>
  BN.prototype._invmp = <span class="function"><span class="keyword">function</span> <span class="title">_invmp</span> <span class="params">(p)</span> {</span>
    assert(p.negative === <span class="number">0</span>);
    assert(!p.isZero());

    <span class="keyword">var</span> a = <span class="keyword">this</span>;
    <span class="keyword">var</span> b = p.clone();

    <span class="keyword">if</span> (a.negative !== <span class="number">0</span>) {
      a = a.umod(p);
    } <span class="keyword">else</span> {
      a = a.clone();
    }

    <span class="keyword">var</span> x1 = <span class="keyword">new</span> BN(<span class="number">1</span>);
    <span class="keyword">var</span> x2 = <span class="keyword">new</span> BN(<span class="number">0</span>);

    <span class="keyword">var</span> delta = b.clone();

    <span class="keyword">while</span> (a.cmpn(<span class="number">1</span>) > <span class="number">0</span> &amp;&amp; b.cmpn(<span class="number">1</span>) > <span class="number">0</span>) {
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, im = <span class="number">1</span>; (a.words[<span class="number">0</span>] &amp; im) === <span class="number">0</span> &amp;&amp; i &lt; <span class="number">26</span>; ++i, im &lt;&lt;= <span class="number">1</span>);
      <span class="keyword">if</span> (i > <span class="number">0</span>) {
        a.iushrn(i);
        <span class="keyword">while</span> (i-- > <span class="number">0</span>) {
          <span class="keyword">if</span> (x1.isOdd()) {
            x1.iadd(delta);
          }

          x1.iushrn(<span class="number">1</span>);
        }
      }

      <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>, jm = <span class="number">1</span>; (b.words[<span class="number">0</span>] &amp; jm) === <span class="number">0</span> &amp;&amp; j &lt; <span class="number">26</span>; ++j, jm &lt;&lt;= <span class="number">1</span>);
      <span class="keyword">if</span> (j > <span class="number">0</span>) {
        b.iushrn(j);
        <span class="keyword">while</span> (j-- > <span class="number">0</span>) {
          <span class="keyword">if</span> (x2.isOdd()) {
            x2.iadd(delta);
          }

          x2.iushrn(<span class="number">1</span>);
        }
      }

      <span class="keyword">if</span> (a.cmp(b) >= <span class="number">0</span>) {
        a.isub(b);
        x1.isub(x2);
      } <span class="keyword">else</span> {
        b.isub(a);
        x2.isub(x1);
      }
    }

    <span class="keyword">var</span> res;
    <span class="keyword">if</span> (a.cmpn(<span class="number">1</span>) === <span class="number">0</span>) {
      res = x1;
    } <span class="keyword">else</span> {
      res = x2;
    }

    <span class="keyword">if</span> (res.cmpn(<span class="number">0</span>) &lt; <span class="number">0</span>) {
      res.iadd(p);
    }

    <span class="keyword">return</span> res;
  };

  BN.prototype.gcd = <span class="function"><span class="keyword">function</span> <span class="title">gcd</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.isZero()) <span class="keyword">return</span> num.abs();
    <span class="keyword">if</span> (num.isZero()) <span class="keyword">return</span> <span class="keyword">this</span>.abs();

    <span class="keyword">var</span> a = <span class="keyword">this</span>.clone();
    <span class="keyword">var</span> b = num.clone();
    a.negative = <span class="number">0</span>;
    b.negative = <span class="number">0</span>;

    <span class="comment">// Remove common factor of two</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> shift = <span class="number">0</span>; a.isEven() &amp;&amp; b.isEven(); shift++) {
      a.iushrn(<span class="number">1</span>);
      b.iushrn(<span class="number">1</span>);
    }

    <span class="keyword">do</span> {
      <span class="keyword">while</span> (a.isEven()) {
        a.iushrn(<span class="number">1</span>);
      }
      <span class="keyword">while</span> (b.isEven()) {
        b.iushrn(<span class="number">1</span>);
      }

      <span class="keyword">var</span> r = a.cmp(b);
      <span class="keyword">if</span> (r &lt; <span class="number">0</span>) {
        <span class="comment">// Swap `a` and `b` to make `a` always bigger than `b`</span>
        <span class="keyword">var</span> t = a;
        a = b;
        b = t;
      } <span class="keyword">else</span> <span class="keyword">if</span> (r === <span class="number">0</span> || b.cmpn(<span class="number">1</span>) === <span class="number">0</span>) {
        <span class="keyword">break</span>;
      }

      a.isub(b);
    } <span class="keyword">while</span> (<span class="literal">true</span>);

    <span class="keyword">return</span> b.iushln(shift);
  };

  <span class="comment">// Invert number in the field F(num)</span>
  BN.prototype.invm = <span class="function"><span class="keyword">function</span> <span class="title">invm</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.egcd(num).a.umod(num);
  };

  BN.prototype.isEven = <span class="function"><span class="keyword">function</span> <span class="title">isEven</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> (<span class="keyword">this</span>.words[<span class="number">0</span>] &amp; <span class="number">1</span>) === <span class="number">0</span>;
  };

  BN.prototype.isOdd = <span class="function"><span class="keyword">function</span> <span class="title">isOdd</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> (<span class="keyword">this</span>.words[<span class="number">0</span>] &amp; <span class="number">1</span>) === <span class="number">1</span>;
  };

  <span class="comment">// And first word and num</span>
  BN.prototype.andln = <span class="function"><span class="keyword">function</span> <span class="title">andln</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.words[<span class="number">0</span>] &amp; num;
  };

  <span class="comment">// Increment at the bit position in-line</span>
  BN.prototype.bincn = <span class="function"><span class="keyword">function</span> <span class="title">bincn</span> <span class="params">(bit)</span> {</span>
    assert(<span class="keyword">typeof</span> bit === <span class="string">'number'</span>);
    <span class="keyword">var</span> r = bit % <span class="number">26</span>;
    <span class="keyword">var</span> s = (bit - r) / <span class="number">26</span>;
    <span class="keyword">var</span> q = <span class="number">1</span> &lt;&lt; r;

    <span class="comment">// Fast case: bit is much higher than all existing words</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length &lt;= s) {
      <span class="keyword">this</span>._expand(s + <span class="number">1</span>);
      <span class="keyword">this</span>.words[s] |= q;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }

    <span class="comment">// Add bit and propagate, if needed</span>
    <span class="keyword">var</span> carry = q;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = s; carry !== <span class="number">0</span> &amp;&amp; i &lt; <span class="keyword">this</span>.length; i++) {
      <span class="keyword">var</span> w = <span class="keyword">this</span>.words[i] | <span class="number">0</span>;
      w += carry;
      carry = w >>> <span class="number">26</span>;
      w &amp;= <span class="number">0x3ffffff</span>;
      <span class="keyword">this</span>.words[i] = w;
    }
    <span class="keyword">if</span> (carry !== <span class="number">0</span>) {
      <span class="keyword">this</span>.words[i] = carry;
      <span class="keyword">this</span>.length++;
    }
    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  BN.prototype.isZero = <span class="function"><span class="keyword">function</span> <span class="title">isZero</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.length === <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>.words[<span class="number">0</span>] === <span class="number">0</span>;
  };

  BN.prototype.cmpn = <span class="function"><span class="keyword">function</span> <span class="title">cmpn</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> negative = num &lt; <span class="number">0</span>;

    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span> &amp;&amp; !negative) <span class="keyword">return</span> -<span class="number">1</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative === <span class="number">0</span> &amp;&amp; negative) <span class="keyword">return</span> <span class="number">1</span>;

    <span class="keyword">this</span>.strip();

    <span class="keyword">var</span> res;
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > <span class="number">1</span>) {
      res = <span class="number">1</span>;
    } <span class="keyword">else</span> {
      <span class="keyword">if</span> (negative) {
        num = -num;
      }

      assert(num &lt;= <span class="number">0x3ffffff</span>, <span class="string">'Number is too big'</span>);

      <span class="keyword">var</span> w = <span class="keyword">this</span>.words[<span class="number">0</span>] | <span class="number">0</span>;
      res = w === num ? <span class="number">0</span> : w &lt; num ? -<span class="number">1</span> : <span class="number">1</span>;
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) <span class="keyword">return</span> -res | <span class="number">0</span>;
    <span class="keyword">return</span> res;
  };

  <span class="comment">// Compare two numbers and return:</span>
  <span class="comment">// 1 - if `this` > `num`</span>
  <span class="comment">// 0 - if `this` == `num`</span>
  <span class="comment">// -1 - if `this` &lt; `num`</span>
  BN.prototype.cmp = <span class="function"><span class="keyword">function</span> <span class="title">cmp</span> <span class="params">(num)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span> &amp;&amp; num.negative === <span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative === <span class="number">0</span> &amp;&amp; num.negative !== <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;

    <span class="keyword">var</span> res = <span class="keyword">this</span>.ucmp(num);
    <span class="keyword">if</span> (<span class="keyword">this</span>.negative !== <span class="number">0</span>) <span class="keyword">return</span> -res | <span class="number">0</span>;
    <span class="keyword">return</span> res;
  };

  <span class="comment">// Unsigned comparison</span>
  BN.prototype.ucmp = <span class="function"><span class="keyword">function</span> <span class="title">ucmp</span> <span class="params">(num)</span> {</span>
    <span class="comment">// At this point both numbers have the same sign</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.length > num.length) <span class="keyword">return</span> <span class="number">1</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.length &lt; num.length) <span class="keyword">return</span> -<span class="number">1</span>;

    <span class="keyword">var</span> res = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="keyword">this</span>.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
      <span class="keyword">var</span> a = <span class="keyword">this</span>.words[i] | <span class="number">0</span>;
      <span class="keyword">var</span> b = num.words[i] | <span class="number">0</span>;

      <span class="keyword">if</span> (a === b) <span class="keyword">continue</span>;
      <span class="keyword">if</span> (a &lt; b) {
        res = -<span class="number">1</span>;
      } <span class="keyword">else</span> <span class="keyword">if</span> (a > b) {
        res = <span class="number">1</span>;
      }
      <span class="keyword">break</span>;
    }
    <span class="keyword">return</span> res;
  };

  BN.prototype.gtn = <span class="function"><span class="keyword">function</span> <span class="title">gtn</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmpn(num) === <span class="number">1</span>;
  };

  BN.prototype.gt = <span class="function"><span class="keyword">function</span> <span class="title">gt</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmp(num) === <span class="number">1</span>;
  };

  BN.prototype.gten = <span class="function"><span class="keyword">function</span> <span class="title">gten</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmpn(num) >= <span class="number">0</span>;
  };

  BN.prototype.gte = <span class="function"><span class="keyword">function</span> <span class="title">gte</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmp(num) >= <span class="number">0</span>;
  };

  BN.prototype.ltn = <span class="function"><span class="keyword">function</span> <span class="title">ltn</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmpn(num) === -<span class="number">1</span>;
  };

  BN.prototype.lt = <span class="function"><span class="keyword">function</span> <span class="title">lt</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmp(num) === -<span class="number">1</span>;
  };

  BN.prototype.lten = <span class="function"><span class="keyword">function</span> <span class="title">lten</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmpn(num) &lt;= <span class="number">0</span>;
  };

  BN.prototype.lte = <span class="function"><span class="keyword">function</span> <span class="title">lte</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmp(num) &lt;= <span class="number">0</span>;
  };

  BN.prototype.eqn = <span class="function"><span class="keyword">function</span> <span class="title">eqn</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmpn(num) === <span class="number">0</span>;
  };

  BN.prototype.eq = <span class="function"><span class="keyword">function</span> <span class="title">eq</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.cmp(num) === <span class="number">0</span>;
  };

  <span class="comment">//</span>
  <span class="comment">// A reduce context, could be using montgomery or something better, depending</span>
  <span class="comment">// on the `m` itself.</span>
  <span class="comment">//</span>
  BN.red = <span class="function"><span class="keyword">function</span> <span class="title">red</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Red(num);
  };

  BN.prototype.toRed = <span class="function"><span class="keyword">function</span> <span class="title">toRed</span> <span class="params">(ctx)</span> {</span>
    assert(!<span class="keyword">this</span>.red, <span class="string">'Already a number in reduction context'</span>);
    assert(<span class="keyword">this</span>.negative === <span class="number">0</span>, <span class="string">'red works only with positives'</span>);
    <span class="keyword">return</span> ctx.convertTo(<span class="keyword">this</span>)._forceRed(ctx);
  };

  BN.prototype.fromRed = <span class="function"><span class="keyword">function</span> <span class="title">fromRed</span> <span class="params">()</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'fromRed works only with numbers in reduction context'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.convertFrom(<span class="keyword">this</span>);
  };

  BN.prototype._forceRed = <span class="function"><span class="keyword">function</span> <span class="title">_forceRed</span> <span class="params">(ctx)</span> {</span>
    <span class="keyword">this</span>.red = ctx;
    <span class="keyword">return</span> <span class="keyword">this</span>;
  };

  BN.prototype.forceRed = <span class="function"><span class="keyword">function</span> <span class="title">forceRed</span> <span class="params">(ctx)</span> {</span>
    assert(!<span class="keyword">this</span>.red, <span class="string">'Already a number in reduction context'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>._forceRed(ctx);
  };

  BN.prototype.redAdd = <span class="function"><span class="keyword">function</span> <span class="title">redAdd</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redAdd works only with red numbers'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.add(<span class="keyword">this</span>, num);
  };

  BN.prototype.redIAdd = <span class="function"><span class="keyword">function</span> <span class="title">redIAdd</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redIAdd works only with red numbers'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.iadd(<span class="keyword">this</span>, num);
  };

  BN.prototype.redSub = <span class="function"><span class="keyword">function</span> <span class="title">redSub</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redSub works only with red numbers'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.sub(<span class="keyword">this</span>, num);
  };

  BN.prototype.redISub = <span class="function"><span class="keyword">function</span> <span class="title">redISub</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redISub works only with red numbers'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.isub(<span class="keyword">this</span>, num);
  };

  BN.prototype.redShl = <span class="function"><span class="keyword">function</span> <span class="title">redShl</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redShl works only with red numbers'</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.shl(<span class="keyword">this</span>, num);
  };

  BN.prototype.redMul = <span class="function"><span class="keyword">function</span> <span class="title">redMul</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redMul works only with red numbers'</span>);
    <span class="keyword">this</span>.red._verify2(<span class="keyword">this</span>, num);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.mul(<span class="keyword">this</span>, num);
  };

  BN.prototype.redIMul = <span class="function"><span class="keyword">function</span> <span class="title">redIMul</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redMul works only with red numbers'</span>);
    <span class="keyword">this</span>.red._verify2(<span class="keyword">this</span>, num);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.imul(<span class="keyword">this</span>, num);
  };

  BN.prototype.redSqr = <span class="function"><span class="keyword">function</span> <span class="title">redSqr</span> <span class="params">()</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redSqr works only with red numbers'</span>);
    <span class="keyword">this</span>.red._verify1(<span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.sqr(<span class="keyword">this</span>);
  };

  BN.prototype.redISqr = <span class="function"><span class="keyword">function</span> <span class="title">redISqr</span> <span class="params">()</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redISqr works only with red numbers'</span>);
    <span class="keyword">this</span>.red._verify1(<span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.isqr(<span class="keyword">this</span>);
  };

  <span class="comment">// Square root over p</span>
  BN.prototype.redSqrt = <span class="function"><span class="keyword">function</span> <span class="title">redSqrt</span> <span class="params">()</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redSqrt works only with red numbers'</span>);
    <span class="keyword">this</span>.red._verify1(<span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.sqrt(<span class="keyword">this</span>);
  };

  BN.prototype.redInvm = <span class="function"><span class="keyword">function</span> <span class="title">redInvm</span> <span class="params">()</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redInvm works only with red numbers'</span>);
    <span class="keyword">this</span>.red._verify1(<span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.invm(<span class="keyword">this</span>);
  };

  <span class="comment">// Return negative clone of `this` % `red modulo`</span>
  BN.prototype.redNeg = <span class="function"><span class="keyword">function</span> <span class="title">redNeg</span> <span class="params">()</span> {</span>
    assert(<span class="keyword">this</span>.red, <span class="string">'redNeg works only with red numbers'</span>);
    <span class="keyword">this</span>.red._verify1(<span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.neg(<span class="keyword">this</span>);
  };

  BN.prototype.redPow = <span class="function"><span class="keyword">function</span> <span class="title">redPow</span> <span class="params">(num)</span> {</span>
    assert(<span class="keyword">this</span>.red &amp;&amp; !num.red, <span class="string">'redPow(normalNum)'</span>);
    <span class="keyword">this</span>.red._verify1(<span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>.red.pow(<span class="keyword">this</span>, num);
  };

  <span class="comment">// Prime numbers with efficient reduction</span>
  <span class="keyword">var</span> primes = {
    k256: <span class="literal">null</span>,
    p224: <span class="literal">null</span>,
    p192: <span class="literal">null</span>,
    p25519: <span class="literal">null</span>
  };

  <span class="comment">// Pseudo-Mersenne prime</span>
  <span class="function"><span class="keyword">function</span> <span class="title">MPrime</span> <span class="params">(name, p)</span> {</span>
    <span class="comment">// P = 2 ^ N - K</span>
    <span class="keyword">this</span>.name = name;
    <span class="keyword">this</span>.p = <span class="keyword">new</span> BN(p, <span class="number">16</span>);
    <span class="keyword">this</span>.n = <span class="keyword">this</span>.p.bitLength();
    <span class="keyword">this</span>.k = <span class="keyword">new</span> BN(<span class="number">1</span>).iushln(<span class="keyword">this</span>.n).isub(<span class="keyword">this</span>.p);

    <span class="keyword">this</span>.tmp = <span class="keyword">this</span>._tmp();
  }

  MPrime.prototype._tmp = <span class="function"><span class="keyword">function</span> <span class="title">_tmp</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> tmp = <span class="keyword">new</span> BN(<span class="literal">null</span>);
    tmp.words = <span class="keyword">new</span> Array(Math.ceil(<span class="keyword">this</span>.n / <span class="number">13</span>));
    <span class="keyword">return</span> tmp;
  };

  MPrime.prototype.ireduce = <span class="function"><span class="keyword">function</span> <span class="title">ireduce</span> <span class="params">(num)</span> {</span>
    <span class="comment">// Assumes that `num` is less than `P^2`</span>
    <span class="comment">// num = HI * (2 ^ N - K) + HI * K + LO = HI * K + LO (mod P)</span>
    <span class="keyword">var</span> r = num;
    <span class="keyword">var</span> rlen;

    <span class="keyword">do</span> {
      <span class="keyword">this</span>.split(r, <span class="keyword">this</span>.tmp);
      r = <span class="keyword">this</span>.imulK(r);
      r = r.iadd(<span class="keyword">this</span>.tmp);
      rlen = r.bitLength();
    } <span class="keyword">while</span> (rlen > <span class="keyword">this</span>.n);

    <span class="keyword">var</span> cmp = rlen &lt; <span class="keyword">this</span>.n ? -<span class="number">1</span> : r.ucmp(<span class="keyword">this</span>.p);
    <span class="keyword">if</span> (cmp === <span class="number">0</span>) {
      r.words[<span class="number">0</span>] = <span class="number">0</span>;
      r.length = <span class="number">1</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (cmp > <span class="number">0</span>) {
      r.isub(<span class="keyword">this</span>.p);
    } <span class="keyword">else</span> {
      r.strip();
    }

    <span class="keyword">return</span> r;
  };

  MPrime.prototype.split = <span class="function"><span class="keyword">function</span> <span class="title">split</span> <span class="params">(input, out)</span> {</span>
    input.iushrn(<span class="keyword">this</span>.n, <span class="number">0</span>, out);
  };

  MPrime.prototype.imulK = <span class="function"><span class="keyword">function</span> <span class="title">imulK</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> num.imul(<span class="keyword">this</span>.k);
  };

  <span class="function"><span class="keyword">function</span> <span class="title">K256</span> <span class="params">()</span> {</span>
    MPrime.call(
      <span class="keyword">this</span>,
      <span class="string">'k256'</span>,
      <span class="string">'ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f'</span>);
  }
  inherits(K256, MPrime);

  K256.prototype.split = <span class="function"><span class="keyword">function</span> <span class="title">split</span> <span class="params">(input, output)</span> {</span>
    <span class="comment">// 256 = 9 * 26 + 22</span>
    <span class="keyword">var</span> mask = <span class="number">0x3fffff</span>;

    <span class="keyword">var</span> outLen = Math.min(input.length, <span class="number">9</span>);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; outLen; i++) {
      output.words[i] = input.words[i];
    }
    output.length = outLen;

    <span class="keyword">if</span> (input.length &lt;= <span class="number">9</span>) {
      input.words[<span class="number">0</span>] = <span class="number">0</span>;
      input.length = <span class="number">1</span>;
      <span class="keyword">return</span>;
    }

    <span class="comment">// Shift by 9 limbs</span>
    <span class="keyword">var</span> prev = input.words[<span class="number">9</span>];
    output.words[output.length++] = prev &amp; mask;

    <span class="keyword">for</span> (i = <span class="number">10</span>; i &lt; input.length; i++) {
      <span class="keyword">var</span> next = input.words[i] | <span class="number">0</span>;
      input.words[i - <span class="number">10</span>] = ((next &amp; mask) &lt;&lt; <span class="number">4</span>) | (prev >>> <span class="number">22</span>);
      prev = next;
    }
    prev >>>= <span class="number">22</span>;
    input.words[i - <span class="number">10</span>] = prev;
    <span class="keyword">if</span> (prev === <span class="number">0</span> &amp;&amp; input.length > <span class="number">10</span>) {
      input.length -= <span class="number">10</span>;
    } <span class="keyword">else</span> {
      input.length -= <span class="number">9</span>;
    }
  };

  K256.prototype.imulK = <span class="function"><span class="keyword">function</span> <span class="title">imulK</span> <span class="params">(num)</span> {</span>
    <span class="comment">// K = 0x1000003d1 = [ 0x40, 0x3d1 ]</span>
    num.words[num.length] = <span class="number">0</span>;
    num.words[num.length + <span class="number">1</span>] = <span class="number">0</span>;
    num.length += <span class="number">2</span>;

    <span class="comment">// bounded at: 0x40 * 0x3ffffff + 0x3d0 = 0x100000390</span>
    <span class="keyword">var</span> lo = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; num.length; i++) {
      <span class="keyword">var</span> w = num.words[i] | <span class="number">0</span>;
      lo += w * <span class="number">0x3d1</span>;
      num.words[i] = lo &amp; <span class="number">0x3ffffff</span>;
      lo = w * <span class="number">0x40</span> + ((lo / <span class="number">0x4000000</span>) | <span class="number">0</span>);
    }

    <span class="comment">// Fast length reduction</span>
    <span class="keyword">if</span> (num.words[num.length - <span class="number">1</span>] === <span class="number">0</span>) {
      num.length--;
      <span class="keyword">if</span> (num.words[num.length - <span class="number">1</span>] === <span class="number">0</span>) {
        num.length--;
      }
    }
    <span class="keyword">return</span> num;
  };

  <span class="function"><span class="keyword">function</span> <span class="title">P224</span> <span class="params">()</span> {</span>
    MPrime.call(
      <span class="keyword">this</span>,
      <span class="string">'p224'</span>,
      <span class="string">'ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001'</span>);
  }
  inherits(P224, MPrime);

  <span class="function"><span class="keyword">function</span> <span class="title">P192</span> <span class="params">()</span> {</span>
    MPrime.call(
      <span class="keyword">this</span>,
      <span class="string">'p192'</span>,
      <span class="string">'ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff'</span>);
  }
  inherits(P192, MPrime);

  <span class="function"><span class="keyword">function</span> <span class="title">P25519</span> <span class="params">()</span> {</span>
    <span class="comment">// 2 ^ 255 - 19</span>
    MPrime.call(
      <span class="keyword">this</span>,
      <span class="string">'25519'</span>,
      <span class="string">'7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed'</span>);
  }
  inherits(P25519, MPrime);

  P25519.prototype.imulK = <span class="function"><span class="keyword">function</span> <span class="title">imulK</span> <span class="params">(num)</span> {</span>
    <span class="comment">// K = 0x13</span>
    <span class="keyword">var</span> carry = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; num.length; i++) {
      <span class="keyword">var</span> hi = (num.words[i] | <span class="number">0</span>) * <span class="number">0x13</span> + carry;
      <span class="keyword">var</span> lo = hi &amp; <span class="number">0x3ffffff</span>;
      hi >>>= <span class="number">26</span>;

      num.words[i] = lo;
      carry = hi;
    }
    <span class="keyword">if</span> (carry !== <span class="number">0</span>) {
      num.words[num.length++] = carry;
    }
    <span class="keyword">return</span> num;
  };

  <span class="comment">// Exported mostly for testing purposes, use plain name instead</span>
  BN._prime = <span class="function"><span class="keyword">function</span> <span class="title">prime</span> <span class="params">(name)</span> {</span>
    <span class="comment">// Cached version of prime</span>
    <span class="keyword">if</span> (primes[name]) <span class="keyword">return</span> primes[name];

    <span class="keyword">var</span> prime;
    <span class="keyword">if</span> (name === <span class="string">'k256'</span>) {
      prime = <span class="keyword">new</span> K256();
    } <span class="keyword">else</span> <span class="keyword">if</span> (name === <span class="string">'p224'</span>) {
      prime = <span class="keyword">new</span> P224();
    } <span class="keyword">else</span> <span class="keyword">if</span> (name === <span class="string">'p192'</span>) {
      prime = <span class="keyword">new</span> P192();
    } <span class="keyword">else</span> <span class="keyword">if</span> (name === <span class="string">'p25519'</span>) {
      prime = <span class="keyword">new</span> P25519();
    } <span class="keyword">else</span> {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Unknown prime '</span> + name);
    }
    primes[name] = prime;

    <span class="keyword">return</span> prime;
  };

  <span class="comment">//</span>
  <span class="comment">// Base reduction engine</span>
  <span class="comment">//</span>
  <span class="function"><span class="keyword">function</span> <span class="title">Red</span> <span class="params">(m)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">typeof</span> m === <span class="string">'string'</span>) {
      <span class="keyword">var</span> prime = BN._prime(m);
      <span class="keyword">this</span>.m = prime.p;
      <span class="keyword">this</span>.prime = prime;
    } <span class="keyword">else</span> {
      assert(m.gtn(<span class="number">1</span>), <span class="string">'modulus must be greater than 1'</span>);
      <span class="keyword">this</span>.m = m;
      <span class="keyword">this</span>.prime = <span class="literal">null</span>;
    }
  }

  Red.prototype._verify1 = <span class="function"><span class="keyword">function</span> <span class="title">_verify1</span> <span class="params">(a)</span> {</span>
    assert(a.negative === <span class="number">0</span>, <span class="string">'red works only with positives'</span>);
    assert(a.red, <span class="string">'red works only with red numbers'</span>);
  };

  Red.prototype._verify2 = <span class="function"><span class="keyword">function</span> <span class="title">_verify2</span> <span class="params">(a, b)</span> {</span>
    assert((a.negative | b.negative) === <span class="number">0</span>, <span class="string">'red works only with positives'</span>);
    assert(a.red &amp;&amp; a.red === b.red,
      <span class="string">'red works only with red numbers'</span>);
  };

  Red.prototype.imod = <span class="function"><span class="keyword">function</span> <span class="title">imod</span> <span class="params">(a)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.prime) <span class="keyword">return</span> <span class="keyword">this</span>.prime.ireduce(a)._forceRed(<span class="keyword">this</span>);
    <span class="keyword">return</span> a.umod(<span class="keyword">this</span>.m)._forceRed(<span class="keyword">this</span>);
  };

  Red.prototype.neg = <span class="function"><span class="keyword">function</span> <span class="title">neg</span> <span class="params">(a)</span> {</span>
    <span class="keyword">if</span> (a.isZero()) {
      <span class="keyword">return</span> a.clone();
    }

    <span class="keyword">return</span> <span class="keyword">this</span>.m.sub(a)._forceRed(<span class="keyword">this</span>);
  };

  Red.prototype.add = <span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">this</span>._verify2(a, b);

    <span class="keyword">var</span> res = a.add(b);
    <span class="keyword">if</span> (res.cmp(<span class="keyword">this</span>.m) >= <span class="number">0</span>) {
      res.isub(<span class="keyword">this</span>.m);
    }
    <span class="keyword">return</span> res._forceRed(<span class="keyword">this</span>);
  };

  Red.prototype.iadd = <span class="function"><span class="keyword">function</span> <span class="title">iadd</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">this</span>._verify2(a, b);

    <span class="keyword">var</span> res = a.iadd(b);
    <span class="keyword">if</span> (res.cmp(<span class="keyword">this</span>.m) >= <span class="number">0</span>) {
      res.isub(<span class="keyword">this</span>.m);
    }
    <span class="keyword">return</span> res;
  };

  Red.prototype.sub = <span class="function"><span class="keyword">function</span> <span class="title">sub</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">this</span>._verify2(a, b);

    <span class="keyword">var</span> res = a.sub(b);
    <span class="keyword">if</span> (res.cmpn(<span class="number">0</span>) &lt; <span class="number">0</span>) {
      res.iadd(<span class="keyword">this</span>.m);
    }
    <span class="keyword">return</span> res._forceRed(<span class="keyword">this</span>);
  };

  Red.prototype.isub = <span class="function"><span class="keyword">function</span> <span class="title">isub</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">this</span>._verify2(a, b);

    <span class="keyword">var</span> res = a.isub(b);
    <span class="keyword">if</span> (res.cmpn(<span class="number">0</span>) &lt; <span class="number">0</span>) {
      res.iadd(<span class="keyword">this</span>.m);
    }
    <span class="keyword">return</span> res;
  };

  Red.prototype.shl = <span class="function"><span class="keyword">function</span> <span class="title">shl</span> <span class="params">(a, num)</span> {</span>
    <span class="keyword">this</span>._verify1(a);
    <span class="keyword">return</span> <span class="keyword">this</span>.imod(a.ushln(num));
  };

  Red.prototype.imul = <span class="function"><span class="keyword">function</span> <span class="title">imul</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">this</span>._verify2(a, b);
    <span class="keyword">return</span> <span class="keyword">this</span>.imod(a.imul(b));
  };

  Red.prototype.mul = <span class="function"><span class="keyword">function</span> <span class="title">mul</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">this</span>._verify2(a, b);
    <span class="keyword">return</span> <span class="keyword">this</span>.imod(a.mul(b));
  };

  Red.prototype.isqr = <span class="function"><span class="keyword">function</span> <span class="title">isqr</span> <span class="params">(a)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.imul(a, a.clone());
  };

  Red.prototype.sqr = <span class="function"><span class="keyword">function</span> <span class="title">sqr</span> <span class="params">(a)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.mul(a, a);
  };

  Red.prototype.sqrt = <span class="function"><span class="keyword">function</span> <span class="title">sqrt</span> <span class="params">(a)</span> {</span>
    <span class="keyword">if</span> (a.isZero()) <span class="keyword">return</span> a.clone();

    <span class="keyword">var</span> mod3 = <span class="keyword">this</span>.m.andln(<span class="number">3</span>);
    assert(mod3 % <span class="number">2</span> === <span class="number">1</span>);

    <span class="comment">// Fast case</span>
    <span class="keyword">if</span> (mod3 === <span class="number">3</span>) {
      <span class="keyword">var</span> pow = <span class="keyword">this</span>.m.add(<span class="keyword">new</span> BN(<span class="number">1</span>)).iushrn(<span class="number">2</span>);
      <span class="keyword">return</span> <span class="keyword">this</span>.pow(a, pow);
    }

    <span class="comment">// Tonelli-Shanks algorithm (Totally unoptimized and slow)</span>
    <span class="comment">//</span>
    <span class="comment">// Find Q and S, that Q * 2 ^ S = (P - 1)</span>
    <span class="keyword">var</span> q = <span class="keyword">this</span>.m.subn(<span class="number">1</span>);
    <span class="keyword">var</span> s = <span class="number">0</span>;
    <span class="keyword">while</span> (!q.isZero() &amp;&amp; q.andln(<span class="number">1</span>) === <span class="number">0</span>) {
      s++;
      q.iushrn(<span class="number">1</span>);
    }
    assert(!q.isZero());

    <span class="keyword">var</span> one = <span class="keyword">new</span> BN(<span class="number">1</span>).toRed(<span class="keyword">this</span>);
    <span class="keyword">var</span> nOne = one.redNeg();

    <span class="comment">// Find quadratic non-residue</span>
    <span class="comment">// NOTE: Max is such because of generalized Riemann hypothesis.</span>
    <span class="keyword">var</span> lpow = <span class="keyword">this</span>.m.subn(<span class="number">1</span>).iushrn(<span class="number">1</span>);
    <span class="keyword">var</span> z = <span class="keyword">this</span>.m.bitLength();
    z = <span class="keyword">new</span> BN(<span class="number">2</span> * z * z).toRed(<span class="keyword">this</span>);

    <span class="keyword">while</span> (<span class="keyword">this</span>.pow(z, lpow).cmp(nOne) !== <span class="number">0</span>) {
      z.redIAdd(nOne);
    }

    <span class="keyword">var</span> c = <span class="keyword">this</span>.pow(z, q);
    <span class="keyword">var</span> r = <span class="keyword">this</span>.pow(a, q.addn(<span class="number">1</span>).iushrn(<span class="number">1</span>));
    <span class="keyword">var</span> t = <span class="keyword">this</span>.pow(a, q);
    <span class="keyword">var</span> m = s;
    <span class="keyword">while</span> (t.cmp(one) !== <span class="number">0</span>) {
      <span class="keyword">var</span> tmp = t;
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; tmp.cmp(one) !== <span class="number">0</span>; i++) {
        tmp = tmp.redSqr();
      }
      assert(i &lt; m);
      <span class="keyword">var</span> b = <span class="keyword">this</span>.pow(c, <span class="keyword">new</span> BN(<span class="number">1</span>).iushln(m - i - <span class="number">1</span>));

      r = r.redMul(b);
      c = b.redSqr();
      t = t.redMul(c);
      m = i;
    }

    <span class="keyword">return</span> r;
  };

  Red.prototype.invm = <span class="function"><span class="keyword">function</span> <span class="title">invm</span> <span class="params">(a)</span> {</span>
    <span class="keyword">var</span> inv = a._invmp(<span class="keyword">this</span>.m);
    <span class="keyword">if</span> (inv.negative !== <span class="number">0</span>) {
      inv.negative = <span class="number">0</span>;
      <span class="keyword">return</span> <span class="keyword">this</span>.imod(inv).redNeg();
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> <span class="keyword">this</span>.imod(inv);
    }
  };

  Red.prototype.pow = <span class="function"><span class="keyword">function</span> <span class="title">pow</span> <span class="params">(a, num)</span> {</span>
    <span class="keyword">if</span> (num.isZero()) <span class="keyword">return</span> <span class="keyword">new</span> BN(<span class="number">1</span>).toRed(<span class="keyword">this</span>);
    <span class="keyword">if</span> (num.cmpn(<span class="number">1</span>) === <span class="number">0</span>) <span class="keyword">return</span> a.clone();

    <span class="keyword">var</span> windowSize = <span class="number">4</span>;
    <span class="keyword">var</span> wnd = <span class="keyword">new</span> Array(<span class="number">1</span> &lt;&lt; windowSize);
    wnd[<span class="number">0</span>] = <span class="keyword">new</span> BN(<span class="number">1</span>).toRed(<span class="keyword">this</span>);
    wnd[<span class="number">1</span>] = a;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">2</span>; i &lt; wnd.length; i++) {
      wnd[i] = <span class="keyword">this</span>.mul(wnd[i - <span class="number">1</span>], a);
    }

    <span class="keyword">var</span> res = wnd[<span class="number">0</span>];
    <span class="keyword">var</span> current = <span class="number">0</span>;
    <span class="keyword">var</span> currentLen = <span class="number">0</span>;
    <span class="keyword">var</span> start = num.bitLength() % <span class="number">26</span>;
    <span class="keyword">if</span> (start === <span class="number">0</span>) {
      start = <span class="number">26</span>;
    }

    <span class="keyword">for</span> (i = num.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
      <span class="keyword">var</span> word = num.words[i];
      <span class="keyword">for</span> (<span class="keyword">var</span> j = start - <span class="number">1</span>; j >= <span class="number">0</span>; j--) {
        <span class="keyword">var</span> bit = (word >> j) &amp; <span class="number">1</span>;
        <span class="keyword">if</span> (res !== wnd[<span class="number">0</span>]) {
          res = <span class="keyword">this</span>.sqr(res);
        }

        <span class="keyword">if</span> (bit === <span class="number">0</span> &amp;&amp; current === <span class="number">0</span>) {
          currentLen = <span class="number">0</span>;
          <span class="keyword">continue</span>;
        }

        current &lt;&lt;= <span class="number">1</span>;
        current |= bit;
        currentLen++;
        <span class="keyword">if</span> (currentLen !== windowSize &amp;&amp; (i !== <span class="number">0</span> || j !== <span class="number">0</span>)) <span class="keyword">continue</span>;

        res = <span class="keyword">this</span>.mul(res, wnd[current]);
        currentLen = <span class="number">0</span>;
        current = <span class="number">0</span>;
      }
      start = <span class="number">26</span>;
    }

    <span class="keyword">return</span> res;
  };

  Red.prototype.convertTo = <span class="function"><span class="keyword">function</span> <span class="title">convertTo</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> r = num.umod(<span class="keyword">this</span>.m);

    <span class="keyword">return</span> r === num ? r.clone() : r;
  };

  Red.prototype.convertFrom = <span class="function"><span class="keyword">function</span> <span class="title">convertFrom</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> res = num.clone();
    res.red = <span class="literal">null</span>;
    <span class="keyword">return</span> res;
  };

  <span class="comment">//</span>
  <span class="comment">// Montgomery method engine</span>
  <span class="comment">//</span>

  BN.mont = <span class="function"><span class="keyword">function</span> <span class="title">mont</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Mont(num);
  };

  <span class="function"><span class="keyword">function</span> <span class="title">Mont</span> <span class="params">(m)</span> {</span>
    Red.call(<span class="keyword">this</span>, m);

    <span class="keyword">this</span>.shift = <span class="keyword">this</span>.m.bitLength();
    <span class="keyword">if</span> (<span class="keyword">this</span>.shift % <span class="number">26</span> !== <span class="number">0</span>) {
      <span class="keyword">this</span>.shift += <span class="number">26</span> - (<span class="keyword">this</span>.shift % <span class="number">26</span>);
    }

    <span class="keyword">this</span>.r = <span class="keyword">new</span> BN(<span class="number">1</span>).iushln(<span class="keyword">this</span>.shift);
    <span class="keyword">this</span>.r2 = <span class="keyword">this</span>.imod(<span class="keyword">this</span>.r.sqr());
    <span class="keyword">this</span>.rinv = <span class="keyword">this</span>.r._invmp(<span class="keyword">this</span>.m);

    <span class="keyword">this</span>.minv = <span class="keyword">this</span>.rinv.mul(<span class="keyword">this</span>.r).isubn(<span class="number">1</span>).div(<span class="keyword">this</span>.m);
    <span class="keyword">this</span>.minv = <span class="keyword">this</span>.minv.umod(<span class="keyword">this</span>.r);
    <span class="keyword">this</span>.minv = <span class="keyword">this</span>.r.sub(<span class="keyword">this</span>.minv);
  }
  inherits(Mont, Red);

  Mont.prototype.convertTo = <span class="function"><span class="keyword">function</span> <span class="title">convertTo</span> <span class="params">(num)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.imod(num.ushln(<span class="keyword">this</span>.shift));
  };

  Mont.prototype.convertFrom = <span class="function"><span class="keyword">function</span> <span class="title">convertFrom</span> <span class="params">(num)</span> {</span>
    <span class="keyword">var</span> r = <span class="keyword">this</span>.imod(num.mul(<span class="keyword">this</span>.rinv));
    r.red = <span class="literal">null</span>;
    <span class="keyword">return</span> r;
  };

  Mont.prototype.imul = <span class="function"><span class="keyword">function</span> <span class="title">imul</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">if</span> (a.isZero() || b.isZero()) {
      a.words[<span class="number">0</span>] = <span class="number">0</span>;
      a.length = <span class="number">1</span>;
      <span class="keyword">return</span> a;
    }

    <span class="keyword">var</span> t = a.imul(b);
    <span class="keyword">var</span> c = t.maskn(<span class="keyword">this</span>.shift).mul(<span class="keyword">this</span>.minv).imaskn(<span class="keyword">this</span>.shift).mul(<span class="keyword">this</span>.m);
    <span class="keyword">var</span> u = t.isub(c).iushrn(<span class="keyword">this</span>.shift);
    <span class="keyword">var</span> res = u;

    <span class="keyword">if</span> (u.cmp(<span class="keyword">this</span>.m) >= <span class="number">0</span>) {
      res = u.isub(<span class="keyword">this</span>.m);
    } <span class="keyword">else</span> <span class="keyword">if</span> (u.cmpn(<span class="number">0</span>) &lt; <span class="number">0</span>) {
      res = u.iadd(<span class="keyword">this</span>.m);
    }

    <span class="keyword">return</span> res._forceRed(<span class="keyword">this</span>);
  };

  Mont.prototype.mul = <span class="function"><span class="keyword">function</span> <span class="title">mul</span> <span class="params">(a, b)</span> {</span>
    <span class="keyword">if</span> (a.isZero() || b.isZero()) <span class="keyword">return</span> <span class="keyword">new</span> BN(<span class="number">0</span>)._forceRed(<span class="keyword">this</span>);

    <span class="keyword">var</span> t = a.mul(b);
    <span class="keyword">var</span> c = t.maskn(<span class="keyword">this</span>.shift).mul(<span class="keyword">this</span>.minv).imaskn(<span class="keyword">this</span>.shift).mul(<span class="keyword">this</span>.m);
    <span class="keyword">var</span> u = t.isub(c).iushrn(<span class="keyword">this</span>.shift);
    <span class="keyword">var</span> res = u;
    <span class="keyword">if</span> (u.cmp(<span class="keyword">this</span>.m) >= <span class="number">0</span>) {
      res = u.isub(<span class="keyword">this</span>.m);
    } <span class="keyword">else</span> <span class="keyword">if</span> (u.cmpn(<span class="number">0</span>) &lt; <span class="number">0</span>) {
      res = u.iadd(<span class="keyword">this</span>.m);
    }

    <span class="keyword">return</span> res._forceRed(<span class="keyword">this</span>);
  };

  Mont.prototype.invm = <span class="function"><span class="keyword">function</span> <span class="title">invm</span> <span class="params">(a)</span> {</span>
    <span class="comment">// (AR)^-1 * R^2 = (A^-1 * R^-1) * R^2 = A^-1 * R</span>
    <span class="keyword">var</span> res = <span class="keyword">this</span>.imod(a._invmp(<span class="keyword">this</span>.m).mul(<span class="keyword">this</span>.r2));
    <span class="keyword">return</span> res._forceRed(<span class="keyword">this</span>);
  };
})(<span class="keyword">typeof</span> module === <span class="string">'undefined'</span> || module, <span class="keyword">this</span>);
</code></pre>