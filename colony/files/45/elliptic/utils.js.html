<h1>utils.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> utils = exports;
<span class="keyword">var</span> BN = require(<span class="string">'bn.js'</span>);
<span class="keyword">var</span> minAssert = require(<span class="string">'minimalistic-assert'</span>);
<span class="keyword">var</span> minUtils = require(<span class="string">'minimalistic-crypto-utils'</span>);

utils.assert = minAssert;
utils.toArray = minUtils.toArray;
utils.zero2 = minUtils.zero2;
utils.toHex = minUtils.toHex;
utils.encode = minUtils.encode;

<span class="comment">// Represent num in a w-NAF form</span>
<span class="function"><span class="keyword">function</span> <span class="title">getNAF</span><span class="params">(num, w)</span> {</span>
  <span class="keyword">var</span> naf = [];
  <span class="keyword">var</span> ws = <span class="number">1</span> &lt;&lt; (w + <span class="number">1</span>);
  <span class="keyword">var</span> k = num.clone();
  <span class="keyword">while</span> (k.cmpn(<span class="number">1</span>) >= <span class="number">0</span>) {
    <span class="keyword">var</span> z;
    <span class="keyword">if</span> (k.isOdd()) {
      <span class="keyword">var</span> mod = k.andln(ws - <span class="number">1</span>);
      <span class="keyword">if</span> (mod > (ws >> <span class="number">1</span>) - <span class="number">1</span>)
        z = (ws >> <span class="number">1</span>) - mod;
      <span class="keyword">else</span>
        z = mod;
      k.isubn(z);
    } <span class="keyword">else</span> {
      z = <span class="number">0</span>;
    }
    naf.push(z);

    <span class="comment">// Optimization, shift by word if possible</span>
    <span class="keyword">var</span> shift = (k.cmpn(<span class="number">0</span>) !== <span class="number">0</span> &amp;&amp; k.andln(ws - <span class="number">1</span>) === <span class="number">0</span>) ? (w + <span class="number">1</span>) : <span class="number">1</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; shift; i++)
      naf.push(<span class="number">0</span>);
    k.iushrn(shift);
  }

  <span class="keyword">return</span> naf;
}
utils.getNAF = getNAF;

<span class="comment">// Represent k1, k2 in a Joint Sparse Form</span>
<span class="function"><span class="keyword">function</span> <span class="title">getJSF</span><span class="params">(k1, k2)</span> {</span>
  <span class="keyword">var</span> jsf = [
    [],
    []
  ];

  k1 = k1.clone();
  k2 = k2.clone();
  <span class="keyword">var</span> d1 = <span class="number">0</span>;
  <span class="keyword">var</span> d2 = <span class="number">0</span>;
  <span class="keyword">while</span> (k1.cmpn(-d1) > <span class="number">0</span> || k2.cmpn(-d2) > <span class="number">0</span>) {

    <span class="comment">// First phase</span>
    <span class="keyword">var</span> m14 = (k1.andln(<span class="number">3</span>) + d1) &amp; <span class="number">3</span>;
    <span class="keyword">var</span> m24 = (k2.andln(<span class="number">3</span>) + d2) &amp; <span class="number">3</span>;
    <span class="keyword">if</span> (m14 === <span class="number">3</span>)
      m14 = -<span class="number">1</span>;
    <span class="keyword">if</span> (m24 === <span class="number">3</span>)
      m24 = -<span class="number">1</span>;
    <span class="keyword">var</span> u1;
    <span class="keyword">if</span> ((m14 &amp; <span class="number">1</span>) === <span class="number">0</span>) {
      u1 = <span class="number">0</span>;
    } <span class="keyword">else</span> {
      <span class="keyword">var</span> m8 = (k1.andln(<span class="number">7</span>) + d1) &amp; <span class="number">7</span>;
      <span class="keyword">if</span> ((m8 === <span class="number">3</span> || m8 === <span class="number">5</span>) &amp;&amp; m24 === <span class="number">2</span>)
        u1 = -m14;
      <span class="keyword">else</span>
        u1 = m14;
    }
    jsf[<span class="number">0</span>].push(u1);

    <span class="keyword">var</span> u2;
    <span class="keyword">if</span> ((m24 &amp; <span class="number">1</span>) === <span class="number">0</span>) {
      u2 = <span class="number">0</span>;
    } <span class="keyword">else</span> {
      <span class="keyword">var</span> m8 = (k2.andln(<span class="number">7</span>) + d2) &amp; <span class="number">7</span>;
      <span class="keyword">if</span> ((m8 === <span class="number">3</span> || m8 === <span class="number">5</span>) &amp;&amp; m14 === <span class="number">2</span>)
        u2 = -m24;
      <span class="keyword">else</span>
        u2 = m24;
    }
    jsf[<span class="number">1</span>].push(u2);

    <span class="comment">// Second phase</span>
    <span class="keyword">if</span> (<span class="number">2</span> * d1 === u1 + <span class="number">1</span>)
      d1 = <span class="number">1</span> - d1;
    <span class="keyword">if</span> (<span class="number">2</span> * d2 === u2 + <span class="number">1</span>)
      d2 = <span class="number">1</span> - d2;
    k1.iushrn(<span class="number">1</span>);
    k2.iushrn(<span class="number">1</span>);
  }

  <span class="keyword">return</span> jsf;
}
utils.getJSF = getJSF;

<span class="function"><span class="keyword">function</span> <span class="title">cachedProperty</span><span class="params">(obj, name, computer)</span> {</span>
  <span class="keyword">var</span> key = <span class="string">'_'</span> + name;
  obj.prototype[name] = <span class="function"><span class="keyword">function</span> <span class="title">cachedProperty</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> <span class="keyword">this</span>[key] !== <span class="literal">undefined</span> ? <span class="keyword">this</span>[key] :
           <span class="keyword">this</span>[key] = computer.call(<span class="keyword">this</span>);
  };
}
utils.cachedProperty = cachedProperty;

<span class="function"><span class="keyword">function</span> <span class="title">parseBytes</span><span class="params">(bytes)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">typeof</span> bytes === <span class="string">'string'</span> ? utils.toArray(bytes, <span class="string">'hex'</span>) :
                                     bytes;
}
utils.parseBytes = parseBytes;

<span class="function"><span class="keyword">function</span> <span class="title">intFromLE</span><span class="params">(bytes)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> BN(bytes, <span class="string">'hex'</span>, <span class="string">'le'</span>);
}
utils.intFromLE = intFromLE;

</code></pre>