<h1>key.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> BN = require(<span class="string">'bn.js'</span>);
<span class="keyword">var</span> utils = require(<span class="string">'../utils'</span>);
<span class="keyword">var</span> assert = utils.assert;

<span class="function"><span class="keyword">function</span> <span class="title">KeyPair</span><span class="params">(ec, options)</span> {</span>
  <span class="keyword">this</span>.ec = ec;
  <span class="keyword">this</span>.priv = <span class="literal">null</span>;
  <span class="keyword">this</span>.pub = <span class="literal">null</span>;

  <span class="comment">// KeyPair(ec, { priv: ..., pub: ... })</span>
  <span class="keyword">if</span> (options.priv)
    <span class="keyword">this</span>._importPrivate(options.priv, options.privEnc);
  <span class="keyword">if</span> (options.pub)
    <span class="keyword">this</span>._importPublic(options.pub, options.pubEnc);
}
module.exports = KeyPair;

KeyPair.fromPublic = <span class="function"><span class="keyword">function</span> <span class="title">fromPublic</span><span class="params">(ec, pub, enc)</span> {</span>
  <span class="keyword">if</span> (pub <span class="keyword">instanceof</span> KeyPair)
    <span class="keyword">return</span> pub;

  <span class="keyword">return</span> <span class="keyword">new</span> KeyPair(ec, {
    pub: pub,
    pubEnc: enc
  });
};

KeyPair.fromPrivate = <span class="function"><span class="keyword">function</span> <span class="title">fromPrivate</span><span class="params">(ec, priv, enc)</span> {</span>
  <span class="keyword">if</span> (priv <span class="keyword">instanceof</span> KeyPair)
    <span class="keyword">return</span> priv;

  <span class="keyword">return</span> <span class="keyword">new</span> KeyPair(ec, {
    priv: priv,
    privEnc: enc
  });
};

KeyPair.prototype.validate = <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">()</span> {</span>
  <span class="keyword">var</span> pub = <span class="keyword">this</span>.getPublic();

  <span class="keyword">if</span> (pub.isInfinity())
    <span class="keyword">return</span> { result: <span class="literal">false</span>, reason: <span class="string">'Invalid public key'</span> };
  <span class="keyword">if</span> (!pub.validate())
    <span class="keyword">return</span> { result: <span class="literal">false</span>, reason: <span class="string">'Public key is not a point'</span> };
  <span class="keyword">if</span> (!pub.mul(<span class="keyword">this</span>.ec.curve.n).isInfinity())
    <span class="keyword">return</span> { result: <span class="literal">false</span>, reason: <span class="string">'Public key * N != O'</span> };

  <span class="keyword">return</span> { result: <span class="literal">true</span>, reason: <span class="literal">null</span> };
};

KeyPair.prototype.getPublic = <span class="function"><span class="keyword">function</span> <span class="title">getPublic</span><span class="params">(compact, enc)</span> {</span>
  <span class="comment">// compact is optional argument</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> compact === <span class="string">'string'</span>) {
    enc = compact;
    compact = <span class="literal">null</span>;
  }

  <span class="keyword">if</span> (!<span class="keyword">this</span>.pub)
    <span class="keyword">this</span>.pub = <span class="keyword">this</span>.ec.g.mul(<span class="keyword">this</span>.priv);

  <span class="keyword">if</span> (!enc)
    <span class="keyword">return</span> <span class="keyword">this</span>.pub;

  <span class="keyword">return</span> <span class="keyword">this</span>.pub.encode(enc, compact);
};

KeyPair.prototype.getPrivate = <span class="function"><span class="keyword">function</span> <span class="title">getPrivate</span><span class="params">(enc)</span> {</span>
  <span class="keyword">if</span> (enc === <span class="string">'hex'</span>)
    <span class="keyword">return</span> <span class="keyword">this</span>.priv.toString(<span class="number">16</span>, <span class="number">2</span>);
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.priv;
};

KeyPair.prototype._importPrivate = <span class="function"><span class="keyword">function</span> <span class="title">_importPrivate</span><span class="params">(key, enc)</span> {</span>
  <span class="keyword">this</span>.priv = <span class="keyword">new</span> BN(key, enc || <span class="number">16</span>);

  <span class="comment">// Ensure that the priv won't be bigger than n, otherwise we may fail</span>
  <span class="comment">// in fixed multiplication method</span>
  <span class="keyword">this</span>.priv = <span class="keyword">this</span>.priv.umod(<span class="keyword">this</span>.ec.curve.n);
};

KeyPair.prototype._importPublic = <span class="function"><span class="keyword">function</span> <span class="title">_importPublic</span><span class="params">(key, enc)</span> {</span>
  <span class="keyword">if</span> (key.x || key.y) {
    <span class="comment">// Montgomery points only have an `x` coordinate.</span>
    <span class="comment">// Weierstrass/Edwards points on the other hand have both `x` and</span>
    <span class="comment">// `y` coordinates.</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.ec.curve.type === <span class="string">'mont'</span>) {
      assert(key.x, <span class="string">'Need x coordinate'</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.ec.curve.type === <span class="string">'short'</span> ||
               <span class="keyword">this</span>.ec.curve.type === <span class="string">'edwards'</span>) {
      assert(key.x &amp;&amp; key.y, <span class="string">'Need both x and y coordinate'</span>);
    }
    <span class="keyword">this</span>.pub = <span class="keyword">this</span>.ec.curve.point(key.x, key.y);
    <span class="keyword">return</span>;
  }
  <span class="keyword">this</span>.pub = <span class="keyword">this</span>.ec.curve.decodePoint(key, enc);
};

<span class="comment">// ECDH</span>
KeyPair.prototype.derive = <span class="function"><span class="keyword">function</span> <span class="title">derive</span><span class="params">(pub)</span> {</span>
  <span class="keyword">return</span> pub.mul(<span class="keyword">this</span>.priv).getX();
};

<span class="comment">// ECDSA</span>
KeyPair.prototype.sign = <span class="function"><span class="keyword">function</span> <span class="title">sign</span><span class="params">(msg, enc, options)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.ec.sign(msg, <span class="keyword">this</span>, enc, options);
};

KeyPair.prototype.verify = <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">(msg, signature)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.ec.verify(msg, signature, <span class="keyword">this</span>);
};

KeyPair.prototype.inspect = <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="string">'&lt;Key priv: '</span> + (<span class="keyword">this</span>.priv &amp;&amp; <span class="keyword">this</span>.priv.toString(<span class="number">16</span>, <span class="number">2</span>)) +
         <span class="string">' pub: '</span> + (<span class="keyword">this</span>.pub &amp;&amp; <span class="keyword">this</span>.pub.inspect()) + <span class="string">' >'</span>;
};
</code></pre>