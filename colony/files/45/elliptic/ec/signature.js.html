<h1>signature.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> BN = require(<span class="string">'bn.js'</span>);

<span class="keyword">var</span> utils = require(<span class="string">'../utils'</span>);
<span class="keyword">var</span> assert = utils.assert;

<span class="function"><span class="keyword">function</span> <span class="title">Signature</span><span class="params">(options, enc)</span> {</span>
  <span class="keyword">if</span> (options <span class="keyword">instanceof</span> Signature)
    <span class="keyword">return</span> options;

  <span class="keyword">if</span> (<span class="keyword">this</span>._importDER(options, enc))
    <span class="keyword">return</span>;

  assert(options.r &amp;&amp; options.s, <span class="string">'Signature without r or s'</span>);
  <span class="keyword">this</span>.r = <span class="keyword">new</span> BN(options.r, <span class="number">16</span>);
  <span class="keyword">this</span>.s = <span class="keyword">new</span> BN(options.s, <span class="number">16</span>);
  <span class="keyword">if</span> (options.recoveryParam === <span class="literal">undefined</span>)
    <span class="keyword">this</span>.recoveryParam = <span class="literal">null</span>;
  <span class="keyword">else</span>
    <span class="keyword">this</span>.recoveryParam = options.recoveryParam;
}
module.exports = Signature;

<span class="function"><span class="keyword">function</span> <span class="title">Position</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.place = <span class="number">0</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">getLength</span><span class="params">(buf, p)</span> {</span>
  <span class="keyword">var</span> initial = buf[p.place++];
  <span class="keyword">if</span> (!(initial &amp; <span class="number">0x80</span>)) {
    <span class="keyword">return</span> initial;
  }
  <span class="keyword">var</span> octetLen = initial &amp; <span class="number">0xf</span>;
  <span class="keyword">var</span> val = <span class="number">0</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, off = p.place; i &lt; octetLen; i++, off++) {
    val &lt;&lt;= <span class="number">8</span>;
    val |= buf[off];
  }
  p.place = off;
  <span class="keyword">return</span> val;
}

<span class="function"><span class="keyword">function</span> <span class="title">rmPadding</span><span class="params">(buf)</span> {</span>
  <span class="keyword">var</span> i = <span class="number">0</span>;
  <span class="keyword">var</span> len = buf.length - <span class="number">1</span>;
  <span class="keyword">while</span> (!buf[i] &amp;&amp; !(buf[i + <span class="number">1</span>] &amp; <span class="number">0x80</span>) &amp;&amp; i &lt; len) {
    i++;
  }
  <span class="keyword">if</span> (i === <span class="number">0</span>) {
    <span class="keyword">return</span> buf;
  }
  <span class="keyword">return</span> buf.slice(i);
}

Signature.prototype._importDER = <span class="function"><span class="keyword">function</span> <span class="title">_importDER</span><span class="params">(data, enc)</span> {</span>
  data = utils.toArray(data, enc);
  <span class="keyword">var</span> p = <span class="keyword">new</span> Position();
  <span class="keyword">if</span> (data[p.place++] !== <span class="number">0x30</span>) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">var</span> len = getLength(data, p);
  <span class="keyword">if</span> ((len + p.place) !== data.length) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">if</span> (data[p.place++] !== <span class="number">0x02</span>) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">var</span> rlen = getLength(data, p);
  <span class="keyword">var</span> r = data.slice(p.place, rlen + p.place);
  p.place += rlen;
  <span class="keyword">if</span> (data[p.place++] !== <span class="number">0x02</span>) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">var</span> slen = getLength(data, p);
  <span class="keyword">if</span> (data.length !== slen + p.place) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">var</span> s = data.slice(p.place, slen + p.place);
  <span class="keyword">if</span> (r[<span class="number">0</span>] === <span class="number">0</span> &amp;&amp; (r[<span class="number">1</span>] &amp; <span class="number">0x80</span>)) {
    r = r.slice(<span class="number">1</span>);
  }
  <span class="keyword">if</span> (s[<span class="number">0</span>] === <span class="number">0</span> &amp;&amp; (s[<span class="number">1</span>] &amp; <span class="number">0x80</span>)) {
    s = s.slice(<span class="number">1</span>);
  }

  <span class="keyword">this</span>.r = <span class="keyword">new</span> BN(r);
  <span class="keyword">this</span>.s = <span class="keyword">new</span> BN(s);
  <span class="keyword">this</span>.recoveryParam = <span class="literal">null</span>;

  <span class="keyword">return</span> <span class="literal">true</span>;
};

<span class="function"><span class="keyword">function</span> <span class="title">constructLength</span><span class="params">(arr, len)</span> {</span>
  <span class="keyword">if</span> (len &lt; <span class="number">0x80</span>) {
    arr.push(len);
    <span class="keyword">return</span>;
  }
  <span class="keyword">var</span> octets = <span class="number">1</span> + (Math.log(len) / Math.LN2 >>> <span class="number">3</span>);
  arr.push(octets | <span class="number">0x80</span>);
  <span class="keyword">while</span> (--octets) {
    arr.push((len >>> (octets &lt;&lt; <span class="number">3</span>)) &amp; <span class="number">0xff</span>);
  }
  arr.push(len);
}

Signature.prototype.toDER = <span class="function"><span class="keyword">function</span> <span class="title">toDER</span><span class="params">(enc)</span> {</span>
  <span class="keyword">var</span> r = <span class="keyword">this</span>.r.toArray();
  <span class="keyword">var</span> s = <span class="keyword">this</span>.s.toArray();

  <span class="comment">// Pad values</span>
  <span class="keyword">if</span> (r[<span class="number">0</span>] &amp; <span class="number">0x80</span>)
    r = [ <span class="number">0</span> ].concat(r);
  <span class="comment">// Pad values</span>
  <span class="keyword">if</span> (s[<span class="number">0</span>] &amp; <span class="number">0x80</span>)
    s = [ <span class="number">0</span> ].concat(s);

  r = rmPadding(r);
  s = rmPadding(s);

  <span class="keyword">while</span> (!s[<span class="number">0</span>] &amp;&amp; !(s[<span class="number">1</span>] &amp; <span class="number">0x80</span>)) {
    s = s.slice(<span class="number">1</span>);
  }
  <span class="keyword">var</span> arr = [ <span class="number">0x02</span> ];
  constructLength(arr, r.length);
  arr = arr.concat(r);
  arr.push(<span class="number">0x02</span>);
  constructLength(arr, s.length);
  <span class="keyword">var</span> backHalf = arr.concat(s);
  <span class="keyword">var</span> res = [ <span class="number">0x30</span> ];
  constructLength(res, backHalf.length);
  res = res.concat(backHalf);
  <span class="keyword">return</span> utils.encode(res, enc);
};
</code></pre>