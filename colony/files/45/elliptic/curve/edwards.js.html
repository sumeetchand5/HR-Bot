<h1>edwards.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> utils = require(<span class="string">'../utils'</span>);
<span class="keyword">var</span> BN = require(<span class="string">'bn.js'</span>);
<span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);
<span class="keyword">var</span> Base = require(<span class="string">'./base'</span>);

<span class="keyword">var</span> assert = utils.assert;

<span class="function"><span class="keyword">function</span> <span class="title">EdwardsCurve</span><span class="params">(conf)</span> {</span>
  <span class="comment">// NOTE: Important as we are creating point in Base.call()</span>
  <span class="keyword">this</span>.twisted = (conf.a | <span class="number">0</span>) !== <span class="number">1</span>;
  <span class="keyword">this</span>.mOneA = <span class="keyword">this</span>.twisted &amp;&amp; (conf.a | <span class="number">0</span>) === -<span class="number">1</span>;
  <span class="keyword">this</span>.extended = <span class="keyword">this</span>.mOneA;

  Base.call(<span class="keyword">this</span>, <span class="string">'edwards'</span>, conf);

  <span class="keyword">this</span>.a = <span class="keyword">new</span> BN(conf.a, <span class="number">16</span>).umod(<span class="keyword">this</span>.red.m);
  <span class="keyword">this</span>.a = <span class="keyword">this</span>.a.toRed(<span class="keyword">this</span>.red);
  <span class="keyword">this</span>.c = <span class="keyword">new</span> BN(conf.c, <span class="number">16</span>).toRed(<span class="keyword">this</span>.red);
  <span class="keyword">this</span>.c2 = <span class="keyword">this</span>.c.redSqr();
  <span class="keyword">this</span>.d = <span class="keyword">new</span> BN(conf.d, <span class="number">16</span>).toRed(<span class="keyword">this</span>.red);
  <span class="keyword">this</span>.dd = <span class="keyword">this</span>.d.redAdd(<span class="keyword">this</span>.d);

  assert(!<span class="keyword">this</span>.twisted || <span class="keyword">this</span>.c.fromRed().cmpn(<span class="number">1</span>) === <span class="number">0</span>);
  <span class="keyword">this</span>.oneC = (conf.c | <span class="number">0</span>) === <span class="number">1</span>;
}
inherits(EdwardsCurve, Base);
module.exports = EdwardsCurve;

EdwardsCurve.prototype._mulA = <span class="function"><span class="keyword">function</span> <span class="title">_mulA</span><span class="params">(num)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.mOneA)
    <span class="keyword">return</span> num.redNeg();
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.a.redMul(num);
};

EdwardsCurve.prototype._mulC = <span class="function"><span class="keyword">function</span> <span class="title">_mulC</span><span class="params">(num)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.oneC)
    <span class="keyword">return</span> num;
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.c.redMul(num);
};

<span class="comment">// Just for compatibility with Short curve</span>
EdwardsCurve.prototype.jpoint = <span class="function"><span class="keyword">function</span> <span class="title">jpoint</span><span class="params">(x, y, z, t)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.point(x, y, z, t);
};

EdwardsCurve.prototype.pointFromX = <span class="function"><span class="keyword">function</span> <span class="title">pointFromX</span><span class="params">(x, odd)</span> {</span>
  x = <span class="keyword">new</span> BN(x, <span class="number">16</span>);
  <span class="keyword">if</span> (!x.red)
    x = x.toRed(<span class="keyword">this</span>.red);

  <span class="keyword">var</span> x2 = x.redSqr();
  <span class="keyword">var</span> rhs = <span class="keyword">this</span>.c2.redSub(<span class="keyword">this</span>.a.redMul(x2));
  <span class="keyword">var</span> lhs = <span class="keyword">this</span>.one.redSub(<span class="keyword">this</span>.c2.redMul(<span class="keyword">this</span>.d).redMul(x2));

  <span class="keyword">var</span> y2 = rhs.redMul(lhs.redInvm());
  <span class="keyword">var</span> y = y2.redSqrt();
  <span class="keyword">if</span> (y.redSqr().redSub(y2).cmp(<span class="keyword">this</span>.zero) !== <span class="number">0</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'invalid point'</span>);

  <span class="keyword">var</span> isOdd = y.fromRed().isOdd();
  <span class="keyword">if</span> (odd &amp;&amp; !isOdd || !odd &amp;&amp; isOdd)
    y = y.redNeg();

  <span class="keyword">return</span> <span class="keyword">this</span>.point(x, y);
};

EdwardsCurve.prototype.pointFromY = <span class="function"><span class="keyword">function</span> <span class="title">pointFromY</span><span class="params">(y, odd)</span> {</span>
  y = <span class="keyword">new</span> BN(y, <span class="number">16</span>);
  <span class="keyword">if</span> (!y.red)
    y = y.toRed(<span class="keyword">this</span>.red);

  <span class="comment">// x^2 = (y^2 - c^2) / (c^2 d y^2 - a)</span>
  <span class="keyword">var</span> y2 = y.redSqr();
  <span class="keyword">var</span> lhs = y2.redSub(<span class="keyword">this</span>.c2);
  <span class="keyword">var</span> rhs = y2.redMul(<span class="keyword">this</span>.d).redMul(<span class="keyword">this</span>.c2).redSub(<span class="keyword">this</span>.a);
  <span class="keyword">var</span> x2 = lhs.redMul(rhs.redInvm());

  <span class="keyword">if</span> (x2.cmp(<span class="keyword">this</span>.zero) === <span class="number">0</span>) {
    <span class="keyword">if</span> (odd)
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'invalid point'</span>);
    <span class="keyword">else</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.point(<span class="keyword">this</span>.zero, y);
  }

  <span class="keyword">var</span> x = x2.redSqrt();
  <span class="keyword">if</span> (x.redSqr().redSub(x2).cmp(<span class="keyword">this</span>.zero) !== <span class="number">0</span>)
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'invalid point'</span>);

  <span class="keyword">if</span> (x.fromRed().isOdd() !== odd)
    x = x.redNeg();

  <span class="keyword">return</span> <span class="keyword">this</span>.point(x, y);
};

EdwardsCurve.prototype.validate = <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">(point)</span> {</span>
  <span class="keyword">if</span> (point.isInfinity())
    <span class="keyword">return</span> <span class="literal">true</span>;

  <span class="comment">// Curve: A * X^2 + Y^2 = C^2 * (1 + D * X^2 * Y^2)</span>
  point.normalize();

  <span class="keyword">var</span> x2 = point.x.redSqr();
  <span class="keyword">var</span> y2 = point.y.redSqr();
  <span class="keyword">var</span> lhs = x2.redMul(<span class="keyword">this</span>.a).redAdd(y2);
  <span class="keyword">var</span> rhs = <span class="keyword">this</span>.c2.redMul(<span class="keyword">this</span>.one.redAdd(<span class="keyword">this</span>.d.redMul(x2).redMul(y2)));

  <span class="keyword">return</span> lhs.cmp(rhs) === <span class="number">0</span>;
};

<span class="function"><span class="keyword">function</span> <span class="title">Point</span><span class="params">(curve, x, y, z, t)</span> {</span>
  Base.BasePoint.call(<span class="keyword">this</span>, curve, <span class="string">'projective'</span>);
  <span class="keyword">if</span> (x === <span class="literal">null</span> &amp;&amp; y === <span class="literal">null</span> &amp;&amp; z === <span class="literal">null</span>) {
    <span class="keyword">this</span>.x = <span class="keyword">this</span>.curve.zero;
    <span class="keyword">this</span>.y = <span class="keyword">this</span>.curve.one;
    <span class="keyword">this</span>.z = <span class="keyword">this</span>.curve.one;
    <span class="keyword">this</span>.t = <span class="keyword">this</span>.curve.zero;
    <span class="keyword">this</span>.zOne = <span class="literal">true</span>;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.x = <span class="keyword">new</span> BN(x, <span class="number">16</span>);
    <span class="keyword">this</span>.y = <span class="keyword">new</span> BN(y, <span class="number">16</span>);
    <span class="keyword">this</span>.z = z ? <span class="keyword">new</span> BN(z, <span class="number">16</span>) : <span class="keyword">this</span>.curve.one;
    <span class="keyword">this</span>.t = t &amp;&amp; <span class="keyword">new</span> BN(t, <span class="number">16</span>);
    <span class="keyword">if</span> (!<span class="keyword">this</span>.x.red)
      <span class="keyword">this</span>.x = <span class="keyword">this</span>.x.toRed(<span class="keyword">this</span>.curve.red);
    <span class="keyword">if</span> (!<span class="keyword">this</span>.y.red)
      <span class="keyword">this</span>.y = <span class="keyword">this</span>.y.toRed(<span class="keyword">this</span>.curve.red);
    <span class="keyword">if</span> (!<span class="keyword">this</span>.z.red)
      <span class="keyword">this</span>.z = <span class="keyword">this</span>.z.toRed(<span class="keyword">this</span>.curve.red);
    <span class="keyword">if</span> (<span class="keyword">this</span>.t &amp;&amp; !<span class="keyword">this</span>.t.red)
      <span class="keyword">this</span>.t = <span class="keyword">this</span>.t.toRed(<span class="keyword">this</span>.curve.red);
    <span class="keyword">this</span>.zOne = <span class="keyword">this</span>.z === <span class="keyword">this</span>.curve.one;

    <span class="comment">// Use extended coordinates</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.curve.extended &amp;&amp; !<span class="keyword">this</span>.t) {
      <span class="keyword">this</span>.t = <span class="keyword">this</span>.x.redMul(<span class="keyword">this</span>.y);
      <span class="keyword">if</span> (!<span class="keyword">this</span>.zOne)
        <span class="keyword">this</span>.t = <span class="keyword">this</span>.t.redMul(<span class="keyword">this</span>.z.redInvm());
    }
  }
}
inherits(Point, Base.BasePoint);

EdwardsCurve.prototype.pointFromJSON = <span class="function"><span class="keyword">function</span> <span class="title">pointFromJSON</span><span class="params">(obj)</span> {</span>
  <span class="keyword">return</span> Point.fromJSON(<span class="keyword">this</span>, obj);
};

EdwardsCurve.prototype.point = <span class="function"><span class="keyword">function</span> <span class="title">point</span><span class="params">(x, y, z, t)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> Point(<span class="keyword">this</span>, x, y, z, t);
};

Point.fromJSON = <span class="function"><span class="keyword">function</span> <span class="title">fromJSON</span><span class="params">(curve, obj)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> Point(curve, obj[<span class="number">0</span>], obj[<span class="number">1</span>], obj[<span class="number">2</span>]);
};

Point.prototype.inspect = <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.isInfinity())
    <span class="keyword">return</span> <span class="string">'&lt;EC Point Infinity>'</span>;
  <span class="keyword">return</span> <span class="string">'&lt;EC Point x: '</span> + <span class="keyword">this</span>.x.fromRed().toString(<span class="number">16</span>, <span class="number">2</span>) +
      <span class="string">' y: '</span> + <span class="keyword">this</span>.y.fromRed().toString(<span class="number">16</span>, <span class="number">2</span>) +
      <span class="string">' z: '</span> + <span class="keyword">this</span>.z.fromRed().toString(<span class="number">16</span>, <span class="number">2</span>) + <span class="string">'>'</span>;
};

Point.prototype.isInfinity = <span class="function"><span class="keyword">function</span> <span class="title">isInfinity</span><span class="params">()</span> {</span>
  <span class="comment">// XXX This code assumes that zero is always zero in red</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.x.cmpn(<span class="number">0</span>) === <span class="number">0</span> &amp;&amp;
    (<span class="keyword">this</span>.y.cmp(<span class="keyword">this</span>.z) === <span class="number">0</span> ||
    (<span class="keyword">this</span>.zOne &amp;&amp; <span class="keyword">this</span>.y.cmp(<span class="keyword">this</span>.curve.c) === <span class="number">0</span>));
};

Point.prototype._extDbl = <span class="function"><span class="keyword">function</span> <span class="title">_extDbl</span><span class="params">()</span> {</span>
  <span class="comment">// hyperelliptic.org/EFD/g1p/auto-twisted-extended-1.html</span>
  <span class="comment">//     #doubling-dbl-2008-hwcd</span>
  <span class="comment">// 4M + 4S</span>

  <span class="comment">// A = X1^2</span>
  <span class="keyword">var</span> a = <span class="keyword">this</span>.x.redSqr();
  <span class="comment">// B = Y1^2</span>
  <span class="keyword">var</span> b = <span class="keyword">this</span>.y.redSqr();
  <span class="comment">// C = 2 * Z1^2</span>
  <span class="keyword">var</span> c = <span class="keyword">this</span>.z.redSqr();
  c = c.redIAdd(c);
  <span class="comment">// D = a * A</span>
  <span class="keyword">var</span> d = <span class="keyword">this</span>.curve._mulA(a);
  <span class="comment">// E = (X1 + Y1)^2 - A - B</span>
  <span class="keyword">var</span> e = <span class="keyword">this</span>.x.redAdd(<span class="keyword">this</span>.y).redSqr().redISub(a).redISub(b);
  <span class="comment">// G = D + B</span>
  <span class="keyword">var</span> g = d.redAdd(b);
  <span class="comment">// F = G - C</span>
  <span class="keyword">var</span> f = g.redSub(c);
  <span class="comment">// H = D - B</span>
  <span class="keyword">var</span> h = d.redSub(b);
  <span class="comment">// X3 = E * F</span>
  <span class="keyword">var</span> nx = e.redMul(f);
  <span class="comment">// Y3 = G * H</span>
  <span class="keyword">var</span> ny = g.redMul(h);
  <span class="comment">// T3 = E * H</span>
  <span class="keyword">var</span> nt = e.redMul(h);
  <span class="comment">// Z3 = F * G</span>
  <span class="keyword">var</span> nz = f.redMul(g);
  <span class="keyword">return</span> <span class="keyword">this</span>.curve.point(nx, ny, nz, nt);
};

Point.prototype._projDbl = <span class="function"><span class="keyword">function</span> <span class="title">_projDbl</span><span class="params">()</span> {</span>
  <span class="comment">// hyperelliptic.org/EFD/g1p/auto-twisted-projective.html</span>
  <span class="comment">//     #doubling-dbl-2008-bbjlp</span>
  <span class="comment">//     #doubling-dbl-2007-bl</span>
  <span class="comment">// and others</span>
  <span class="comment">// Generally 3M + 4S or 2M + 4S</span>

  <span class="comment">// B = (X1 + Y1)^2</span>
  <span class="keyword">var</span> b = <span class="keyword">this</span>.x.redAdd(<span class="keyword">this</span>.y).redSqr();
  <span class="comment">// C = X1^2</span>
  <span class="keyword">var</span> c = <span class="keyword">this</span>.x.redSqr();
  <span class="comment">// D = Y1^2</span>
  <span class="keyword">var</span> d = <span class="keyword">this</span>.y.redSqr();

  <span class="keyword">var</span> nx;
  <span class="keyword">var</span> ny;
  <span class="keyword">var</span> nz;
  <span class="keyword">if</span> (<span class="keyword">this</span>.curve.twisted) {
    <span class="comment">// E = a * C</span>
    <span class="keyword">var</span> e = <span class="keyword">this</span>.curve._mulA(c);
    <span class="comment">// F = E + D</span>
    <span class="keyword">var</span> f = e.redAdd(d);
    <span class="keyword">if</span> (<span class="keyword">this</span>.zOne) {
      <span class="comment">// X3 = (B - C - D) * (F - 2)</span>
      nx = b.redSub(c).redSub(d).redMul(f.redSub(<span class="keyword">this</span>.curve.two));
      <span class="comment">// Y3 = F * (E - D)</span>
      ny = f.redMul(e.redSub(d));
      <span class="comment">// Z3 = F^2 - 2 * F</span>
      nz = f.redSqr().redSub(f).redSub(f);
    } <span class="keyword">else</span> {
      <span class="comment">// H = Z1^2</span>
      <span class="keyword">var</span> h = <span class="keyword">this</span>.z.redSqr();
      <span class="comment">// J = F - 2 * H</span>
      <span class="keyword">var</span> j = f.redSub(h).redISub(h);
      <span class="comment">// X3 = (B-C-D)*J</span>
      nx = b.redSub(c).redISub(d).redMul(j);
      <span class="comment">// Y3 = F * (E - D)</span>
      ny = f.redMul(e.redSub(d));
      <span class="comment">// Z3 = F * J</span>
      nz = f.redMul(j);
    }
  } <span class="keyword">else</span> {
    <span class="comment">// E = C + D</span>
    <span class="keyword">var</span> e = c.redAdd(d);
    <span class="comment">// H = (c * Z1)^2</span>
    <span class="keyword">var</span> h = <span class="keyword">this</span>.curve._mulC(<span class="keyword">this</span>.z).redSqr();
    <span class="comment">// J = E - 2 * H</span>
    <span class="keyword">var</span> j = e.redSub(h).redSub(h);
    <span class="comment">// X3 = c * (B - E) * J</span>
    nx = <span class="keyword">this</span>.curve._mulC(b.redISub(e)).redMul(j);
    <span class="comment">// Y3 = c * E * (C - D)</span>
    ny = <span class="keyword">this</span>.curve._mulC(e).redMul(c.redISub(d));
    <span class="comment">// Z3 = E * J</span>
    nz = e.redMul(j);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.curve.point(nx, ny, nz);
};

Point.prototype.dbl = <span class="function"><span class="keyword">function</span> <span class="title">dbl</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.isInfinity())
    <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="comment">// Double in extended coordinates</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.curve.extended)
    <span class="keyword">return</span> <span class="keyword">this</span>._extDbl();
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">this</span>._projDbl();
};

Point.prototype._extAdd = <span class="function"><span class="keyword">function</span> <span class="title">_extAdd</span><span class="params">(p)</span> {</span>
  <span class="comment">// hyperelliptic.org/EFD/g1p/auto-twisted-extended-1.html</span>
  <span class="comment">//     #addition-add-2008-hwcd-3</span>
  <span class="comment">// 8M</span>

  <span class="comment">// A = (Y1 - X1) * (Y2 - X2)</span>
  <span class="keyword">var</span> a = <span class="keyword">this</span>.y.redSub(<span class="keyword">this</span>.x).redMul(p.y.redSub(p.x));
  <span class="comment">// B = (Y1 + X1) * (Y2 + X2)</span>
  <span class="keyword">var</span> b = <span class="keyword">this</span>.y.redAdd(<span class="keyword">this</span>.x).redMul(p.y.redAdd(p.x));
  <span class="comment">// C = T1 * k * T2</span>
  <span class="keyword">var</span> c = <span class="keyword">this</span>.t.redMul(<span class="keyword">this</span>.curve.dd).redMul(p.t);
  <span class="comment">// D = Z1 * 2 * Z2</span>
  <span class="keyword">var</span> d = <span class="keyword">this</span>.z.redMul(p.z.redAdd(p.z));
  <span class="comment">// E = B - A</span>
  <span class="keyword">var</span> e = b.redSub(a);
  <span class="comment">// F = D - C</span>
  <span class="keyword">var</span> f = d.redSub(c);
  <span class="comment">// G = D + C</span>
  <span class="keyword">var</span> g = d.redAdd(c);
  <span class="comment">// H = B + A</span>
  <span class="keyword">var</span> h = b.redAdd(a);
  <span class="comment">// X3 = E * F</span>
  <span class="keyword">var</span> nx = e.redMul(f);
  <span class="comment">// Y3 = G * H</span>
  <span class="keyword">var</span> ny = g.redMul(h);
  <span class="comment">// T3 = E * H</span>
  <span class="keyword">var</span> nt = e.redMul(h);
  <span class="comment">// Z3 = F * G</span>
  <span class="keyword">var</span> nz = f.redMul(g);
  <span class="keyword">return</span> <span class="keyword">this</span>.curve.point(nx, ny, nz, nt);
};

Point.prototype._projAdd = <span class="function"><span class="keyword">function</span> <span class="title">_projAdd</span><span class="params">(p)</span> {</span>
  <span class="comment">// hyperelliptic.org/EFD/g1p/auto-twisted-projective.html</span>
  <span class="comment">//     #addition-add-2008-bbjlp</span>
  <span class="comment">//     #addition-add-2007-bl</span>
  <span class="comment">// 10M + 1S</span>

  <span class="comment">// A = Z1 * Z2</span>
  <span class="keyword">var</span> a = <span class="keyword">this</span>.z.redMul(p.z);
  <span class="comment">// B = A^2</span>
  <span class="keyword">var</span> b = a.redSqr();
  <span class="comment">// C = X1 * X2</span>
  <span class="keyword">var</span> c = <span class="keyword">this</span>.x.redMul(p.x);
  <span class="comment">// D = Y1 * Y2</span>
  <span class="keyword">var</span> d = <span class="keyword">this</span>.y.redMul(p.y);
  <span class="comment">// E = d * C * D</span>
  <span class="keyword">var</span> e = <span class="keyword">this</span>.curve.d.redMul(c).redMul(d);
  <span class="comment">// F = B - E</span>
  <span class="keyword">var</span> f = b.redSub(e);
  <span class="comment">// G = B + E</span>
  <span class="keyword">var</span> g = b.redAdd(e);
  <span class="comment">// X3 = A * F * ((X1 + Y1) * (X2 + Y2) - C - D)</span>
  <span class="keyword">var</span> tmp = <span class="keyword">this</span>.x.redAdd(<span class="keyword">this</span>.y).redMul(p.x.redAdd(p.y)).redISub(c).redISub(d);
  <span class="keyword">var</span> nx = a.redMul(f).redMul(tmp);
  <span class="keyword">var</span> ny;
  <span class="keyword">var</span> nz;
  <span class="keyword">if</span> (<span class="keyword">this</span>.curve.twisted) {
    <span class="comment">// Y3 = A * G * (D - a * C)</span>
    ny = a.redMul(g).redMul(d.redSub(<span class="keyword">this</span>.curve._mulA(c)));
    <span class="comment">// Z3 = F * G</span>
    nz = f.redMul(g);
  } <span class="keyword">else</span> {
    <span class="comment">// Y3 = A * G * (D - C)</span>
    ny = a.redMul(g).redMul(d.redSub(c));
    <span class="comment">// Z3 = c * F * G</span>
    nz = <span class="keyword">this</span>.curve._mulC(f).redMul(g);
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.curve.point(nx, ny, nz);
};

Point.prototype.add = <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(p)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.isInfinity())
    <span class="keyword">return</span> p;
  <span class="keyword">if</span> (p.isInfinity())
    <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="keyword">if</span> (<span class="keyword">this</span>.curve.extended)
    <span class="keyword">return</span> <span class="keyword">this</span>._extAdd(p);
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">this</span>._projAdd(p);
};

Point.prototype.mul = <span class="function"><span class="keyword">function</span> <span class="title">mul</span><span class="params">(k)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>._hasDoubles(k))
    <span class="keyword">return</span> <span class="keyword">this</span>.curve._fixedNafMul(<span class="keyword">this</span>, k);
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">this</span>.curve._wnafMul(<span class="keyword">this</span>, k);
};

Point.prototype.mulAdd = <span class="function"><span class="keyword">function</span> <span class="title">mulAdd</span><span class="params">(k1, p, k2)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.curve._wnafMulAdd(<span class="number">1</span>, [ <span class="keyword">this</span>, p ], [ k1, k2 ], <span class="number">2</span>, <span class="literal">false</span>);
};

Point.prototype.jmulAdd = <span class="function"><span class="keyword">function</span> <span class="title">jmulAdd</span><span class="params">(k1, p, k2)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.curve._wnafMulAdd(<span class="number">1</span>, [ <span class="keyword">this</span>, p ], [ k1, k2 ], <span class="number">2</span>, <span class="literal">true</span>);
};

Point.prototype.normalize = <span class="function"><span class="keyword">function</span> <span class="title">normalize</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.zOne)
    <span class="keyword">return</span> <span class="keyword">this</span>;

  <span class="comment">// Normalize coordinates</span>
  <span class="keyword">var</span> zi = <span class="keyword">this</span>.z.redInvm();
  <span class="keyword">this</span>.x = <span class="keyword">this</span>.x.redMul(zi);
  <span class="keyword">this</span>.y = <span class="keyword">this</span>.y.redMul(zi);
  <span class="keyword">if</span> (<span class="keyword">this</span>.t)
    <span class="keyword">this</span>.t = <span class="keyword">this</span>.t.redMul(zi);
  <span class="keyword">this</span>.z = <span class="keyword">this</span>.curve.one;
  <span class="keyword">this</span>.zOne = <span class="literal">true</span>;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};

Point.prototype.neg = <span class="function"><span class="keyword">function</span> <span class="title">neg</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.curve.point(<span class="keyword">this</span>.x.redNeg(),
                          <span class="keyword">this</span>.y,
                          <span class="keyword">this</span>.z,
                          <span class="keyword">this</span>.t &amp;&amp; <span class="keyword">this</span>.t.redNeg());
};

Point.prototype.getX = <span class="function"><span class="keyword">function</span> <span class="title">getX</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.normalize();
  <span class="keyword">return</span> <span class="keyword">this</span>.x.fromRed();
};

Point.prototype.getY = <span class="function"><span class="keyword">function</span> <span class="title">getY</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.normalize();
  <span class="keyword">return</span> <span class="keyword">this</span>.y.fromRed();
};

Point.prototype.eq = <span class="function"><span class="keyword">function</span> <span class="title">eq</span><span class="params">(other)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span> === other ||
         <span class="keyword">this</span>.getX().cmp(other.getX()) === <span class="number">0</span> &amp;&amp;
         <span class="keyword">this</span>.getY().cmp(other.getY()) === <span class="number">0</span>;
};

Point.prototype.eqXToP = <span class="function"><span class="keyword">function</span> <span class="title">eqXToP</span><span class="params">(x)</span> {</span>
  <span class="keyword">var</span> rx = x.toRed(<span class="keyword">this</span>.curve.red).redMul(<span class="keyword">this</span>.z);
  <span class="keyword">if</span> (<span class="keyword">this</span>.x.cmp(rx) === <span class="number">0</span>)
    <span class="keyword">return</span> <span class="literal">true</span>;

  <span class="keyword">var</span> xc = x.clone();
  <span class="keyword">var</span> t = <span class="keyword">this</span>.curve.redN.redMul(<span class="keyword">this</span>.z);
  <span class="keyword">for</span> (;;) {
    xc.iadd(<span class="keyword">this</span>.curve.n);
    <span class="keyword">if</span> (xc.cmp(<span class="keyword">this</span>.curve.p) >= <span class="number">0</span>)
      <span class="keyword">return</span> <span class="literal">false</span>;

    rx.redIAdd(t);
    <span class="keyword">if</span> (<span class="keyword">this</span>.x.cmp(rx) === <span class="number">0</span>)
      <span class="keyword">return</span> <span class="literal">true</span>;
  }
};

<span class="comment">// Compatibility with BaseCurve</span>
Point.prototype.toP = Point.prototype.normalize;
Point.prototype.mixedAdd = Point.prototype.add;
</code></pre>