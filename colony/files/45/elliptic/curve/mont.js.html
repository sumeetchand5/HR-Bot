<h1>mont.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>;

<span class="keyword">var</span> BN = require(<span class="string">'bn.js'</span>);
<span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>);
<span class="keyword">var</span> Base = require(<span class="string">'./base'</span>);

<span class="keyword">var</span> utils = require(<span class="string">'../utils'</span>);

<span class="function"><span class="keyword">function</span> <span class="title">MontCurve</span><span class="params">(conf)</span> {</span>
  Base.call(<span class="keyword">this</span>, <span class="string">'mont'</span>, conf);

  <span class="keyword">this</span>.a = <span class="keyword">new</span> BN(conf.a, <span class="number">16</span>).toRed(<span class="keyword">this</span>.red);
  <span class="keyword">this</span>.b = <span class="keyword">new</span> BN(conf.b, <span class="number">16</span>).toRed(<span class="keyword">this</span>.red);
  <span class="keyword">this</span>.i4 = <span class="keyword">new</span> BN(<span class="number">4</span>).toRed(<span class="keyword">this</span>.red).redInvm();
  <span class="keyword">this</span>.two = <span class="keyword">new</span> BN(<span class="number">2</span>).toRed(<span class="keyword">this</span>.red);
  <span class="keyword">this</span>.a24 = <span class="keyword">this</span>.i4.redMul(<span class="keyword">this</span>.a.redAdd(<span class="keyword">this</span>.two));
}
inherits(MontCurve, Base);
module.exports = MontCurve;

MontCurve.prototype.validate = <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">(point)</span> {</span>
  <span class="keyword">var</span> x = point.normalize().x;
  <span class="keyword">var</span> x2 = x.redSqr();
  <span class="keyword">var</span> rhs = x2.redMul(x).redAdd(x2.redMul(<span class="keyword">this</span>.a)).redAdd(x);
  <span class="keyword">var</span> y = rhs.redSqrt();

  <span class="keyword">return</span> y.redSqr().cmp(rhs) === <span class="number">0</span>;
};

<span class="function"><span class="keyword">function</span> <span class="title">Point</span><span class="params">(curve, x, z)</span> {</span>
  Base.BasePoint.call(<span class="keyword">this</span>, curve, <span class="string">'projective'</span>);
  <span class="keyword">if</span> (x === <span class="literal">null</span> &amp;&amp; z === <span class="literal">null</span>) {
    <span class="keyword">this</span>.x = <span class="keyword">this</span>.curve.one;
    <span class="keyword">this</span>.z = <span class="keyword">this</span>.curve.zero;
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.x = <span class="keyword">new</span> BN(x, <span class="number">16</span>);
    <span class="keyword">this</span>.z = <span class="keyword">new</span> BN(z, <span class="number">16</span>);
    <span class="keyword">if</span> (!<span class="keyword">this</span>.x.red)
      <span class="keyword">this</span>.x = <span class="keyword">this</span>.x.toRed(<span class="keyword">this</span>.curve.red);
    <span class="keyword">if</span> (!<span class="keyword">this</span>.z.red)
      <span class="keyword">this</span>.z = <span class="keyword">this</span>.z.toRed(<span class="keyword">this</span>.curve.red);
  }
}
inherits(Point, Base.BasePoint);

MontCurve.prototype.decodePoint = <span class="function"><span class="keyword">function</span> <span class="title">decodePoint</span><span class="params">(bytes, enc)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.point(utils.toArray(bytes, enc), <span class="number">1</span>);
};

MontCurve.prototype.point = <span class="function"><span class="keyword">function</span> <span class="title">point</span><span class="params">(x, z)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> Point(<span class="keyword">this</span>, x, z);
};

MontCurve.prototype.pointFromJSON = <span class="function"><span class="keyword">function</span> <span class="title">pointFromJSON</span><span class="params">(obj)</span> {</span>
  <span class="keyword">return</span> Point.fromJSON(<span class="keyword">this</span>, obj);
};

Point.prototype.precompute = <span class="function"><span class="keyword">function</span> <span class="title">precompute</span><span class="params">()</span> {</span>
  <span class="comment">// No-op</span>
};

Point.prototype._encode = <span class="function"><span class="keyword">function</span> <span class="title">_encode</span><span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.getX().toArray(<span class="string">'be'</span>, <span class="keyword">this</span>.curve.p.byteLength());
};

Point.fromJSON = <span class="function"><span class="keyword">function</span> <span class="title">fromJSON</span><span class="params">(curve, obj)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">new</span> Point(curve, obj[<span class="number">0</span>], obj[<span class="number">1</span>] || curve.one);
};

Point.prototype.inspect = <span class="function"><span class="keyword">function</span> <span class="title">inspect</span><span class="params">()</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.isInfinity())
    <span class="keyword">return</span> <span class="string">'&lt;EC Point Infinity>'</span>;
  <span class="keyword">return</span> <span class="string">'&lt;EC Point x: '</span> + <span class="keyword">this</span>.x.fromRed().toString(<span class="number">16</span>, <span class="number">2</span>) +
      <span class="string">' z: '</span> + <span class="keyword">this</span>.z.fromRed().toString(<span class="number">16</span>, <span class="number">2</span>) + <span class="string">'>'</span>;
};

Point.prototype.isInfinity = <span class="function"><span class="keyword">function</span> <span class="title">isInfinity</span><span class="params">()</span> {</span>
  <span class="comment">// XXX This code assumes that zero is always zero in red</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.z.cmpn(<span class="number">0</span>) === <span class="number">0</span>;
};

Point.prototype.dbl = <span class="function"><span class="keyword">function</span> <span class="title">dbl</span><span class="params">()</span> {</span>
  <span class="comment">// http://hyperelliptic.org/EFD/g1p/auto-montgom-xz.html#doubling-dbl-1987-m-3</span>
  <span class="comment">// 2M + 2S + 4A</span>

  <span class="comment">// A = X1 + Z1</span>
  <span class="keyword">var</span> a = <span class="keyword">this</span>.x.redAdd(<span class="keyword">this</span>.z);
  <span class="comment">// AA = A^2</span>
  <span class="keyword">var</span> aa = a.redSqr();
  <span class="comment">// B = X1 - Z1</span>
  <span class="keyword">var</span> b = <span class="keyword">this</span>.x.redSub(<span class="keyword">this</span>.z);
  <span class="comment">// BB = B^2</span>
  <span class="keyword">var</span> bb = b.redSqr();
  <span class="comment">// C = AA - BB</span>
  <span class="keyword">var</span> c = aa.redSub(bb);
  <span class="comment">// X3 = AA * BB</span>
  <span class="keyword">var</span> nx = aa.redMul(bb);
  <span class="comment">// Z3 = C * (BB + A24 * C)</span>
  <span class="keyword">var</span> nz = c.redMul(bb.redAdd(<span class="keyword">this</span>.curve.a24.redMul(c)));
  <span class="keyword">return</span> <span class="keyword">this</span>.curve.point(nx, nz);
};

Point.prototype.add = <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Not supported on Montgomery curve'</span>);
};

Point.prototype.diffAdd = <span class="function"><span class="keyword">function</span> <span class="title">diffAdd</span><span class="params">(p, diff)</span> {</span>
  <span class="comment">// http://hyperelliptic.org/EFD/g1p/auto-montgom-xz.html#diffadd-dadd-1987-m-3</span>
  <span class="comment">// 4M + 2S + 6A</span>

  <span class="comment">// A = X2 + Z2</span>
  <span class="keyword">var</span> a = <span class="keyword">this</span>.x.redAdd(<span class="keyword">this</span>.z);
  <span class="comment">// B = X2 - Z2</span>
  <span class="keyword">var</span> b = <span class="keyword">this</span>.x.redSub(<span class="keyword">this</span>.z);
  <span class="comment">// C = X3 + Z3</span>
  <span class="keyword">var</span> c = p.x.redAdd(p.z);
  <span class="comment">// D = X3 - Z3</span>
  <span class="keyword">var</span> d = p.x.redSub(p.z);
  <span class="comment">// DA = D * A</span>
  <span class="keyword">var</span> da = d.redMul(a);
  <span class="comment">// CB = C * B</span>
  <span class="keyword">var</span> cb = c.redMul(b);
  <span class="comment">// X5 = Z1 * (DA + CB)^2</span>
  <span class="keyword">var</span> nx = diff.z.redMul(da.redAdd(cb).redSqr());
  <span class="comment">// Z5 = X1 * (DA - CB)^2</span>
  <span class="keyword">var</span> nz = diff.x.redMul(da.redISub(cb).redSqr());
  <span class="keyword">return</span> <span class="keyword">this</span>.curve.point(nx, nz);
};

Point.prototype.mul = <span class="function"><span class="keyword">function</span> <span class="title">mul</span><span class="params">(k)</span> {</span>
  <span class="keyword">var</span> t = k.clone();
  <span class="keyword">var</span> a = <span class="keyword">this</span>; <span class="comment">// (N / 2) * Q + Q</span>
  <span class="keyword">var</span> b = <span class="keyword">this</span>.curve.point(<span class="literal">null</span>, <span class="literal">null</span>); <span class="comment">// (N / 2) * Q</span>
  <span class="keyword">var</span> c = <span class="keyword">this</span>; <span class="comment">// Q</span>

  <span class="keyword">for</span> (<span class="keyword">var</span> bits = []; t.cmpn(<span class="number">0</span>) !== <span class="number">0</span>; t.iushrn(<span class="number">1</span>))
    bits.push(t.andln(<span class="number">1</span>));

  <span class="keyword">for</span> (<span class="keyword">var</span> i = bits.length - <span class="number">1</span>; i >= <span class="number">0</span>; i--) {
    <span class="keyword">if</span> (bits[i] === <span class="number">0</span>) {
      <span class="comment">// N * Q + Q = ((N / 2) * Q + Q)) + (N / 2) * Q</span>
      a = a.diffAdd(b, c);
      <span class="comment">// N * Q = 2 * ((N / 2) * Q + Q))</span>
      b = b.dbl();
    } <span class="keyword">else</span> {
      <span class="comment">// N * Q = ((N / 2) * Q + Q) + ((N / 2) * Q)</span>
      b = a.diffAdd(b, c);
      <span class="comment">// N * Q + Q = 2 * ((N / 2) * Q + Q)</span>
      a = a.dbl();
    }
  }
  <span class="keyword">return</span> b;
};

Point.prototype.mulAdd = <span class="function"><span class="keyword">function</span> <span class="title">mulAdd</span><span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Not supported on Montgomery curve'</span>);
};

Point.prototype.jumlAdd = <span class="function"><span class="keyword">function</span> <span class="title">jumlAdd</span><span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Not supported on Montgomery curve'</span>);
};

Point.prototype.eq = <span class="function"><span class="keyword">function</span> <span class="title">eq</span><span class="params">(other)</span> {</span>
  <span class="keyword">return</span> <span class="keyword">this</span>.getX().cmp(other.getX()) === <span class="number">0</span>;
};

Point.prototype.normalize = <span class="function"><span class="keyword">function</span> <span class="title">normalize</span><span class="params">()</span> {</span>
  <span class="keyword">this</span>.x = <span class="keyword">this</span>.x.redMul(<span class="keyword">this</span>.z.redInvm());
  <span class="keyword">this</span>.z = <span class="keyword">this</span>.curve.one;
  <span class="keyword">return</span> <span class="keyword">this</span>;
};

Point.prototype.getX = <span class="function"><span class="keyword">function</span> <span class="title">getX</span><span class="params">()</span> {</span>
  <span class="comment">// Normalize coordinates</span>
  <span class="keyword">this</span>.normalize();

  <span class="keyword">return</span> <span class="keyword">this</span>.x.fromRed();
};
</code></pre>