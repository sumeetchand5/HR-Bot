<h1>browser.js</h1>
<pre><code class="lang-js"><span class="string">'use strict'</span>

<span class="function"><span class="keyword">function</span> <span class="title">oldBrowser</span> <span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'secure random number generation not supported by this browser\nuse chrome, FireFox or Internet Explorer 11'</span>)
}
<span class="keyword">var</span> safeBuffer = require(<span class="string">'safe-buffer'</span>)
<span class="keyword">var</span> randombytes = require(<span class="string">'randombytes'</span>)
<span class="keyword">var</span> Buffer = safeBuffer.Buffer
<span class="keyword">var</span> kBufferMaxLength = safeBuffer.kMaxLength
<span class="keyword">var</span> crypto = global.crypto || global.msCrypto
<span class="keyword">var</span> kMaxUint32 = Math.pow(<span class="number">2</span>, <span class="number">32</span>) - <span class="number">1</span>
<span class="function"><span class="keyword">function</span> <span class="title">assertOffset</span> <span class="params">(offset, length)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> offset !== <span class="string">'number'</span> || offset !== offset) { <span class="comment">// eslint-disable-line no-self-compare</span>
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'offset must be a number'</span>)
  }

  <span class="keyword">if</span> (offset > kMaxUint32 || offset &lt; <span class="number">0</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'offset must be a uint32'</span>)
  }

  <span class="keyword">if</span> (offset > kBufferMaxLength || offset > length) {
    <span class="keyword">throw</span> <span class="keyword">new</span> RangeError(<span class="string">'offset out of range'</span>)
  }
}

<span class="function"><span class="keyword">function</span> <span class="title">assertSize</span> <span class="params">(size, offset, length)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> size !== <span class="string">'number'</span> || size !== size) { <span class="comment">// eslint-disable-line no-self-compare</span>
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'size must be a number'</span>)
  }

  <span class="keyword">if</span> (size > kMaxUint32 || size &lt; <span class="number">0</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'size must be a uint32'</span>)
  }

  <span class="keyword">if</span> (size + offset > length || size > kBufferMaxLength) {
    <span class="keyword">throw</span> <span class="keyword">new</span> RangeError(<span class="string">'buffer too small'</span>)
  }
}
<span class="keyword">if</span> ((crypto &amp;&amp; crypto.getRandomValues) || !process.browser) {
  exports.randomFill = randomFill
  exports.randomFillSync = randomFillSync
} <span class="keyword">else</span> {
  exports.randomFill = oldBrowser
  exports.randomFillSync = oldBrowser
}
<span class="function"><span class="keyword">function</span> <span class="title">randomFill</span> <span class="params">(buf, offset, size, cb)</span> {</span>
  <span class="keyword">if</span> (!Buffer.isBuffer(buf) &amp;&amp; !(buf <span class="keyword">instanceof</span> global.Uint8Array)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'"buf" argument must be a Buffer or Uint8Array'</span>)
  }

  <span class="keyword">if</span> (<span class="keyword">typeof</span> offset === <span class="string">'function'</span>) {
    cb = offset
    offset = <span class="number">0</span>
    size = buf.length
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> size === <span class="string">'function'</span>) {
    cb = size
    size = buf.length - offset
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> cb !== <span class="string">'function'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'"cb" argument must be a function'</span>)
  }
  assertOffset(offset, buf.length)
  assertSize(size, offset, buf.length)
  <span class="keyword">return</span> actualFill(buf, offset, size, cb)
}

<span class="function"><span class="keyword">function</span> <span class="title">actualFill</span> <span class="params">(buf, offset, size, cb)</span> {</span>
  <span class="keyword">if</span> (process.browser) {
    <span class="keyword">var</span> ourBuf = buf.buffer
    <span class="keyword">var</span> uint = <span class="keyword">new</span> Uint8Array(ourBuf, offset, size)
    crypto.getRandomValues(uint)
    <span class="keyword">if</span> (cb) {
      process.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        cb(<span class="literal">null</span>, buf)
      })
      <span class="keyword">return</span>
    }
    <span class="keyword">return</span> buf
  }
  <span class="keyword">if</span> (cb) {
    randombytes(size, <span class="function"><span class="keyword">function</span> <span class="params">(err, bytes)</span> {</span>
      <span class="keyword">if</span> (err) {
        <span class="keyword">return</span> cb(err)
      }
      bytes.copy(buf, offset)
      cb(<span class="literal">null</span>, buf)
    })
    <span class="keyword">return</span>
  }
  <span class="keyword">var</span> bytes = randombytes(size)
  bytes.copy(buf, offset)
  <span class="keyword">return</span> buf
}
<span class="function"><span class="keyword">function</span> <span class="title">randomFillSync</span> <span class="params">(buf, offset, size)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> offset === <span class="string">'undefined'</span>) {
    offset = <span class="number">0</span>
  }
  <span class="keyword">if</span> (!Buffer.isBuffer(buf) &amp;&amp; !(buf <span class="keyword">instanceof</span> global.Uint8Array)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'"buf" argument must be a Buffer or Uint8Array'</span>)
  }

  assertOffset(offset, buf.length)

  <span class="keyword">if</span> (size === <span class="literal">undefined</span>) size = buf.length - offset

  assertSize(size, offset, buf.length)

  <span class="keyword">return</span> actualFill(buf, offset, size)
}
</code></pre>