<h1>index.js</h1>
<pre><code class="lang-js"><span class="keyword">var</span> Buffer = require(<span class="string">'safe-buffer'</span>).Buffer
<span class="keyword">var</span> Transform = require(<span class="string">'stream'</span>).Transform
<span class="keyword">var</span> StringDecoder = require(<span class="string">'string_decoder'</span>).StringDecoder
<span class="keyword">var</span> inherits = require(<span class="string">'inherits'</span>)

<span class="function"><span class="keyword">function</span> <span class="title">CipherBase</span> <span class="params">(hashMode)</span> {</span>
  Transform.call(<span class="keyword">this</span>)
  <span class="keyword">this</span>.hashMode = <span class="keyword">typeof</span> hashMode === <span class="string">'string'</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.hashMode) {
    <span class="keyword">this</span>[hashMode] = <span class="keyword">this</span>._finalOrDigest
  } <span class="keyword">else</span> {
    <span class="keyword">this</span>.final = <span class="keyword">this</span>._finalOrDigest
  }
  <span class="keyword">if</span> (<span class="keyword">this</span>._final) {
    <span class="keyword">this</span>.__final = <span class="keyword">this</span>._final
    <span class="keyword">this</span>._final = <span class="literal">null</span>
  }
  <span class="keyword">this</span>._decoder = <span class="literal">null</span>
  <span class="keyword">this</span>._encoding = <span class="literal">null</span>
}
inherits(CipherBase, Transform)

CipherBase.prototype.update = <span class="function"><span class="keyword">function</span> <span class="params">(data, inputEnc, outputEnc)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> data === <span class="string">'string'</span>) {
    data = Buffer.from(data, inputEnc)
  }

  <span class="keyword">var</span> outData = <span class="keyword">this</span>._update(data)
  <span class="keyword">if</span> (<span class="keyword">this</span>.hashMode) <span class="keyword">return</span> <span class="keyword">this</span>

  <span class="keyword">if</span> (outputEnc) {
    outData = <span class="keyword">this</span>._toString(outData, outputEnc)
  }

  <span class="keyword">return</span> outData
}

CipherBase.prototype.setAutoPadding = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>}
CipherBase.prototype.getAuthTag = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'trying to get auth tag in unsupported state'</span>)
}

CipherBase.prototype.setAuthTag = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'trying to set auth tag in unsupported state'</span>)
}

CipherBase.prototype.setAAD = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'trying to set aad in unsupported state'</span>)
}

CipherBase.prototype._transform = <span class="function"><span class="keyword">function</span> <span class="params">(data, _, next)</span> {</span>
  <span class="keyword">var</span> err
  <span class="keyword">try</span> {
    <span class="keyword">if</span> (<span class="keyword">this</span>.hashMode) {
      <span class="keyword">this</span>._update(data)
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.push(<span class="keyword">this</span>._update(data))
    }
  } <span class="keyword">catch</span> (e) {
    err = e
  } <span class="keyword">finally</span> {
    next(err)
  }
}
CipherBase.prototype._flush = <span class="function"><span class="keyword">function</span> <span class="params">(done)</span> {</span>
  <span class="keyword">var</span> err
  <span class="keyword">try</span> {
    <span class="keyword">this</span>.push(<span class="keyword">this</span>.__final())
  } <span class="keyword">catch</span> (e) {
    err = e
  }

  done(err)
}
CipherBase.prototype._finalOrDigest = <span class="function"><span class="keyword">function</span> <span class="params">(outputEnc)</span> {</span>
  <span class="keyword">var</span> outData = <span class="keyword">this</span>.__final() || Buffer.alloc(<span class="number">0</span>)
  <span class="keyword">if</span> (outputEnc) {
    outData = <span class="keyword">this</span>._toString(outData, outputEnc, <span class="literal">true</span>)
  }
  <span class="keyword">return</span> outData
}

CipherBase.prototype._toString = <span class="function"><span class="keyword">function</span> <span class="params">(value, enc, fin)</span> {</span>
  <span class="keyword">if</span> (!<span class="keyword">this</span>._decoder) {
    <span class="keyword">this</span>._decoder = <span class="keyword">new</span> StringDecoder(enc)
    <span class="keyword">this</span>._encoding = enc
  }

  <span class="keyword">if</span> (<span class="keyword">this</span>._encoding !== enc) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'can\'t switch encodings'</span>)

  <span class="keyword">var</span> out = <span class="keyword">this</span>._decoder.write(value)
  <span class="keyword">if</span> (fin) {
    out += <span class="keyword">this</span>._decoder.end()
  }

  <span class="keyword">return</span> out
}

module.exports = CipherBase
</code></pre>